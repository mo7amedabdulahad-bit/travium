window.Travian={applicationId:"travian",Defaults:TravianDefaults||{},emptyFunction:function(){},redirectTo:function(b){Travian.WindowManager.getWindows().map(function(c){Travian.WindowManager.unregister(c)});window.location.assign(b)},api:function(g,e,j,c){e=e||{};var f=function(k,l){if(k.reload){return window.location.reload()}if(k.redirectTo){return Travian.redirectTo(k.redirectTo)}l(k)};var h=e.success||Travian.emptyFunction;var d=e.error||Travian.emptyFunction;var b=Object.assign({},Travian.Defaults.ajaxOptions||{},e,{url:"/api/v1/"+g,method:j||"POST",data:JSON.stringify(e.data),processData:false,dataType:c||"json",contentType:"application/json; charset=UTF-8",headers:{"X-Version":"1001.2",Authorization:"Bearer "+Travian.muskellungesWhippersnapperAngrilyOutstayed},complete:e.complete||Travian.emptyFunction,success:function(k){f(k,h)},error:function(k){f((k&&k.responseJSON)||{},d)}});return jQuery.ajax(b)},getDirection:function(){if(!this.direction){this.direction=jQuery("body").css("direction").toLowerCase()
}return this.direction},insertScript:(function(){var b=[];var c=function(d){if(b.length===0){jQuery("script[src]").each(function(e,f){f=jQuery(f);b.push({src:f[0].src,id:f[0].id,defer:f[0].defer,defaultURL:false})})}return jQuery.grep(b,function(e){return e.src===d.src}).length>0};return function(d,e){var f=this;if(!d){return}if(d&&d.$family&&d.$family.name==="array"){jQuery.each(d,function(g,h){f.insertScript(h)});return}if(typeof d==="string"){d={src:d}}var e=e||this.emptyFunction;if(c(d)){e();return}b.push(d);jQuery("<script>").attr("type","text/javascript").attr("id",(d.id?d.id:undefined)).appendTo("head").on("load",e).attr("src",d.src).attr("defer",!!d.defer)}})(),popup:function(c,b){b=b||{};var d=Object.keys(b).filter(function(e){return b[e]}).reduce(function(f,e){return f+","+e+"=yes"},"");return window.open(c,b.id||"_blank",d,true)},isToggleClosed:function(e,d){e=jQuery(e);d=jQuery(d);var c=(d.attr("class").indexOf("Mirrored")>=0);var b=e.hasClass("hide"),f=b&&d.hasClass("switchClosed");
if(c){f=b&&d.hasClass("switchClosedMirrored")}return f},toggleSwitch:function(d,c){d=jQuery(d);c=jQuery(c);d.toggleClass("hide");var b=(c.attr("class").indexOf("Mirrored")>=0);c.toggleClass("switchClosed");if(b){c.toggleClass("switchClosedMirrored")}c.toggleClass("switchOpened");if(b){c.toggleClass("switchOpenedMirrored")}return this},toggleSwitchDescription:function(d,b,c){if(typeOf(d)==="element"){d=[d]}d.each(function(e){if(e.hasClass("switchClosed")){e.setTitle(b)}else{e.setTitle(c)}});return this},forceDisplay:function(b){var c=typeof b==="undefined"?jQuery(".forceDisplayElement"):b;c.each(function(d){d.addClass("invisible");d.removeClass("invisible")})},adjustButtonDisableState:function(){jQuery(".disableButtonHandler").each(function(b,c){c=jQuery(c);if(c.css("display")==="none"||c.css("visibility")==="hidden"){c.find("button").each(function(d,e){e=jQuery(e);var f=e.attr("olddisabled")===undefined?e.attr("disabled")==="true":e.attr("olddisabled")!=="false";e.attr("olddisabled",f).attr("disabled",true)
})}else{c.find("button").each(function(d,e){e=jQuery(e);var f=e.attr("olddisabled");if(f!==undefined){e.attr("disabled",f!=="false")}else{e.attr("disabled",false)}})}})},isMobile:function(){var b=false;var c=navigator.userAgent||navigator.vendor||window.opera;if(/ipad|ipod|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|windows nt.+touch|xda|xiino/i.test(c)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(c.substr(0,4))){b=true
}return b},parseURL:function(c){var d=document.createElement("a"),b={};d.href=c;d.search.substr(1).split("&").forEach(function(g){var f=g.split("=");var e=decodeURIComponent(f[0]);if(e.length>0){b[e]=f[1]}});return{protocol:d.protocol,host:d.host,hostname:d.hostname,port:d.port,pathname:(d.pathname.charAt(0)!=="/"?"/":"")+d.pathname,searchObject:b,hash:d.hash}},composeURL:function(b){var c=b.protocol+"//"+b.host;c+=this.composeURI(b);return c},composeURI:function(b){var e=b.pathname;var c="?";for(var d in b.searchObject){if(b.searchObject.hasOwnProperty(d)){e+=c+d+"="+b.searchObject[d];c="&"}}e+=b.hash;return e},getScript:function(f,h,d){d=d||{};var g=(typeof d.forceCallback==="undefined"?true:!!d.forceCallback);var b=jQuery("script");if(b){for(var e=b.length-1;e>=0;e--){if(b[e].src&&b[e].src===f){return(g?h:false)}}}var c=(typeof d.useCache==="undefined"?true:!!d.useCache);if(c){jQuery.ajax({url:f,dataType:"script",success:h,cache:true})}else{jQuery.getScript(f,h)}return true},getCss:function(d){var b=jQuery("link");
if(b){for(var c=b.length-1;c>=0;c--){if(b[c].href&&b[c].href===d){return false}}}jQuery('<link rel="stylesheet" type="text/css" href="'+d+'"/>').appendTo("head");return true},updateSideboxVillageHref:function(c){var b=jQuery("#sidebarBoxVillagelist");b.find("li").each(function(){var d=jQuery(this).find("a");var f=Travian.parseURL(d.attr("href"));var h="";var e="?";if(c!==undefined){f.searchObject.t=c}for(var g in f.searchObject){if(f.searchObject.hasOwnProperty(g)){h+=e+g+"="+f.searchObject[g];e="&"}}d.attr("href",h)})},dismissCookieNotice:function(){var c=jQuery("body");var b=c.find("#cookieNotice");if(b.length>0){if(c.hasClass("mobileOptimized")&&b.css("position")==="fixed"){b.css({transform:"rotateX(-90deg)"})}else{b.animate({"margin-top":b.outerHeight()*-1},250)}if(c.hasClass("buildingsV3")){c.animate({"background-position-y":0},250)}setTimeout(function(){b.remove();c.removeClass("cookieNoticeVisible")},400);document.cookie="travian-dismissCookieNotice=1; Max-Age=31536000; Path=/"}}};
Travian.Helpers={substitute:function(c,b,d){return c.replace(d||(/\\?\{([^{}]+)\}/g),function(f,e){if(f.charAt(0)==="\\"){return f.slice(1)}return(b[e]!=null)?b[e]:""})},capitalizeFirstLetter:function capitalizeFirstLetter(b){return b.charAt(0).toUpperCase()+b.slice(1)},mergeOne:function(c,b,d){switch(typeof d){case"object":if(typeof c[b]==="object"){Travian.Helpers.deepmergeObject(c[b]||{},d)}else{c[b]=Object.assign({},d)}break;case"array":c[b]=d.slice(0);break;default:c[b]=d}return c},deepmergeObject:function(f){for(var e=1,b=arguments.length;e<b;e++){var c=arguments[e];for(var d in c){Travian.Helpers.mergeOne(f,d,c[d])}}return f}};Travian.Browser=(function(){var b,d={chrome:false,mozilla:false,opera:false,msie:false,safari:false};var c=function(g){g=g.toLowerCase();var f=/(chrome)[ \/]([\w.]+)/.exec(g)||/(webkit)[ \/]([\w.]+)/.exec(g)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(g)||/(msie) ([\w.]+)/.exec(g)||g.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(g)||[];return{browser:f[1]||"",version:f[2]||"0"}
};var e=navigator.userAgent.toLowerCase();if(e.indexOf("chrome")>-1){d.chrome=true}else{if(e.indexOf("safari")>-1){d.safari=true}else{if(e.indexOf("opera")>-1){d.opera=true}else{if(e.indexOf("firefox")>-1){d.mozilla=true}else{if(e.indexOf("msie")>-1){d.msie=true}}}}}b=c(navigator.userAgent);if(b.browser){d[b.browser]=true;d.version=b.version}if(d.chrome){d.webkit=true}if(d.safari){d.webkit=true}return d})();Travian.Draggable=function(c,b){this.options=Object.assign({onDrag:function(d,e){},snap:6,unit:"px",grid:false,style:true,limit:false,handle:false,invert:false,unDraggableTags:["button","input","a","textarea","select","option"],preventDefault:true,stopPropagation:true,compensateScroll:false,modifiers:{x:"left",y:"top"}},b);this.attach=function(){this.handles.on("mousedown",this.bound.start);this.handles.on("touchstart",this.bound.start);if(this.options.compensateScroll){this.offsetParent.on("scroll",this.bound.scrollListener)}return this};this.detach=function(){this.handles.off("mousedown",this.bound.start);
this.handles.off("touchstart",this.bound.start);if(this.options.compensateScroll){this.offsetParent.off("scroll",this.bound.scrollListener)}return this};this.scrollListener=function(){if(!this.mouse.start){return}var d={x:this.offsetParent.scrollTop(),y:this.offsetParent.scrollLeft()};if(this.element.css("position")==="absolute"){var e=this.sumValues(d,this.compensateScroll.last,-1);this.mouse.now=this.sumValues(this.mouse.now,e,1)}else{this.compensateScroll.diff=this.sumValues(d,this.compensateScroll.start,-1)}if(this.offsetParent!==window){this.compensateScroll.diff=this.sumValues(this.compensateScroll.start,d,-1)}this.compensateScroll.last=d;this.render(this.options)};this.sumValues=function(g,f,j){var e={},d=this.options;for(var h in d.modifiers){if(!d.modifiers[h]){continue}e[h]=g[h]+f[h]*j}return e};this.start=function(d){if(this.options.unDraggableTags.indexOf(d.target.getAttribute("tag"))!==-1){return}var n=this.options;if(d.which===3||d.button===2){return}if(n.preventDefault){d.preventDefault()
}if(n.stopPropagation){d.stopPropagation()}this.compensateScroll.start=this.compensateScroll.last={x:this.offsetParent.scrollTop(),y:this.offsetParent.scrollLeft()};this.compensateScroll.diff={x:0,y:0};this.mouse.start={x:d.pageX,y:d.pageY};var g=n.limit;this.limit={x:[],y:[]};var j,l,e=this.offsetParent===window?null:this.offsetParent;for(j in n.modifiers){if(n.modifiers.hasOwnProperty(j)){var f=this.element.css(n.modifiers[j]);if(f&&!f.match(/px$/)){if(!l){l=this.element.getCoordinates(e)}f=l[n.modifiers[j]]}if(n.style){this.value.now[j]=parseInt(f||0)}else{this.value.now[j]=this.element[n.modifiers[j]]}if(n.invert){this.value.now[j]*=-1}this.mouse.pos[j]=this.mouse.start[j]-this.value.now[j];if(g&&g[j]){var h=2;while(h--){var k=g[j][h];if(k||k===0){this.limit[j][h]=(typeof k==="function")?k():k}}}}}if(typeof this.options.grid==="number"){this.options.grid={x:this.options.grid,y:this.options.grid}}var m={mousemove:this.bound.check,mouseup:this.bound.cancel,touchend:this.bound.cancel};
this.document.on(m);document.addEventListener("touchmove",this.bound.check,{passive:false})};this.check=function(d){if(this.options.preventDefault){d.preventDefault()}var e=Math.round(Math.sqrt(Math.pow(d.pageX-this.mouse.start.x,2)+Math.pow(d.pageY-this.mouse.start.y,2)));if(e>this.options.snap){this.cancel();this.document.on({mousemove:this.bound.drag,mouseup:this.bound.stop,touchend:this.bound.stop});document.addEventListener("touchmove",this.bound.drag,{passive:false})}};this.drag=function(e){var d=this.options;if(d.preventDefault){e.preventDefault()}this.mouse.now=this.sumValues({x:e.pageX,y:e.pageY},this.compensateScroll.diff,-1);this.render(d);this.options.onDrag(this.element,e)};this.render=function(d){for(var e in d.modifiers){if(d.modifiers.hasOwnProperty(e)){if(!d.modifiers[e]){continue}this.value.now[e]=this.mouse.now[e]-this.mouse.pos[e];if(d.invert){this.value.now[e]*=-1}if(d.limit&&this.limit[e]){if((this.limit[e][1]||this.limit[e][1]===0)&&(this.value.now[e]>this.limit[e][1])){this.value.now[e]=this.limit[e][1]
}else{if((this.limit[e][0]||this.limit[e][0]===0)&&(this.value.now[e]<this.limit[e][0])){this.value.now[e]=this.limit[e][0]}}}if(d.grid[e]){this.value.now[e]-=((this.value.now[e]-(this.limit[e][0]||0))%d.grid[e])}if(d.style){this.element.css(d.modifiers[e],this.value.now[e]+d.unit)}else{this.element[d.modifiers[e]]=this.value.now[e]}}}};this.cancel=function(d){this.document.off({mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel})};this.stop=function(e){var d={mousemove:this.bound.drag,mouseup:this.bound.stop,touchmove:this.bound.drag,touchend:this.bound.stop};this.document.off(d);this.mouse.start=null};this.element=jQuery(c);this.document=jQuery(document);this.handles=jQuery(this.options.handle)||this.element;this.mouse={now:{},pos:{}};this.value={start:{},now:{}};this.offsetParent=this.element.parent();this.selection="selectstart" in document?"selectstart":"mousedown";this.compensateScroll={start:{},diff:{},last:{}};this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),scrollListener:this.scrollListener.bind(this)};
this.attach()};Travian.Moveable=function(c,b){this.options=Object.assign({onDrop:function(f,h,g){},droppables:[],container:false,precalculate:false,includeMargins:true,checkDroppables:true},b);this.setContainer=function(f){this.container=jQuery(f)};this.start=function(f){if(this.container){this.options.limit=this.calculateLimit()}if(this.options.precalculate){this.positions=this.droppables.map(function(g){return g.getCoordinates()})}this.parent.start.call(this,f)};this.calculateLimit=function(){var q=this.element,l=this.container,k=jQuery(q.parent()||document.body),o=l.getCoordinates(k),j={},h={},r={},n={},t={},g={x:k.scrollTop(),y:k.scrollLeft()};["top","right","bottom","left"].each(function(y){j[y]=parseInt(q.css("margin-"+y));h[y]=parseInt(q.css("border-"+y));r[y]=parseInt(l.css("margin-"+y));n[y]=parseInt(l.css("border-"+y));t[y]=parseInt(k.css("padding-"+y))},this);var m=q.offsetWidth+j.left+j.right,x=q.offsetHeight+j.top+j.bottom,p=0+g.x,s=0+g.y,v=o.right-n.right-m+g.x,f=o.bottom-n.bottom-x+g.y;
if(this.options.includeMargins){p+=j.left;s+=j.top}else{v+=j.right;f+=j.bottom}if(q.css("position")==="relative"){var u=q.getCoordinates(k);u.left-=parseInt(q.css("left"));u.top-=parseInt(q.css("top"));p-=u.left;s-=u.top;if(l.css("position")!=="relative"){p+=n.left;s+=n.top}v+=j.left-u.left;f+=j.top-u.top;if(l!==k){p+=r.left+t.left;if(!t.left&&p<0){p=0}s+=k===document.body?0:r.top+t.top;if(!t.top&&s<0){s=0}}}else{p-=j.left;s-=j.top;if(l!==k){p+=o.left+n.left;s+=o.top+n.top}}return{x:[p,v],y:[s,f]}};this.getDroppableCoordinates=function(h){var g=h.getCoordinates();if(h.css("position")==="fixed"){var f=window.getScroll();g.left+=f.x;g.right+=f.x;g.top+=f.y;g.bottom+=f.y}return g};this.checkDroppables=function(){var f=this.droppables.filter(function(j,h){j=this.positions?this.positions[h]:this.getDroppableCoordinates(j);var g=this.mouse.now;return(g.x>j.left&&g.x<j.right&&g.y<j.bottom&&g.y>j.top)},this).getLast();if(this.overed!==f){this.overed=f}};this.drag=function(f){this.parent.drag.call(this,f);
if(this.options.checkDroppables&&this.droppables.length){this.checkDroppables()}};this.stop=function(f){this.checkDroppables();this.options.onDrop(this.element,this.overed,f);this.overed=null;return this.parent.stop.call(this,f)};Travian.Draggable.call(this,c,this.options);this.droppables=jQuery(this.options.droppables);this.setContainer(this.options.container||document.body);if(this.options.style){if(this.options.modifiers.x==="left"&&this.options.modifiers.y==="top"){var d=c.position(),e=c.css(["left","top"]);if(d&&(e.left==="auto"||e.top==="auto")){c.offset(c.position())}}if(c.css("position")==="static"){c.css("position","absolute")}}this.overed=null};Travian.Moveable.prototype=Object.create(Travian.Draggable.prototype);Travian.Moveable.constructor=Travian.Moveable;Travian.Moveable.parent=Travian.Draggable.prototype;function addNsEvent(c,f){var d=c.split("."),b=d[0],e=d[1];this.bindCache=this.bindCache||{};if(this.bindCache[c]){this.bindCache[c].push(f)}else{this.bindCache[c]=[f]}this.addEvent(b,f);
return this}function removeNsEvent(d){if(typeof this.bindCache==="undefined"||!this.bindCache.hasOwnProperty(d)){return this}var c=d.split(".")[0],b=0,e=this.bindCache[d],f;for(;f=e[b++];){this.removeEvent(c,f)}return this}function removeNsEvents(e){var b,d,c=this;Object.each(this.bindCache,function(g,f){if(f.contains(".")&&f.split(".").getLast()===e){b=0;for(;d=g[b++];){c.removeEvent(f.split(".")[0],d)}}});return this}Travian.Storage=(function(){var d=null;var e=function(m,l){var n=g(m);l=h(l);if(n===null){}else{n.removeItem(l)}};var b=function(m,l){return{data:m,time:(new Date()).getTime(),cachingTime:l}};var k=function(m,l){var o=g(m);var n=null;l=h(l);if(o===null){return null}else{n=o.getItem(l)}if(n==null||typeof n==="undefined"){return null}return JSON.decode(n)};var g=function(m){var l=m?"localStorage":"sessionStorage";if(!window[l]){return null}return window[l]};var c=function(){if(d===null){d=jQuery("input").css({type:"hidden",behavior:"url(#default#userData)"}).appendTo("body")
}return d};var h=function(l){return"Travian."+l};var f=function(m,l,n){var p=g(m);var o=JSON.encode(n);l=h(l);if(p===null){return null}else{p.setItem(l,o)}};var j=function(n,m){var l=n.cachingTime;if(typeof m.cachingTime!=="undefined"&&m.cachingTime!==null){l=m.cachingTime}return m.time!==false&&(new Date()).getTime()-m.time>l};return{cachingTime:365*24*60*60*1000,clear:function(l,m){e(m,l);return this},get:function(l,m){var n=k(m,l);if(n===null){return null}if(j(this,n)===true){return null}return n.data},set:function(m,o,n,l){var p=b(o,l);f(n,m,p);return this}}})();Travian.Translation={keys:{},add:function(c,d){var b={};if(typeof c!=="object"){b[c]=d}else{b=c}this.keys=Object.assign({},this.keys,b);return this},get:function(b){return this.keys[b]},translate:function(c,b){b=b||{};return c.replace(/\\?\{([^{}]+)\}/g,function(e,d){return Travian.Translation.keys[d]||b[d]||"{"+d+"}"})}};Travian.Tip=(function(){var d=function(e){var f={title:"",text:""};if(typeof e==="undefined"){return false
}var g=e.split("||");if(g.length===1){f.text=g[0]}else{if(g.length===2){f.title=g[0];f.text=g[1]}else{return false}}return f};var c=function(f){var e,g;f.each(function(h,j){if(j.title!==""){if(j.tagName==="title"){j=jQuery(j);g=j.parent("path")[0]||j.parent("circle")[0]||j.parent("rect")[0];e=d(j[0].textContent);var k=document.createElement("textarea");k.innerHTML=e.title;e.title=k.value;k.innerHTML=e.text;e.text=k.value;jQuery(k).remove();j.remove()}else{g=j;e=d(j.title);jQuery(j).removeAttr("title")}if(e===false){return}Travian.Tip.set(g,e)}})};var b=function(k){var g=jQuery(window);var h={x:g.width(),y:g.height()};var j={x:k.element.width(),y:k.element.height()};var f=Object.assign({},k.mousePosition);var e={x:g.scrollLeft(),y:g.scrollTop()};if((k.mousePosition.x-e.x)>h.x){k.mousePosition.x=h.x}if((k.mousePosition.y-e.y)>h.y){k.mousePosition.y=h.y}f.x=k.mousePosition.x+k.options.offset.x;f.y=k.mousePosition.y+k.options.offset.y;if((f.x+j.x-e.x)>h.x-k.options.windowPadding.x){f.x=k.mousePosition.x-k.options.offset.x-j.x
}if((f.y+j.y-e.y)>h.y-k.options.windowPadding.y){f.y=k.mousePosition.y-k.options.offset.y-j.y}if(f.x<e.x+k.options.windowPadding.x){f.x=e.x+k.options.windowPadding.x}if(f.y<e.y+k.options.windowPadding.y){f.y=e.y+k.options.windowPadding.y}k.element.css({left:f.x,top:f.y})};return Object.create({displayState:"hide",element:null,elementCurrent:null,elementTitle:null,elementText:null,lastText:"",lastTitle:"",mousePosition:{x:0,y:0},options:{html:'<div class="tip"><div class="tip-container"><div class="tl"></div><div class="tr"></div><div class="tc"></div><div class="ml"></div><div class="mr"></div><div class="mc"></div><div class="bl"></div><div class="br"></div><div class="bc"></div><div class="tip-contents"><div class="title elementTitle"></div><div class="text elementText"></div></div></div></div>',hideDelay:250,maxWidthInPercent:0.33,minWidthInPixels:200,offset:{x:16,y:16},showDelay:100,windowPadding:{x:10,y:10},zIndex:10000},timer:null,show:function(f){if(typeof f==="string"){f={title:"",text:f,unescaped:false}
}if(!f.text&&!f.title){this.hide();return this}this.updateContent(f);var e=this.element;if(this.displayState!=="show"){this.displayState="show";clearTimeout(this.timer);this.timer=setTimeout(function(){e.fadeIn(400)},this.options.showDelay)}return this},hide:function(){var e=this.element;if(this.displayState!=="hide"){this.displayState="hide";clearTimeout(this.timer);this.timer=setTimeout(function(){e.fadeOut(400)},this.options.hideDelay)}return this},init:function(){this.render();this.refresh()},render:function(){var e=this;this.element=jQuery("<div></div>");this.element.css({position:"absolute",top:0,left:0,display:"none",zIndex:this.options.zIndex});this.element.html(this.options.html);this.element.appendTo("body");this.elementTitle=this.element.find(".elementTitle");this.elementText=this.element.find(".elementText");this.elementContainer=this.element.find(".tip-container");this.elementContents=this.element.find(".tip-contents");jQuery("body").mousemove(function(f){e.mousePosition.x=f.pageX;
e.mousePosition.y=f.pageY;if(e.displayState!=="show"){return}b(e)});return this},setContent:function(e,f){jQuery(e).prop("_travianTooltip",typeof f==="string"?d(f):f)},set:function(e,f){var g=this;e=jQuery(e);if(!e.prop("_travianTooltip")){e.on({mouseover:function(j){var h=jQuery(j.delegateTarget);g.elementCurrent=h;g.show(h.prop("_travianTooltip"))},mouseout:function(h){g.elementCurrent=null;g.hide()}})}this.setContent(e,f);return this},updateContent:function(j){var h=Object.assign({},j);var f=null;if(typeof h.title==="undefined"||!h.title){h.title=""}if(typeof h.text==="undefined"||!h.text){h.text=""}h.title=Travian.Translation.translate(h.title);h.text=Travian.Translation.translate(h.text);if(this.lastText!==h.text||this.lastTitle!==h.title){if(typeof h.unescaped==="undefined"||h.unescaped!==true){}this.elementTitle.html(h.title);if(h.title.length>0){this.elementTitle.show()}else{this.elementTitle.hide()}this.elementText.html(h.text);if(h.text.length>0){this.elementText.show()}else{this.elementText.hide()
}var g=jQuery("body").hasClass("mobileOptimized")?jQuery("body").width()*0.5:jQuery("body").width()*this.options.maxWidthInPercent;var e=Math.max(g,this.options.minWidthInPixels);this.elementContents.css({wordBreak:"normal",wordWrap:"normal",width:"auto",whiteSpace:"normal","max-width":e});var k=this.elementContents.width();if(k>e){this.elementContents.css({wordWrap:"break-word",wordBreak:"break-all"})}b(this);this.lastText=h.text;this.lastTitle=h.title}return this},updateAllInElement:function(e){c(jQuery(e).find('[title][title!=""], path title, circle title, rect title'))},refresh:function(){this.updateAllInElement(document.body)}})})();jQuery(function(){Travian.Tip.init();Travian.Tip.show(" ").hide()});Travian.Dialog={CLOSE_CONTEXT_FORMSUBMIT:"formSubmit",CLOSE_CONTEXT_OVERLAYBACKGROUND:"overlayBackground",CLOSE_CONTEXT_CANCELBUTTON:"cancelButton",CLOSE_CONTEXT_CLOSEONCLICKOK:"closeOnClickOk",CLOSE_CONTEXT_CLOSEONESCKEY:"closeOnEscKey"};Travian.Dialog.Dialog=function(b){this.overlay=null;
this.options=Object.assign({version:1,cssClass:null,buttonOk:true,keepOpen:false,buttonTextOk:null,buttonCloseOnClickOk:false,buttonCancel:true,elementFocus:".dialogButtonOk",relativeTo:null,title:null,useEscKey:true,submitMethod:"get",submitUrl:null,preventFormSubmit:false,overlayCancel:true,draggable:false,dragPosition:null,enableBackground:true,darkOverlay:false,savePositionForSession:{preferenceKey:null},infoIcon:null,buttonTextInfo:null,fx:{duration:400},onOkay:Travian.emptyFunction,onClose:Travian.emptyFunction,afterClose:Travian.emptyFunction,onOpen:Travian.emptyFunction,onDrag:Travian.emptyFunction},b);this.toggleFormState=function(c){this.buttonOk.toggleClass("disabled",c).disabled=c;return this};this.disableForm=function(){return this.toggleFormState(true)};this.enableForm=function(){return this.toggleFormState(false)};this.correctDialogPosition=function(d){var c=Travian.WindowManager.width,k=Travian.WindowManager.height,j=this.wrapper.width(),e=this.wrapper.height(),h=d.left,g=d.top,f=jQuery(document).scrollTop()||0;
if(h<0){h=0}else{if(h+j>=c){h=c-j}}if(g<0){g=0}else{if(g+e>=(k+f)){g=(k+f)-e}}return{left:h,top:g}};this.render=function(){let $this=this;let body=jQuery("body");if(this.options.savePositionForSession.preferenceKey){var c=Travian.Game.Preferences.get(this.options.savePositionForSession.preferenceKey);if(c!==null){c=JSON.parse(c);this.options.savePositionForSession.position=c.position}}let buttonTemplate=jQuery(Travian.Templates["ButtonV"+this.options.version]);let dialogTemplate=jQuery(Travian.Templates["DialogV"+this.options.version]);if(buttonTemplate.length<=0||dialogTemplate.length<=0){throw ("Dialog.js: Unable to load required template(s).")}buttonTemplate.addClass("green dialogButtonOk ok textButtonV"+this.options.version);buttonTemplate.attr("type","submit");if(this.options.version===2){buttonTemplate.addClass("buttonFramed withText rectangle")}this.overlay=dialogTemplate;if($this.options.enableBackground){this.overlay.addClass("enabled");if($this.options.darkOverlay){this.overlay.addClass("dark")
}if($this.options.overlayCancel){this.overlay.on("click",function(d){if(d.target.classList.contains("dialogOverlay")){$this.close(Travian.Dialog.CLOSE_CONTEXT_OVERLAYBACKGROUND)}})}}this.wrapper=this.overlay.find(".dialogWrapper");if(typeof this.options.context!=="undefined"){this.wrapper.attr("data-context",this.options.context)}if(this.options.cssClass===null&&this.options.version===2){this.options.cssClass="plain"}this.wrapper.find(".dialog").addClass(this.options.cssClass);this.wrapper.find(".buttons").append(buttonTemplate);body.prepend(this.overlay);jQuery(window).on("resize scroll",function(){$this.updatePosition(200,true)});this.content=this.wrapper.find("div#dialogContent");this.title=this.wrapper.find("div.title");this.setTitle(this.options.title);this.elementContents=this.wrapper.find("div.dialogContents");this.infoButton=this.wrapper.find("div.info");this.dialogDragbar=this.wrapper.find("div.dialogDragBar");if(this.options.infoIcon){this.setInfoIcon(this.options.infoIcon)}else{this.infoButton.hide()
}if(this.options.draggable){this.wrapper.addClass("dragWrapper");new Travian.Moveable(this.wrapper,{droppables:this.title,handle:this.dialogDragbar,onDrop:function(e){var d=jQuery(e).position();$this.options.dragPosition=$this.correctDialogPosition(d);if($this.options.savePositionForSession.preferenceKey!==null){$this.options.savePositionForSession.position=$this.correctDialogPosition(d)}},onDrag:function(e){var d=jQuery(e);d.css($this.correctDialogPosition(d.position()));$this.options.onDrag($this)}});this.title.css("drag")}if(this.options.draggable){this.wrapper.on("mousedown touchdown",function(){$this.bringToFront()})}this.form=this.wrapper.find("form").on("submit",function(d){if($this.form.disabled){d.stopPropagation();return false}$this.disableForm();$this.options.onOkay($this,$this.content);if($this.options.keepOpen===false){$this.close(Travian.Dialog.CLOSE_CONTEXT_FORMSUBMIT)}if($this.options.preventFormSubmit){d.stopPropagation();return false}});this.form.disabled=false;if(this.options.submitMethod){this.form.attr("method",this.options.submitMethod)
}if(this.options.submitUrl){this.form.attr("action",this.options.submitUrl)}this.buttonOk=this.wrapper.find("button.ok");if(this.options.buttonOk===false){this.buttonOk.closest(".buttons").hide()}else{let buttonContentDiv=this.buttonOk.find("div");if(buttonContentDiv.length>0){buttonContentDiv.html(this.options.buttonTextOk)}else{this.buttonOk.html(this.options.buttonTextOk)}Travian.Tip.set(this.buttonOk,this.options.buttonTextOk)}if(this.options.buttonCloseOnClickOk){this.buttonOk.click(function(d){d.preventDefault();$this.close(Travian.Dialog.CLOSE_CONTEXT_CLOSEONCLICKOK)})}this.buttonCancel=this.wrapper.find(".dialogCancelButton");if(this.options.buttonCancel===false){this.buttonCancel.hide()}else{this.buttonCancel.on("click",function(){$this.close(Travian.Dialog.CLOSE_CONTEXT_CANCELBUTTON)})}this.bringToFront()};this.updateInfoButton=function(c){this.options=Object.assign(this.options,c);if(this.options.infoIcon){this.setInfoIcon(this.options.infoIcon)}else{this.infoButton.hide()}return this
};this.displayButtonOk=function(c){if(typeof c==="undefined"||c===null||c===true){this.buttonOk.closest(".buttons").show();this.buttonOk.show()}else{this.buttonOk.hide()}};this.setContent=function(c){this.content.empty();this.content.append(c);this.updatePosition();Travian.Tip.updateAllInElement(this.wrapper);jQuery(window).trigger("domAltered",this.wrapper);return this};this.setTitle=function(c){this.options.title=c;this.title.html(this.options.title);if(!this.options.title){this.title.hide()}return this};this.calculatePosition=function(){let w=jQuery(window);let scroll={x:w.scrollLeft(),y:w.scrollTop()};let body=jQuery("body");let viewportSize={width:window.outerWidth,height:window.outerHeight};if(window.innerWidth>window.outerWidth){viewportSize.width=window.innerWidth}if(window.innerHeight>window.outerHeight){viewportSize.height=window.innerHeight}let elementSize={width:this.wrapper.width(),height:this.wrapper.height()};let relativeElement=jQuery(this.options.relativeTo);if(relativeElement.length<=0){relativeElement=body
}let sizeRelative={x:relativeElement.width(),y:relativeElement.height()};let positionRelative={x:relativeElement.offset().left,y:relativeElement.offset().top};positionRelative.x=this.checkValue(positionRelative.x);positionRelative.y=this.checkValue(positionRelative.y);let position={left:positionRelative.x+sizeRelative.x/2-elementSize.width/2-scroll.x,top:positionRelative.y+sizeRelative.y/2-elementSize.height/2-scroll.y};if(position.top+elementSize.height>viewportSize.height){position.top=viewportSize.height-elementSize.height}position.left=this.checkValue(position.left,5);position.top=this.checkValue(position.top,40);if(position.left+elementSize.width>viewportSize.width){position.left=viewportSize.width-elementSize.width}if(position.left<0){position.left=0}return position};this.checkValue=function(d,c){return(d<0)?(c||0):d};this.updatePosition=function(d,c){if(this.options.draggable||this.options.relativeTo!==null){let body=jQuery("body");if(body.hasClass("ie")){this.wrapper.addClass("iePositionException")
}if(this.options.savePositionForSession.preferenceKey&&this.options.savePositionForSession.position&&(typeof c==="undefined"||!c)){this.setPosition(this.options.savePositionForSession.position)}else{if(this.options.dragPosition&&typeof this.options.dragPosition.x!=="undefined"&&typeof this.options.dragPosition.y!=="undefined"){this.setPosition(this.options.dragPosition)}else{let position=this.calculatePosition();this.setPosition({x:position.left,y:position.top},d)}}}};this.hide=function(){this.overlay.hide()};this.unhide=function(){this.overlay.show()};this.dispose=function(){if(this.options.useEscKey){jQuery("body").off(".dialog")}if(typeof Travian.WindowManager!=="undefined"){Travian.WindowManager.unregister(this)}jQuery(this.overlay).remove();this.overlay=null};this.toElement=function(){return this.wrapper};this.setPosition=function(c,d){this.wrapper.css({left:c.x,top:c.y});return c};this.bringToFront=function(){if(typeof Travian.WindowManager==="undefined"){return false}if(Travian.WindowManager.getCurrentZIndex()===parseInt(this.wrapper.css("zIndex"))){return false
}var c=Travian.WindowManager.getZIndex();this.wrapper.css({zIndex:c});if(this.overlay.length>0){this.overlay.css({zIndex:(c-5)})}};this.setInfoIcon=function(c){if(c){this.options.infoIcon=c;var d=this;this.infoButton.off("click");this.infoButton.show();this.infoButton.on("click",function(){if(typeof d.options.infoIcon==="string"){return window.open(d.options.infoIcon,"_blank")}if(typeof d.options.infoIcon==="function"){return d.options.infoIcon()}});if(this.options.buttonTextInfo){Travian.Tip.set(this.infoButton,this.options.buttonTextInfo)}}else{this.infoButton.hide()}return this};this.updateCssClass=function(c){if(c){var g=this.options.cssClass.split(" ");var f=this.wrapper.find("div.dialog");if(f){for(var e=0;e<g.length;e++){f.removeClass(g[e])}this.options.cssClass=c;var h=(c).split(" ");for(var d=0;d<h.length;d++){if(h[d]!==""){f.addClass(h[d])}}}}return this};this.makeInputAmountable=function(e,c,h){var g=c||Number.MAX_VALUE;var f=function(m,k,o){m=jQuery(m);var n=k||Number.MAX_VALUE;
var l=parseInt(m.val())||0;var j=Math.max(0,Math.min(l,n));m.val(j);if(o){o(j)}};var d=function(j,l,k){if(j===8||j===46||(j===65&&(l===true||k===true))||(j===67&&(l===true||k===true))||(j===88&&(l===true||k===true))||(j===86&&(l===true||k===true))||(j>=35&&j<=39)){return true}return(((j>=48&&j<=57)||(j>=96&&j<=105)))};jQuery(e).on({keydown:function(j){if(!d(j.keyCode,j.ctrlKey,j.metaKey)){j.preventDefault()}},keyup:function(){f(this,g,h)},paste:function(){f(this,g,h)},change:function(){f(this,g,h)},blur:function(){f(this,g,h)},input:function(){f(this,g,h)}})};Object.assign(this.options,b);this.animateFunction=this.options.fx.duration===0?function(e,c,d,f){e.css(c);if(typeof f==="function"){f()}}:function(d,c,f,e){d.animate(c,f,e)};this.options.relativeTo=this.options.relativeTo||null;if(this.options.relativeTo!==null){this.options.relativeTo=jQuery(this.options.relativeTo)}if(this.options.buttonTextOk===null){this.options.buttonTextOk=Travian.Translation.get("allgemein.ok")}this.render();
if(typeof Travian.WindowManager!=="undefined"){Travian.WindowManager.register(this)}};Travian.Dialog.Dialog.prototype.reload=Travian.emptyFunction;Travian.Dialog.Dialog.prototype.show=function(){var b=this;this.open=true;this.updatePosition();this.overlay.addClass("dialogVisible");setTimeout(function(){b.options.onOpen(b,b.content);var c=jQuery(b.options.elementFocus);if(c.length>0){c.focus()}},b.options.fx.duration);if(this.options.useEscKey){jQuery("body").one("keyup.dialog",function(c){if(c.keyCode===27){b.close(Travian.Dialog.CLOSE_CONTEXT_CLOSEONESCKEY)}})}Travian.TabManager.initializeOnDialogLoad();Travian.Tip.hide();return this};Travian.Dialog.Dialog.prototype.close=function(b){var c=this;this.open=false;this.options.onClose(this,this.content);if(this.overlay&&this.overlay.length>0){this.overlay.removeClass("dialogVisible")}setTimeout(function(){c.dispose()},c.options.fx.duration);if(this.options.savePositionForSession.preferenceKey&&this.options.savePositionForSession.position){Travian.Game.Preferences.set(this.options.savePositionForSession.preferenceKey,JSON.stringify(this.options.savePositionForSession))
}Travian.Tip.hide();this.options.afterClose();return this};Travian.Dialog.Confirmation=function(c){this.options=Object.assign({onConfirm:Travian.emptyFunction,onCancel:function(){Travian.WindowManager.closeByContext("confirmationDialog")},message:"",confirmText:"",cancelText:"",confirmClass:"green",cancelClass:"grey",buttonCancel:false,buttonOk:false,cssClass:"white confirmationDialog",context:"confirmationDialog"},c);var e=jQuery('<div class="confirmationDialog"></div>').append('<div class="message">'+this.options.message+"</div>").append('<div class="buttons"></div>');if(typeof Travian.Templates.ButtonV1!=="undefined"){var d=jQuery(Travian.Templates.ButtonV1);d.addClass("textButtonV1 "+this.options.confirmClass);d.attr("type","button");d.on("click",this.options.onConfirm);d.html(this.options.confirmText);var f=jQuery(Travian.Templates.ButtonV1);f.addClass("textButtonV1 "+this.options.cancelClass);f.attr("type","button");f.on("click",this.options.onCancel);f.html(this.options.cancelText);
e.find(".buttons").append(f).append(d)}var b=new Travian.Dialog.Dialog(this.options);return b.setContent(e)};Travian.WindowManager={windows:[],currentZIndex:6000,zIndexMaxValue:9900,width:630,height:460,register:function(b){if(typeof b.options.context==="undefined"){b.options.context="noContext"}b.identifier=this.__createIdentifier();this.windows.push(b);return b},unregister:function(b){this.windows=this.windows.filter(function(c){return c!==b})},closeWindow:function(b){b.close()},hideWindow:function(b){b.hide()},showWindow:function(b){b.unhide()},hideByContext:function(b){var c=this;this.eachWindow(function(d){if(!c.checkContext(b,d)){return false}c.hideWindow(d)})},showByContext:function(b){var c=this;this.eachWindow(function(d){if(!c.checkContext(b,d)){return false}c.showWindow(d)})},closeByContext:function(b){var c=this;this.eachWindow(function(d){if(!c.checkContext(b,d)){return false}c.closeWindow(d)})},getWindowsByContext:function(b){var d=this;var c=[];this.eachWindow(function(e){if(!d.checkContext(b,e)){return false
}c.push(e)});return c},checkContext:function(c,b){if(typeof b.options.context!=="undefined"){if(b.options.context===c){return true}}return false},eachWindow:function(c){for(var b=0;b<this.windows.length;b++){c(this.windows[b])}},getWindows:function(){return this.windows},reloadWindow:function(b){b.reload()},reloadWindowsByContext:function(b){var c=this;this.eachWindow(function(d){if(!c.checkContext(b,d)){return false}c.reloadWindow(d)})},__createIdentifier:function(){return this.windows.length},cleanupZIndex:function(){var b=0;this.eachWindow(function(d){var e=jQuery(d).css("zIndex");var c=(e-3000);if(c>b){b=c}jQuery(d).css({zIndex:c})});this.currentZIndex=b},getZIndex:function(){if(this.currentZIndex>=this.zIndexMaxValue){this.cleanupZIndex()}this.currentZIndex+=10;return this.currentZIndex},getCurrentZIndex:function(){return this.currentZIndex},checkOpenWindowByContext:function(b){var d=false;var c=this;this.eachWindow(function(e){if(c.checkContext(b,e)){d=true}});return d},getWindowDimensions:function(){var b=Travian.WindowManager.width,c=Travian.WindowManager.height;
if(document.body&&document.body.offsetWidth){b=document.body.offsetWidth;c=document.body.offsetHeight}if(document.compatMode==="CSS1Compat"&&document.documentElement&&document.documentElement.offsetWidth){b=document.documentElement.offsetWidth;c=document.documentElement.offsetHeight}if(window.innerWidth&&window.innerHeight){b=window.innerWidth;c=window.innerHeight}return{width:b,height:c}},closeAllWindows:function(){var b=this;this.eachWindow(function(c){b.closeWindow(c)})},storeDocumentSize:function(){var b=jQuery(document);Travian.WindowManager.width=b.width();Travian.WindowManager.height=b.height()}};jQuery(Travian.WindowManager.storeDocumentSize);jQuery(window).on("resize",Travian.WindowManager.storeDocumentSize);Travian.Dialog.Ajax=function(c,b){Travian.Dialog.Dialog.call(this,b);this.cmd=c;this.request()};Travian.Dialog.Ajax.prototype=Object.create(Travian.Dialog.Dialog.prototype);Travian.Dialog.Ajax.constructor=Travian.Dialog.Ajax;Travian.Dialog.Ajax.prototype.reload=function(){this.request()
};Travian.Dialog.Ajax.prototype.request=function(){var b=this;Travian.api(this.cmd,{data:this.options.data,success:function(c){if(c.html!==""){b.setContent(c.html).setTitle(c.title).setInfoIcon(c.infoIcon).updateCssClass(c.cssClass).show()}else{b.close()}}});return this};Travian.Dialog.Api=function(b){Travian.Dialog.Dialog.call(this,b);this.request()};Travian.Dialog.Api.prototype=Object.create(Travian.Dialog.Dialog.prototype);Travian.Dialog.Api.constructor=Travian.Dialog.Api;Travian.Dialog.Api.prototype.reload=function(){this.request()};Travian.Dialog.Api.prototype.request=function(){var b=this;Travian.api(this.options.call,{data:this.options.data,success:function(c){if(c.html!==""){b.setContent(c.html).setTitle(c.title).setInfoIcon(c.infoIcon).updateCssClass(c.cssClass).show()}else{b.close()}}},this.options.method);return this};var Digitarald={AutoCompleter:function(c,b){this.selected=null;this.options={minLength:1,markQuery:true,width:"inherit",maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:true,className:"autocompleter-choices",zIndex:42,delay:400,observerOptions:{},autoSubmit:false,overflow:false,overflowMargin:25,selectFirst:false,filter:null,filterCase:false,filterSubset:false,forceSelect:false,selectMode:true,choicesMatch:null,multiple:false,separator:", ",separatorSplit:/\s*[,;]\s*/,autoTrim:false,allowDupes:false,fx:{open:{opacity:1},close:{opacity:0},duration:200},fxFunc:function(g,f,j,h){g.animate(f,j,h)
}};this.arrayUnique=function(f){return f.reduce(function(g,h){if(g.indexOf(h)<0){g.push(h)}return g},[])};this.destroy=function(){this.choices=this.selected=this.choices.destroy()};this.onCommand=function(j){if(!j){return this.prefetch()}var h=j.keyCode||j.which;if(j&&!j.shiftKey&&h){switch(h){case 13:if(this.element.val()!==this.opted){return true}if(this.selected&&this.visible){this.choiceSelect(this.selected);return this.options.autoSubmit}break;case 38:case 40:if(!this.prefetch()&&this.queryValue!==null){var f=(h===38);var g=this.selected?(f?"prev":"next"):(f?"last":"first");this.choiceOver((this.selected||this.choices.find("li"))[g](this.options.choicesMatch),true)}return false;case 27:case 9:this.hideChoices(true);break}}return true};this.selectRange=function(h,l,f){if(h.setSelectionRange){h.focus();h.setSelectionRange(l,f)}else{var j=h.get("data-value");var k=j.substr(l,f-l).replace(/\r/g,"").length;l=j.substr(0,l).replace(/\r/g,"").length;var g=h.createTextRange();g.collapse(true);
g.moveEnd("character",l+k);g.moveStart("character",l);g.select()}return this};this.setSelection=function(l){var m=this.selected.attr("data-value"),n=m;var f=this.searchFor.length,h=m.length;if(m.substr(0,f).toLowerCase()!==this.searchFor.toLowerCase()){f=0}if(this.options.multiple){var k=this.options.separatorSplit;n=this.element.val();f+=this.queryIndex;h+=this.queryIndex;var g=n.substr(this.queryIndex).split(k,1)[0];n=n.substr(0,this.queryIndex)+m+n.substr(this.queryIndex+g.length);if(l){var j=n.split(this.options.separatorSplit).filter(function(p){return this.test(p)},/[^\s,]+/);if(!this.options.allowDupes){j=this.arrayUnique(j)}var o=this.options.separator;n=j.join(o)+o;h=n.length}}this.observer.setValue(n);this.opted=n;if(l||this.selectMode==="pick"){f=h}this.selectRange(this.element[0],f,h)};this.showChoices=function(){var j=this.options.choicesMatch,m=this.choices.children("li[value='"+j+"']").first();this.selected=this.selectedValue=null;if(!m){return}if(!this.visible){this.visible=true;
this.choices.css({display:"inherit"});this.options.fxFunc(this.choices,this.options.fx.open,this.options.fx.duration)}if(this.options.selectFirst||this.typeAhead||m.inputValue===this.searchFor){this.choiceOver(m,this.typeAhead)}var h=this.choices.children("li[value='"+j+"']"),g=this.options.maxChoices;var k={overflowY:"hidden",height:""};this.overflown=false;if(h.length>g){k.overflowY="scroll";k.height=this.choices.offset().top-h[g].offset().top;this.overflown=true}if(this.options.visibleChoices){var l=this.element.offset();var f=this.element.outerHeight();k.left=l.left;k.top=l.top+f}this.choices.css(k)};this.hideChoices=function(f){if(f){var h=this.element.val();if(this.options.forceSelect){h=this.opted}if(this.options.autoTrim){h=h.split(this.options.separatorSplit).filter(function(j){return j}).join(this.options.separator)}this.observer.setValue(h)}if(!this.visible){return}this.visible=false;if(this.selected){this.selected.removeClass("autocompleter-selected")}this.observer.clear();var g=function(){this.choices.css({display:"none"})
}.bind(this);this.options.fxFunc(this.choices,this.options.fx.open,this.options.fx.duration,g)};this.prefetch=function(){var l=this.element.val(),k=l,j=l;if(this.options.multiple){var g=this.options.separatorSplit;var f=this.element[0].selectionStart;var m=l.substr(0,f).split(g);var h=m.length-1;f-=m[h].length;k=m;j=m[h].toLowerCase()}if(j.length<this.options.minLength){this.hideChoices()}else{if(j===this.searchFor||(this.visible&&k===this.selectedValue)){if(this.visible){return false}this.showChoices()}else{this.searchFor=j;this.queryValue=k;this.queryIndex=f;this.query(this.queryValue)}}return true};this.update=function(l){this.choices.empty();var j=l&&typeof l;if(j==="object"&&!l.length){(this.options.emptyChoices||this.hideChoices).call(this)}else{if(this.options.maxChoices<l.length&&!this.options.overflow){l.length=this.options.maxChoices}for(var h=0;h<l.length;h++){var g=l[h];if(this.options.injectChoice){this.options.injectChoice(g)}else{var k=this.markQueryValue(g);var f=jQuery("<li></li>").attr("data-value",g).html(k);
this.addChoiceEvents(f).appendTo(this.choices)}}this.showChoices()}};this.choiceOver=function(h,j){if(!h||h.length===0||h===this.selected){return}if(this.selected){this.selected.removeClass("autocompleter-selected")}this.selected=h.addClass("autocompleter-selected");if(!this.selectMode){this.opted=this.element.val()}if(!j){return}this.selectedValue=this.selected.attr("data-value");if(this.overflown){var l=this.selected.position(),k=this.options.overflowMargin,m=this.choices.scrollTop,f=this.choices.offsetHeight,g=m+f;if(l.top-k<m&&m){this.choices.scrollTop=Math.max(l.top-k,0)}else{if(l.bottom+k>g){this.choices.scrollTop=Math.min(l.bottom-f+k,g)}}}if(this.selectMode){this.setSelection()}};this.choiceSelect=function(f){if(f&&f.length>0){this.choiceOver(f)}this.setSelection(true);this.searchFor=false;this.hideChoices()};this.escapeRegExp=function(f){return String(f).replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")};this.filter=function(f){return(f||this.tokens).filter(function(g){return this.test(g)
},new RegExp(((this.options.filterSubset)?"":"^")+this.escapeRegExp(this.searchFor),(this.options.filterCase)?"":"i"))};this.markQueryValue=function(f){return(!this.options.markQuery||!this.searchFor)?f:f.replace(new RegExp("("+((this.options.filterSubset)?"":"^")+this.escapeRegExp(this.searchFor)+")",(this.options.filterCase)?"":"i"),'<span class="autocompleter-queried">$1</span>')};this.addChoiceEvents=function(f){return f.on({mouseover:this.choiceOver.bind(this,f),click:this.choiceSelect.bind(this,f)})};this.Observer=function(h,f,g){this.delay=g||1000;this.timeout=null;this.equals=function(k,j){return(k===j||JSON.stringify(k)===JSON.stringify(j))};this.changed=function(){var j=this.element.val();if(this.equals(this.value,j)){return}this.clear();this.value=j;this.timeout=setTimeout(this.onFired,this.delay,[this.value,this.element])};this.setValue=function(j){this.value=j;this.element.val(j);this.element.trigger("change");return this.clear()};this.clear=function(){clearTimeout(this.timeout);
return this};this.element=h;this.onFired=f;this.value=this.element.get("data-value");this.element.on("keyup",this.changed.bind(this))};Object.assign(this.options,b);var d=jQuery(this.options.customChoices);this.choices=d.length>0?d:jQuery("<ul></ul>").addClass(this.options.className).css({zIndex:this.options.zIndex,display:"none"}).appendTo("body");this.element=c.prop("autocomplete","off").on("keydown",this.onCommand.bind(this)).on("click",this.onCommand.bind(this,false)).on("focusout",this.hideChoices.bind(this,true));this.observer=new this.Observer(this.element,this.prefetch.bind(this),this.options.delay);this.searchFor=null;this.queryValue=null;if(this.options.filter){this.filter=this.options.filter.bind(this)}var e=this.options.selectMode;this.typeAhead=(e==="type-ahead");this.selectMode=(e===true)?"selection":e}};Digitarald.AutoCompleter.prototype.query=function(b){};Travian.DoubleClickPreventer=function(){this.prevent=false;this.timeout=400;this.timerId=0;this.check=function(){if(this.prevent){return false
}this.prevent=true;var b=this;this.timerId=setTimeout(function(){b.prevent=false},this.timeout);return true};this.cancelTimer=function(){if(this.timerId){clearTimeout(this.timerId);this.timerId=0;this.prevent=false}}};Travian.DoubleClickPreventer.globalPrevent=false;Travian.DoubleClickPreventer.globalTimeout=400;Travian.DoubleClickPreventer.globalCheck=function(){var b=Travian.DoubleClickPreventer.prevent;if(b===false){Travian.DoubleClickPreventer.prevent=true;Travian.DoubleClickPreventer.timer=setTimeout(function(){Travian.DoubleClickPreventer.prevent=false},Travian.DoubleClickPreventer.timeout)}return !b};Travian.Form=function(){this.elements={};this.addElement=function(b,c){c.setName(b);this.elements[b]=c;return this};this.addInputElementByName=function(b,d){var c=Travian.Form.Element.Input.createElementByName(this,b,d);this.addElement(b,c);return this};this.onElementChanged=function(c){var d=c.isDirty();if(d===false){var b;for(b in this.elements){if(this.elements[b].isDirty()){d=true;
break}}}this.onDirty(d);return this}};Travian.Form.prototype.onClick=function(b){return this};Travian.Form.prototype.onDirty=function(b){return this};Travian.Form.UnloadHelper=Object.create({formQueryString:"input, textarea, select",message:null,identifierCount:0,htmlForms:{},formStates:{},initialize:function(){},isEnabled:function(){var c;for(c in this.formStates){if(this.formStates[c]){return true}}for(c in this.htmlForms){var d=jQuery("#"+c);if(d===null){delete this.htmlForms[c];continue}var b=this.htmlForms[c];var e=this.generateFormHash(d);if(b!==e){return true}}return false},enableSecurity:function(b){if(b===null){b=this.getIdentifier()}this.formStates[b]=true;return b},disableSecurity:function(b){this.formStates[b]=false},getIdentifier:function(){this.identifierCount++;return this.identifierCount},generateFormHash:function(c){var b="";c.find(this.formQueryString).each(function(){var e=jQuery(this);var d=e.prop("tagName").toLowerCase();var g=e.attr("type");if(typeof g==="string"){g=g.toLowerCase()
}switch(true){case d==="input"&&(g==="checkbox"||g==="radio"):b+=e.is(":checked");break;case d==="input"||d==="textarea":b+=e.val();break;case d==="select":var f=e.find("option:selected");if(f.length>0){b+=f.prop("value")}break}});return jQuery.md5(b)},watchHtmlForm:function(b){var c=this;b.delegate(this.formQueryString,"change keyup",function(){c.updateSubmitButtons(b)});this.htmlForms[b.attr("id")]=this.generateFormHash(b);b.on("submit",function(){c.htmlForms[b.attr("id")]=c.generateFormHash(b)});this.updateSubmitButtons(b)},unwatchHtmlForm:function(b){delete this.htmlForms[b.attr("id")]},updateSubmitButtons:function(c){var d=this;var b=(d.htmlForms[c.attr("id")]===d.generateFormHash(c));c.find("input[type=submit], button[type=submit]").each(function(){jQuery(this).toggleClass("disabled",b)[0].disabled=b})}});Travian.Form.UnloadHelper.initialize();Travian.Form.Element=function(b){this.form=null;this.name=null;this.initialize=function(c){this.form=c};this.onClick=function(){this.form.onClick(this);
return this};this.setForm=function(c){this.form=c;return this};this.setName=function(c){this.name=c;return this};this.getName=function(){return this.name};this.initialize(b)};Travian.Form.Element.prototype.onChange=function(){this.form.onElementChanged(this);return this};Travian.Form.Element.prototype.isDirty=function(){return false};Travian.Form.Element.Input=function(c,b){this.originalValue=null;this.currentValue=null;this.type=null;this.element=null;this.initialize=function(e,d){Travian.Form.Element.call(this,e);this.element=d;this.originalValue=this.currentValue=this.getValue();this.initEvents()};this.getInput=function(){return this.element};this.onChange=function(){this.currentValue=this.getValue();Travian.Form.Element.prototype.onChange.call(this);return this};this.isDirty=function(){return this.originalValue!==this.currentValue};this.initialize(c,b)};Travian.Form.Element.Input.prototype=Object.create(Travian.Form.Element.prototype);Travian.Form.Element.Input.constructor=Travian.Form.Element.Input;
Travian.Form.Element.Input.createElementByName=function(e,b,d){var g=null;if(typeof d==="undefined"){d=jQuery(document)}var f=d.find('[name="'+b+'"]');if(f.length===0){throw new Error('Element with name "'+b+'" not found.')}var c=jQuery(f[0]);switch(c.prop("tagName").toLowerCase()){case"input":g=c.attr("type");if(g==="radio"||g==="checkbox"){c=f}break;default:g=c.get(0).nodeName.toLowerCase();break}g=g.charAt(0).toUpperCase()+g.slice(1).toLowerCase();if(!Travian.Form.Element.Input[g]){throw new Error('Element type "'+g+'" not yet implemented!')}return new Travian.Form.Element.Input[g](e,c)};Travian.Form.Element.Input.prototype.initEvents=function(){var b=this;this.element.on("change",function(){b.onChange()});return this};Travian.Form.Element.Input.prototype.getValue=function(){return this.element.val()};Travian.Form.Element.Input.Button=function(c,b){this.initEvents=function(){var d=this;this.element.on("click",function(){d.onClick()});return this};this.getValue=function(){return null};
Travian.Form.Element.Input.call(this,c,b)};Travian.Form.Element.Input.Button.prototype=Object.create(Travian.Form.Element.Input.prototype);Travian.Form.Element.Input.Button.constructor=Travian.Form.Element.Input.Button;Travian.Form.Element.Input.Checkbox=function(c,b){this.valueBefore=null;this.initEvents=function(){var d=this;this.valueBefore=this.getValue();this.element.on("click",function(){if(d.getValue()!==d.valueBefore){d.valueBefore=d.getValue();d.onChange()}});return this};this.getValue=function(){var d=null;if(this.element.length>0){this.element.each(function(f,g){var e=jQuery(g);if(e.is(":checked")){d=e.val()}})}return d};Travian.Form.Element.Input.call(this,c,b)};Travian.Form.Element.Input.Checkbox.prototype=Object.create(Travian.Form.Element.Input.prototype);Travian.Form.Element.Input.Checkbox.constructor=Travian.Form.Element.Input.Checkbox;Travian.Form.Element.Input.Radio=function(c,b){this.valueBefore=null;this.initEvents=function(){var d=this;this.valueBefore=this.getValue();
this.element.on("click",function(){if(d.getValue()!==d.valueBefore){d.valueBefore=d.getValue();d.onChange()}});return this};this.getValue=function(){var d=null;if(this.element.length>0){this.element.each(function(f,g){var e=jQuery(g);if(e.is(":checked")){d=e.val()}})}return d};Travian.Form.Element.Input.call(this,c,b)};Travian.Form.Element.Input.Radio.prototype=Object.create(Travian.Form.Element.Input.prototype);Travian.Form.Element.Input.Radio.constructor=Travian.Form.Element.Input.Radio;Travian.Form.Element.Input.Text=function(c,b){Travian.Form.Element.Input.call(this,c,b)};Travian.Form.Element.Input.Text.prototype=Object.create(Travian.Form.Element.Input.prototype);Travian.Form.Element.Input.Text.constructor=Travian.Form.Element.Input.Text;Travian.Form.Element.Input.Textarea=function(c,b){Travian.Form.Element.Input.call(this,c,b)};Travian.Form.Element.Input.Textarea.prototype=Object.create(Travian.Form.Element.Input.prototype);Travian.Form.Element.Input.Textarea.constructor=Travian.Form.Element.Input.Textarea;
Travian.Formatter=function(b){this.options=Object.assign({languageKey:"de-DE",formatType:"type3",decimalSeperator:",",forceDecimal:true,showDecimalsIfThereAny:false,minusCharacter:"\u2212"},b);this.getFormattedNumber=function(e,h){if(isNaN(e)||e===undefined||e===null||e===""){return 0}if(parseInt(e)!==e){e=String(parseFloat(e))}else{e=String(parseFloat(e))+".0"}var g=e.match(/([\d.,\s-]*?)[.,]?(\d*)?$/);var j={left:g[1],right:g[2]};j.left=j.left.replace(/[\s,.'"]*/g,"");var d=false;if(j.left<0){d=true}j.left=j.left.replace(/[-]*/g,"");var f=0;if(this.typeFunctions[this.options.formatType]===undefined){throw"Der Zahlenformattyp"+this.options.formatType+"ist unbekannt!"}f=this.typeFunctions[this.options.formatType].createNumberFunction(j,this.options);if(d===true){f=this.options.minusCharacter+f}if(h!==undefined&&h.hasOwnProperty("unit")){switch(h.unit){case"percent":f=f+"%";break}}return f};this.setOptionLanguageKey=function(d){var e=this.getDefinitionByLanguage(d);if(e!==false){this.options.formatType=e.type;
this.options.decimalSeperator=e.decimalSeperator;return true}return false};this.getAvailableTypes=function(){var d=[];Object.each(this.typeFunctions,function(f,e){d.push(e)});return d};this.removeNonDigits=function(d){var e=d.match(/\d/g);e=parseInt(e.join(""));return e};this.getDefinitionByLanguage=function(h){var g=this;var f=false;for(var d in this.languageDefinitions){var e=this.languageDefinitions[d];if(e.languages.indexOf(h)!==-1){f=g.languageDefinitions[d];break}}return f};this.languageDefinitions={1:{decimalSeperator:",",type:"type1",languages:["bg-BG","cs-CZ","et-EE","fi-FI","fr-FR","hu-HU","lt-LT","lv-LV","pl-PL","pt-PT","ru-RU","sk-SK","sv-SE","uk-UA"]},2:{decimalSeperator:".",type:"type2",languages:["bs-BA-Latn","en-US","ja-JP","ms-MY","th-TH","com"]},3:{decimalSeperator:",",type:"type3",languages:["ar-AE","da-DK","de-DE","el-GR","es-CL","es-ES","he-IL","hr-HR","id-ID","it-IT","nl-NL","no-NO","pt-BR","ro-RO","sl-SI","sr-RS-Cyrl","tr-TR","vi-VN"]},4:{decimalSeperator:".",type:"type4",languages:["in"]}};
this.typeFunctions={type1:{createNumberFunction:function(h,e){var d="";var g=h.left.split("").reverse().join("");for(var f=0;f<=(g.length-1);f++){if(f%3===0&&f!==0){d+=","}d+=g.charAt(f)}d=d.split("").reverse().join("");if(h.right!==undefined&&e.forceDecimal===true){d+=","+h.right}else{if(h.right!==undefined&&e.showDecimalsIfThereAny===true&&h.right!=="0"){d+=","+h.right}}return d}},type2:{createNumberFunction:function(h,e){var d="";var g=h.left.split("").reverse().join("");for(var f=0;f<=(g.length-1);f++){if(f%3===0&&f!==0){d+=","}d+=g.charAt(f)}d=d.split("").reverse().join("");if(h.right!==undefined&&e.forceDecimal===true){d+="."+h.right}else{if(h.right!==undefined&&e.showDecimalsIfThereAny===true&&h.right!=="0"){d+="."+h.right}}return d}},type3:{createNumberFunction:function(h,e){var d="";var g=h.left.split("").reverse().join("");for(var f=0;f<=(g.length-1);f++){if(f%3===0&&f!==0){d+="."}d+=g.charAt(f)}d=d.split("").reverse().join("");if(h.right!==undefined&&e.forceDecimal===true){d+=","+h.right
}else{if(h.right!==undefined&&e.showDecimalsIfThereAny===true&&h.right!=="0"){d+=","+h.right}}return d}},type4:{createNumberFunction:function(l,f){var e="";var k=3;var h=l.left.split("").reverse().join("");var d=0;for(var g=0;g<=(h.length-1);g++){if(d%k===0&&d!==0){e+=",";k=2;d=0}e+=h.charAt(g);d++}e=e.split("").reverse().join("");if(l.right!==undefined&&f.forceDecimal===true){e+="."+l.right}else{if(l.right!==undefined&&f.showDecimalsIfThereAny===true&&l.right!=="0"){e+="."+l.right}}return e}},seperatorless:{createNumberFunction:function(f,e){var d=f.left;if(f.right!==undefined&&e.forceDecimal===false){d+=e.decimalSeperator+f.right}return d}},toInt:{createNumberFunction:function(e,d){return e.left}},toIntRounded:{createNumberFunction:function(f,e){if(f.right===undefined){return f.left}var d=f.left+"."+f.right;return(Number.convert(d)).round()}}};if(b===undefined||b.languageKey===undefined){this.options.languageKey=Travian.Game.language}if(this.options.languageKey!==undefined){var c=this.getDefinitionByLanguage(this.options.languageKey);
if(c!==false){this.options.formatType=c.type;this.options.decimalSeperator=c.decimalSeperator}}};Travian.Formatter.Filter={aNumber:function(b){if(!b.value.match(/^[0-9\-\.,]+$/)){b.value=b.value.replace(/[^0-9\-\.,]/g,"")}}};Travian.Seasons=Object.create({currentSeason:null,setState:function(d){var b=jQuery("body");var c=Travian.Seasons.currentSeason.cssClassName;b.find("span.pleaseSaveYourChanges").removeClass("hidden");d?b.addClass(c):b.removeClass(c);Travian.Seasons.currentSeason.setState(d)}});Travian.Seasons.Season=function(){};Travian.Seasons.Season.prototype.cssClassName="";Travian.Seasons.Season.prototype.setState=function(b){};Travian.Seasons.Season.prototype.restart=function(b){};Travian.Seasons.Season.prototype.setPreferences=function(b){return b};Travian.Seasons.currentSeason=new Travian.Seasons.Season();Travian.Seasons.Winter=function(){this.cssClassName="season-winter";this.snowSettings={enabled:false,maxFlakes:250,maxFlakeRadius:3,maxDensity:25,screenWidth:0,screenHeight:0,moveToBackground:true};
this.snowFlakes=[];this.context=null;this.wind=0;this.animationFrame=null;this.animationTime=0;this.restarting=false;this.bodyWrapperHeight=0;this.updateState=function(){var f=jQuery("body");var k=jQuery(document);this.bodyWrapperHeight=jQuery("#bodyWrapper").height();var g=(!f.hasClass("ie")||f.hasClass("ie11"));if(this.snowSettings.enabled&&g){this.snowSettings.screenWidth=k.width();this.snowSettings.screenHeight=k.height();var h=(this.snowSettings.moveToBackground?"movedToBackground":"");var e;if(!this.snowSettings.moveToBackground){e=f}else{e=jQuery("#background")}e.prepend('<canvas id="snowAnimation" class="'+h+'" width="'+this.snowSettings.screenWidth+'" height="'+this.snowSettings.screenHeight+'"></canvas>');this.context=document.getElementById("snowAnimation").getContext("2d");this.context.fillStyle="rgba(255, 255, 255, 0.8)";this.context.width=this.snowSettings.screenWidth;this.context.height=this.snowSettings.screenHeight;for(var j=0;j<this.snowSettings.maxFlakes;j++){this.snowFlakes.push({x:parseFloat((Math.random()*this.snowSettings.screenWidth).toFixed(2)),y:parseFloat((Math.random()*this.snowSettings.screenHeight).toFixed(2)),radius:parseFloat((Math.random()*this.snowSettings.maxFlakeRadius).toFixed(2)),density:parseFloat((Math.random()*this.snowSettings.maxDensity).toFixed(2))})
}this.animationTime=Date.now();this.animationFrame=requestAnimationFrame(this.runAnimation);jQuery(window).on("resize.travianSnowAnimation",this.restart)}this.restarting=false};this.runAnimation=function(){var e=jQuery("#bodyWrapper").height();if(e!==d.bodyWrapperHeight){d.restart()}else{if(d.animationFrame!==null){var f=Date.now();if((f-d.animationTime)>24){d.drawTheSnow();d.updateSnowFlakePositions();d.animationTime=f}d.animationFrame=requestAnimationFrame(d.runAnimation)}}};this.updateSnowFlakePositions=function(){d.wind+=0.01;var e=6;if(Math.sin(d.wind)>-0.1&&Math.sin(d.wind)<0.1){e=10}var f;for(var g=0;g<d.snowFlakes.length;g++){f=d.snowFlakes[g];f.x=parseFloat((f.x+Math.sin(d.wind)*2).toFixed(2));f.y=parseFloat((f.y+Math.cos(d.wind+f.density)+1+f.radius/2).toFixed(2));if((f.y+f.radius>d.snowSettings.screenHeight)||(f.x+f.radius)<f.radius*-1||(f.x+f.radius)>d.snowSettings.screenWidth+f.radius){if(g%e>0){f.x=Math.random()*d.snowSettings.screenWidth;f.y=f.radius*-1}else{if(Math.random()>0.5){f.x=f.radius*-1;
f.y=Math.random()*d.snowSettings.screenHeight}else{f.x=d.snowSettings.screenWidth;f.y=Math.random()*d.snowSettings.screenHeight}}}}};this.drawTheSnow=function(){var f=Math.PI*2;d.context.clearRect(0,0,d.snowSettings.screenWidth,d.snowSettings.screenHeight);d.context.beginPath();var e;var h=d.context;for(var g=0;g<d.snowFlakes.length;g++){e=d.snowFlakes[g];h.moveTo(e.x,e.y);h.arc(e.x,e.y,e.radius,0,f)}d.context.fill()};this.restart=function(){jQuery(window).off("resize.travianSnowAnimation");d.restarting=true;cancelAnimationFrame(d.animationFrame);d.animationFrame=null;d.context=null;var e=jQuery("canvas#snowAnimation");d.snowFlakes=[];e.remove();d.updateState()};this.setState=function(f){var e=f&&jQuery("input[name=option_seasonal_snow_enabled]").is(":checked");this.setPreferences({enabled:e});this.restart()};this.setPreferences=function(e){this.snowSettings=Object.assign(this.snowSettings,e);return this.snowSettings};this.isActive=function(){return(jQuery("body").attr("class")||"").split(" ").indexOf(this.cssClassName)>-1
};Travian.Seasons.Season.call(this);var d=this;var b={};try{b=JSON.parse(Travian.Game.Preferences.get("snowAnimation"))}catch(c){}this.setPreferences(b);if(this.isActive()){this.restart()}};Travian.Seasons.Winter.prototype=Object.create(Travian.Seasons.Season.prototype);Travian.Seasons.Winter.constructor=Travian.Seasons.Winter;Travian.Seasons.Winter.writeNewPreferences=function(b){jQuery("body").find("span.pleaseSaveYourChanges").removeClass("hidden");jQuery("input[name=option_seasonal_snow_preferencesSettings]").val(JSON.stringify(b)).trigger("change")};Travian.Seasons.Winter.setSettingsElementState=function(c,d){var b=c.find("input, select");if(d){c.removeClass("disabled");b.prop("disabled",false)}else{c.addClass("disabled");b.prop("disabled",true)}};Travian.Seasons.Winter.bindSettingsEvents=function(b,c){Travian.Seasons.Winter.setSettingsElementState(c,b.is(":checked"));b.on("change",function(){Travian.Seasons.Winter.setSettingsElementState(c,this.checked)});c.find("#option_seasonal_snow_enabled").on("change",function(){var d=this.checked;
if(!Travian.Seasons.currentSeason.restarting){setTimeout(function(){var e=Travian.Seasons.currentSeason.setPreferences({enabled:d});Travian.Seasons.Winter.writeNewPreferences(e);Travian.Seasons.currentSeason.restart()},100)}});c.find("#option_seasonal_snow_maxFlakes").on("change",function(){var d=Math.min(2500,Math.max(25,parseInt(jQuery(this).val())));if(!Travian.Seasons.currentSeason.restarting){setTimeout(function(){var e=Travian.Seasons.currentSeason.setPreferences({maxFlakes:d});Travian.Seasons.Winter.writeNewPreferences(e);Travian.Seasons.currentSeason.restart()},100)}});c.find("#option_seasonal_snow_maxFlakeRadius").on("change",function(){var d=Math.min(10,Math.max(3,parseInt(jQuery(this).val())));if(!Travian.Seasons.currentSeason.restarting){setTimeout(function(){var e=Travian.Seasons.currentSeason.setPreferences({maxFlakeRadius:d});Travian.Seasons.Winter.writeNewPreferences(e);Travian.Seasons.currentSeason.restart()},100)}});c.find("#option_seasonal_snow_moveToBackground").on("change",function(){var d=parseInt(jQuery(this).val())===1;
if(!Travian.Seasons.currentSeason.restarting){setTimeout(function(){var e=Travian.Seasons.currentSeason.setPreferences({moveToBackground:d});Travian.Seasons.Winter.writeNewPreferences(e);Travian.Seasons.currentSeason.restart()},100)}})};jQuery(function(){if(Travian.Defaults.Season==="winter"){Travian.Seasons.currentSeason=new Travian.Seasons.Winter()}});Travian.i18n={DIRECTION_OVERRIDE_LTR:String.fromCharCode(8237),DIRECTION_OVERRIDE_RTL:String.fromCharCode(8238),DIRECTION_STOP_OVERRIDE:String.fromCharCode(8236),LTR:"ltr",RTL:"rtl",RTL_LANGUAGES:["ar-AE","he-IL"],RTL_MATHS:["ar-AE"],RTL_RATIO:["ar-AE"],ARABIC_NUMBERS:["ar-AE","he-IL"],clearDirection:function(b){return b.replace(/[\u202D\u202C\u202E]/g,"")}};Travian.i18n.Number=function(c,b){b=typeof b!=="undefined"?b:{};let settings={mathDirection:null,unit:"",sign:false,locale:null,grouping:null,fraction:null};let prepareSettings=function(g){const f=String.fromCharCode(37);const h=String.fromCharCode(215);const e={"%":f,x:h};const d={PLUS:String.fromCharCode(43),MINUS:String.fromCharCode(45)};
const j="de-DE";let language=Travian.Game.language;if(language==="com"){language="en-US"}settings.mathDirection=(Travian.i18n.RTL_MATHS.indexOf(language)>=0?Travian.i18n.RTL:Travian.i18n.LTR);if(typeof g.unit!=="undefined"){settings.unit=Object.keys(e).indexOf(g.unit)>=0?e[g.unit]:g.unit}settings.sign=(c<0?d.MINUS:(typeof g.alwaysShowSign!=="undefined"&&g.alwaysShowSign?d.PLUS:""));let validLanguage=language.split("-",2).join("-");settings.locale=(Travian.i18n.ARABIC_NUMBERS.indexOf(validLanguage)>=0?j:(validLanguage||j));settings.grouping=(typeof g.grouping!=="undefined"?g.grouping:false);settings.fraction=(typeof g.fraction!=="undefined"?g.fraction:0)};this.getSettings=function(){return settings};this.getPlainNumber=function(){return c};this.toString=function(){let number=Math.abs(c);let options={};if(!settings.grouping){options.useGrouping=settings.grouping}if(typeof settings.fraction!=="undefined"){options.minimumFractionDigits=settings.fraction;options.maximumFractionDigits=settings.fraction
}number=Travian.i18n.DIRECTION_OVERRIDE_LTR+number.toLocaleString(settings.locale,options)+Travian.i18n.DIRECTION_STOP_OVERRIDE;if(settings.unit||settings.sign){let mathDirectionMark=(settings.mathDirection===Travian.i18n.LTR?Travian.i18n.DIRECTION_OVERRIDE_LTR:Travian.i18n.DIRECTION_OVERRIDE_RTL);let sign=settings.sign;if(settings.signWrapper){sign=settings.signWrapper.replace("SIGN",sign)}number=mathDirectionMark+sign+number+settings.unit+Travian.i18n.DIRECTION_STOP_OVERRIDE}return number};prepareSettings(b)};Travian.i18n.Ratio=function(b,e,c){const d="&nbsp;";b=(new Travian.i18n.Number(b,c)).toString();e=(new Travian.i18n.Number(e,c)).toString();c=typeof c!=="undefined"?c:{};let getRatioSeparator=function(f){f=typeof f!=="undefined"?f:false;let language=Travian.Game.language;let separator=Travian.i18n.RTL_RATIO.indexOf(language)>=0?"\\":"/";if(f){separator=d+separator+d}return separator};let toString=function(){let language=Travian.Game.language;let separator=getRatioSeparator(c.useSpaces);
let ratioDirection=Travian.i18n.RTL_RATIO.indexOf(language)>=0?Travian.i18n.RTL:Travian.i18n.LTR;let processedNominator=b;if(typeof c.nominatorClass!=="undefined"){processedNominator='<span class="'+c.nominatorClass+'">'+b+"</span>"}let processedDenominator=e;if(typeof c.denominatorClass!=="undefined"){processedDenominator='<span class="'+c.denominatorClass+'">'+e+"</span>"}let ratioDirectionMark=ratioDirection===Travian.i18n.LTR?Travian.i18n.DIRECTION_OVERRIDE_LTR:Travian.i18n.DIRECTION_OVERRIDE_RTL;return ratioDirectionMark+processedNominator+separator+processedDenominator+Travian.i18n.DIRECTION_STOP_OVERRIDE};return toString()};Travian.Game={currentPage:window.location.href.split("/").pop().split(".php",2).shift(),eventJamHtml:null,speed:1,version:4,worldId:null,gotoPage:function(d,e,b,c){Travian.api("ajax/"+e,{data:{data:{page:d,entries:c}},success:function(f){jQuery(b).html(f.result)}});return this},iPopupUrl:function(b,d){var c=new Travian.Dialog.Dialog({title:d,buttonOk:false,enableBackground:false,draggable:true,fx:{duration:0}});
c.setContent('<iframe class="popup" frameborder="0" id="Frame" src="'+b+'" width="475" height="500" scrolling="yes" border="0" allowTransparency="true"></iframe>');c.show();return false},unitZoom:function(d,b){var c=new Travian.Dialog.Dialog({version:2,buttonOk:false,cssClass:"plain"});c.setContent('<img class="unitFull u'+d+'Full" src="/img/x.gif" alt="'+b+'">');c.show();return false},setLanguage:function(c){var b;switch(c){case"sr-RS-Cyrl":b="sr-Cyrl";break;case"bs-BA-Latn":b="bs-Latn";break;default:b=c;break}this.language=c;this.bcpLanguageCode=b}};jQuery(function(){Travian.TimersAndCounters.init();var b=jQuery("*.dynamic_img");b.on({mouseenter:function(c){jQuery(this).addClass("over")},mouseleave:function(c){jQuery(this).removeClass("over").removeClass("clicked")},mousedown:function(c){jQuery(this).removeClass("over").addClass("clicked")}})});Travian.Game.Preferences={preferences:{},initialize:function(b){var d=this;for(var c in b){if(b.hasOwnProperty(c)){switch(b[c]){case"true":d.preferences[c]=true;
break;case"false":d.preferences[c]=false;break;case"null":d.preferences[c]=null;break;default:d.preferences[c]=b[c]}}}},get:function(b){if(this.preferences[b]!==undefined){return this.preferences[b]}return null},set:function(b,d){if(this.preferences[b]!==d){this.preferences[b]=d;var c={};c[b]=d===null||d===undefined?d:d.toString();Travian.api("preferences",{data:c})}},reload:function(){var b=this;Travian.api("preferences/all",{success:function(c){b.preferences={};b.initialize(c);jQuery(window).trigger("travian.preferences.reloaded")}},"get")}};Travian.Game.Layout={states:{travian_toggle:["expanded","collapsed"]},goldIsUpdating:false,toggleBox:function(g,d,k){var h=d+"_"+k;var l=this.states[d];var c=Travian.Game.Preferences.get(h);if(l.indexOf(c)===-1){c=l[0]}var e="";for(var f=0;f<l.length;f++){var b=l[f];g.removeClass(b);if(b!==c){e=b;g.addClass(e);var j=Travian.Translation.get(k+"_"+e);g.find("button.toggle").prop("title",j);Travian.Tip.refresh()}}Travian.Game.Preferences.set(h,e);this.setInfoboxItemsRead()
},loadLayoutButtonTitle:function(b,d,c){Travian.api("ajax/getLayoutButtonTitle",{data:{boxId:d,buttonId:c},success:function(f){var e={title:f.newTitle,text:f.newText,unescaped:false};Travian.Tip.setContent(b,e);Travian.Tip.show(e)}})},setInfoboxItemsRead:function(){var d=jQuery("#sidebarBoxInfobox");if(d.length>0&&d.hasClass("toggleable")){var b=jQuery("#sidebarBoxInfobox li.unreaded");if(d.hasClass("collapsed")&&b.length>0){var c=[];b.each(function(e,f){c.push(jQuery(f).attr("id").replace("infoID_",""))});Travian.api("ajax/infoboxSetRead",{data:{infoIds:c},success:function(f){jQuery("#sidebarBoxInfobox li.unreaded").removeClass("unreaded");var e=jQuery("#sidebarBoxInfobox div.messageShortInfo");if(typeof f.messageCounterContent!=="undefined"){e.animate({"margin-top":"15px",opacity:0},250);setTimeout(function(){e.remove();jQuery(f.messageCounterContent).insertAfter("#sidebarBoxInfobox .boxTitle");jQuery("#sidebarBoxInfobox div.messageShortInfo").css({"margin-top":"15px",opacity:0}).animate({"margin-top":0,opacity:1},250);
Travian.Tip.refresh()},250)}}})}}},setupInfoboxItemsDeletionWithMessage:function(c,b){jQuery("a.infoboxDeleteButton").each(function(d,g){var e=jQuery(g);var f=e.attr("data-id");e.click(function(j){var h=new Travian.Dialog.Dialog({preventFormSubmit:true,buttonTextOk:b,onOkay:function(){Travian.api("ajax/infoboxDelete",{data:{id:f},success:function(){window.location.href=window.location.href}})}});h.setContent(c);h.show();return false})})},updateGold:function(c){Travian.Game.Layout.goldIsUpdating=true;var b=parseInt(jQuery(".ajaxReplaceableGoldAmount").first().html());Travian.api("ajax/getGoldAmount",{data:{},success:function(e){var d=e.goldAmount;if(d!==b){var f=new Travian.Formatter({forceDecimal:false});jQuery(".ajaxReplaceableGoldAmount").html(f.getFormattedNumber(d));if(typeof c==="function"){c()}else{if(typeof c==="string"&&typeof c.split(".").reduce(function(h,g){return h[g]},window)==="function"){c.split(".").reduce(function(h,g){return h[g]},window)}}}Travian.Game.Layout.goldIsUpdating=false
}})},updateResources:function(b){if(b===undefined){Travian.api("ajax/getResources",{data:{},success:function(d){Travian.Game.Layout.updateResources(d)}})}else{for(var c=1;c<=4;c++){resources.storage["l"+c]=parseInt(b["l"+c])}Travian.TimersAndCounters.init()}},toggleBackgroundOverlay:function(){var b=jQuery("#backgroundOverlay");if(b.length>0){b.removeClass("visible");setTimeout(function(){b.remove()},500)}else{b=jQuery('<div id="backgroundOverlay"></div>');jQuery("body").prepend(b);b.addClass("visible")}},fixViewportWidth:function(){var b=jQuery("body");let viewportValue;let mobileOptimized=b.hasClass("mobileOptimized");let rtl=b.hasClass("rtl");switch(true){case navigator.userAgent.match(/iPhone/i)!==null:case rtl&&mobileOptimized&&window.outerWidth<=620:viewportValue="width=620";break;case rtl&&(!mobileOptimized||window.outerWidth>620):viewportValue="width=1280";break;default:viewportValue="width=device-width";break}jQuery("meta[name=viewport]").attr("content",viewportValue)},initMobileOptimizations:function(){Travian.Game.Layout.fixViewportWidth();
jQuery(window).on("resize",Travian.Game.Layout.fixViewportWidth);let sideBarAfterContent=jQuery("#sidebarAfterContent");let sideBarBeforeContent=jQuery("#sidebarBeforeContent");let body=jQuery("body:not(.activate):not(.login):not(.logout):not(.error_site)");let isRTL=body.hasClass("rtl");let touchStartX=0;let touchCount=0;let swipe=true;body.on("touchstart",function(b){let target=jQuery(b.target);if(!target.hasClass("preventMobileSwipeNavigation")&&target.parents(".preventMobileSwipeNavigation").length===0){touchStartX=b.originalEvent.changedTouches[0].pageX}touchCount++});body.on("touchmove",function(){swipe=swipe&&touchCount===1});body.on("touchend",function(b){if(swipe){let target=jQuery(b.target);let dialogWrapper=body.find(".dialogWrapper");let isDialogOpen=dialogWrapper.length>0&&dialogWrapper.is(":visible");if(!isDialogOpen&&!target.hasClass("preventMobileSwipeNavigation")&&target.parents(".preventMobileSwipeNavigation").length===0&&!body.hasClass("mainLayoutDisabled")){let delta=b.originalEvent.changedTouches[0].pageX-touchStartX;
let direction=delta>=0?"right":"left";if(Math.abs(delta)>=200){if((!isRTL&&direction==="left")||(isRTL&&direction==="right")){if(!sideBarBeforeContent.hasClass("mobileOpened")){sideBarAfterContent.addClass("mobileOpened")}sideBarBeforeContent.removeClass("mobileOpened")}if((!isRTL&&direction==="right")||(isRTL&&direction==="left")){if(!sideBarAfterContent.hasClass("mobileOpened")){sideBarBeforeContent.addClass("mobileOpened")}sideBarAfterContent.removeClass("mobileOpened")}}}}if(touchCount>0){touchCount--}touchStartX=0;if(touchCount===0){swipe=true}});jQuery("#sidebarAfterContent, #sidebarAfterContent *, #sidebarBeforeContent, #sidebarBeforeContent *").on("click",function(b){let target=jQuery(b.target);let dialogWrapper=body.find(".dialogWrapper");let isDialogOpen=dialogWrapper.length>0&&dialogWrapper.is(":visible");if(!isDialogOpen&&target.parents(".sidebarBox").length===0||target.is("button:not(.toggleBox)")||target.is("a")||target.parents("a, button:not(.toggleBox)").length>0){sideBarBeforeContent.removeClass("mobileOpened");
sideBarAfterContent.removeClass("mobileOpened")}})},updateHeroExperienceBar:function(d,c){TweenLite.to(jQuery("#experienceMask path"),0.5,{morphSVG:d.mask});TweenLite.to(jQuery("#topBarHero .experience path.title"),0.5,{morphSVG:d.title});var b=jQuery("#topBarHero .experience .title");b.html("<title>"+Travian.Translation.get("hero.erfahrung")+": "+c+"</title>");Travian.Tip.refresh()},updateHeroHealthBar:function(f,d,e){TweenLite.to(jQuery("#healthMask path"),0.5,{morphSVG:f.mask});TweenLite.to(jQuery("#topBarHero .health path.title"),0.5,{morphSVG:f.title});var b=jQuery("#topBarHero .health image").attr("xlink:href");var c=b.replace(/^(.*\/)(\w+)(\.png)$/,"$1"+e+"$3");jQuery("#topBarHero .health image").attr("xlink:href",c);let healthTitle=jQuery("#topBarHero .health .title");healthTitle.html("<title>"+Travian.Translation.get("hero.health")+": "+(new Travian.i18n.Number(d,{unit:"%"})).toString()+"</title>");Travian.Tip.refresh()},disable:function(){jQuery("body").addClass("mainLayoutDisabled")
},enable:function(){jQuery("body").removeClass("mainLayoutDisabled")}};Travian.Game.ColorPicker=function(b,c){this.selectColor=function(d){var e=this;this.container.find("div.moocolorcheckbox-container").removeClass(e.options.selectedClassName);this.container.find('div[colorPick="'+d+'"]').each(function(f,g){jQuery(g).parent("div").addClass(e.options.selectedClassName);e.options.onChange(d)});return this};this.draw=function(){var d=this;this.container.empty();this.options.colors.forEach(function(e){var f=jQuery("<div></div>").addClass(d.options.className+" moocolorcheckbox-container").css({"float":"left",cursor:"pointer"}).on("click",function(){d.selectColor(e)}).appendTo(d.container);jQuery("<div></div>").addClass("entry").html("&nbsp;").css({"background-color":e}).attr("colorPick",e).appendTo(f)});return this};this.options=Object.assign({},{colors:[],defaultColor:-1,className:"moocolorcheckbox",selectedClassName:"moocolorcheckbox_selected"},c);this.container=jQuery(b);this.container.css("overflow","hidden");
this.draw();if(this.options.defaultColor>=0){this.selectColor(this.options.colors[this.options.defaultColor])}};Travian.Game.ImagePicker=function(b,c){this.selectImage=function(e){var f=this;this.container.find("div").removeClass(f.options.selectedClassName);this.container.find('img[src$="'+e+'"]').each(function(h,g){jQuery(g).parent("div").addClass(f.options.selectedClassName);f.options.onChange(e)});return this};this.options=Object.assign({},{images:[],defaultImage:-1,className:"mooimagecheckbox",selectedClassName:"mooimagecheckbox_selected",onChange:Travian.emptyFunction},c);this.container=b;this.container.css({overflow:"hidden"});var d=this;d.container.empty();this.options.images.forEach(function(e){jQuery("<div></div>").addClass(d.options.className).html('<img src="'+e+'" alt="" />').css({"float":"left",cursor:"pointer"}).on("click",function(){d.selectImage(e)}).appendTo(d.container)});if(this.options.defaultImage>=0){this.selectImage(this.options.images[this.options.defaultImage])
}};Travian.Game.SwitchDown=function(b){this.switchDownElement=jQuery(b);var c=this;this.switchDownElement.on("click",function(d){c.switchDownElement.children().toggleClass("hide");d.stopPropagation();return false})};Travian.Game.AddLine=function(b){this.options=Object.assign({insertAfterLastEntry:true,elements:{add:null,insert:null,table:null,template:null},entryCount:0,maxEntries:false,selectors:{add:".addLine.addElement",insert:".addLine.insertElement",template:".addLine.templateElement"},onAddBefore:Travian.emptyFunction,onAddAfter:Travian.emptyFunction,onCloneBefore:Travian.emptyFunction,onCloneAfter:Travian.emptyFunction,onInsertBefore:Travian.emptyFunction,onInsertAfter:Travian.emptyFunction,onInsertInputBefore:Travian.emptyFunction,onInsertInputAfter:Travian.emptyFunction},b);var c=this;if(!this.options.elements.table){throw"Table element for Travian.Game.AddLine is not definied"}this.options.elements.table=jQuery(this.options.elements.table);"template add insert".split(" ").forEach(function(d){if(!c.options.elements[d]){c.options.elements[d]=c.options.elements.table.find(c.options.selectors[d])
}if(!c.options.elements[d]){throw'Element "'+d+'" for Travian.Game.AddLine is not definied'}});this.options.elements.add.addClass("addLine removeElement");this.options.elements.template=this.options.elements.template.clone(true);this.options.elements.add.removeClass("addLine removeElement");this.options.elements.add.on("click",function(h){h.stopPropagation();c.options.onAddBefore();c.options.onCloneBefore();var g=c.options.elements.template.clone(true);c.options.onCloneAfter(g);var f=g.find("label, input, textarea, button, select");c.options.onInsertBefore(g);f.each(function(e,j){if(j.tagName.toLowerCase()==="input"){if(j.type.toLowerCase()==="checkbox"||j.type.toLowerCase()==="radio"){j.tagName.checked=false}else{if(j.type.toLowerCase()==="text"||j.type.toLowerCase()==="password"){j.tagName.value=""}}}else{if(j.tagName.toLowerCase()==="select"){j.tagName.selectedIndex=-1}else{if(j.tagName.toLowerCase()==="textarea"){j.tagName.value=""}}}c.options.onInsertInputBefore(c.options.entryCount,g,j)
});c.options.elements.insert.after(g.css({opacity:0}));g.animate({opacity:1});var d=g.find(".addLine.removeElement");if(d){d.after(c.options.elements.add);d.remove()}c.options.entryCount++;if(c.options.maxEntries!==false&&c.options.maxEntries===c.options.entryCount){c.options.elements.add.dispose();Travian.Tip.hide()}f.each(function(e){c.options.onInsertInputAfter(g,e)});c.options.onInsertAfter(g);if(c.options.insertAfterLastEntry===true){c.options.elements.insert=g}c.options.onAddAfter(g)})};Travian.Game.InstantTabs=function(c){var b=c.find(".tabNavi .container");b.on("click",function(j){j.preventDefault();var g=this;var f=0;b.each(function(e,k){if(g!=null){if(k===g){g=null}else{f++}}});b.removeClass("active");jQuery(this).addClass("active");var d=c.find(".tabContainer");d.addClass("hide");var h=d.get(f);jQuery(h).removeClass("hide");return false})};Travian.Game.TabScrollNavigation=function(){this.navigation="";this.scrollFrom="";this.scrollTo="";this.scrollingContainer="";this.isRTL=false;
this.initialize=function(){var b=this;b.navigation=jQuery(".subNavi");b.isRTL=jQuery("body.rtl").length>0;if(b.navigation.length>0){b.scrollFrom=b.navigation.find(".scrollFrom");b.scrollTo=b.navigation.find(".scrollTo");b.scrollingContainer=b.navigation.find(".scrollingContainer");b.updateButtonStates();b.scrollToActiveTab();b.scrollFrom.on("click",function(){if(!b.isRTL){b.scrollingContainer.stop().animate({scrollLeft:0},500)}else{b.scrollingContainer.stop().animate({scrollLeft:b.scrollingContainer[0].scrollWidth-b.scrollingContainer[0].clientWidth},500)}b.scrollFrom.attr("disabled","disabled");setTimeout(function(){b.updateButtonStates()},550)});b.scrollTo.on("click",function(){if(!b.isRTL){b.scrollingContainer.stop().animate({scrollLeft:b.scrollingContainer[0].scrollWidth-b.scrollingContainer[0].clientWidth},500)}else{b.scrollingContainer.stop().animate({scrollLeft:0},500)}b.scrollTo.attr("disabled","disabled");setTimeout(function(){b.updateButtonStates()},550)})}};this.updateButtonStates=function(){var b=this;
if(b.scrollingContainer[0].scrollWidth>b.scrollingContainer[0].clientWidth){if(!b.isRTL){b.scrollFrom.attr("disabled",b.scrollingContainer[0].scrollLeft>0?false:"disabled");b.scrollTo.attr("disabled",b.scrollingContainer[0].scrollLeft<(b.scrollingContainer[0].scrollWidth-b.scrollingContainer[0].clientWidth)?false:"disabled")}else{b.scrollFrom.attr("disabled",b.scrollingContainer[0].scrollLeft<(b.scrollingContainer[0].scrollWidth-b.scrollingContainer[0].clientWidth)?false:"disabled");b.scrollTo.attr("disabled",b.scrollingContainer[0].scrollLeft>0?false:"disabled")}}};this.scrollToActiveTab=function(){var b=this;var c=b.navigation.find(".tabItem.active").parent(".content");if(b.scrollingContainer[0].scrollWidth>b.scrollingContainer[0].clientWidth&&((!b.isRTL&&(c.position().left+c.width())>b.scrollingContainer[0].clientWidth)||(b.isRTL&&(c.position().left+c.width())<b.scrollingContainer[0].clientWidth))){if(!b.isRTL){b.scrollingContainer.stop().animate({scrollLeft:b.scrollingContainer[0].scrollWidth-b.scrollingContainer[0].clientWidth},500)
}else{b.scrollingContainer.stop().animate({scrollLeft:b.scrollingContainer[0].clientWidth-b.scrollingContainer[0].scrollWidth},500)}setTimeout(function(){b.updateButtonStates()},550)}};this.initialize()};Travian.Game.AutoCompleter=function(c,d,b){this.query=function(e){Travian.api("ajax/autoComplete",{data:{type:this.options.type,context:this.options.context,search:e},success:this.update.bind(this),error:function(){this.update([])}.bind(this)})};Digitarald.AutoCompleter.call(this,c,Object.assign({minLength:2,maxChoices:10,width:"auto",fxOptions:false,emptyChoices:function(){jQuery("<li></li>").html(Travian.Translation.translate("{cropfinder.keine_ergebnisse}")).appendTo(this.choices);this.showChoices()}.bind(this)},b||{},{type:d}))};Travian.Game.AutoCompleter.prototype=Object.create(Digitarald.AutoCompleter.prototype);Travian.Game.AutoCompleter.constructor=Travian.Game.AutoCompleter;Travian.Game.AutoCompleter.UserName=function(c,b){Travian.Game.AutoCompleter.call(this,c,"username",Object.assign({multiple:true,separator:"; ",autoTrim:true,allowDupes:false},b))
};Travian.Game.AutoCompleter.UserName.prototype=Object.create(Travian.Game.AutoCompleter.prototype);Travian.Game.AutoCompleter.UserName.constructor=Travian.Game.AutoCompleter.UserName;Travian.Game.AutoCompleter.VillageName=function(c,b){Travian.Game.AutoCompleter.call(this,c,"villagename",Object.assign({maxChoices:20},b))};Travian.Game.AutoCompleter.VillageName.prototype=Object.create(Travian.Game.AutoCompleter.prototype);Travian.Game.AutoCompleter.VillageName.constructor=Travian.Game.AutoCompleter.VillageName;Travian.Game.Messages={check_in_progress:false,recipients_checked:false,technicalAccounts:["support","multihunter","plus"],checkRecipients:function(c,b){if(!Travian.Game.Messages.check_in_progress){Travian.Game.Messages.check_in_progress=true;Travian.api("ajax/checkRecipient",{data:{recipients:c},success:function(){Travian.Game.Messages.check_in_progress=false;Travian.Game.Messages.recipients_checked=true;b.trigger("submit")},error:function(d){Travian.Game.Messages.check_in_progress=false;
var e=new Travian.Dialog.Dialog({preventFormSubmit:true});e.setContent(d.errorMsg);e.show()}})}},addRecipient:function(c){var d=jQuery("#receiver");var b=this.getRecipients().filter(function(e){return e!==""});b.push(c);d.val(b.join("; "));d.trigger("change")},getRecipients:function(c){var b=jQuery("#receiver");return b.val().split(";").map(function(d){return c?d.trim().toLowerCase():d.trim()})},checkIfRecipientsContainTechnicalAccounts:function(b){return this.technicalAccounts.reduce(function(d,c){return d||b.indexOf(c)>-1},false)}};Travian.Game.AddressBook={entrypoint:"addressbook",dialog:null,getDialog:function(){if(this.dialog===null){this.dialog=new Travian.Game.AddressBook.Dialog()}return this.dialog},show:function(){if(this.dialog){this.dialog.unhide()}else{this.getDialog().show()}},hide:function(){if(this.dialog!==null){this.dialog.hide()}},call:function(d,c){if(!c){return}var b=this.dialog;b.disableForm();Travian.api(this.entrypoint+d,{data:{friend:c},success:function(e){b.setContent(e.html)
},complete:function(){b.enableForm()}})},add:function(b){this.call("/add",b);return false},accept:function(b){this.call("/accept",b);return false},remove:function(b){this.call("/delete",b);return false}};Travian.Game.AddressBook.Dialog=function(b){var c=this;this.close=function(){this.hide()};Travian.Dialog.Api.call(this,Object.assign({call:Travian.Game.AddressBook.entrypoint,keepOpen:true,context:"addressbook",draggable:false,enableBackground:false,preventFormSubmit:true,title:Travian.Translation.translate("{nachrichten.adressbuch}"),buttonTextOk:Travian.Translation.translate("{allgemein.save}"),onOkay:function(){var d=c.content.find("input.friend").map(function(f,e){return e.value}).get().filter(function(e){return e});Travian.Game.AddressBook.add(d)}},b||{}))};Travian.Game.AddressBook.Dialog.prototype=Object.create(Travian.Dialog.Api.prototype);Travian.Game.AddressBook.Dialog.constructor=Travian.Dialog.Api;Travian.Game.Notice=function(c,b){this.maxNotesLength=-1;this.element=jQuery("#notice");
this.initialize=function(e,d){if(typeof e==="undefined"){e=-1}this.maxNotesLength=parseInt(e);if(typeof d==="undefined"){d=jQuery("#notice")}this.element=d;var f=this;jQuery("#send").on("click",function(g){if(!f.DoubleClickPreventer){f.DoubleClickPreventer=new Travian.DoubleClickPreventer();f.DoubleClickPreventer.timeout=250}if(!f.DoubleClickPreventer.check()){return}if(!f.checkMaxLength()){g.preventDefault();f.showNoticeTooLongMessage()}})};this.showNoticeTooLongMessage=function(){var d=new Travian.Dialog.Dialog({preventFormSubmit:true});d.setContent(Travian.Translation.get("nachrichten.notice_too_long"));d.show()};this.checkMaxLength=function(){if(this.element.length===0){return false}if(this.maxNotesLength<0){return true}return this.element.val().length<=this.maxNotesLength};this.initialize(c,b)};Travian.Game.BBEditor=function(c,b){this.preview=null;this.textArea=null;this.id=null;this.initialize=function(e,d){var f=this;this.id=e;this.textArea=jQuery("#"+e);this.toolbar=jQuery("#"+e+"_toolbar");
this.preview=jQuery("#"+e+"_preview");this.preview.css("display","none");this.preview.addClass("preview");jQuery("#"+e+"_previewButton").on("click",jQuery.proxy(function(g){f.fetchPreview(g)},f));jQuery("#"+e+"_resourceButton").on("click",jQuery.proxy(function(g){f.showToolbarWindow(g)},f));jQuery("#"+e+"_smilieButton").on("click",jQuery.proxy(function(g){f.showToolbarWindow(g)},f));jQuery("#"+e+"_troopButton").on("click",jQuery.proxy(function(g){f.showToolbarWindow(g)},f));this.textArea.on("click",jQuery.proxy(function(g){f.hideToolbarWindow(g)},f));this.addEvent(this.toolbar,jQuery.proxy(function(g){f.insertTag(g)},f));d=typeof d!=="undefined"?d:false;if(Boolean(d)===true){this.fetchPreview()}};this.addEvent=function(g,f){var e=jQuery(g).children();for(var d=0;d<e.length;d++){if(Travian.Game.BBEditor.getInformationFromClass(e[d],"bbTag")){jQuery(e[d]).on("click",f)}}};this.insertTag=function(j){var h=this;j.preventDefault();this.hidePreview();var f;if(jQuery(j.target).is("button")){f=jQuery(j.target)
}else{f=jQuery(j.target).parent()}var d=Travian.Game.BBEditor.getInformationFromClass(f[0],"bbTag");var g=this.textArea[0].scrollTop;switch(Travian.Game.BBEditor.getInformationFromClass(f[0],"bbType")){case"d":h.insertAroundCursor(this.textArea,"["+d+"]","[/"+d+"]");break;case"s":h.insertAtCursor(this.textArea,d);break;case"o":h.insertAtCursor(this.textArea,("["+Travian.Game.BBEditor.getInformationFromClass(f[0],"bbTag")+"]"));break}this.textArea[0].scrollTop=g};this.showToolbarWindow=function(j){var h=this;j.preventDefault();var g=j.target;var f=jQuery("#"+h.id+"_"+Travian.Game.BBEditor.getInformationFromClass(g,"bbWin"));var d=true;if(f.css("display")==="block"){d=false}h.hideToolbarWindow();if(d){f.show();f.css("display","block")}};this.hideToolbarWindow=function(h){var g=this;if(h){h.preventDefault()}var f=jQuery("#"+g.id+"_toolbarWindows").children();for(var d=0;d<f.length;d++){jQuery(f[d]).css("display","none")}};this.fetchPreview=function(f){var d=this;if(typeof f!=="undefined"){f.preventDefault()
}if(d.textArea.css("display")==="none"||d.textArea.val().length<1){d.hidePreview();return}Travian.api("ajax/bb",{data:{nl2br:1,target:d.id,text:d.textArea.val()},success:function(e){d.showPreview(e)}})};this.showPreview=function(d){if(d.error===true){alert(d.errorMsg)}else{this.preview.html(d.text);this.preview.css("display","block");this.textArea.css("display","none")}};this.hidePreview=function(){this.preview.css("display","none");this.textArea.css("display","inline")};this.insertAroundCursor=function(f,h,d){var e=f[0].selectionStart;var g=f[0].selectionEnd;var l=f.val().substring(e,g);var k=h+l+d;var j=f.val();f.val(j.substring(0,e)+k+j.substring(g));f.focus();f[0].selectionStart=e+h.length;f[0].selectionEnd=e+h.length};this.insertAtCursor=function(e,h){var d=e[0].selectionStart;var f=e[0].selectionEnd;var g=e.val();e.val(g.substring(0,d)+h+g.substring(f));e.focus();e[0].selectionStart=d+h.length;e[0].selectionEnd=d+h.length};this.initialize(c,b)};Travian.Game.BBEditor.getInformationFromClass=function(d,e){var c=jQuery(d);
if(d.nodeName.toLowerCase()==="img"){d=c.parent("button")[0];if(!d){d=c.parent("a")[0]}}var b=jQuery(d).attr("class").split(" ").filter(function(f){return f.indexOf(e)===0});if(b.length>0&&b[0].length>0){b=b[0].substr(0,b[0].length-1).split("{");if(b.length===2){b=b[1]}else{b=null}}return b};Travian.Game.RaidList={data:{},weAreAdding:false,closestDropContainer:null,listsInSelectedVillage:null,captchaField:null,doubleClickPreventer:null,isRaidBeingSent:false,onError:function(b){var c=new Travian.Dialog.Dialog({buttonOk:true,buttonCloseOnClickOk:true,preventFormSubmit:true});c.setContent(b.errorMsg);c.show()},startRaid:function(b){let $this=this;if($this.doubleClickPreventer===null){$this.doubleClickPreventer=new Travian.DoubleClickPreventer()}if($this.isRaidBeingSent||!$this.doubleClickPreventer.check()){return}$this.isRaidBeingSent=true;let allStartButtons=jQuery("#raidList .startButton");allStartButtons.attr("disabled","disabled");let listElement=jQuery("#raidList"+b);jQuery("#raidList .attackInfoIcon").remove();
let sort=listElement.find("input[name=sort]").val();let direction=listElement.find("input[name=direction]").val();let a=listElement.find("input[name=a]").val();let checkedSlots=listElement.find(".markSlot:checked");let checkedSlotsIds=[];if(checkedSlots.length>0){checkedSlots.each(function(c,d){checkedSlotsIds.push(jQuery(d).data("slot"))})}let captcha=jQuery("."+$this.captchaField);Travian.api("ajax/raidList",{data:{method:"ActionStartRaid",listId:b,slots:checkedSlotsIds,sort:sort,direction:direction,captcha:captcha.length>0?captcha.val():null,a:a,loadedLists:Object.keys($this.data)},success:function(c){if(c.captchaRequired){$this.confirm(listElement.find("form:last-of-type",true))}else{let listConfigs=[];if(typeof $this.data[b]!=="undefined"){listConfigs.push({id:b,sortField:sort,sortDirection:direction,startedRaids:c.startedRaids[b],errorMessages:c.errorMessages})}for(let i=0;i<c.listsToUpdate.length;i++){let lid=c.listsToUpdate[i];if(typeof $this.data[lid]!=="undefined"&&parseInt(lid)!==parseInt(b)){let sortBy=jQuery("#raidList"+lid).find('input[name="sort"]').val();
listConfigs.push({id:lid,sortField:sortBy,sortDirection:$this.data[lid].directions[sortBy]})}}$this.loadLists(listConfigs);let successAndErrorSummary={success:c.startedRaids,error:c.countRaidListError};$this.refreshListHeaders(true,b,successAndErrorSummary)}if(typeof c.a!=="undefined"){jQuery("input[name=a]").val(c.a)}if(c.limitReached){$this.onError({errorMsg:c.limitReached})}$this.isRaidBeingSent=false;allStartButtons.attr("disabled",false)},error:$this.onError})},refreshListHeaders:function(c,b,d){if(jQuery("#raidList").length>0){Travian.api("ajax/raidList",{data:{method:"ActionGetListHeaders",listId:!c&&typeof b!=="undefined"?b:null,successAndErrorSummary:typeof d!=="undefined"?d:null},success:function(e){for(let i=0;i<e.lists.length;i++){let list=e.lists[i];let listElement=jQuery("#raidList"+list.id);listElement.find(".listName .value").html(list.name);listElement.find(".raidListHeadline .slots").html(list.slotsMarkup);Travian.Tip.refresh()}},error:this.onError})}},addSlot:function(c,b,f,d){var e=this;
d=d||null;Travian.api("ajax/raidList",{data:{method:"ActionAddSlotForm",listId:c,weAreAdding:(Travian.Game.RaidList.weAreAdding?true:null),x:b,y:f,context:d},success:function(g){e.dialog({buttonOk:false,context:"raidAddSlotDialog"},g.html);return true},error:e.onError});jQuery("#raidList .attackInfoIcon").remove()},deleteSlots:function(b){var c=this;Travian.api("ajax/raidList",{data:{method:"actionDeleteSlots",slots:b},success:function(){var d=Travian.WindowManager.getWindowsByContext("raidAddSlotDialog").pop();c.refreshList(d.options.raidListId);c.refreshListHeaders(false,d.options.raidListId);d.close();return true},error:c.onError});jQuery("#raidList .attackInfoIcon").remove()},editSlots:function(b,d,f){var j=this,h=jQuery("#raidList"+b+" .markSlot"),c=jQuery("#raidList"+b+" .markSlot:checked"),g=[];if(typeof d==="undefined"){var e=c.length!==0?c:h;e.each(function(k,l){g.push(jQuery(l).data("slot"))})}else{g.push(d)}Travian.api("ajax/raidList",{data:{method:"actionEditSlotForm",listId:b,slots:g,context:f},success:function(k){j.dialog({buttonOk:false,context:"raidAddSlotDialog",raidListId:b},k.html);
return true},error:j.onError});jQuery("#raidList .attackInfoIcon").remove()},addSlotPopupWrapper:function(c,b,d){Travian.Game.RaidList.weAreAdding=true;Travian.Game.RaidList.addSlotWrapper(c,b,d)},editSlotPopupWrapper:function(b,c){Travian.Game.RaidList.weAreAdding=false;Travian.Game.RaidList.editSlotWrapper(b,c)},addSlotWrapper:function(c,b,f){var d=Travian.WindowManager.getWindows();var e=(d.length)?d[d.length-1]:null;if(d.length>0&&!!e){d[d.length-1].close()}Travian.Game.RaidList.addSlot(c,b,f)},editSlotWrapper:function(b,c){var d=Travian.WindowManager.getWindows();var e=(d.length)?d[d.length-1]:null;if(d.length>0&&!!e){d[d.length-1].close()}Travian.Game.RaidList.editSlots(b,c,true,"map")},dialog:function(b,d){var c=new Travian.Dialog.Dialog(Object.assign({preventFormSubmit:true},b));c.setContent(d);c.show()},saveSlot:function(b,c,e){var d=this;if(c!==null&&c.length>1){d.persistSlotEntry(b,c,e);return}Travian.api("ajax/raidList",{data:{method:"ActionCheckForForeignSlotEntry",listId:b,slots:c,x:e.x,y:e.y},success:function(g){if(!(typeof g!="undefined"&&g.hasOwnProperty("entryExists"))){return
}if(g.entryExists){var f=new Travian.Dialog.Dialog({buttonOk:true,buttonCloseOnClickOk:false,preventFormSubmit:true,onOkay:function(){d.persistSlotEntry(b,c,e)}});f.setContent('<div class="centeredText">'+Travian.Translation.get("raidList.overwriteFarmListEntry")+"<br>"+Travian.Translation.get("raidList.thisWillOverwriteAnExistingFarmListEntry")+"</div>");f.show()}else{d.persistSlotEntry(b,c,e)}},error:d.onError});jQuery("#raidList .attackInfoIcon").remove()},persistSlotEntry:function(b,d,f){var e=this,c=jQuery("#raidListSlot #edit_form .troops");c.siblings(".error").remove();Travian.api("ajax/raidList",{data:{method:d===null||d.length<2?"ActionAddSlot":"SlotsBulkEdit",listId:b,slots:d,x:f.x,y:f.y,t1:f.t1,t2:f.t2,t3:f.t3,t4:f.t4,t5:f.t5,t6:f.t6,t7:f.t7,t8:f.t8,t9:f.t9,t10:f.t10,slotState:typeof f.deactivate!=="undefined"&&!!f.deactivate?"inactive":"active"},success:function(){var g=Travian.WindowManager.getWindowsByContext("raidAddSlotDialog");if(g.length>0){g.pop().close()}e.refreshAllOpenLists();
e.refreshListHeaders(false,b);return true},error:e.onError})},refreshAllOpenLists:function(){let listIDs=Object.keys(this.data);let listConfigs=[];for(let i=0;i<listIDs.length;i++){let listId=listIDs[i];let sortBy=jQuery("#raidList"+listId).find('input[name="sort"]').val();listConfigs.push({id:parseInt(listId),sortField:sortBy,sortDirection:this.data[listId].directions[sortBy]})}this.loadLists(listConfigs)},refreshList:function(b){if(typeof this.data[b]!=="undefined"){let sortBy=jQuery("#raidList"+b).find('input[name="sort"]').val();this.loadLists([{id:b,sortField:sortBy,sortDirection:this.data[b].directions[sortBy]}])}},loadLists:function(b){let $this=this;for(let i=b.length-1;i>=0;i--){let expandCollapseSwitch=jQuery("#raidList"+b[i].id+" .expandCollapse");if(typeof $this.data[b[i].id]!=="undefined"&&expandCollapseSwitch.hasClass("collapsed")){delete $this.data[b[i].id];b.splice(i,1)}else{expandCollapseSwitch.addClass("loading")}}if(b.length>0){Travian.api("ajax/raidListSlots",{data:{listConfigs:b},success:function(c){for(let i=0;
i<c.lists.length;i++){let listData=c.lists[i];let listId=listData.id;let list=jQuery("#raidList"+listId);let expandList=typeof $this.data[listId]==="undefined";$this.data[listId]=listData.list;let listContent=list.find(".raidListContent");listContent.html(listData.html);let expandCollapseSwitch=list.find(".expandCollapse");expandCollapseSwitch.removeClass("loading");list.find("input[name=sort]").val(listData.sort);list.find("input[name=direction]").val(listData.direction);$this.updateTroopSummaryForAList(listId);if(typeof b[i].startedRaids!=="undefined"){let feedback=list.find(".feedback");feedback.find("td span").html(b[i].startedRaids);feedback.show();list.find(".selectedTroops").hide()}if(expandList&&listContent.hasClass("hide")){listContent.removeClass("hide");expandCollapseSwitch.removeClass("collapsed").addClass("expanded")}}Travian.Tip.refresh()},error:$this.onError})}return this},showCreateNewList:function(b){var c=this;Travian.api("ajax/raidList",{data:{method:"actionAddListForm",did:b},success:function(d){c.dialog({buttonOk:false,context:"createNewList"},d.html)
},error:c.onError})},createNewList:function(){let did=jQuery('input[name="villageId"]').val();var b={did:did,listName:jQuery('input[name="listName"]').val(),method:"actionAddList",t1:jQuery('#raidListCreate input[name="t1"]').val(),t2:jQuery('#raidListCreate input[name="t2"]').val(),t3:jQuery('#raidListCreate input[name="t3"]').val(),t4:jQuery('#raidListCreate input[name="t4"]').val(),t5:jQuery('#raidListCreate input[name="t5"]').val(),t6:jQuery('#raidListCreate input[name="t6"]').val(),t7:jQuery('#raidListCreate input[name="t7"]').val(),t8:jQuery('#raidListCreate input[name="t8"]').val(),t9:jQuery('#raidListCreate input[name="t9"]').val(),t10:jQuery('#raidListCreate input[name="t10"]').val()};var c=this;Travian.api("ajax/raidList",{data:b,success:function(d){if(d.validation_message){jQuery("#raidListCreate #error").html(d.validation_message)}else{Travian.WindowManager.closeByContext("createNewList");if(jQuery("#raidList").length>0){jQuery("#raidList .villageWrapper[data-did="+did+"]").append(d.listHTML);
c.enableDragAndDropSorting();if(d.maxRaidListsReached===true){jQuery("a.createNew:not(.disabled)").addClass("hidden");jQuery("a.createNew.disabled").removeClass("hidden")}}}},error:c.onError});jQuery("#raidList .attackInfoIcon").remove()},deleteList:function(b){var c=this;if(c.doubleClickPreventer===null){c.doubleClickPreventer=new Travian.DoubleClickPreventer()}if(!c.doubleClickPreventer.check()){return}Travian.api("ajax/raidList",{data:{method:"actionDeleteList",listId:b},success:function(){Travian.WindowManager.closeByContext("deleteList");Travian.WindowManager.closeByContext("updateList");jQuery("#raidList"+b).parent(".dropContainer").remove();delete c.data[b];jQuery("a.createNew:not(.disabled)").removeClass("hidden");jQuery("a.createNew.disabled").addClass("hidden")},error:c.onError})},showUpdateList:function(b){var c=this;Travian.api("ajax/raidList",{data:{method:"actionUpdateListForm",listId:b},success:function(d){c.dialog({buttonOk:false,context:"updateList"},d.html)},error:c.onError})
},updateList:function(b){let $this=this;let newSortIndex=jQuery('#raidListUpdate input[name="sortIndex"]').val();let data={method:"actionUpdateList",listId:b,listName:jQuery('input[name="listName"]').val(),t1:jQuery('#raidListUpdate input[name="t1"]').val(),t2:jQuery('#raidListUpdate input[name="t2"]').val(),t3:jQuery('#raidListUpdate input[name="t3"]').val(),t4:jQuery('#raidListUpdate input[name="t4"]').val(),t5:jQuery('#raidListUpdate input[name="t5"]').val(),t6:jQuery('#raidListUpdate input[name="t6"]').val(),t7:jQuery('#raidListUpdate input[name="t7"]').val(),t8:jQuery('#raidListUpdate input[name="t8"]').val(),t9:jQuery('#raidListUpdate input[name="t9"]').val(),t10:jQuery('#raidListUpdate input[name="t10"]').val(),sortIndex:newSortIndex};Travian.api("ajax/raidList",{data:data,success:function(c){if(c.validation_message){jQuery("#raidListUpdate #error").html(c.validation_message)}else{Travian.WindowManager.closeByContext("updateList");$this.refreshListHeaders(false,b,null);let listElement=jQuery("#raidList"+b);
if(listElement.length>0){let indexFrom=parseInt(listElement.parent(".dropContainer").data("sortindex"));let indexTo=parseInt(newSortIndex);if(indexFrom!==indexTo){listElement.parents(".villageWrapper").find(".dropContainer[data-sortindex="+indexTo+"]").append(listElement);let allLists=listElement.parents(".villageWrapper").find(".raidList");if(indexTo>indexFrom){allLists.each(function(){let list=jQuery(this);if(list.data("listid")!==b){let dropContainer=list.parent(".dropContainer");let index=dropContainer.data("sortindex");if(index>indexFrom&&index<=indexTo){dropContainer.prev(".dropContainer").append(list)}}})}else{allLists.each(function(){let list=jQuery(this);if(list.data("listid")!==b){let dropContainer=list.parent(".dropContainer");let index=dropContainer.data("sortindex");if(index<indexFrom&&index>=indexTo){dropContainer.next(".dropContainer").append(list)}}})}}}}},error:$this.onError});jQuery("#raidList .attackInfoIcon").remove()},markSlotsOfAListForRaid:function(b,d,c){c=typeof c!=="undefined"?c:true;
jQuery.each(this.data[b].slots,function(e,f){if(c&&f.isActive||!c){let el=jQuery("#slot"+e);if(typeof f!=="undefined"){f.marked=d;el.prop("checked",d)}}});this.updateTroopSummaryForAList(b);this.toggleEditButtonText(b);this.toggleStateToggleButtonText(b);jQuery("#raidList .attackInfoIcon").remove();return this},markSlotForRaid:function(b,c,d,e){this.data[b].slots[c].marked=d;if(typeof e==="undefined"||e){this.updateTroopSummaryForAList(b)}this.toggleEditButtonText(b);this.toggleStateToggleButtonText(b);jQuery("#raidList .attackInfoIcon").remove();return this},toggleEditButtonText:function(c){var e=jQuery("#raidList"+c+" .editButton");var f=jQuery("#raidList"+c+" .markSlot").length;var b=jQuery("#raidList"+c+" .markSlot:checked").length;var d=b>0&&f!==b?e.data("selected-text"):e.data("default-text");e.html(d)},toggleStateToggleButtonText:function(c){var e=this.getStateToggleButtonState(c);var d=jQuery("#raidList"+c);var b=d.find(".stateToggleButton");var f={activateSelected:b.data("activate-selected-text"),activateAll:b.data("activate-default-text"),deactivateSelected:b.data("deactivate-selected-text"),deactivateAll:b.data("deactivate-default-text")};
b.html(f[e])},getStateToggleButtonState:function(c){var f=jQuery("#raidList"+c);var g=f.find(".markSlot").length;var d=f.find(".markSlot:checked");var b=d.length;var h=f.find(".slotInactive").length;var e=0;d.each(function(){if(jQuery(this).parents(".slotInactive").length>0){e++}});if(b>0&&g!==b){return e>0?"activateSelected":"deactivateSelected"}else{if(g===b){return e>0?"activateAll":"deactivateAll"}else{return h>0?"activateAll":"deactivateAll"}}},toggleSlotsState:function(e){var j=this;var b=j.getStateToggleButtonState(e);var c=b==="activateSelected"||b==="activateAll"?"active":"inactive";var g=jQuery("#raidList"+e);var f=g.find(".markSlot");var d=g.find(".markSlot:checked");var h=d.length>0?d:f;var k=[];h.each(function(){k.push(parseInt(jQuery(this).data("slot")))});Travian.api("ajax/raidList",{data:{method:"toggleSlotsState",slotState:c,slots:k},success:function(){j.refreshList(e)},error:j.onError})},setData:function(b){this.data=b},sort:function(b,c){this.closeLastRaidSorting(b);return this.loadLists([{id:b,sortField:c,sortDirection:this.data[b].directions[c]!=="asc"?"asc":"desc"}])
},toggleList:function(b){var c=jQuery("#raidList"+b+" .expandCollapse").hasClass("expanded")?false:true;if(typeof this.data[b]==="undefined"){this.loadLists([{id:b}])}else{var d=jQuery("#raidList"+b);d.find(".expandCollapse").toggleClass("collapsed").toggleClass("expanded");let raidListContent=d.find(".raidListContent");raidListContent.toggleClass("hide");if(raidListContent.hasClass("hide")){d.find("input[type=checkbox]").prop("checked",false)}}this.updateExpandedList(b,c);jQuery("#raidList .attackInfoIcon").remove();return this},collapseList:function(b){var c=jQuery("#raidList"+b);c.find(".expandCollapse").addClass("collapsed").removeClass("expanded");c.find(".raidListContent").addClass("hide");c.find("input[type=checkbox]").prop("checked",false)},updateTroopSummaryForAList:function(d){var g=this;var b=[0,0,0,0,0,0,0,0,0,0,0];var e=0;var f=jQuery("#raidList"+d);var c=f.find(".feedback").hide();f.find(".selectedTroops").show();jQuery.each(this.data[d].slots,function(h,k){if(k.marked){e++;
for(var j=1;j<=10;j++){b[j]+=k.troops[j]}}});f.find(".selectedCount").html(Travian.Translation.translate("{raidList.selected}").replace("[COUNT]",e));if(e>0){f.find(".equals span").show()}else{f.find(".equals span").hide()}f.find(".troopSelectionUnit").each(function(h,j){j=jQuery(j);let troopIndex=h+1;if(b[troopIndex]>0){let troopsInVillageCount=Travian.i18n.clearDirection(j.find(".troopsInVillage").text());let denominatorClass="troopsInVillage";if(b[troopIndex]>parseInt(troopsInVillageCount)){denominatorClass+=" alert"}j.find("span").html(Travian.i18n.Ratio(b[troopIndex],troopsInVillageCount,{nominatorClass:"troopSelectionValue",denominatorClass:denominatorClass}));j.show()}else{j.hide()}});return this},confirm:function(c,b){let $this=this;b=typeof b!=="undefined"?b:false;let form=jQuery(c).closest("form");let lid=form.find('input[name="lid"]').val();Travian.api("ajax/raidListCaptcha",{data:{lid:lid,attempt:b?"retry":"new"},success:function(d){if(!d.captchaIsNeeded){$this.startRaid(lid)
}else{$this.dialog({buttonOk:false,darkOverlay:true,context:"raidListCaptcha"},d.html)}}})},RaidSlot:function(d,c,b){this.slots=d;this.context=c;this.targets=b;this.updateRaidList=function(){var e=jQuery("#xCoordInput").val();var f=jQuery("#yCoordInput").val();this.update({listId:this.getSelectedListId(),x:e,y:f})};this.updateTargetId=function(){var e=jQuery("#target_id").val();var f=this.targets.find(function(g){return g.did==e});if(f){jQuery("#xCoordInput").val(f.x);jQuery("#yCoordInput").val(f.y);this.update({listId:this.getSelectedListId(),x:f.x,y:f.y})}};this.update=function(e){var g=this;var f=Object.assign({method:"actionCheckSlotExists",slots:this.slots,context:this.context},e);Travian.api("ajax/raidList",{data:f,success:function(h){if(h.update){Travian.WindowManager.getWindowsByContext("raidAddSlotDialog").pop().setContent(h.html)}},error:g.onError})};this.getSelectedListId=function(){return jQuery("select#lid option:selected").val()}},updateListSortIndex:function(b,c,e,d){var f=this;
Travian.api("ajax/raidList",{data:{method:"actionUpdateListSortIndex",listId:b,indexFrom:c,indexTo:e,did:d},success:function(g){},error:f.onError})},enableDragAndDropSorting:function(){jQuery(function(){jQuery(".dragAndDrop").off("mousedown touchstart").on("mousedown touchstart",function(f){f.preventDefault();var e=jQuery(this).parents(".raidList");Travian.Game.RaidList.collapseList(e.data("listid"));e.addClass("dragged");var d=e.clone();d.attr("id","dragElement");d.css({width:e.width()});e.parents(".dropContainer").prepend(d);c(f);jQuery(".villageWrapper").addClass("inactive");e.parents(".villageWrapper").removeClass("inactive");Travian.Game.RaidList.closestDropContainer=e.parents(".dropContainer")});jQuery(window).on("mousemove touchmove",function(f){var e=jQuery(".raidList.dragged");if(e.length>0){c(f);var d=b(f);Travian.Game.RaidList.closestDropContainer=e.parents(".dropContainer");e.parents(".villageWrapper").find(".dropContainer").each(function(){var k=jQuery(this);var j=Math.abs(d.y-k.offset().top-k.height()/2);
var h=Math.abs(d.y-Travian.Game.RaidList.closestDropContainer.offset().top-Travian.Game.RaidList.closestDropContainer.height()/2);if(j<h){Travian.Game.RaidList.closestDropContainer=k}});jQuery(".dropContainer").removeClass("highlightDropSection");if(parseInt(Travian.Game.RaidList.closestDropContainer.find(".raidList").data("listid"))!==parseInt(e.data("listid"))){var g=parseInt(Travian.Game.RaidList.closestDropContainer.data("sortindex"))>parseInt(e.parent(".dropContainer").data("sortindex"))?"down":"up";Travian.Game.RaidList.closestDropContainer.removeClass("up").removeClass("down").addClass("highlightDropSection "+g)}}});jQuery(window).on("mouseup touchend",function(){var f=jQuery(".raidList.dragged");if(f.length>0){var j=parseInt(f.parents(".dropContainer").data("sortindex"));var h=parseInt(Travian.Game.RaidList.closestDropContainer.data("sortindex"));var l=parseInt(f.parents(".villageWrapper").data("did"));Travian.Game.RaidList.closestDropContainer.append(f);Travian.Game.RaidList.updateListSortIndex(parseInt(f.data("listid")),j,h,l);
var m=Travian.Game.RaidList.closestDropContainer.parents(".villageWrapper").find(".raidList");if(h>j){m.each(function(){var o=jQuery(this);if(o.data("listid")!==f.data("listid")){var p=o.parent(".dropContainer");var n=p.data("sortindex");if(n>j&&n<=h){p.prev(".dropContainer").append(o)}}})}else{m.each(function(){var o=jQuery(this);if(o.data("listid")!==f.data("listid")){var p=o.parent(".dropContainer");var n=p.data("sortindex");if(n<j&&n>=h){p.next(".dropContainer").append(o)}}})}var d=jQuery("#dragElement");var g=Travian.Game.RaidList.closestDropContainer.find(".raidList:not(#dragElement)");g.addClass("hidden");var k=g.offset();var e=jQuery(window).scrollTop();d.animate({left:k.left,top:k.top-e},250);setTimeout(function(){g.removeClass("hidden");d.remove()},250);jQuery(".villageWrapper").removeClass("inactive");f.removeClass("dragged");jQuery(".dropContainer").removeClass("highlightDropSection")}});var b=function(f){var e=f.pageX;var d=f.pageY;if(typeof d==="undefined"){e=f.originalEvent.touches[0].pageX;
d=f.originalEvent.touches[0].pageY}return{x:e,y:d}};var c=function(e){var f=b(e);var g=jQuery(window).scrollTop();var d=jQuery("#dragElement");var m=d.offset();var h=d.find(".dragAndDrop svg");var l=h.offset();var k=m.left-l.left+h.width()/2;var j=l.top-m.top+h.height()/2+g;d.css({left:f.x+k,top:f.y-j})}})},enableClickSorting:function(d){var c=jQuery(".sortContainer");var j,h,e=null;var g=1;jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,function(k,l){if(parseInt(l.id)===parseInt(d)){j=l}if(parseInt(l.sortIndex)>g){g=parseInt(l.sortIndex)}});c.find(".moveUp").on("click",function(m){m.preventDefault();var k=parseInt(j.sortIndex);var l=k-1;if(k>1){h=null;e=null;jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,function(n,o){var p=parseInt(o.sortIndex);if(p<k&&p>=l){o.sortIndex=p+1}if(parseInt(o.id)===parseInt(j.id)){o.sortIndex=l;j.sortIndex=l}});f()}});c.find(".moveDown").on("click",function(m){m.preventDefault();var k=parseInt(j.sortIndex);var l=k+1;if(k<g){h=null;e=null;
jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,function(n,o){var p=parseInt(o.sortIndex);if(p>k&&p<=l){o.sortIndex=p-1}if(parseInt(o.id)===parseInt(j.id)){o.sortIndex=l;j.sortIndex=l}});f()}});var b=function(){jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,function(k,l){var m=parseInt(l.sortIndex);if(m===j.sortIndex-1){h=l}if(m===j.sortIndex+1){e=l}})};var f=function(){b();var m=c.find(".listBefore");m.find(".sortIndex").html(h!==null?h.sortIndex:"");m.find(".listName").html(h!==null?h.name:"");var l=c.find(".listCurrent");l.find(".sortIndex").html(j.sortIndex);var n=c.find(".listAfter");n.find(".sortIndex").html(e!==null?e.sortIndex:"");n.find(".listName").html(e!==null?e.name:"");var k=c.find(".moveUp").removeClass("disabled");if(j.sortIndex===1){k.addClass("disabled")}var o=c.find(".moveDown").removeClass("disabled");if(j.sortIndex===g){o.addClass("disabled")}jQuery('#raidListUpdate input[name="sortIndex"]').val(j.sortIndex)}},openLastRaidSorting:function(b){var c=this;
var d=jQuery("#raidList"+b).find("nav.lastRaidSorting");d.addClass("open");d.on("click",function(f){if(jQuery(f.target).is(d)){c.closeLastRaidSorting(b)}})},closeLastRaidSorting:function(b){var c=jQuery("#raidList"+b).find("nav.lastRaidSorting");c.removeClass("open");c.off("click")},updateExpandedList:function(b,c){var d=this;Travian.api("ajax/raidList",{data:{method:"updateListExpandedStatus",listId:b,isExpanded:c},success:function(){},error:d.onError})}};Travian.Game.Reports={editRights:function(c,b){Travian.api("ajax/reportRightsGet",{data:{reportId:b.datas.reportId},success:function(g){b.datas=Object.assign({},b.datas||{},g||{});var e='<div class="reports" id="editRights"><div><label><input type="checkbox" id="right1" class="check" /> {anonymOpponent}</label></div><div><label><input type="checkbox" id="right2" class="check" /> {anonymMyself}</label></div><div><label><input type="checkbox" id="right3" class="check" /> {hiddenOwnTroops}</label></div><div><label><input type="checkbox" id="right4" class="check" /> {hiddenOtherTroops}</label></div><div class="description">{description}<br /><textarea id="description"></textarea></div></div>';
var f=Travian.Helpers.substitute(e,b.text);var d=new Travian.Dialog.Dialog({relativeTo:c,buttonTextOk:b.text.buttonTextOk,title:b.text.title,preventFormSubmit:true,onOpen:function(h,j){jQuery("#right1").prop("checked",b.datas.right1);jQuery("#right2").prop("checked",b.datas.right2);jQuery("#right3").prop("checked",b.datas.right3);jQuery("#right4").prop("checked",b.datas.right4);jQuery("#description").html(b.datas.description)},onOkay:function(h,j){Travian.api("ajax/reportRightsSet",{data:{data:Object.assign({},b.datas,{right1:jQuery("#right1").prop("checked"),right2:jQuery("#right2").prop("checked"),right3:jQuery("#right3").prop("checked"),right4:jQuery("#right4").prop("checked"),description:jQuery("#description").val()})}});return false}});d.setContent(f);d.show()}});return false}};var reload_enabled=true;var auto_reload=1;var delayTimeForReload=0;var resources={};Travian.TimersAndCounters={timeCounters:[],resourceCounters:{},pathReload:"reload=auto",timeToInt:function(b){var d,c;d=b.split(":");
c=d[0]*3600+d[1]*60+d[2]*1;return c},intToTime:function(d,h,f){var b,g,c,e;if(d<(0-delayTimeForReload-1)){e=h?"0:00:0?":(Travian.Game.eventJamHtml||"0:00:0?")}else{d=Math.max(0,d);b=Math.floor(d/3600);if(f==="12h"&&b===0){b=12}g=Math.floor(d/60)%60;c=d%60;e=b+":";if(g<10){e+="0"}e+=g+":";if(c<10){e+="0"}e+=c}return{hour:b,minute:g,second:c,time:e}},init:function(){this.initResourcesCounters();this.initTimers();this.dropReload()},initTimers:function(){this.timeCounters=[];this.initTimersInContext(document)},initTimer:function(e){var c,b;var d=e.getAttribute("format");switch(e.getAttribute("counting")){case"down":c=parseInt(e.getAttribute("value"))||0;b={node:e,value:c,counting:"down",startedAt:Math.floor(Date.now()/1000),reloadDelay:c<delayTimeForReload?delayTimeForReload*1000:0,inReload:false};break;default:b={node:e,value:this.timeToInt(e.innerHTML||"00:00:00"),counting:"up",startedAt:Math.floor(Date.now()/1000),inReload:false,format:d};break}this.updateTimerValue(b);if(b.value>-1){this.timeCounters.push(b)
}},initTimersInContext:function(c){var b,d=c.getElementsByClassName("timer");for(b=0;b<d.length;b++){this.initTimer(d[b])}this.executeTimers()},updateTimer:function(d,c){var b=this.timeCounters.find(function(e){return e.node===d});if(b){b.value=parseInt(c);b.startedAt=Math.floor(Date.now()/1000)}},updateTimerValue:function(h){var d=Math.floor(Date.now()/1000)-h.startedAt;var c;var f=false;var e;var g;var b;switch(h.counting){case"down":c=h.value-d;e=this.intToTime(c);h.node.innerHTML=e.time;h.node.setAttribute("value",c);if(c<1){f=true}break;case"up":g=h.format=="12h"?(h.value+d)%43200:(h.value+d)%86400;e=this.intToTime(g,null,h.format);h.node.innerHTML=e.time;if(h.format=="12h"&&e.hour===12&&e.minute===0&&e.second===0){b=jQuery(h.node).next();if(b.length>0){b[0].innerHTML=b[0].innerHTML.indexOf("pm")!==-1?" am":" pm"}}break}return f},executeTimers:function(){if(this.timeCounters.length>0){window.setTimeout("Travian.TimersAndCounters.executeTimers()",1000)}for(var b=0;b<this.timeCounters.length;
b++){var c=this.timeCounters[b];if(this.updateTimerValue(c)&&!c.inReload&&window.reload_enabled){c.inReload=true;this.processReload(c.reloadDelay)}}},initResourcesCounters:function(){this.resourceCounters={};this.initResourcesCounter("l1","lbar1");this.initResourcesCounter("l2","lbar2");this.initResourcesCounter("l3","lbar3");this.initResourcesCounter("l4","lbar4")},initResourcesCounter:function(b,f){var c=document.getElementById(b),d=document.getElementById(f);try{var h=resources.production[b];if(h===0){this.updateResourceCounter(c,d,resources.storage[b])}else{this.resourceCounters[b]={startInMs:Date.now(),production:h,initialResources:resources.storage[b],maximumResources:resources.maxStorage[b],minimumResources:0,tickInMs:Math.max(Math.round(Math.abs(3600000/h)),100),bar:d,node:c};this.executeCounter(b)}}catch(g){}},updateResourceCounter:function(b,c,f){var g=new Travian.Formatter({forceDecimal:false});b.innerHTML=g.getFormattedNumber(f);var e=jQuery(c);if(e.length>0){var d=Math.round(100*f/resources.maxStorage[b.id]);
e.removeClass("stockFull");if(f>=resources.maxStorage[b.id]){e.addClass("stockFull")}e.css({width:d+"%"})}},executeCounter:function(e){var c=this.resourceCounters[e];var b=Date.now()-c.startInMs;var d=Math.floor(c.initialResources+b*(c.production/3600000));switch(true){case (d>=c.maximumResources):d=c.maximumResources;break;case (d<=c.minimumResources):d=c.minimumResources;break;default:window.setTimeout("Travian.TimersAndCounters.executeCounter('"+e+"')",c.tickInMs)}resources.storage[e]=d;this.updateResourceCounter(c.node,c.bar,d)},dropReload:function(){var d,c,e,b;d=document.location.href;c=document.location.hash;if(c!==""){b=d.indexOf(c);d=d.substring(0,b)}e=d.indexOf(this.pathReload);if(e!==-1){d=d.substring(0,e-1)+c;window.history.pushState({id:d},"",d)}},processReload:function(c){var b;switch(auto_reload){case 0:case 1:b=this.reload;break;case 2:if(typeof window.customReload==="function"){b=window.customReload}else{b=this.reload}break}var d=this.pathReload;setTimeout(function(){b(d)
},c+1000)},reload:function(b){var d=window.location.href,c;if((c=d.indexOf("#"))!==-1){d=d.substring(0,c)}if(d.indexOf(b)===-1){if(d.indexOf("?")===-1){d+="?"+b}else{d+="&"+b}}window.location.href=d},enableReloadEvent:function(){window.reload_enabled=true},suppressReloadEvent:function(){window.reload_enabled=false}};Travian.Game.Hero={};Travian.Game.Hero.Editor=function(){var b=null;return function(c){this.unloadIdentifier=null;this.options=Object.assign({element:null,command:null,attributes:null,urlHeroImage:null,elementHeroImage:null},c);this.hideAll=function(){var d=this.options.element.find(".attributes .container .infoOpen").removeClass("infoOpen");d.find(".headline").removeClass("switchOpened").addClass("switchClosed");this.options.element.find(".attributes .container .details").hide();return this};this.initialize=function(){var f=this;f.initializeAttributes();var e=f.options.element.find("#save");if(e!==null){e.on("click",function(g){f.sendAction("save",function(){var h=Travian.parseURL(f.options.urlHeroImage);
delete (h.searchObject.code);h.searchObject.time=(new Date()).getTime();jQuery("."+f.options.elementHeroImage).attr("src",Travian.composeURI(h))});g.preventDefault()})}var d=f.options.element.find("#random");if(d!==null){d.off("click",b);b=function(g){f.sendAction("random");g.preventDefault()};d.on("click",b)}this.bindGenderSwitch();this.storeAttributesInInput(this.options.attributes)};this.initializeAttributes=function(){var d=this;if(typeof d.options.element!=="object"){d.options.element=jQuery("#"+this.options.element)}this.hideAll();this.options.element.find(".attributes .container .info .headline").on("click",function(e){e.preventDefault();d.showAttribute(jQuery(this).parent(".info"))});this.options.element.find(".attributes .container .attribute").on("click",function(g){var h=parseInt(g.target.id.split("attribute_button_")[1]);var f=jQuery(g.target).parents(".info").attr("id");d.options.attributes[f]=h;d.sendAction("show");g.preventDefault()})};this.sendAction=function(d,f){if(d==="save"){Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier)
}else{this.unloadIdentifier=Travian.Form.UnloadHelper.enableSecurity(this.unloadIdentifier)}var e=this;Travian.api("ajax/"+this.options.command,{data:{action:d,attribs:this.options.attributes},success:function(g){jQuery(".hero_head .image").html(g.html);if(g.attributesHtml){jQuery("#attributesContainer").html(g.attributesHtml);e.initializeAttributes()}e.options.attributes=g.attributes;e.storeAttributesInInput(g.attributes);(f||Travian.emptyFunction)()}});return this};this.showAttribute=function(d){d=jQuery(d);var e=d.hasClass("infoOpen");this.hideAll();if(!e){d.addClass("infoOpen");d.find(".headline").removeClass("switchClosed").addClass("switchOpened");d.find(".details").show()}return this};this.storeAttributesInInput=function(e){var d=this.options.element.find("input[name=attributes]");if(d!==null){d.val(encodeURI(JSON.stringify(e)))}return this};this.switchGender=function(d){if(this.options.element.hasClass("genderSwitch")){jQuery("#heroEditorActivateMale, #heroEditorActivateFemale").removeClass("iconActive disabled");
if(d==="male"){this.options.element.removeClass("female").addClass("male");jQuery("#heroEditorActivateMale").addClass("iconActive disabled")}else{this.options.element.removeClass("male").addClass("female");jQuery("#heroEditorActivateFemale").addClass("iconActive disabled")}}this.options.attributes.gender=d;this.sendAction("gender")};this.bindGenderSwitch=function(){var d=this;jQuery("#heroEditorActivateMale, #heroEditorActivateFemale").on("click",function(f){if(jQuery(this).attr("id")==="heroEditorActivateMale"&&d.options.element.hasClass("male")===false){d.switchGender("male")}else{if(jQuery(this).attr("id")==="heroEditorActivateFemale"&&d.options.element.hasClass("female")===false){d.switchGender("female")}}f.preventDefault()})};this.initialize()}}();Travian.Game.Hero.Editor.constructor=Travian.Game.Hero.Editor;Travian.Game.Hero.Inventory=function(b){this.dragStatus=false;this.isClicked=false;this.dropOnSlotFailed=false;this.items=[];this.options=Object.assign({did:null,c:null,gender:"male",heroState:{},isInVillage:true,isDead:false,data:[],heroBodyHash:false,images:"img/hero/items/item{typeId}.png",text:{}},b);
this.startDrop=false;this.DoubleClickPreventer=null;this.createAndAddItem=function(c){var d=Object.assign({placeElement:undefined,html_id:"item_"+c.id},c||{});if(JSON.stringify(this.items).indexOf(JSON.stringify(d))===-1){this.items.push(d)}return this};this.createDivs=function(){var f=this;var g=jQuery("#placeHolder");var e=function(j){if(f.dropOnSlotFailed){f.dropOnSlotFailed=false;return}if(!f.DoubleClickPreventer){f.DoubleClickPreventer=new Travian.DoubleClickPreventer()}var h=Travian.isMobile()||f.DoubleClickPreventer.check();if(j.isUseable&&h){if(!Travian.isMobile()||(j.clickedFirstTime&&Travian.isMobile())){Travian.Tip.hide();f.moveToMatchingPlace(j)}else{if(f.startDrop!==true){f.mark(j.slot)}j.clickedFirstTime=true}}};var d=function(h){f=this;if(h.isUseable){if(f.startDrop!==true){f.mark(h.slot)}}};var c=function(h){f=this;if(h.isUseable){if(f.startDrop!==true){f.unMark(h.slot)}}};jQuery.each(this.items,function(j,m){m.isUseable=f.options.isInVillage||m.isConsumable||m.slot==="bag";
if(f.options.isDead&&!m.isUsableIfDead){m.isUseable=false}var l="";if(!m.isUseable){l=(f.options.isDead?f.options.text.notMoveableTextDead:f.options.text.notMoveableText)+"<br />"}l+=m.attributes.join("<br />");var k=jQuery("<div></div>").attr("id","item_"+m.id).addClass("item "+f.options.gender+"_item_"+m.typeId+" "+(m.isUseable?"":"disabled")).css("position","relative").html('<div class="amount">'+m.amount+"</div>").on({click:jQuery.proxy(e,f,m),mouseover:jQuery.proxy(d,f,m),mouseout:jQuery.proxy(c,f,m)}).appendTo(g);Travian.Tip.set(k,{unescaped:true,title:"("+m.amount+") "+m.name,text:l});k[0].item=m;k[0].item.element=k;var h=null;if(m.placeId<0){h=jQuery("#"+m.slot);k.addClass("onHero")}else{h=jQuery("#inventory_"+m.placeId)}h.addClass(m.isUseable?"":"disabled");f.moveToDrop(k,h,true)});this.makeDraggable();this.options.elementHeroBody[0].src=String(this.options.urlBodyImage).replace((/\\?\{([^{}]+)\}/g),jQuery.proxy(this.substitute,{heroBodyHash:f.options.heroBodyHash}));return this
};this.substitute=function(d,c){if(d.charAt(0)==="\\"){return d.slice(1)}return(this[c]!=null)?this[c]:""};this.dialog=function(c,g){var h=this;var k=c.text;var f=c.amount;var j=c.amount;var e=c.calculate;delete (c.text);delete (c.amount);delete (c.calculate);c.onOpen=function(n,o){var m=o.children("input#amount.text");if(m.length>0){var l=function(y){if(e){var z=1+e.bonusPercent/100;var p=y*Math.round(e.valuePerItem*z);var t=y*e.valuePerItem;var q=p-t;var v;var u=o.find(".displayUseValue");var x=o.find(".displayUseBonusP");var r=o.find(".displayUseBonus");var s=o.find(".displayAfterUse");if(u.length>0){u.html(t)}if(x.length>0){x.html(e.bonusPercent)}if(r.length>0){r.html(q)}if(s.length>0){if(e.maxValue){v=Math.min(e.currentValue+p,e.maxValue)}else{v=e.currentValue+p}s.html(v)}}};m.val(f);l(f);n.makeInputAmountable(m,j,l.bind(h))}return true};c.onClose=function(){h.isClicked=false;h.resetItemDrop(g)};c=Object.assign(c,{buttonTextOk:this.options.text.buttonOk});k=String(k).replace((/\\?\{([^{}]+)\}/g),jQuery.proxy(this.substitute,{inputField:'<input class="text" id="amount" type="text" value="0" autocomplete="off" />',equipmentBonus:'<span class="displayUseBonusP">0</span>'}));
var d=new Travian.Dialog.Dialog(c);d.setContent(k);d.show();return this};this.executeMovement=function(f,d,c){var e=this;Travian.api("inventory",{data:{action:"inventory",id:f,drid:d,amount:c,clicked:e.isClicked,did:this.options.did,c:this.options.c},success:function(m){e.isClicked=false;e.options.c=m.checkSum;e.options.heroState=Object.assign(e.options.heroState,m.heroState||{});if(m.heroBodyHash){e.options.heroBodyHash=m.heroBodyHash}jQuery.each(e.items,function(p,q){jQuery("#"+q.html_id).remove()});e.items=[];jQuery.each(m.items,function(p,q){e.createAndAddItem(q)});jQuery(".inventory").each(function(p,q){jQuery(q).remove()});var o=m.inventorySize;if(m.heroData.freePoints>0){jQuery("div.hero_inventory .attribute .setPoint").show()}for(var j=1,h=null;j<=o;j++){h=jQuery("<div></div>").attr("id","inventory_"+j).addClass("inventory draggable").insertBefore(jQuery("#itemsToSale").find(".market"))}e.createDivs();var l=jQuery("#attributes");var k=jQuery(".heroHealthBarBox");var g=jQuery(".heroXpBarBox");
jQuery.each(m.heroData,function(x,u){var p=l.find("."+x);if(p.length>0){var y=p.find(".current");var v=p.find(".progress .bar").not(".setted");var s=p.find(".points");var q=p.find(".tooltip");if(p.hasClass("res")){var r=jQuery("#setResource").find(".resource label .current");jQuery(r).each(function(z,A){jQuery(A).html(u["resourceHero"+z])})}if(p.hasClass("tooltip")){q.push(p)}if(y.length>0&&y.find(".value").length>0){y=y.find(".value")}if(typeof u.current!=="undefined"&&y.length>0){y.html(u.current)}if(typeof u.percent!=="undefined"&&v.length>0){var t=x!=="experience"?u.percent:Math.ceil(u.percent);v.css("width",t+"%");if(typeof u.backgroundColor!=="undefined"){v.css("backgroundColor",u.backgroundColor)}if(typeof u.points!=="undefined"&&s.length>0){if(s.find("input").length>0){s.find("input").val(u.points)}else{s.html(u.points)}}if(typeof u.tooltip!=="undefined"&&q.length){jQuery.each(q,function(z,A){jQuery(A).attr("title",u.tooltip);Travian.Tip.refresh()})}}}});if(l[0].className!=="hero-dead"){l.find(".experience").find(".value").html(m.heroData.experience.current);
var n=l.find(".health");if(n.length>0){n.find(".value").html(m.heroData.health.percent+"%");n.find(".bar").css("width",m.heroData.health.percent+"%")}k.prop("title",m.heroData.health.tooltipSidebar);k.find(".bar").css("width",m.heroData.health.percent+"%");g.prop("title",m.heroData.experience.tooltipSidebar);g.find(".bar").css("width",m.heroData.experience.percent+"%")}if(typeof e.DoubleClickPreventer!=="undefined"){e.DoubleClickPreventer.cancelTimer()}e.dragStatus=false;if(e.options.afterRequestCallback[m.itemTypeId]){e.options.afterRequestCallback[m.itemTypeId](e,e.options,c,m)}},error:function(g){new Travian.Dialog.Dialog({preventFormSubmit:true}).setContent(g.errorMsg).show()}});return this};this.initialize=function(){var c=this;jQuery.each(this.options.data,function(d,e){c.createAndAddItem(e)});this.createDivs()};this.isInventoryId=function(c){return c.substr(0,9)==="inventory"};this.makeDraggable=function(){var d=this;var c=jQuery(".draggable");var e=jQuery("#text");jQuery(".item").each(function(f,g){if(g.item.isUseable===false){return
}if(!Travian.isMobile()){jQuery(g).on("mousedown",function(j){d.dropOnSlotFailed=false;j.preventDefault();d.startDrop=true;var h=this;h.item.dragOrigin=jQuery(this).parent(".draggable");jQuery("body").on("mousemove.inventoryItem",function(l){if(!d.startDrop){return}if(!d.dragStatus&&j.pageX===l.pageX&&j.pageY===l.pageY){return}d.dragStatus=true;jQuery("#content").children().css({userSelect:"none"});var k=jQuery(h);k.offset({left:l.pageX-k.width()/2,top:l.pageY-k.height()/2});k.addClass("whileDragging").removeClass("onHero")})});jQuery(g).on("mouseup",function(k){jQuery("#content").children().css({userSelect:"auto"});jQuery("body").off("mousemove.inventoryItem");if(!d.dragStatus){d.startDrop=false;return false}var j=jQuery(this);var l=this.item;var h=k.pageX;var o=k.pageY;var m=false;var n=false;jQuery(c).each(function(p,q){if(!n){q=jQuery(q);var u=q.offset();var s=u.left;var r=u.left+q.width();var v=u.top;var t=u.top+q.height();if(h>=s&&h<=r&&o>=v&&o<=t){n=true;if(d.isInventoryId(q.prop("id"))){d.moveToDrop(j,q,false);
m=true}else{if(l.slot===q.attr("id")){d.moveToDrop(j,jQuery("#"+l.slot),false);m=true}}}}});if(!m){if(!d.isInventoryId(l.dragOrigin[0].id)){j.addClass("onHero")}d.dragStatus=false;d.dropOnSlotFailed=true;d.moveToDrop(j,l.dragOrigin,true)}j.removeClass("whileDragging");Travian.Tip.hide();m=false;d.startDrop=false})}});return this};this.mark=function(c){jQuery("#"+c).addClass("heroMarked");return this};this.moveItem=function(e,c,d){if(d){this.executeMovement(e[0].item.id,c.attr("id"),d)}else{e.detach().appendTo(c);this.resetItemDrop(e);e[0].item.placeElement=jQuery(c)}return this};this.moveToDrop=function(h,e,d){var j=this;var g={title:"",text:"",executeAfterOkay:true,show:true,onOpen:Travian.emptyFunction,onOkay:Travian.emptyFunction,onClose:Travian.emptyFunction,relativeTo:h[0],amount:h[0].item.amount,preventFormSubmit:true};var c=false;h[0].item.dragOrigin=null;var f=function(){if(!g.executeAfterOkay){j.resetItemDrop(h);return}var k;if(d){k=false}else{if(c===true){var l=jQuery("#amount");
k=(l.length>0)?l.val():1}else{k=h[0].item.amount}}j.moveItem(h,e,k)};if(d!==true&&(h[0].item.isConsumable||h[0].item.slot==="bag")&&(j.isClicked||(e&&e.attr("id").substr(0,3)==="bag"))){if(this.options.useOneDialogTitleCallbacks[h[0].item.typeId]){g=Object.assign(g,this.options.useOneDialogTitleCallbacks[h[0].item.typeId](h[0].item,this.options,g)||{})}c=true;if(g.title===""){g.title=h[0].item.name}if(g.text===""){if(h[0].item.isConsumable){if(h[0].item.amount===1){g.text=this.options.text.useOneDialogTitle}else{g.text=this.options.text.useDialogDescription}}else{g.text=this.options.text.moveDialogDescription}}if(g.show){g.onOkay=function(){f();return true};this.dialog(g,h)}}else{f()}return this};this.moveToMatchingPlace=function(c){if(this.dragStatus===false){var d=jQuery("#"+(c.place===c.slot?"inventory":c.slot));this.isClicked=true;this.moveToDrop(c.element,d,false);this.unMark(c.slot)}else{this.dragStatus=false}return this};this.resetItemDrop=function(c){c.css({left:0,top:0});return this
};this.unMark=function(c){jQuery("#"+c).removeClass("heroMarked");return this};this.initialize()};Travian.Game.Hero.SilverExchange=function(b){this.options=Object.assign({exchangeOptions:{directionType:"SilverToGold",showExchangeTypeElement:null,inputElement:null,resultValueElements:[],inputValueElements:[],baseMultiplier:1,maxAmount:null,submitButton:null,submitButton2:null,handleMaxFunction:null,submitButtonClickListener:null},messages:{notEnoughGold:null,autoCorrect:null,disabledSubmitTooltip:null,enabledSubmitTooltip:null,maxAmountTooltip:null},maxAmountChangedFunction:null},b);this.isWaiting=false;this.lastUseTimestamp=0;this.initialize=function(){this.checkFileInputExtension();if(this.options.exchangeOptions.showExchangeTypeElement.length>0){this.assignListenerToShowExchangeType(this.options.exchangeOptions.showExchangeTypeElement)}if(this.options.exchangeOptions.submitButton.length>0&&this.options.exchangeOptions.directionType==="SilverToGold"){var c=this;this.options.exchangeOptions.submitButton.on("click",function(d){c.sendAction(jQuery(this));
d.preventDefault()})}if(this.options.exchangeOptions.inputElement.length>0){this.assignListenerToExchangeInput(this.options.exchangeOptions.inputElement)}};this.checkFileInputExtension=function(){if(jQuery.fn.filterInputTG!==undefined){return false}jQuery.fn.extend({filterInputTG:function(c){var d=c.regex;var f=this;function e(m){var p=0,k=0,o,l,j,h,n;if(typeof m.selectionStart=="number"&&typeof m.selectionEnd=="number"){p=m.selectionStart;k=m.selectionEnd}else{m.focus();l=document.selection.createRange();if(l&&l.parentElement()==m){h=m.value.length;o=m.value.replace(/\r\n/g,"\n");j=m.createTextRange();j.moveToBookmark(l.getBookmark());n=m.createTextRange();n.collapse(false);if(j.compareEndPoints("StartToEnd",n)>-1){p=k=h}else{p=-j.moveStart("character",-h);p+=o.slice(0,p).split("\n").length-1;if(j.compareEndPoints("EndToEnd",n)>-1){k=h}else{k=-j.moveEnd("character",-h);k+=o.slice(0,k).split("\n").length-1}}}}return{start:p,end:k}}function g(o){o=o||event;var m=f.val();var k=0;var n=0;if(o.type=="keypress"){k=o.charCode|k
}else{n=o.keyCode|n}var j=e(o.target);if(k==0&&n!=8&&n!=46){return true}if(k==0&&(n==8||n==46)){if(typeof(c.success)==="function"){var l="";if(j.start==0&&(j.end-j.start)>0){l=m.substr(0,j.start-1)+m.substr(j.end)}else{if(j.end==m.length&&(j.end-j.start)>0){l=m.substr(0,j.start)+m.substr(j.end+1)}else{if((j.end-j.start)>0){l=m.substr(0,j.start)+m.substr(j.end)}else{if((j.end-j.start)==0){if(n==8){l=m.substr(0,j.start-1)+m.substr(j.end)}if(n==46){l=m.substr(0,j.start)+m.substr(j.end+1)}}}}}return c.success.call(this,l)}}var p=m.substr(0,j.start);var h=m.substr(j.end);m=p+String.fromCharCode(k)+h;if(k>0&&d.test(m)){if(typeof(c.success)==="function"){return c.success.call(this,m)}return true}else{if(typeof(c.failure)==="function"){return c.failure.call(this,m)}}return false}return(this.on("keydown",g)&&this.on("keypress",g))}})};this.assignListenerToExchangeInput=function(c){var e=this;var d=function(f){e.hideAllMessages();if(e.options.exchangeOptions.submitButton.length>0&&e.options.exchangeOptions.submitButton2&&e.options.exchangeOptions.submitButton2.length>0){e.options.exchangeOptions.submitButton2.addClass("hide");
e.options.exchangeOptions.submitButton.removeClass("hide")}return e.updateExchangeValue(f)};c.filterInputTG({regex:/^[1-9][0-9]{0,6}$/,success:d});return this};this.updateExchangeValue=function(j){this.setLastUseTimestamp();var f=this.options.exchangeOptions;var d=parseInt(j,10)||0;var h=0;var e="enabledSubmitTooltip";var c=f.handleMaxFunction;var g=true;if(f.maxAmount!==null&&"function"==typeof c&&d>f.maxAmount){h=c.call(this,d);e="maxAmountTooltip";this.updateElementsTooltip(f.submitButton,"maxAmountTooltip");if(f.submitButton2&&f.submitButton2.length>0){this.updateElementsTooltip(f.submitButton2,"maxAmountTooltip")}jQuery("#silverExchange .exchangeType"+this.options.exchangeOptions.directionType+" input").val(d);g=false}else{h=d}h=Math.floor(h*f.baseMultiplier);if(f.submitButton.length>0&&h===0){this.disableElement(f.submitButton);e="disabledSubmitTooltip";if(f.submitButton2&&f.submitButton2.length>0){this.disableElement(f.submitButton2)}}else{if(f.submitButton.length>0){this.enableElement(f.submitButton);
if(f.submitButton2&&f.submitButton2.length>0){this.enableElement(f.submitButton2)}}}this.updateElementsTooltip(f.submitButton,e);if(f.submitButton2&&f.submitButton2.length>0){this.updateElementsTooltip(f.submitButton2,e)}this.setElementsValue(f.resultValueElements,h);this.setElementsValue(f.inputValueElements,d);return g};this.setElementsValue=function(f,e){if(typeof f==="object"&&(f instanceof Array)){for(var c=0;c<f.length;c++){var d=f[c].setType;switch(true){case jQuery.inArray(d,["html","val","text"])!==-1:f[c].element[d](e);break;case (typeof d==="object"&&d.hasOwnProperty("attr")):f[c].element.attr(d.attr,e);break;case (typeof d==="object"&&d.hasOwnProperty("prop")):f[c].element.prop(d.prop,e);break;default:}}}return this};this.assignListenerToShowExchangeType=function(d){var e=this;var c=function(f){e.switchToExchangeType();f.preventDefault()};d.on("click",c);return this};this.switchToExchangeType=function(){this.setLastUseTimestamp();this.inactivateEach("#silverExchange .directionButtons .directionButton");
this.activate(this.options.exchangeOptions.showExchangeTypeElement);this.inactivateEach(jQuery("#silverExchange .exchangeType"));this.activate(jQuery("#silverExchange .exchangeType"+this.options.exchangeOptions.directionType));this.hideAllMessages();this.updateExchangeValue(jQuery("#silverExchange .exchangeType"+this.options.exchangeOptions.directionType+" input").val());return this};this.inactivateEach=function(c){jQuery(c).each(function(d,f){var e=jQuery(f);e.removeClass("active");e.addClass("disabled")})};this.activate=function(c){c.addClass("active");c.removeClass("disabled");return this};this.showMessageByKey=function(c){var d=this.options.messages[c];this.showMessage(d);return this};this.showMessage=function(d){var c='<span class="'+d.type+'">'+d.message+"</span>";jQuery("#silverExchange .exchangeMessageLine").html(c);return this};this.hideAllMessages=function(){jQuery("#silverExchange .exchangeMessageLine").html("<span>&nbsp;</span>");return this};this.updateElementsTooltip=function(c,d){if(this.options.messages[d]&&this.options.messages[d].message){Travian.Tip.set(c,this.options.messages[d].message)
}};this.sendAction=function(e){var j=this;j.setLastUseTimestamp();if(this.isButtonInactive(e)){return false}if(this.isWaiting===true){return false}this.isWaiting=true;this.disableElement(e);var d=jQuery("#silverExchange .exchangeType input.text");d.each(function(){j.disableElement(jQuery(this))});var f=new Date().getTime();var h=this.options.exchangeOptions.directionType;var g=d.filter("input[class^=silverInput]").val();var c=d.filter("input[class^=goldInput]").val();Travian.api("ajax/silverExchange",{data:{exTyp:h,s:g,g:c},success:function(k){if(k.errorMessage){j.setError(k)}else{var m=Math.max(0,500-(new Date().getTime()-f));var l=function(n){if(n.message){j.isWaiting=false;j.hideAllMessages();j.overrideGoldAndSilver(n.oldGold,n.oldSilver,n.newGold,n.newSilver);j.enableElement(e);d.each(function(){j.enableElement(jQuery(this))});if(j.options.exchangeOptions.directionType==="SilverToGold"){j.options.exchangeOptions.maxAmount=n.newSilver}else{j.options.exchangeOptions.maxAmount=n.newGold
}if(j.options.maxAmountChangedFunction=="function"){j.options.maxAmountChangedFunction.call(this,{oldGold:n.oldGold,oldSilver:n.oldSilver,newGold:n.newGold,newSilver:n.newSilver})}jQuery(document).trigger("TG:changeMaxGoldToSilverAmounts",{oldGold:n.oldGold,oldSilver:n.oldSilver,newGold:n.newGold,newSilver:n.newSilver});j.updateExchangeValue(jQuery("#silverExchange .exchangeType"+j.options.exchangeOptions.directionType+" input").val());j.showMessage(n.message);var o=Travian.parseURL(window.location.href);j.updateHeroAuctionContent(o.searchObject.action,{filter:o.searchObject.filter,page:o.searchObject.page})}};setTimeout(l.bind(j),m,k)}}});return this};this.setMaxAmounts=function(c){if(this.options.exchangeOptions.directionType==="SilverToGold"){this.options.exchangeOptions.maxAmount=c.newSilver}else{this.options.exchangeOptions.maxAmount=c.newGold}return this};this.disableElement=function(c){c.addClass("disabled");return this};this.enableElement=function(c){c.removeClass("disabled");return this
};this.isButtonInactive=function(c){return c.hasClass("disabled")};this.overrideGoldAndSilver=function(c,f,j,h){if(j===undefined&&h===undefined){return this}var d;var e;var g=function(m,n){n=jQuery(n);if(this.type==="gold"){d=parseInt(c);e=parseInt(j)}else{d=parseInt(f);e=parseInt(h)}var l=n.html();var o=new Travian.Formatter({forceDecimal:false});l=o.removeNonDigits(l);var k=d-l;n.html(e+k)};jQuery(".ajaxReplaceableSilverAmountDiff").each(jQuery.proxy(g,{type:"silver"}));jQuery(".ajaxReplaceableGoldAmountDiff").each(jQuery.proxy(g,{type:"gold"}));jQuery(".ajaxReplaceableSilverAmount").each(function(k,l){jQuery(l).html(h)});jQuery(".ajaxReplaceableGoldAmount").each(function(k,l){jQuery(l).html(j)});return this};this.setLastUseTimestamp=function(){window.lastTimestampUseSilverExchange=new Date().getTime()};this.updateHeroAuctionContent=function(g,c){var e=c||{};var f={action:g};for(var d in e){if(e.hasOwnProperty(d)&&!f[d]){f[d]=e[d]}}Travian.api("ajax/heroAuctionContent",{data:f,success:function(h){if(h.html){var j=jQuery("#auction");
j.html(h.html);Travian.Tip.updateAllInElement(j);Travian.TimersAndCounters.initTimers()}}})};this.initialize()};Travian.Game.Hero.HorseToggle={waitingForResponse:false,init:function(){jQuery("#horseToggleBox > div button").on({mouseover:this.fnOnMouseOver,mouseout:this.fnOnMouseOut,click:this.fnOnClick})},fnOnMouseOver:function(){var b=jQuery(this).parents().eq(2);if(b.length>0&&b.hasClass("inactive")){b.addClass("hover")}},fnOnMouseOut:function(){var b=jQuery(this).parents().eq(2);if(b.length>0&&b.hasClass("inactive")){b.removeClass("hover")}},fnOnClick:function(){if(Travian.Game.Hero.HorseToggle.waitingForResponse){return false}var c=jQuery(this).parents().eq(2);if(c.length>0&&c.hasClass("inactive")){var b=jQuery("#horseToggleBox > div.inactive");var d=jQuery("#horseToggleBox > div.active");b.find(".button button").addClass("disabled")[0].disabled=true;Travian.Game.Hero.HorseToggle.waitingForResponse=true;Travian.api("ajax/horseToggle",{data:{},success:function(f){if(f.changed){var e=jQuery(".speed .powervalue .current");
if(e.length>0){e.html(f.newSpeed)}jQuery("#heroSpeedValueNumber").html(f.newSpeed);b.removeClass("inactive").addClass("active");d.removeClass("active").addClass("inactive");jQuery(window).trigger("domAltered",jQuery("#horseToggleBox > div.inactive"));jQuery(window).trigger("domAltered",jQuery("#horseToggleBox > div.active"))}b.find(".button button").removeClass("disabled")[0].disabled=false;Travian.Game.Hero.HorseToggle.waitingForResponse=false}})}}};Travian.Game.Hero.Properties={};Travian.Game.Hero.Properties.PropertyForm=function(){this.unloadIdentifier=null;this.onDirty=function(e){var d=this.elements.saveHeroAttributes.getInput();var c=jQuery(".heroAttributesFormMessage");if(e){c.removeClass("hide");d.removeClass("disabled")[0].disabled=false;this.unloadIdentifier=Travian.Form.UnloadHelper.enableSecurity(this.unloadIdentifier)}else{c.addClass("hide");d.addClass("disabled")[0].disabled=true;Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier)}if(typeof this.elements.resetHeroAttributes!=="undefined"){var b=this.elements.resetHeroAttributes.getInput();
b[0].disabled=b.hasClass("disabled")}return this};this.onClick=function(b){switch(b.getName()){case"saveHeroAttributes":this.saveHeroAttributes();break;case"resetHeroAttributes":this.resetHeroAttributes();break;default:return}return this};this.saveHeroAttributes=function(){var b={resource:this.elements.resource.getValue(),attackBehaviour:this.elements.attackBehaviour.getValue()};if(this.elements.properties!==undefined){b.attributes=this.elements.properties.getPropertyValues()}Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier);Travian.api("ajax/heroSetAttributes",{data:b})};this.resetHeroAttributes=function(){Travian.api("ajax/heroResetAttributes",{data:{}})};Travian.Form.call(this)};Travian.Game.Hero.Properties.PropertyForm.prototype=Object.create(Travian.Form.prototype);Travian.Game.Hero.Properties.PropertyForm.constructor=Travian.Game.Hero.Properties.PropertyForm;Travian.Game.Hero.PropertySetter=function(c,b){this.options=Object.assign({availablePoints:0,element:null,selectorBtnMinus:".pointsValueSetter.sub a",selectorBtnPlus:".pointsValueSetter.add a",elementAvailablePoints:""},b);
this.getAvailablePoints=function(){return this.options.availablePoints-this.getSettedPoints()};this.getPropertyValues=function(){var d={};jQuery.each(this.options.attributes,function(e,f){d[f.getId()]=f.getSettedPoints()});return d};this.isDirty=function(){return this.getSettedPoints()>0};this.initialize=function(d){var e=this;Travian.Form.Element.call(this,d);jQuery.each(this.options.attributes,function(f,g){g.setPropertySetter(e)});this.options.element=jQuery("#"+this.options.element);this.options.elementAvailablePoints=jQuery("#"+this.options.elementAvailablePoints);this.update()};this.getSettedPoints=function(){var d=0;jQuery.each(this.options.attributes,function(e,f){d+=f.getSettedPoints()});return d};this.update=function(){jQuery.each(this.options.attributes,function(e,f){f.updateButtons()});var d=this.getAvailablePoints()+"/"+this.options.availablePoints;this.options.elementAvailablePoints.html(d);this.onChange();return this};this.initialize(c)};Travian.Game.Hero.PropertySetter.prototype=Object.create(Travian.Form.Element.prototype);
Travian.Game.Hero.PropertySetter.constructor=Travian.Game.Hero.PropertySetter;Travian.Game.Hero.PropertySetter.Attribute=function(b){this.options=Object.assign({id:null,element:null,value:null,usedPoints:null,maxPoints:null,elementBtnMinus:".pointsValueSetter.sub a",elementBtnPlus:".pointsValueSetter.add a",elementInput:".points input",elementProgressBar:".progress .bar.setted",elementValue:".current .value"},b);this.propertySetter=null;this.settedPoints=0;this.getId=function(){return this.options.id};this.getMaxPoints=function(){return this.options.maxPoints};this.getPropertySetter=function(){if(this.propertySetter===null){throw"missing propertySetter in Travian.Game.Hero.PropertySetter.Attribute"}return this.propertySetter};this.getSettedPoints=function(){return this.settedPoints};this.getTotalPoints=function(){return this.settedPoints+this.options.usedPoints};this.initialize=function(){var g=this;this.options.element=jQuery("#"+this.options.element);this.options.elementBtnMinus=this.options.element.find(this.options.elementBtnMinus);
this.options.elementBtnPlus=this.options.element.find(this.options.elementBtnPlus);this.options.elementInput=this.options.element.find(this.options.elementInput);this.options.elementProgressBar=this.options.element.find(this.options.elementProgressBar);this.options.elementValue=this.options.element.find(this.options.elementValue);var j=null;var c=false;var d=function(k,l){l.preventDefault();if(c===false){g[k+"Point"]()}c=false;return false};var f=function(k){k.preventDefault();if(j){clearInterval(j)}jQuery(k.target).removeClass("click");return false};var h=function(l,m){m.preventDefault();if(j){clearInterval(j)}c=true;jQuery(m.target).addClass("click");var k=jQuery(document.body);k.off("mouseup",f);k.on("mouseup",f);g[l+"Point"]();j=setInterval(g[l+"Point"].bind(g),200);return false};var e=function(m){var k=null;var l=(m.originalEvent.wheelDelta>0?1:-1);m.preventDefault();if(j){clearInterval(j)}g.setSettedPoints(g.getSettedPoints()+l);if(l>0){k=g.options.elementBtnPlus;g.options.elementBtnMinus.removeClass("click")
}else{k=g.options.elementBtnMinus;g.options.elementBtnPlus.removeClass("click")}k.addClass("click");j=setTimeout(function(){k.removeClass("click")},100);return false};this.options.elementBtnMinus.on({click:jQuery.proxy(d,this,"sub"),mousedown:jQuery.proxy(h,this,"sub"),mousewheel:e});this.options.elementBtnPlus.on({click:jQuery.proxy(d,this,"add"),mousedown:jQuery.proxy(h,this,"add"),mousewheel:e});this.options.elementInput.on({change:function(l){var k=parseInt(g.options.elementInput.val());if(isNaN(k)){k=g.getTotalPoints()}g.setSettedPoints(k-g.options.usedPoints)},mousewheel:e})};this.setPropertySetter=function(c){this.propertySetter=c;return this};this.setSettedPoints=function(d){d=parseInt(d);if(isNaN(d)){d=this.settedPoints}if(d<0){d=0}if(d>this.getMaxPoints()-this.options.usedPoints){d=this.getMaxPoints()-this.options.usedPoints}var c=this.getPropertySetter().getAvailablePoints();if(this.settedPoints<d&&c<d-this.settedPoints){d=this.settedPoints+c}this.settedPoints=d;return this.update()
};this.addPoint=function(c){if(c==null||c===""){c=1}if(c<0){c=0}return this.setSettedPoints(this.getSettedPoints()+c)};this.subPoint=function(c){if(c==null||c===""){c=1}if(c<0){c=0}return this.setSettedPoints(this.getSettedPoints()-c)};this.updateButtons=function(){this.options.elementBtnPlus.toggleClass("disabled",this.getTotalPoints()>=this.getMaxPoints()||this.getPropertySetter().getAvailablePoints()===0);this.options.elementBtnMinus.toggleClass("disabled",this.getSettedPoints()===0);return this};this.initialize()};Travian.Game.Hero.PropertySetter.Attribute.prototype.calculateValue=function(){return 0};Travian.Game.Hero.PropertySetter.Attribute.prototype.update=function(){this.options.elementValue.html(this.calculateValue());this.options.elementInput.val(this.options.usedPoints+this.getSettedPoints());this.options.elementProgressBar.css("width",Math.max(0,Math.min(100,Math.round(100/Math.min(this.getMaxPoints()+4,100)*this.getSettedPoints())))+"%");this.getPropertySetter().update();return this
};Travian.Game.Hero.PropertySetter.Attribute.Power=function(b){this.options=Object.assign({valueOfItems:0,valueBonus:0},b);this.calculateValue=function(){return 100+this.getTotalPoints()*this.options.valueBonus+this.options.valueOfItems};Travian.Game.Hero.PropertySetter.Attribute.call(this,this.options)};Travian.Game.Hero.PropertySetter.Attribute.Power.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype);Travian.Game.Hero.PropertySetter.Attribute.Power.constructor=Travian.Game.Hero.PropertySetter.Attribute.Power;Travian.Game.Hero.PropertySetter.Attribute.OffBonus=function(b){this.calculateValue=function(){return Math.round(this.getTotalPoints()*0.2*10)/10+"%"};Travian.Game.Hero.PropertySetter.Attribute.call(this,b)};Travian.Game.Hero.PropertySetter.Attribute.OffBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype);Travian.Game.Hero.PropertySetter.Attribute.OffBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.OffBonus;Travian.Game.Hero.PropertySetter.Attribute.DefBonus=function(b){this.calculateValue=function(){return Math.round(this.getTotalPoints()*0.2*10)/10+"%"
};Travian.Game.Hero.PropertySetter.Attribute.call(this,b)};Travian.Game.Hero.PropertySetter.Attribute.DefBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype);Travian.Game.Hero.PropertySetter.Attribute.DefBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.DefBonus;Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints=function(b){this.calculateValue=function(){return this.getTotalPoints()};this.options=Object.assign({pointWorth:[6,20,20,20,20]},b);this.elementResources=[];this.getPossibleBonusProductionForResource=function(c){if(c===0){return this.calculateValue()*this.options.pointWorth[0]*Travian.Game.speed}if(c<=4){return this.calculateValue()*this.options.pointWorth[c]*Travian.Game.speed}return 0};this.initialize=function(){Travian.Game.Hero.PropertySetter.Attribute.call(this,this.options);var c=this;var d=jQuery("#setResource");if(d.length>0){d.find("div.resource label:not(.baseCrop) span.current").each(function(e){c.elementResources[e]=this
})}};this.update=function(){var c=this;jQuery.each(this.elementResources,function(d,f){var e=jQuery(f);if(e.length>0){e.html(c.getPossibleBonusProductionForResource(d))}});return Travian.Game.Hero.PropertySetter.Attribute.prototype.update.call(this)};this.initialize()};Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype);Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints.constructor=Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints;Travian.Game.Hero.PropertySetter.Attribute.RegenBonus=function(b){this.calculateValue=function(){return Math.round(this.getTotalPoints()*0.5*10)/10+"%"};Travian.Game.Hero.PropertySetter.Attribute.call(this,b)};Travian.Game.Hero.PropertySetter.Attribute.RegenBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype);Travian.Game.Hero.PropertySetter.Attribute.RegenBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.RegenBonus;
Travian.Game.ActivationWithSectors=function(){this.arrowShapes={tribe1:"",tribe2:"",tribe3:"",tribe4:"",tribe5:""};this.basicShape="M10 10 V230 H[ARROW_POSITION] l20 20 l20 -20 H530 V10 Z";this.initialize=function(){var b=this;b.createArrowShapes();b.updateArrowPositions();b.bindEvents()};this.bindEvents=function(){var b=this;jQuery("#tribeSelectors").find('input[name="vid"]').on("change",function(){b.updateArrowPositions()})};this.createArrowShapes=function(){var e=this;var d=jQuery("#tribeSelectors");var j=d.find("label").outerWidth(true);var h=d.find('input[name="vid"]').length;var g=d.width();var f=(g-h*j)/2;var b;for(var c=0;c<h;c++){b=f+c*j+j/3.3333;e.arrowShapes["tribe"+(c+1)]=e.basicShape.replace("[ARROW_POSITION]",b)}};this.updateArrowPositions=function(){var d=this;var c=jQuery("#tribeSelectors").find('input[name="vid"]');if(jQuery("body.rtl").length>0){c=c.toArray().reverse()}for(var b=0;b<c.length;b++){if(c[b].checked===true){TweenLite.to(jQuery("#presentation svg .inner, #presentation svg .outer"),0.25,{morphSVG:d.arrowShapes["tribe"+(b+1)]})
}}};this.initialize()};Travian.Game.ActivationWithFactions=function(c,b){this.factionsTribesMapping={};this.sortedTribes=[];this.activationWrapper=null;this.dynamicTitles=null;this.initialize=function(){var d=this;d.activationWrapper=jQuery(".activateWithFactions");d.dynamicTitles=jQuery(".dynamicTitles");d.factionsTribesMapping=c;d.sortedTribes=b;d.bindEvents();d.updateSelection()};this.bindEvents=function(){var d=this;d.activationWrapper.find(".buttonWrapper.selectTribe button").on("click",function(j){j.preventDefault();if(jQuery(this).hasClass("update")){d.changeStep("confirm")}else{var k,h=d.activationWrapper.find("form:visible"),f=parseInt(h.find("input[name=vid]:checked").val());for(var e=0;e<d.sortedTribes.length;e++){var g=d.sortedTribes[e];if(g!==f&&d.factionsTribesMapping.hasOwnProperty(g)){k=d.factionsTribesMapping[g];break}}if(typeof k!=="undefined"){h.find('input[value="'+k+'"][name="faction"]').attr("checked","checked")}d.changeStep("selectFaction")}});d.activationWrapper.find(".buttonWrapper.selectFaction button").on("click",function(e){e.preventDefault();
d.changeStep("confirm")});d.activationWrapper.find("a.change.backToFaction").on("click",function(e){e.preventDefault();d.changeStep("selectFaction",true)});d.activationWrapper.find("a.change.backToTribe").on("click",function(e){e.preventDefault();d.changeStep("selectTribe",true)});d.activationWrapper.find("input[name=vid]").on("change",function(){d.updateSelection()});d.activationWrapper.find("input[name=faction]").on("change",function(){d.updateSelection()})};this.changeStep=function(e,d){var g=this;var f=["selectTribe","selectFaction","confirm"];d=typeof d!=="undefined"?d:false;if(f.indexOf(e)!==-1){if(d){g.activationWrapper.addClass("isEditing")}jQuery(f).each(function(h,j){g.activationWrapper.removeClass(j)});g.dynamicTitles.find(".active").removeClass("active");g.activationWrapper.addClass(e);g.dynamicTitles.find("."+e).addClass("active")}};this.updateSelection=function(){var f=this;var e=f.activationWrapper.find("form:visible");var d=e.find("input[name=vid]:checked").val();var g=e.find("input[name=faction]:checked").val().toLowerCase();
e.find(".selection.confirm .confirmTribe").removeClass("selected");e.find(".selection.confirm .confirmTribe.tribe"+d).addClass("selected");e.find(".selection.confirm .confirmFaction").removeClass("selected");e.find(".selection.confirm .confirmFaction."+g).addClass("selected")};this.initialize()};Travian.AdventureList=function(){this.openDurationsCalulator=function(){var b=jQuery("#durationCalculations");b.toggleClass("hide");if(!b.hasClass("hide")){this.calculateDurations()}};this.calculateDurations=function(){var b=jQuery("#adventureListForm");var c=jQuery("#changeVillage").val();Travian.api("ajax/calculateDurationsForAdventure",{data:{adventureKids:jQuery.map(b.find("input[name*=adventureKid]"),function(d){return d.value}),currentKidAndDid:c,originalWalkTimes:jQuery.map(b.find("input[name*=adventureWalktimeOriginalVillage]"),function(d){return d.value})},success:function(d){if(d.noAdventures===false){for(var e in d.responseArray){if(d.responseArray.hasOwnProperty(e)){jQuery("#"+e).html(d.responseArray[e])
}}}}})}};Travian.Game.BuildingUpgradeView={initialize:function(){jQuery("#build .buildingDescription .headline .openedClosedSwitch").on("click",function(){var c=jQuery(this);var b=jQuery("#build .buildingDescription");if(b.hasClass("collapsed")){b.removeClass("collapsed");c.removeClass("switchClosed");c.addClass("switchOpened");Travian.Game.Preferences.set("buildingDescriptionCollapsed",false)}else{b.addClass("collapsed");c.addClass("switchClosed");c.removeClass("switchOpened");Travian.Game.Preferences.set("buildingDescriptionCollapsed",true)}})}};Travian.Game.TrainingTroops={did:null,favouriteTroops:[],trainTroopsContainer:null,favouriteTroopsContainer:null,nonFavouriteTroopsContainer:null,isAnimating:false,initialize:function(){var b=this;b.trainTroopsContainer=jQuery(".trainUnits");b.favouriteTroopsContainer=jQuery("#favouriteTroops");b.nonFavouriteTroopsContainer=jQuery("#nonFavouriteTroops");b.did=parseInt(b.trainTroopsContainer.find("input[name=did]").val());b.loadFavouriteTroops();
b.trainTroopsContainer.find(".troop button.favourite").on("click",function(){if(!b.isAnimating){b.isAnimating=true;var d=jQuery(this);d.attr("disabled","disabled");var c=parseInt(d.attr("data-troopID"));if(d.hasClass("faved")){b.removeFromFavourites(c);d.removeClass("faved")}else{b.addToFavourites(c);d.addClass("faved")}}})},loadFavouriteTroops:function(){var b=Travian.Game.Preferences.get("favouriteTroopsInVillage"+this.did);if(b!==null){this.favouriteTroops=b.split(",")}},saveFavouriteTroops:function(){Travian.Game.Preferences.set("favouriteTroopsInVillage"+this.did,this.favouriteTroops.join(","))},addToFavourites:function(c){this.favouriteTroops.push(""+c);this.favouriteTroops.sort();var b=this.trainTroopsContainer.find(".innerTroopWrapper.troop"+c);b.addClass("favourite");this.orderTroopSection(c);this.saveFavouriteTroops()},removeFromFavourites:function(c){var d=this.favouriteTroops.indexOf(""+c);if(d!==-1){this.favouriteTroops.splice(d,1)}this.favouriteTroops.sort();var b=this.trainTroopsContainer.find(".innerTroopWrapper.troop"+c);
b.removeClass("favourite");this.orderTroopSection(c);this.saveFavouriteTroops()},orderTroopSection:function(f){var k=this;var h=k.favouriteTroopsContainer.find(".action.troop"+f);var m=k.nonFavouriteTroopsContainer.find(".action.troop"+f);var j=h.offset();var d=m.offset();var l=k.trainTroopsContainer.find(".innerTroopWrapper.troop"+f);var c=l.offset();var b=l.find("button.favourite");var e;var g=l.parent().height();if(l.hasClass("favourite")){e=Math.round(c.top-j.top+g);if(e>g){l.addClass("moving");h.removeClass("empty");m.addClass("empty");l.animate({top:e*-1},1000);setTimeout(function(){l.detach();l.appendTo(h);l.animate({top:0},0);setTimeout(function(){l.removeClass("moving");b.attr("disabled",false);k.isAnimating=false},50)},1000)}else{h.addClass("noAnimation").removeClass("empty");m.addClass("noAnimation").addClass("empty");l.detach();l.appendTo(h);setTimeout(function(){h.removeClass("noAnimation");m.removeClass("noAnimation");b.attr("disabled",false);k.isAnimating=false},50)}}else{e=Math.round(c.top-d.top+g);
if(e*-1>=g){l.addClass("moving");m.removeClass("empty");h.addClass("empty");l.animate({top:e*-1},1000);setTimeout(function(){l.detach();l.appendTo(m);l.animate({top:0},0);setTimeout(function(){l.removeClass("moving");b.attr("disabled",false);k.isAnimating=false},50)},1000)}else{m.addClass("noAnimation").removeClass("empty");h.addClass("noAnimation").addClass("empty");l.detach();l.appendTo(m);setTimeout(function(){m.removeClass("noAnimation");h.removeClass("noAnimation");b.attr("disabled",false);k.isAnimating=false},50)}}}};Travian.Game.Marketplace=function(b){this.merchantsAvailable=0;this.capacityPerMerchant=0;this.merchantCapacity=0;this.merchantsMax=0;this.initialize=function(c){this.merchantsAvailable=Math.max(c.merchantsAvailable,0);this.capacityPerMerchant=c.capacityPerMerchant;this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant;this.autoCompleter=c.autoCompleter;this.merchantsMax=c.merchantsMax;this.updateAutoCompleter();this.shortcutListener()};this.refresh=function(c){this.merchantsAvailable=Math.max(c,0);
this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant;jQuery("#merchantCapacityValue").html(this.merchantCapacity);jQuery(".merchantsAvailable").html(this.merchantsAvailable);this.visualizeMerchantCapacity()};this.enableAllLinks=function(){var c;for(c=1;c<=4;c++){linkToUpdate=jQuery("#addRessourcesLink"+c);linkToUpdate.removeClass("notClickable");linkToUpdate[0].disabled=false}};this.enableAllInputFields=function(){var c=0;for(c=1;c<5;c++){jQuery("#r"+c).removeClass("disabled");jQuery("#r"+c)[0].readOnly=0}};this.disableAllLinks=function(){var c;for(c=1;c<=4;c++){linkToUpdate=jQuery("#addRessourcesLink"+c);linkToUpdate.addClass("notClickable");linkToUpdate[0].disabled=true}};this.disableAllInputFields=function(){var c=0;for(c=1;c<5;c++){jQuery("#r"+c).addClass("disabled");jQuery("#r"+c)[0].readOnly=1}};this.shortcutListener=function(){jQuery(function(){Travian.Game.Village.enableVillageListShortcuts();jQuery(window).on("travian.villageList.coordinatesShortcut",function(e,c,g,d,f){jQuery("#xCoordInput").val(c);
jQuery("#yCoordInput").val(g);jQuery("#trade_route_destination").val(d);jQuery("#enterVillageName").val(f)})})};this.setNotice=function(c){if(c.notice&&c.formular){jQuery("#note").html(c.notice);jQuery(".destination").html(c.formular);this.enableAllLinks();this.enableAllInputFields();var d=1;for(d=1;d<5;d++){jQuery("#r"+d).val("")}if(c.button){jQuery("#button").html(c.button)}jQuery(".run_dropdown").removeClass("hide")}};this.setError=function(c){if(c.errorMessage){jQuery("#prepareError").html(c.errorMessage);jQuery("#note").html("")}};this.sendRessources=function(){var c=this;Travian.api("ajax/prepareMarketplace",{data:{t:jQuery("#t").val(),id:jQuery("#id").val(),a:jQuery("#a").val(),sz:jQuery("#sz").val(),kid:jQuery("#kid").val(),c:jQuery("#c").val(),x2:jQuery("#x2").length?jQuery("#x2").first().val():1,r1:jQuery("#r1").val(),r2:jQuery("#r2").val(),r3:jQuery("#r3").val(),r4:jQuery("#r4").val()},success:function(d){if(d.errorMessage){c.setError(d)}else{if(d.notice){jQuery(".run_dropdown").removeClass("hide");
jQuery("div .destination").html(d.formular);c.setNotice(d);c.reloadMarketPlace();Travian.Game.Layout.updateResources();c.updateAutoCompleter()}}}})};this.prepare=function(){var e=this;var d=1;if(jQuery("#x2").length){var c=jQuery("#x2").first();if(c.attr("type")=="checkbox"){d=c[0].checked?2:1}else{d=c.val()}}Travian.api("ajax/prepareMarketplace",{data:{r1:jQuery("#r1").val(),r2:jQuery("#r2").val(),r3:jQuery("#r3").val(),r4:jQuery("#r4").val(),dname:jQuery("#enterVillageName").val(),x:jQuery("#xCoordInput").val(),y:jQuery("#yCoordInput").val(),id:jQuery("#id").val(),t:jQuery("#t").val(),x2:d},success:function(f){if(f.errorMessage){e.setError(f)}else{if(f.formular){e.disableAllLinks();e.disableAllInputFields();jQuery(".destination").html(f.formular);jQuery(".run_dropdown").addClass("hide");jQuery("#prepareError").html("");jQuery("#note").html("");jQuery("#r1").focus()}}if(f.button){jQuery("#button").html('<div id="prepareError" class="error">'+jQuery("#prepareError").html()+"</div>"+f.button+'<div class="clear"></div>')
}return false}})};this.goBack=function(){var c=this;this.enableAllLinks();this.enableAllInputFields();Travian.api("ajax/marketPlaceGoBack",{data:{kid:jQuery("#kid").val(),x2:jQuery("#x2").length?jQuery("#x2").first().val():1,dname:jQuery("#dname")?jQuery("#dname").val():""},success:function(d){jQuery(".destination").html(d.formular);jQuery("#button").html('<div id="prepareError" class="error"></div>'+d.button+'<div class="clear"></div>');jQuery(".run_dropdown").removeClass("hide");c.updateAutoCompleter()}})};this.reloadMarketPlace=function(){var c=this;Travian.api("ajax/reloadMarketplace",{data:{},success:function(d){jQuery("#merchantsOnTheWayFormular").html(d.merchantsOnTheWay);Travian.Game.Layout.updateResources(d.storage);c.refresh(d.merchantsAvailable)}})};this.visualizeMerchantCapacity=function(){this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant;var c=this.summarizeInput();this.setSelectedRessourcesInfo(c);this.setNotEnoughMerchantsError(c);this.updateLinks()};
this.validateAndVisualizeMerchantCapacity=function(c){this.validateResources(c);this.visualizeMerchantCapacity()};this.validateResources=function(f){var d=this.getValue(f);var g=this.clipToStorageMaximum(f,d);var c=d+g;var e=d;if(d>c){e=c}this.setValue(f,e)};this.validateTradeRouteResources=function(c){var e=Math.max(0,this.getValue(c));this.setValue(c,e);var h=this.summarizeInput();var d=this.merchantsMax*this.capacityPerMerchant;var j={};var g=jQuery("#tradeSaveButton");var f=jQuery("#tradeRouteError");if(h>d){j={MERCHANTS_NEEDED:Math.ceil(h/this.capacityPerMerchant),MERCHANTS_AVAILABLE:this.merchantsMax};f.addClass("error").html(Travian.Helpers.substitute(Travian.Translation.translate("{notEnoughMerchants}"),j,/\\?\[([^\[\]]+)\]/g));g.addClass("disabled").attr("disabled",true)}else{f.removeClass("error").html("");g.removeClass("disabled").attr("disabled",false)}};this.validateTradeRouteResourcesSanity=function(){for(var c=1;c<=4;c++){var d=Math.max(0,this.getValue(c));this.setValue(c,d)
}var e=this.summarizeInput();if(e==0){jQuery("#tradeRouteError").addClass("error").html(Travian.Translation.translate("{resourcesNumberInvalid}"));return false}return true};this.validateTradeRouteSendTime=function(){var d=jQuery("#tradeSaveButton");var c=jQuery("#tradeRouteError");if(!this.validateTradeRouteSendTimeSanity()){c.addClass("error").html(Travian.Translation.translate("{invalidTimeFormat}"));d.addClass("disabled").attr("disabled",true);return false}c.removeClass("error").html("");d.removeClass("disabled").attr("disabled",false);return true};this.validateTradeRouteSendTimeSanity=function(){var d=jQuery("#tradeRouteEdit").find(".timeSelector");var e=jQuery("#tradeRouteError");var c=d.find("input[name=hour]");var g=d.find("input[name=minute]");c=c.val();g=g.val();var f=(jQuery.isNumeric(c)&&c>=0&&c<=23)&&(g===""||(jQuery.isNumeric(g)&&g>=0&&g<=59));!f&&e.addClass("error").html(Travian.Translation.translate("{invalidTimeFormat}"));return f};this.furtherMerchantsAvailable=function(){return((this.merchantCapacity-this.summarizeInput())>=0)
};this.updateLinks=function(){var c;for(c=1;c<=4;c++){jQuery("#addRessourcesLink"+c).toggleClass("notClickable",(this.getValueToAddToRessources(c)==0))}};this.addRessources=function(e){if(jQuery("#addRessourcesLink"+e)[0].disabled){return}var d=this.getValueToAddToRessources(e);var c=this.getValue(e);if(d!=0){this.setValue(e,d+c)}this.visualizeMerchantCapacity()};this.getValueToAddToRessources=function(f){var c=0;var e=this.summarizeInput();var d=this.merchantCapacity-e;if(d>0){if(d<this.capacityPerMerchant){c=d}else{if(d>=this.capacityPerMerchant){c=this.capacityPerMerchant}}}else{if(d==0){c=0}else{c=d}}c=this.clipToStorageMaximum(f,c);return c};this.clipToStorageMaximum=function(f,d){var e=this.getStorageFor(f);var c=this.getValue(f);if(d>0){d=Math.min(d,(e-c))}else{if((c+d)>e){d=e-c}}return d};this.getStorageFor=function(c){var d="l"+(c);return window.resources.storage[d]};this.setValue=function(d,c){var e=parseInt(c);if(!isNaN(e)){jQuery("#r"+d).val(Math.max(e,0))}};this.setSelectedRessourcesInfo=function(c){jQuery("#sumResources").toggleClass("notEnoughMerchants",(c>this.merchantCapacity)).html(c)
};this.setNotEnoughMerchantsError=function(e){var h={};var f=this.getNeededMerchants(e);var g=jQuery("#prepareError");var d=null;jQuery("#merchantsNeededNumber").html(f);if(jQuery(".prepare").length>0){d=jQuery(".prepare").first()}if(f>this.merchantsAvailable){h={MERCHANTS_NEEDED:f,MERCHANTS_AVAILABLE:this.merchantsAvailable};g.addClass("error").html(Travian.Helpers.substitute(Travian.Translation.translate("{notEnoughMerchants}"),h,/\\?\[([^\[\]]+)\]/g));d.addClass("disabled").attr("disabled",true);jQuery("#note").html("");jQuery("#merchantsNeeded").addClass("error");jQuery(".merchantCapacity").addClass("error");jQuery("#sumResources").addClass("error")}else{jQuery("#merchantsNeeded").removeClass("error");jQuery(".merchantCapacity").removeClass("error");jQuery("#sumResources").removeClass("error");if(g.length>0){g.html("")}else{var c=jQuery("#button").html();jQuery("#button").html('<div id="prepareError" class="error"></div>'+c+'<div class="clear"></div>')}d.removeClass("disabled").attr("disabled",false)
}};this.getNeededMerchants=function(c){return Math.ceil(c/this.capacityPerMerchant)};this.getValue=function(d){var c=parseInt(jQuery("#r"+d).val());if(!isNaN(c)){return c}return 0};this.summarizeInput=function(){var d=0;for(var c=1;c<=4;c++){d+=this.getValue(c)}return d};this.updateAutoCompleter=function(){var c=jQuery("#enterVillageName");if(this.autoCompleter&&c.length>0){new Travian.Game.AutoCompleter.VillageName(c)}return this};this.initialize(b)};Travian.Game.Marketplace.getPreferences=function(){var d=Travian.Game.Preferences.get("tradeRoutesOrder");var c,b;if(d!=null){c=d.charAt(0);b=d.charAt(1)}else{c="2";b="a"}return{sortingColumn:c,sortingOrder:b}};Travian.Game.Marketplace.toggleSorting=function(d){var c=Travian.Game.Marketplace.getPreferences();var b;if(d==c.sortingColumn){b=c.sortingColumn+(c.sortingOrder=="a"?"d":"a")}else{b=d+"a"}Travian.Game.Preferences.set("tradeRoutesOrder",b)};Travian.Game.Marketplace.toggleTradeRoutes=function(d,c){var b=c.checked?1:0;Travian.api("ajax/toggleTradeRoutes",{data:{routeId:d,enabled:b}});
return false};Travian.Game.Marketplace.updateVillageListLinks=function(c){var e=["dname","x","y"];var d=jQuery(c).serializeArray().reduce(function(g,f){g[f.name]=encodeURIComponent(f.value);return g},{});var b=jQuery("#sidebarBoxVillagelist");b.find("li").each(function(g,j){var f=jQuery(j).find("a");var k=Travian.parseURL(f.attr("href"));for(var h=0;h<e.length;h++){if(d[e[h]]!==undefined){k.searchObject[e[h]]=d[e[h]]}}f.attr("href",Travian.composeURL(k))})};Travian.Game.Marketplace.onLoad=function(){var b=Travian.Game.Marketplace.getPreferences();jQuery("a.sorting#sorting"+b.sortingColumn).addClass(b.sortingOrder=="a"?"asc":"desc")};Travian.Game.Marketplace.constructor=Travian.Game.Marketplace;Travian.Game.Marketplace.ExchangeResources=function(b){var c=b;this.calculateRest=function(){var g=c.find('span[id^="org"]');var h=c.find("span#sum").html();var d=c.find('input[name^="desired"]');var f=c.find('span[id^="diff"]');var e=0;d.each(function(k,j){var m=parseInt(j.value||0);var l=m-parseInt(g[k].innerHTML);
f[k].innerHTML=l>0?"+"+l:l;e+=m});jQuery("#newsum").text(e);jQuery("#remain").text(h-e);this.testSum()};this.fillup=function(d){jQuery('input[name="desired'+d+'"]').val(resources.maxStorage["l"+(d+1)]||0);this.calculateRest()};this.testSum=function(){if(document.getElementById("remain").innerHTML!=="0"){document.getElementById("submitText").style.display="block";document.getElementById("submitButton").style.display="none"}else{document.getElementById("submitText").style.display="none";document.getElementById("submitButton").style.display="block"}Travian.adjustButtonDisableState()};this.distribute=function(f){var e=[];var h=c.find('span[id^="org"]');var d=c.find('input[name^="desired"]');var j=c.find("span#sum");d.each(function(k,l){e[k]=l.value});var g=this;Travian.api("ajax/exchangeResources",{data:{did:f,desired:e},success:function(k){d.each(function(m,l){h[m].innerHTML=k.resources[m];l.value=k.distributed[m]});j.html(k.resources.reduce(function(m,l){return m+l},0));g.calculateRest()},error:function(k){(new Travian.Dialog.Dialog()).setContent(k.errorMsg).show()
}});return false};this.calculateRest()};Travian.Game.RallyPoint={initialize:function(b){b.find("input[type=text]").each(function(c,d){d=jQuery(d);d.on({keydown:function(e){var f=e.keyCode,h=e.ctrlKey,g=e.metaKey;if(f===8||f===46||(f===65&&(h===true||g===true))||(f===67&&(h===true||g===true))||(f===88&&(h===true||g===true))||(f===86&&(h===true||g===true))||(f>=35&&f<=39)||(f===9)||(f===13)){return true}if(!(((f>=48&&f<=57)||(f>=96&&f<=105)))){e.preventDefault()}},input:function(f){var e=parseInt(d.val().replace(/^0+/,""))||0;if(isNaN(e)||e===0||e<0){e=""}d.val(e)}})});Travian.Game.Village.enableVillageListShortcuts();jQuery(window).on("travian.villageList.coordinatesShortcut",function(e,c,g,d,f){jQuery("#xCoordInput").val(c);jQuery("#yCoordInput").val(g);jQuery("#enterVillageName").val(f)})},updateTravelTime:function(b){var f=jQuery(b).closest("form");var d=f.find("div#in");if(d.length===0){return}var c=f.find('input[name="d"]').val();var g=f.find('input[name="to"]').val();var e={};f.find("td.unit input").each(function(j,h){e[h.name.replace(/[t\[\]]/g,"")]=parseInt(h.value)||0
});Travian.api("troop/"+c+"/distanceSpeedAndDuration",{data:{to:g,t:e},success:function(k){d.html(k.durationString);var l=f.find("span#at");var j=new Date();var h=(j.getTime()/1000)%86400-k.offset+k.duration;Travian.TimersAndCounters.updateTimer(l.get(0),Math.round(h))}})}};Travian.AttackSymbol={markAttackSymbol:function(e){var b=jQuery("img#markSymbol_"+e);var c=b.prop("class");var d=parseInt(c.replace(/[^0-9]/gi,""))||0;d=(d+1)%4;b.removeClass().addClass("markAttack markAttack"+d);Travian.api("ajax/markIncomingAttacks",{data:{data:{id:e,state:d}}})}};Travian.Game.RallyPoint.CoordinatesInputHelper=function(b){this.options=Object.assign({coordinateXInputId:"xCoordInput",coordinateYInputId:"yCoordInput",allowedPattern:/^([0-9\-.,]+)([|/])([0-9\-.,]+)$/},b)};Travian.Game.RallyPoint.CoordinatesInputHelper.prototype.insertCoordinates=function(b){let pastedData;if(typeof b.clipboardData!=="undefined"){pastedData=b.clipboardData.getData("text/plain")}else{pastedData=window.clipboardData.getData("Text")
}pastedData=pastedData.replace(/[\u202D\u202C\u202E]/g,"").replace(//g,"-").replace(/[^0-9\-|/]/g,"");let matches=pastedData.match(this.options.allowedPattern);b.preventDefault();if(matches!==null){jQuery("#"+this.options.coordinateXInputId).val(matches[1]);jQuery("#"+this.options.coordinateYInputId).val(matches[3]).focus()}else{jQuery(b.target).val(pastedData.replace(/[^0-9\-]/g,""))}};Travian.Game.AllianceMembers=function(b){this.options=Object.assign({data:{}},b);this.initialize=function(){Travian.Dialog.Ajax.call(this,"ajax/playerNote",this.options)};this.request=function(){var c=this;Travian.api("ajax/playerNote",{data:this.options.data,success:function(d){if(d.close||d.html===""){c.close();Travian.WindowManager.closeAllWindows();window.location.reload()}else{c.setContent(d.html).setTitle(d.title).setInfoIcon(d.infoIcon).updateCssClass(d.cssClass);c.show()}},error:function(e,d){jQuery("#playerNotePopupError").innerHTML=d}});return this};this.reload=function(){this.request()};this.initialize()
};Travian.Game.AllianceMembers.prototype=Object.create(Travian.Dialog.Ajax.prototype);Travian.Game.AllianceMembers.constructor=Travian.Game.AllianceMembers;Travian.Game.AllianceDonation={dialog:null,bonusSelected:false,getDonationParams:function(b){this.calculateSum(b);return{bid:jQuery("#bid").val(),did:jQuery("#did").val(),r1:jQuery("#"+b+"1").val(),r2:jQuery("#"+b+"2").val(),r3:jQuery("#"+b+"3").val(),r4:jQuery("#"+b+"4").val(),amount:this.toNaturalNumber(jQuery("#"+b+"Sum").html())}},wasGoldUsed:function(b){return["donate_gold","donate_gold_confirm"].indexOf(b)!==-1},calculateSum:function(b){var d=0;for(var c=1;c<=4;c++){d+=this.toNaturalNumber(jQuery("#"+b+c).val())}jQuery("#"+b+"Sum").html(d.toString());this.checkAndChangeScalingPopup(b,d);this.checkButtonState(b)},updateBID:function(b){jQuery("#bid").val(b)},checkButtonState:function(c){var h=this;var d=jQuery("#"+c+"Sum").html()!=0;var g=false;var j=document.getElementsByName("bonus");for(var f=0;f<j.length;f++){if(j[f].checked){g=true;
jQuery("#bonusNotSelectedMessage").hide();this.updateBID(jQuery(j[f]).val());break}}var k=jQuery("#limitReached").val()==1;var e=d&&g&&!k;if(!g){this.updateBID(null)}h.bonusSelected=g;if(jQuery("#gold").val()==1){var b=jQuery("#canTriple").val()!=0;if(e&&b){jQuery("#donate_gold").removeClass("disabled")}else{jQuery("#donate_gold").addClass("disabled")}}if(e){jQuery("#donate_green").removeClass("disabled")}else{jQuery("#donate_green").addClass("disabled")}},fillUp:function(c,d,b){if(c.disabled!==true){d=Math.max(d,0);jQuery(c).val(d);this.checkAndChange(c,d,b)}},checkAndChange:function(d,e,b){d=jQuery(d);var c=Math.min(this.toNaturalNumber(d.val()),e);if(d.val()!==c.toString()){d.val(c)}this.calculateSum(b)},toNaturalNumber:function(b){b=parseInt(b);if(isNaN(b)){b=0}if(b<0){b=0}return b},donate:function(c,e,d){var b=jQuery("#donate_gold_confirm");if(e!=="donate_gold"){jQuery("#contributeButtons").find("button").addClass("disabled");if(b.length>0){if(b.hasClass("disabled")){return}else{b.off("click").addClass("disabled")
}}}jQuery(".bonus-donation-response").removeClass("visible");Travian.api("ajax/donateResources",{data:{params:d,action:e},success:function(f){if(f.html!==""){Travian.Game.AllianceDonation.showDialog(f.html)}else{Travian.Game.AllianceDonation.closeDialog()}var h=Travian.Game.AllianceDonation.wasGoldUsed(e);var g=Travian.Game.AllianceDonation.getResourceAnimationSpeed(d.amount,h);if(f.newTotal>0){Travian.Game.AllianceDonation.refreshDailyDonation(f.newTotal,e,d.amount,h);Travian.Game.AllianceDonation.refreshProgressBarTitle(f.limit-f.newTotal)}if(f.reloadAjax===true){Travian.Game.AllianceDonation.countDownResources(d.amount,false);setTimeout(function(){Travian.Game.AllianceDonation.refreshDonationForm(f.limitReached);jQuery(".bonus-donation-response").html(f.responseText);Travian.Game.AllianceDonation.refreshAllianceBonusOverview()},g)}if(f.goldChanged===true){Travian.Game.Layout.updateGold()}if(f.resourcesChanged===true){Travian.Game.Layout.updateResources()}},error:function(f){Travian.Game.AllianceDonation.checkButtonState("donate");
Travian.Game.AllianceDonation.showErrorDialog(f.errorMsg);return false}})},closeDialog:function(){if(this.dialog!==null){this.dialog.close()}},showDialog:function(b){var c=this;this.closeDialog();this.dialog=new Travian.Dialog.Dialog({buttonOk:false,onClose:function(){c.checkButtonState("donate")}});this.dialog.setContent(b);this.dialog.show()},showErrorDialog:function(b){var d=this;var c=new Travian.Dialog.Dialog({buttonOk:true,onClose:function(){d.closeDialog();d.refreshDonationForm(true);d.refreshDonationLimitBar();d.refreshAllianceBonusOverview()}});c.setContent(b);c.show()},showScaleDown:function(c){var b=document.getElementById(c).innerHTML;this.showDialog(b);this.scaleDown("scale")},scaleDown:function(b){var e=parseInt(jQuery("#leftResources").val());var g=parseInt(jQuery("#multiplicationFactor").val());e=parseInt(e/g);var h=0;var d=new Array(5);var j=new Array(5);for(var f=1;f<=4;f++){j[f]=this.toNaturalNumber(jQuery("#"+b+f).val());d[f]=j[f];h+=d[f]}if(h===0){this.closeDialog()
}if(e>=h){this.closeDialog()}var k=e/h;h=0;for(f=1;f<=4;f++){if(d[f]>0){d[f]=Math.floor(d[f]*k);h+=d[f]}}var c=e-h;while(c>0){for(f=1;f<=4&&c>0;f++){if(j[f]>0){d[f]++;c--}}}for(f=1;f<=4;f++){jQuery("#"+b+f).val(d[f]);jQuery("#donate"+f).val(d[f])}jQuery("#"+b+"Sum").html(e.toString());jQuery("#donateSum").html(e.toString());this.checkAndChangeScalingPopup(b,e);setTimeout(function(){Travian.Game.AllianceDonation.changeScaleButton(true)},250)},checkAndChangeScalingPopup:function(c,b){var f=jQuery("#"+c+"SumMultiplied");var e=b;if(f.length>0){e=this.toNaturalNumber(f[0].dataset.multiplicator)*b;f.html(e.toString())}if(c==="scale"){var d=this.toNaturalNumber(jQuery("#resourcesUntilLimit")[0].dataset.limit);this.changeScaleButton((d>=e))}},changeScaleButton:function(b){if(b){jQuery("#buttonScale").hide();jQuery("#scale").addClass("disabled");jQuery(".bonus-scaleDown").addClass("scaled");jQuery("#buttonDonate").show()}else{jQuery("#buttonDonate").hide();jQuery("#scale").removeClass("disabled");
jQuery(".bonus-scaleDown").removeClass("scaled");jQuery("#buttonScale").show()}},donateScaled:function(d,b){var c=this.getDonationParams(b);this.closeDialog();this.donate(b,d.id,c)},refreshGoldConfirmation:function(){var b=jQuery("#donate_gold");b.addClass("disabled");var c=Travian.Game.AllianceDonation.getDonationParams("donate");Travian.Game.AllianceDonation.donate("donate",b.id,c)},refreshDonationForm:function(d){var b=jQuery("#contributionForm"),c=this;if(!b){return}setTimeout(function(){jQuery("#contributionForm").find("input:checked").prop("checked",false)},100);Travian.api("ajax/donationForm",{data:{},success:function(e){b.html(e.form);jQuery(window).trigger("domAltered",jQuery("#contributionForm"));if(d){Travian.TimersAndCounters.init()}jQuery(".bonus-donation-response").addClass("visible");c.initBonusIcons();Travian.Tip.refresh();c.bonusSelected=false;c.initContributeDisabledAction()}})},refreshDonationLimitBar:function(){var b=jQuery("#myDailyContributionLimit");if(!b){return}b.addClass("hidden");
Travian.api("ajax/donationLimitBar",{data:{},success:function(c){b.html(c.limitBar);jQuery(window).trigger("domAltered",jQuery("#myDailyContributionLimit"));Travian.Tip.refresh();b.removeClass("hidden")}})},refreshAllianceBonusOverview:function(){var b=jQuery("#allianceBonusOverview"),c=this;if(!b){return}Travian.api("ajax/allianceBonusOverview",{data:{},success:function(d){b.html(d.overview);c.initBonusOverview();Travian.Tip.refresh()}})},refreshDailyDonation:function(d,k,o,j){var f=jQuery("#donatedToday");var m=jQuery("#dailyContributionTitleText");var s=jQuery("#dailyContributionTitleArrow");var b=parseInt(f.val());var h=parseInt(jQuery("#dailyLimit").val());var l=Math.min(100,((d/h)*100));var n="lightGreen";if(k==="donate_gold"||k==="donate_gold_confirm"){n="gold"}s.addClass(n);var g=this.getResourceAnimationSpeed(o,j);var p=20;o=j?o*3:o;var r=Math.round(o/p);var e=g/p;s.css({transition:"width "+g+"ms, opacity 500ms",width:l.toString()+"%"});var c=1;var q=setInterval(function(){b=b+r;
if(b<d){m.html(Travian.i18n.Ratio(b,h,{nominatorClass:"donationValueNumber",denominatorClass:"donationMaxNumber"}))}if(c===p){m.html(Travian.i18n.Ratio(d,h,{nominatorClass:"donationValueNumber",denominatorClass:"donationMaxNumber"}));s.removeClass(n);clearInterval(q)}c++},e);if(l===100){jQuery(".bonus-donation-response").addClass("white");s.css({width:"100%"});jQuery("#limitReached").val(1);setTimeout(function(){s.addClass("complete");m.addClass("complete").removeClass("white");jQuery(".bonus-donation-response").addClass("complete")},g+500)}f.val(d)},countDownResources:function(h,d){var c=this.getResourceAnimationSpeed(h,d);var j=20;var e=[];var g=[];jQuery("#contributeButtons").find("button").addClass("disabled");var f=0;jQuery(".resourceInput input").each(function(n,m){var o=parseInt(jQuery(m).val());e[f]=o;var l=o/j;if(l<1){l=1}g[f]=l;f++});var b=1;var k=setInterval(function(){for(var l=0;l<e.length;l++){var n=e[l]-g[l];if(n>0){e[l]=n;jQuery(jQuery(".resourceInput input")[l]).val(parseInt(n))
}}if(b===j){for(var m=0;m<e.length;m++){jQuery(jQuery(".resourceInput input")[m]).val(0)}clearInterval(k)}b++},c/j)},getResourceAnimationSpeed:function(g,b){var f=500;var c=2000;if(b){g=g*3}var d=parseInt(jQuery("#dailyLimit").val());var e=f+g*(c-f)/d;e=Math.max(f,Math.min(c,e));return e},initBonusIcons:function(){var b=jQuery("#contributionBox").find("#bonusSelection .bonusButtonRound");b.off("click");b.on("click",function(d){d.preventDefault();var c=jQuery("#bonusBox"+jQuery(this).attr("data-index"));if(c.find(".bonusInfo").hasClass("hide")){c.find("button").trigger("click")}jQuery("html, body").animate({scrollTop:c.offset().top},250)})},initBonusOverview:function(){var b=jQuery(".bonusCollapse");var c;try{c=JSON.decode(Travian.Game.Preferences.get("allianceBonusesOverview")||"{}")}catch(f){c={}}var d=function(){b.each(function(g,e){var k=jQuery(e).attr("ref");var h=jQuery(e).children("img.openedClosedSwitch");if(k.length>0&&h.length>0){var j=jQuery(".bonusInfo."+k);c[k]=!Travian.isToggleClosed(j[0],h[0])
}});Travian.Game.Preferences.set("allianceBonusesOverview",JSON.stringify(c))};if(b.length>0){b.each(function(g,e){jQuery(e).on("click",function(l){var k=jQuery(this).attr("ref");var h=jQuery(this).children("img.openedClosedSwitch");if(k.length>0&&h.length>0){var j=jQuery(".bonusInfo."+k);Travian.toggleSwitch(j[0],h[0]);d()}})})}},playLevelUpRewardAnimation:function(g,c,d,b){Travian.Game.Layout.toggleBackgroundOverlay();var e=jQuery("#backgroundOverlay");var f=jQuery("#bonusLevelUpRewardTemplate").html();e.prepend(f);e.find(".bonusLevelUpReward .bonusRepresentation > div").addClass(g);e.find(".bonusLevelUpReward .banner .description p:first-of-type").html(d);e.find(".bonusLevelUpReward .banner .description p:last-of-type").html(b);setTimeout(function(){e.find(".stoneDisplay").addClass("visible");e.find(".stoneDisplayHeader").addClass("visible");e.find(".banner").addClass("visible");e.find(".swords").addClass("visible").addClass("locked");setTimeout(function(){e.find(".bonusRepresentation .stage1").addClass("visible");
setTimeout(function(){e.find(".bonusRepresentation .glow").addClass("visible");setTimeout(function(){e.find(".bonusRepresentation .stage2").addClass("visible");setTimeout(function(){e.find(".bonusRepresentation .stage1").removeClass("visible");e.find(".bonusRepresentation .glow").removeClass("visible");e.find(".banner").addClass("enlarged");setTimeout(function(){e.find(".stoneDisplayHeader .level1 .glow").addClass("visible");e.find(".stoneDisplayHeader .level1 .star").addClass("visible");setTimeout(function(){e.find(".stoneDisplayHeader .level1 .glow").removeClass("visible")},150);if(c>=2){setTimeout(function(){e.find(".stoneDisplayHeader .level2 .glow").addClass("visible");e.find(".stoneDisplayHeader .level2 .star").addClass("visible");setTimeout(function(){e.find(".stoneDisplayHeader .level2 .glow").removeClass("visible")},150);if(c>=3){setTimeout(function(){e.find(".stoneDisplayHeader .level3 .glow").addClass("visible");e.find(".stoneDisplayHeader .level3 .star").addClass("visible");
setTimeout(function(){e.find(".stoneDisplayHeader .level3 .glow").removeClass("visible")},250);if(c>=4){setTimeout(function(){e.find(".stoneDisplayHeader .level4 .glow").addClass("visible");e.find(".stoneDisplayHeader .level4 .star").addClass("visible");setTimeout(function(){e.find(".stoneDisplayHeader .level4 .glow").removeClass("visible")},250);if(c>=5){setTimeout(function(){e.find(".stoneDisplayHeader .level5 .glow").addClass("visible");e.find(".stoneDisplayHeader .level5 .star").addClass("visible");setTimeout(function(){e.find(".stoneDisplayHeader .level5 .glow").removeClass("visible")},250)},500)}},500)}},500)}},500)}setTimeout(function(){e.find(".bonusRepresentation .glow").addClass("step2 visible");setTimeout(function(){e.find(".bonusRepresentation .glow").removeClass("visible");e.find(".banner").removeClass("enlarged");e.find(".bonusLevelUpReward").addClass("faded");setTimeout(function(){Travian.Game.Layout.toggleBackgroundOverlay()},750)},750)},(2800-(5-c)*500))},1250)},100)},300)
},800)},750)},250)},refreshProgressBarTitle:function(d){var b=jQuery("div.progressBarDailyLimit");var c=b.attr("data-tooltip").match(/(^.*)(\[AMOUNT\])(.*$)/);b.title=c[1]+d+c[3];Travian.Tip.refresh()},initContributeDisabledAction:function(){var b=this;jQuery("#contributeButtons").find("button").on("click",function(){b.calculateSum("donate");if(!b.bonusSelected&&parseInt(jQuery("#donateSum").html())>0){jQuery("#bonusNotSelectedMessage").show()}})}};Travian.Game.AllianceLeave=function(b){this.options=Object.assign({data:{}},b);this.initialize=function(){Travian.Dialog.Ajax.call(this,"ajax/allianceLeave",this.options)};this.reload=function(){this.request()};this.initialize()};Travian.Game.AllianceLeave.prototype=Object.create(Travian.Dialog.Ajax.prototype);Travian.Game.AllianceLeave.constructor=Travian.Game.AllianceLeave;Travian.Game.PaymentWizard=function(b){var c=this;this.options=Travian.Helpers.deepmergeObject({shopUIVersion:0,data:{goldProductId:"",goldProductLocation:"",location:"",activeTab:"buyGold",formData:{}},keepOpen:true,buttonCancel:true,buttonOk:false,context:"paymentWizard",cssClass:"",draggable:false,infoIcon:true,version:2,reloadOnClose:false,darkOverlay:true,overlayCancel:false,useCallback:false,callback:Travian.emptyFunction(),callbackScope:null,onClose:function(d){Travian.Game.PaymentWizardEventListener.PaymentWizardObject=null;
if(c.options.useCallback===true&&typeof c.options.callback==="function"){c.options.callback({scope:c.options.callbackScope})}jQuery(window).trigger("paymentWizardOnCloseEvent");Travian.Game.Layout.updateGold(c.options.callback);Travian.TimersAndCounters.enableReloadEvent();if(c.options.reloadOnClose){window.location.reload()}}},b);this.request=function(){var d=this;Travian.api(this.cmd,{data:this.options.data,success:function(e){if(e.html!==""){d.setReloadOnClose(e.reloadOnClose).setContent(e.html).setInfoIcon(e.infoIcon).show()}else{d.close()}},error:function(e){d.dispose();new Travian.Dialog.Dialog({preventFormSubmit:true}).setContent(e.errorMsg).show()}});return this};this.initialize=function(){var f=this;Travian.TimersAndCounters.suppressReloadEvent();var e=function(h){var g=f.options.shopUIVersion<4?jQuery(h.target).parent(".tabButton").attr("class").split(" ")[1]:jQuery(h.target).data("tabname");if(g==="pros"){f.options.callback=null}f.options.data.activeTab=g;f.options.data.goldProductId=null;
f.reload();h.stopPropagation();return false};var d=f.options.onOpen;f.options.onOpen=function(){var g=jQuery("#paymentWizard");var h=f.options.shopUIVersion<4?".header .tabButton":".header .tabItem";g.find(h).each(function(j,k){k=jQuery(k);k.off("click.paymentWizard");k.on("click.paymentWizard",e)},this);if(g.length>0){g.find(".iconButton.info").attr("title",Travian.Translation.get("paymentWizard.infoButtonLabel"));f.updateInfoButton({buttonTextInfo:Travian.Translation.get("paymentWizard.infoButtonLabel"),infoIcon:function(){window.open(g.find(".paymentWizardAnswersLink").val())}})}if(f.options.data.activeTab==="buyGold"||f.options.data.activeTab===""){f.initializeBuyGoldTab()}else{if(f.options.data.activeTab==="pros"){f.initializeProsTab()}else{if(f.options.data.activeTab==="earnGold"){f.initializeEarnGoldTab()}else{if(f.options.data.activeTab==="vouchers"){f.initializeVouchersTab()}}}}if(d&&(typeof d==="function")){d()}};Travian.Dialog.Ajax.call(this,"ajax/paymentWizard",f.options);return this
};this.initializeBuyGoldTab=function(){var n=this;var j=jQuery("#paymentWizard");var e=j.find(".contentWrapper .infoArea");var k=j.find(".contentWrapper .contentArea");var m=function(q,r){if(!q.hasClass(r)){q=q.parent("."+r)}return q};var f=function(r){var q=e.find(".buyGoldLocation")[0];n.options.data.goldProductLocation=q.options[q.selectedIndex].value;n.options.data.goldProductId="";n.reload();r.stopPropagation();return false};var d=function(q){e.find(".buyGoldInfoStep.locationStep").each(function(r){r.fadeOut()});e.find(".buyGoldInfoStep.locationStep.buyGoldFormStep").fadeIn();q.stopPropagation();return false};var h=function(q){n.options.data.goldProductId="";n.reload();q.stopPropagation();return false};var g=function(r){var q=m(jQuery(r.target),"goldProduct");if(q!=null){var s=q.find(".goldProductId").attr("data-voucher");if(s){voucherPopup();r.stopPropagation();return false}n.options.data.goldProductId=q.find(".goldProductId").val();n.reload()}r.stopPropagation();return false};var p=function(t){var r=m(jQuery(t.target),"providerLink");
if(r!=null){var u,v;var q=r.find(".providerId").val();try{u=r.find(".popupWidth").val()}catch(s){u=800}try{v=r.find(".popupHeight").val()}catch(s){v=600}n.options.useCallback=true;n.openProvider(n.options.data.goldProductId,q,u,v)}t.stopPropagation();return false};var o=function(s){if(!n.DoubleClickPreventer){n.DoubleClickPreventer=new Travian.DoubleClickPreventer();n.DoubleClickPreventer.timeout=2000}if(!n.DoubleClickPreventer.check()){s.stopPropagation();return false}var t=k.find(".paymentOpenOffersResult")[0];if(t){t.destroy()}var r=jQuery(s.target);r.hide();var q=r.parent(".footerItem");if(r.hasClass("ordersHide")===true){q.find(".ordersShow").fadeIn();k.find(".buyGoldContent").fadeOut();k.find(".openOffers").fadeOut();s.stopPropagation();return false}q.down(".ordersHide").fadeIn();k.down(".buyGoldContent").fadeOut();k.down(".openOffers").fadeIn();Travian.api("ajax/paymentWizardOpenOffers",{data:{},success:function(v){var u=k.find(".openOffers")[0];u.empty();if(v.noResult===false){u.html(v.html)
}else{u.html(v.errorMsg)}}});s.stopPropagation();return false};if(e.find(".buyGoldLocation").length>0){e.find(".buyGoldLocation")[0].on("change",f)}if(e.find("a").length>0){e.find("a")[0].on("click",d)}var l=e.find(".changeGoldProduct");if(l.length>0){l[0].on("click",h)}k.find(".goldProduct").each(function(q,r){r.on("click",g)});k.find(".paymentProvider").each(function(q,r){r.on("click",p)});e.find(".openOrdersLink").each(function(q,r){r.on("click",o)});return this};this.updatePosition=function(f,e){var d=this.calculatePosition();this.setPosition({x:d.left,y:d.top},f)};this.initializeEarnGoldTab=function(){var l=this;var d=jQuery("#paymentWizard.earnGold");var e=d.find(".contentWrapper .earnGoldPage").parent();var f=function(n){if(!n||n===""||typeof n==="undefined"){n="earnGoldOverview"}e.children().hide();e.children("."+n).show();return this};var k=function(o){var q=undefined;var p=jQuery(o.target).attr("class").split(" ");for(var n=0;n<p.length;n++){if(p[n].indexOf("earnGold")===0){q=p[n];
break}}f(q);o.stopPropagation();return false};d.find("a.showEarnGoldPage").on("click",k);var h=function(p){var o=e.find(".receiverLines").children().length;if(o<6){var n=Travian.Translation.translate("{earnGoldContentMailSendReceiverCount}").replace("[RECEIVER_COUNT]",o+1);var q=jQuery('<div class="receiverLine">'+n+'<input type="text" class="text" name="receiver[]" /></div>');q.appendTo(e.find(".receiverLines"));if(o>=5){e.find(".receiverLinkLine").hide()}}p.stopPropagation();return false};e.find(".earnGoldAddLink").on("click",h);e.find(".earnGoldSendMailCancel").on("click",function(){l.options.data.formData={};l.options.data.location="";l.reload()});e.find(".earnGoldSendMailSubmit").on("click",function(){var n={};n.receiver=[];e.find(".receiverLines input").each(function(o,p){n.receiver.push(jQuery(p).val())});n.message=e.find(".earnGoldSendMailMessage").val();l.options.data.formData=n;l.options.data.location="earnGoldMailSend";l.reload()});var g=false;var j=function(n){if(g){return this
}g=true;Travian.api("ajax/paymentWizardAdvertisedPersons",{data:{page:n},success:function(o){if(o.errorMessage){l.setError(o)}else{if(o.html){g=false;e.find(".earnGoldAdvertisedPersonsList").html(o.html);e.find(".paginator a").on("click",function(q){var p=jQuery(q.target);if(p.prop("tagName").toLowerCase()!=="a"){p=p.parent("a")}n=p.attr("href").toString().split("=")[1];j(n);q.stopPropagation();return false})}}}});return this};var m=e.find("a.showEarnGoldPage.earnGoldDrumUps");if(m!==null){m.on("click",function(n){j()})}f(l.options.data.location)};this.initializeProsTab=function(){var e=this;var d=jQuery("#featureCollectionWrapper");d.find(".prosButton").each(function(f,g){g=jQuery(g);g.off("click");g.on("click",function(h){e.options.useCallback=true;e.options.callback=function(){window.location.href=window.location.href;window.location.reload()};e.requestSend=true;if(jQuery(this).hasClass("productionboostWood")){jQuery(window).trigger("startWayOfPayment",["productionboostWood","paymentWizard"])
}else{if(jQuery(this).hasClass("productionboostClay")){jQuery(window).trigger("startWayOfPayment",["productionboostClay","paymentWizard"])}else{if(jQuery(this).hasClass("productionboostIron")){jQuery(window).trigger("startWayOfPayment",["productionboostIron","paymentWizard"])}else{if(jQuery(this).hasClass("productionboostCrop")){jQuery(window).trigger("startWayOfPayment",["productionboostCrop","paymentWizard"])}else{if(jQuery(this).hasClass("plus")){jQuery(window).trigger("startWayOfPayment",["plus","paymentWizard"])}else{if(jQuery(this).hasClass("goldclub")){jQuery(window).trigger("startWayOfPayment",["goldclub","paymentWizard"])}}}}}}return false})});d.find(".checkbox").each(function(f,g){g=jQuery(g);g.off("click");g.on("click",function(h){if(jQuery(this).hasClass("prolongProductionboostWood")){return e.toggleAutoprolong("productionboostWood","productionBoost")}else{if(jQuery(this).hasClass("prolongProductionboostClay")){return e.toggleAutoprolong("productionboostClay","productionBoost")
}else{if(jQuery(this).hasClass("prolongProductionboostIron")){return e.toggleAutoprolong("productionboostIron","productionBoost")}else{if(jQuery(this).hasClass("prolongProductionboostCrop")){return e.toggleAutoprolong("productionboostCrop","productionBoost")}else{if(jQuery(this).hasClass("prolongPlus")){return e.toggleAutoprolong("plus","plus")}}}}}h.stopPropagation();return false})});if(e.options.shopUIVersion===4){d.find(".feature").on("mouseover",function(h){var f=jQuery(this).find(".premiumFeatureName").val();if(!f||f===e.lastFeatureName){h.stopPropagation();return false}var k=jQuery("#paymentWizard");k.find(".infoArea .premiumFeature").removeClass("show");k.find(".infoArea .premiumFeature").filter("."+f).addClass("show");var l=k.find("#featureIndicator");var g=jQuery(this);var j=g.get(0).offsetTop+g.height()/2-l.height()/2;l.stop().addClass("moving").animate({top:j},250,"linear",function(){jQuery(this).removeClass("moving")});e.lastFeatureName=f});d.find(".feature.preSelected").trigger("mouseover")
}else{d.find(".feature").on("mouseover",function(g){var f=jQuery(this).find(".premiumFeatureName").val();if(!f||f===e.lastFeatureName){g.stopPropagation();return false}var h=jQuery("#paymentWizard");h.find(".infoArea .premiumFeature").hide();h.find(".contentArea .feature .dynamicContent").hide();jQuery(this).find(".dynamicContent").show();h.find(".infoArea .premiumFeature").filter("."+f).show();e.lastFeatureName=f})}if(d.length>0){Travian.TimersAndCounters.initTimersInContext(d[0])}};this.initializeVouchersTab=function(){return false};this.toggleAutoprolong=function(g,d){var f=this;var e={featureKey:g,toggleAutoprolong:1};Travian.api("ajax/premiumFeature",{data:e,success:function(h){f.reload()}})};this.setReloadOnClose=function(d){this.options.reloadOnClose=this.options.reloadOnClose===false&&d===true?d:this.options.reloadOnClose;return this};this.openProvider=function(e,d,f,g){window.open("/tgpay.php?product="+e+"&provider="+d,"tgpay","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width="+f+",height="+g)
};this.initialize()};Travian.Game.PaymentWizard.prototype=Object.create(Travian.Dialog.Ajax.prototype);Travian.Game.PaymentWizard.constructor=Travian.Game.PaymentWizard;var shopUIV2;function ShopUIV2(){this.allowSlidePackages=true;this.allowSlidePaymentMethods=true;this.goldPackagesPages=[];this.goldPackagesPagesSize=0;this.paymentMethodsPages=[];this.paymentMethodsPageSize=0;this.selectedPaymentMethod=false;this.rtl=false;this.initialize=function(){var c=this;if($$(".paymentWizardDirectionRTL").length>0){this.rtl=true}c.slidingContentInnerPackage=$$("#packageSlider .slidingContentInner")[0];c.slidingContentOuterPackage=$$("#packageSlider .slidingContentOuter")[0];c.slidingContentOuterWidthPackage=c.slidingContentOuterPackage.getDimensions();c.slidingContentOuterWidthPackage=parseInt(c.slidingContentOuterWidthPackage.x);c.slidingContentInnerPackage.set("tween",{duration:500,transition:"linear",link:"cancel",onComplete:function(){c.allowSlidePackages=true}});c.slidingContentInnerPaymentMethods=$$("#paymentMethodsSlider .slidingContentInner")[0];
c.slidingContentOuterPaymentMethods=$$("#paymentMethodsSlider .slidingContentOuter")[0];c.slidingContentOuterWidthPaymentMethods=c.slidingContentOuterPaymentMethods.getDimensions();c.slidingContentOuterWidthPaymentMethods=parseInt(c.slidingContentOuterWidthPaymentMethods.x);c.slidingContentInnerPaymentMethods.set("tween",{duration:500,transition:"linear",link:"cancel",onComplete:function(){c.allowSlidePaymentMethods=true}});var b=0;$$("#packageSlider .productsPage").each(function(e){c.goldPackagesPages[b]=e;if(c.goldPackagesPagesSize==0){var d=e.getStyle("width");d=parseInt(d.replace("px",""));c.goldPackagesPagesSize=d}b++});c.initializePaymentMethods();setTimeout(function(){c.packageSliderButtonCheck();c.paymentMethodsSliderButtonCheck();c.bindEvents();c.updateResultBox();setTimeout(function(){$$("#packageSlider .package.hideForLoading").removeClass("hideForLoading")},500)},250)};this.initializePaymentMethods=function(){var c=this;$$("#paymentMethodsSlider .loading")[0].removeClass("hide");
if(typeof $$(".package.selected input.goldProductId")[0]==="undefined"){return}var b=parseInt($$(".package.selected input.goldProductId")[0].get("value"));$$("#paymentMethodsSlider .slidingContent")[0].empty();c.updateResultBox();Travian.api("ajax/paymentProviders",{data:{selectedPackage:b},success:function(e){if(typeof $$("#paymentMethodsSlider .slidingContent")[0]==="undefined"){return false}$$("#paymentMethodsSlider .slidingContent")[0].set("html",e.html);if(!c.rtl){c.slidingContentInnerPaymentMethods.setStyle("margin-left",0)}else{c.slidingContentInnerPaymentMethods.setStyle("margin-right",0)}c.paymentMethodsPages=[];c.paymentMethodsPageSize=0;var d=0;$$(".methodsPage").each(function(g){c.paymentMethodsPages[d]=g;if(c.paymentMethodsPageSize==0){var f=g.getStyle("width");f=parseInt(f.replace("px",""));c.paymentMethodsPageSize=f}d++});$$("#paymentMethodsSlider .methodItem").each(function(h){h.addEvent("click",c.methodItemClickEvent);if(c.selectedPaymentMethod!==false){if(parseInt(h.getChildren()[0].get("value"))==c.selectedPaymentMethod){$$("#paymentMethodsSlider .methodItem").removeClass("selected");
h.addClass("selected");for(var f=0;f<c.paymentMethodsPages.length;f++){if(c.paymentMethodsPages[f]==h.getParent()){var g=f*c.paymentMethodsPageSize;if(g==0){g=1}c.allowSlidePaymentMethods=false;$$("#paymentMethodsSlider .methodsPage").removeClass("visible").addClass("hidden");c.paymentMethodsPages[f].removeClass("hidden").addClass("visible");if(!c.rtl){c.slidingContentInnerPaymentMethods.tween("margin-left",g*-1)}else{c.slidingContentInnerPaymentMethods.tween("margin-right",g*-1)}c.updateResultBox()}}}}});c.paymentMethodsSliderButtonCheck();$$("#paymentMethodsSlider .loading")[0].addClass("hide")}})};this.packageSliderButtonCheck=function(){var b=this;if(typeof b.goldPackagesPages[0]!="undefined"){if(b.goldPackagesPages[0].hasClass("visible")){if(!$$("#packageSlider .slideArea.area1")[0].hasClass("inactive")){$$("#packageSlider .slideArea.area1")[0].addClass("inactive")}}else{$$("#packageSlider .slideArea.area1")[0].removeClass("inactive")}if(b.goldPackagesPages[b.goldPackagesPages.length-1].hasClass("hidden")){if($$("#packageSlider .slideArea.area2")[0].hasClass("inactive")){$$("#packageSlider .slideArea.area2")[0].removeClass("inactive")
}}else{$$("#packageSlider .slideArea.area2")[0].addClass("inactive")}}};this.paymentMethodsSliderButtonCheck=function(){var b=this;if(typeof b.paymentMethodsPages[0]!="undefined"){if(b.paymentMethodsPages[0].hasClass("visible")){if(!$$("#paymentMethodsSlider .slideArea.area1")[0].hasClass("inactive")){$$("#paymentMethodsSlider .slideArea.area1")[0].addClass("inactive")}}else{$$("#paymentMethodsSlider .slideArea.area1")[0].removeClass("inactive")}if(b.paymentMethodsPages[b.paymentMethodsPages.length-1].hasClass("hidden")){if($$("#paymentMethodsSlider .slideArea.area2")[0].hasClass("inactive")){$$("#paymentMethodsSlider .slideArea.area2")[0].removeClass("inactive")}}else{$$("#paymentMethodsSlider .slideArea.area2")[0].addClass("inactive")}}};this.bindEvents=function(){var b=this;$$("#packageSlider .slideArea.area1").addEvent("click",function(){b.packageSlideLeft()});$$("#packageSlider .slideArea.area2").addEvent("click",function(){b.packageSlideRight()});$$("#packageSlider .package").addEvent("click",function(){if(!this.hasClass("selected")){$$(".package").removeClass("selected");
this.addClass("selected");b.initializePaymentMethods()}});$$("#phonePackages .package").addEvent("click",function(){if(!this.hasClass("selected")){$$(".package").removeClass("selected");this.addClass("selected");b.initializePaymentMethods()}});$$("#paymentMethodsSlider .slideArea.area1").addEvent("click",function(){b.paymentMethodsSlideLeft()});$$("#paymentMethodsSlider .slideArea.area2").addEvent("click",function(){b.paymentMethodsSlideRight()});$$("#paymentMethodsSlider .methodItem").addEvent("click",b.methodItemClickEvent);$$("#paymentMethodsSlider").addEvent("click",function(){b.updateResultBox();b.saveSelectedPaymentMethod()});$$("#overview .resultBox .activeButton").addEvent("click",function(){b.buyNowAction()});$$(".buyGoldLocation").addEvent("change",function(){b.changeLocation()});$$("#vouchers .package").addEvent("click",function(){voucherPopup()});window.addEvent("shopUIV2RestorePreview",function(){$$("#paymentMethodsSlider .loading")[0].removeClass("hide");$$("#packageSlider .slidingContentInner")[0].set("html","");
$$("#paymentMethodsSlider .slidingContentInner")[0].set("html","");$$("#phonePackages .package").destroy();$$("#vouchers .package").destroy();$$("#packageSlider .slideArea > div").removeClass("active").addClass("inactive");$$("#paymentMethodsSlider .slideArea > div").removeClass("active").addClass("inactive");$$(".resultBox .goldUnits").set("html","");$$(".resultBox #goldBalanceNew").set("html","");$$(".resultBox #priceToPay").set("html","")})};this.methodItemClickEvent=function(){if(!this.hasClass("inactive")&&!this.hasClass("defect")){$$("#paymentMethodsSlider .methodItem").removeClass("selected");this.addClass("selected")}};this.updateResultBox=function(){if(typeof $$(".package.selected .goldUnits")[0]==="undefined"){return}$$(".resultBox #packageGoldAmount .goldUnits")[0].set("html",$$(".package.selected .goldUnits")[0].get("html"));$$(".resultBox #goldBalanceNew")[0].set("html",(parseInt($$(".package.selected .goldUnits")[0].get("html"))+parseInt($$(".accountBalance span")[0].get("html"))));
$$(".resultBox #priceToPay")[0].set("html",$$(".package.selected .price")[0].get("html"));if($$("#paymentMethodsSlider .methodItem.selected")[0]){$$(".resultBox .inactiveButton").addClass("hide");$$(".resultBox .activeButton").removeClass("hide")}else{$$(".resultBox .activeButton").addClass("hide");$$(".resultBox .inactiveButton").removeClass("hide")}};this.saveSelectedPaymentMethod=function(){var b=this;if($$("#paymentMethodsSlider .methodItem.selected")[0]){b.selectedPaymentMethod=parseInt($$("#paymentMethodsSlider .methodItem.selected input.providerId")[0].get("value"))}};this.packageSlideLeft=function(){var h=this;if(h.allowSlidePackages){var g="";var b="";var c=false;for(var d=h.goldPackagesPages.length-1;d>=0;d--){if(h.goldPackagesPages[d].hasClass("visible")){g=h.goldPackagesPages[d];c=true}if(c&&h.goldPackagesPages[d].hasClass("hidden")){b=h.goldPackagesPages[d];break}}if(b!=""){var f=0;if(!h.rtl){f=h.slidingContentInnerPackage.getStyle("margin-left")}else{f=h.slidingContentInnerPackage.getStyle("margin-right")
}f=parseInt(f.replace("px",""));var e=(f+h.goldPackagesPagesSize);if(e==0){e=1}g.removeClass("visible").addClass("hidden");b.removeClass("hidden").addClass("visible");h.allowSlidePackages=false;if(!h.rtl){h.slidingContentInnerPackage.tween("margin-left",e)}else{h.slidingContentInnerPackage.tween("margin-right",e)}}}h.packageSliderButtonCheck()};this.packageSlideRight=function(){var h=this;if(h.allowSlidePackages){var g="";var b="";var c=false;for(var d=0;d<h.goldPackagesPages.length;d++){if(h.goldPackagesPages[d].hasClass("visible")){g=h.goldPackagesPages[d];c=true}if(h.goldPackagesPages[d].hasClass("hidden")){if(c){b=h.goldPackagesPages[d];break}}}if(b!=""){var f=0;if(!h.rtl){f=h.slidingContentInnerPackage.getStyle("margin-left")}else{f=h.slidingContentInnerPackage.getStyle("margin-right")}f=parseInt(f.replace("px",""))*-1;var e=(f+h.goldPackagesPagesSize)*-1;g.removeClass("visible").addClass("hidden");b.removeClass("hidden").addClass("visible");h.allowSlidePaymentMethods=false;if(!h.rtl){h.slidingContentInnerPackage.tween("margin-left",e)
}else{h.slidingContentInnerPackage.tween("margin-right",e)}}}h.packageSliderButtonCheck()};this.paymentMethodsSlideLeft=function(){var h=this;if(h.allowSlidePaymentMethods){var g="";var b="";var c=false;for(var d=h.paymentMethodsPages.length-1;d>=0;d--){if(h.paymentMethodsPages[d].hasClass("visible")){g=h.paymentMethodsPages[d];c=true}if(c&&h.paymentMethodsPages[d].hasClass("hidden")){b=h.paymentMethodsPages[d];break}}if(b!=""){var f=0;if(!h.rtl){f=h.slidingContentInnerPaymentMethods.getStyle("margin-left")}else{f=h.slidingContentInnerPaymentMethods.getStyle("margin-right")}f=parseInt(f.replace("px",""));var e=(f+h.paymentMethodsPageSize);if(e==0){e=1}g.removeClass("visible").addClass("hidden");b.removeClass("hidden").addClass("visible");h.allowSlidePaymentMethods=false;if(!h.rtl){h.slidingContentInnerPaymentMethods.tween("margin-left",e)}else{h.slidingContentInnerPaymentMethods.tween("margin-right",e)}}}h.paymentMethodsSliderButtonCheck()};this.paymentMethodsSlideRight=function(){var h=this;
if(h.allowSlidePaymentMethods){var g="";var b="";var c=false;for(var d=0;d<h.paymentMethodsPages.length;d++){if(h.paymentMethodsPages[d].hasClass("visible")){g=h.paymentMethodsPages[d];c=true}if(h.paymentMethodsPages[d].hasClass("hidden")){if(c){b=h.paymentMethodsPages[d];break}}}if(b!=""){var f=0;if(!h.rtl){f=h.slidingContentInnerPaymentMethods.getStyle("margin-left")}else{f=h.slidingContentInnerPaymentMethods.getStyle("margin-right")}f=parseInt(f.replace("px",""))*-1;var e=(f+h.paymentMethodsPageSize)*-1;g.removeClass("visible").addClass("hidden");b.removeClass("hidden").addClass("visible");h.allowSlidePaymentMethods=false;if(!h.rtl){h.slidingContentInnerPaymentMethods.tween("margin-left",e)}else{h.slidingContentInnerPaymentMethods.tween("margin-right",e)}}}h.paymentMethodsSliderButtonCheck()};this.buyNowAction=function(){if($$("#overview .resultBox .inactiveButton.hide")[0]){var f=parseInt($$(".package.selected input.goldProductId")[0].get("value"));var c=parseInt($$("#paymentMethodsSlider .methodItem.selected input.providerId")[0].get("value"));
var e=800;var g=600;if($$("#paymentMethodsSlider .methodItem.selected input.popupWidth")[0]){e=$$("#paymentMethodsSlider .methodItem.selected input.popupWidth")[0]}if($$("#paymentMethodsSlider .methodItem.selected input.popupHeight")[0]){g=$$("#paymentMethodsSlider .methodItem.selected input.popupHeight")[0]}var b=(screen.width-e)/2;var d=(screen.height-g)/2;window.open("/tgpay.php?product="+f+"&provider="+c,"tgpay","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width="+e+",height="+g+",left="+b+",top="+d)}};this.changeLocation=function(){var c=$$("select.buyGoldLocation")[0].getSelected()[0].get("value");var b=(new Overlay(document.body,{opacity:0.8,duration:250})).open();Travian.Game.PaymentWizardEventListener.PaymentWizardObject&&Travian.Game.PaymentWizardEventListener.PaymentWizardObject.close();jQuery(window).trigger("startPaymentWizard",{data:{goldProductId:"",goldProductLocation:c,location:"",activeTab:"buyGold",formData:{}},onOpen:function(){b.close().dispose()}})};this.selectPackage=function(f){var e=this;
var g=$$(".package input[value="+f+"]")[0];f=g.getParent();var b=f.getParent();if(b.id!="phonePackages"){if(b.hasClass("hidden")){for(var c=0;c<e.goldPackagesPages.length;c++){if(e.goldPackagesPages[c]==b){var d=c*e.goldPackagesPagesSize;if(d==0){d=1}e.allowSlidePackages=false;$$("#packageSlider .productsPage").removeClass("visible").addClass("hidden");e.goldPackagesPages[c].removeClass("hidden").addClass("visible");if(!e.rtl){e.slidingContentInnerPackage.tween("margin-left",d*-1)}else{e.slidingContentInnerPackage.tween("margin-right",d*-1)}}}}}$$(".package").removeClass("selected");f.addClass("selected")}}var shopUIV4=new ShopUIV4();function ShopUIV4(){this.paymentShop=null;this.paymentWizard=null;this.packages=null;this.countrySelection=null;this.countrySelectionTemplate=null;this.paymentMethods=null;this.selectedPackage=null;this.continueButton=null;this.closeButton=null;this.loader=null;this.progressSteps=null;this.activeTab=null;this.currentProgressStep="selectPackage";this.country=null;
this.goldProductId=null;this.goldProductLocation=null;this.goldBookingListenerInterval=null;this.initialize=function(){var b=this;b.paymentShop=jQuery(".dialog.paymentShopV4");b.paymentWizard=jQuery("#paymentWizard");b.paymentWizard.addClass("selectPackage");b.showLoader(true);b.goldProductId=typeof Travian.Game.PaymentWizardEventListener.PaymentWizardObject!=="undefined"?Travian.Game.PaymentWizardEventListener.PaymentWizardObject.options.data.goldProductId:null;b.goldProductLocation=typeof Travian.Game.PaymentWizardEventListener.PaymentWizardObject!=="undefined"?Travian.Game.PaymentWizardEventListener.PaymentWizardObject.options.data.goldProductLocation:null;Travian.api("paynet/init",{success:function(c){if(typeof c.html!=="undefined"){jQuery(window).off("travian.preferences.reloaded");if(b.paymentWizard.hasClass("buyGold")){b.paymentWizard.find(".contentWrapper").empty().append(c.html);b.countrySelection=b.paymentShop.find(".countrySelection");b.countrySelectionTemplate=b.paymentShop.find("#countrySelectionTemplate");
b.billingWrapper=b.paymentShop.find(".billingWrapper");b.packages=b.paymentShop.find("input[name=package]");b.paymentMethods=b.paymentShop.find("input[name=paymentMethod]");b.continueButton=b.paymentShop.find("button.buyButton");b.closeButton=b.paymentShop.find("#backToGame");b.progressSteps=b.paymentShop.find(".buyProgress .step");b.selectedPackage=null;b.initializePaymentMethods();b.bindEvents();b.setProgressStep("selectPackage",false);b.displayPromotionIndicator();Travian.Tip.refresh();Travian.TimersAndCounters.initTimersInContext(b.paymentShop.find(".specialOffersPackages")[0]);if(b.goldProductLocation!==null&&b.goldProductLocation!==""&&b.countrySelectionTemplate.find("input[name=country]:checked").val()!==b.goldProductLocation){b.hideLoader();b.changeCountry(b.goldProductLocation)}else{b.preselectPackage();b.hideLoader()}}}},error:function(c){b.paymentWizard.find(".contentWrapper").empty();b.errorDialog(c.message);b.hideLoader()}},"get")};this.preselectPackage=function(){let $this=this;
if($this.goldProductId!==null&&$this.goldProductId!==""){$this.paymentWizard.find("input[value="+$this.goldProductId+"]").prop("checked","checked").trigger("change")}};this.initializePaymentMethods=function(){var b=this;if(b.selectedPackage!==null){b.hideLoader();b.showLoader();Travian.api("paynet/cart",{data:{productID:b.selectedPackage},success:function(d){if(typeof d.html!=="undefined"){jQuery(".paymentMethods").html(d.html);b.paymentShop.find("input[name=paymentMethod]").on("change.paymentShopV4",function(){if(b.paymentShop.find("input[name=paymentMethod]:checked").length>0){b.continueButton.removeClass("disabled")}});b.setProgressStep("selectPaymentMethod",false);b.hideLoader();Travian.Tip.refresh();b.paymentWizard.find(".paymentMethods .paymentMethod.back").on("click.paymentShopV4",function(){b.setProgressStep("selectPaymentMethod",true)});var c=b.paymentShop.find("input[name=paymentMethod]");if(c.length===1){c.prop("checked","checked");b.continueButton.removeClass("disabled")}else{var f=Travian.Game.Preferences.get("lastUsedPaymentMethod");
if(f!==null){var e=b.paymentShop.find("input[name=paymentMethod][data-code="+f+"]");if(e.length>0){e.prop("checked","checked");if(!e.find("+ label").is(":visible")){jQuery("#togglePaymentMethods").prop("checked","checked")}b.continueButton.removeClass("disabled")}}}}},error:function(c){b.hideLoader();b.errorDialog(c.message)}},"put")}};this.bindEvents=function(){var b=this;b.countrySelection.off("click.paymentShopV4").on("click.paymentShopV4",function(c){c.preventDefault();b.renderCountryDialog()});b.packages.off("change.paymentShopV4").on("change.paymentShopV4",function(){b.continueButton.addClass("disabled");b.selectedPackage=b.paymentShop.find("input[name=package]:checked").val();b.initializePaymentMethods()});b.packages.off("click.paymentShopV4").on("click.paymentShopV4",function(){if(b.currentProgressStep==="insertBillingInformation"){b.setProgressStep("selectPackage",true)}});b.paymentWizard.find(".paymentWrapper .smsPayment a").off("click.paymentShopV4").on("click.paymentShopV4",function(c){c.preventDefault();
b.paymentWizard.addClass("sms")});b.progressSteps.off("click.paymentShopV4").on("click.paymentShopV4",function(){var c=jQuery(this);["selectPackage","selectPaymentMethod"].forEach(function(d){if(c.hasClass(d)){b.setProgressStep(d,true)}})});b.continueButton.off("click.paymentShopV4").on("click.paymentShopV4",function(){var f=jQuery(this);if(!f.hasClass("disabled")&&f.prop("disabled")!=="disabled"){var c=b.paymentShop.find("input[name=paymentMethod]:checked");if(c.length===0){return false}var d=false;switch(b.currentProgressStep){case"selectPaymentMethod":b.setProgressStep("insertBillingInformation",false);break;case"insertBillingInformation":b.showLoader();d=true;break}if(d){var e=c.data("code");Travian.api("paynet/create-payment",{data:{paymentMethodCode:e},success:function(k){b.hideLoader();if(typeof k.url!=="undefined"){var l=900;var m=800;var h=jQuery(window);var g=(h.width()-l)/2+window.screenX;var j=(h.height()-m)/2;window.open(k.url,"paynet","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width="+l+",height="+m+",left="+g+",top="+j);
b.setProgressStep("confirmed");b.paymentShop.find(".confirmation.forwarded").addClass("visible");Travian.Game.Preferences.set("goldBookingNotification",null);Travian.Game.Preferences.set("lastUsedPaymentMethod",e);if(jQuery("input[name=package][value="+b.selectedPackage+"]").parent(".specialOffersPackages").length>0){jQuery("#oneTimeOfferNotification").removeClass("firstTimeAnimation").addClass("dismissed")}}else{b.errorDialog("Error: The payment method could not be loaded.")}},error:function(g){b.hideLoader();b.errorDialog(g.message)}},"post")}}});b.closeButton.off("click.paymentShopV4").on("click.paymentShopV4",function(){Travian.WindowManager.closeByContext("paymentWizard")})};this.changeCountry=function(c){var b=this;b.country=c;b.showLoader();let inputElement=b.countrySelectionTemplate.find("input[name=country][value="+c+"]");let parent=inputElement.parent("label");let shopTitle=b.paymentWizard.find("h1.countrySelection");shopTitle.find(".inlineIcon .value").html(parent.data("country-native"));
shopTitle.find(".inlineIcon").find("svg").remove();shopTitle.find(".inlineIcon").prepend(parent.find("svg").clone());Travian.api("paynet/productsByCountry/"+b.country,{success:function(d){b.hideLoader();if(typeof d.renderedPackages!=="undefined"&&typeof d.renderedSmsPackages!=="undefined"&&typeof d.renderedSpecialOffersPackages!=="undefined"){b.paymentWizard.find(".packages:not(.smsPackages):not(.specialOffersPackages").empty().append(d.renderedPackages);b.paymentWizard.find(".smsPackages").empty().append(d.renderedSmsPackages);b.paymentWizard.find(".specialOffersPackages").empty().append(d.renderedSpecialOffersPackages);Travian.TimersAndCounters.initTimersInContext(b.paymentShop.find(".specialOffersPackages")[0]);b.packages=b.paymentShop.find("input[name=package]");if(d.renderedSmsPackages===""){b.paymentWizard.find(".smsPayment").removeClass("available")}else{b.paymentWizard.find(".smsPayment").addClass("available")}b.setProgressStep("selectPackage",false);b.bindEvents();b.preselectPackage()
}},error:function(d){b.hideLoader();b.errorDialog(d.message)}},"get")};this.showLoader=function(c){var b=this;b.loader=b.paymentShop.find(".loading");if(typeof c!=="undefined"&&c===true){b.loader.addClass("visible").addClass("preview")}else{b.loader.addClass("visible")}b.paymentShop.find("h1.countrySelection").addClass("disabled");b.paymentShop.find(".contentNavi .tabItem").attr("disabled","disabled");b.paymentShop.find("div:not(#dialogContent) .iconButton").addClass("disabled");b.activeTab=b.paymentShop.find(".contentNavi .content.active");b.activeTab.removeClass("active")};this.hideLoader=function(){var b=this;b.loader.removeClass("visible");b.paymentShop.find("h1.countrySelection").removeClass("disabled");b.paymentShop.find(".contentNavi .tabItem").attr("disabled",false);b.paymentShop.find("div:not(#dialogContent) .iconButton").removeClass("disabled");b.activeTab.addClass("active")};this.setProgressStep=function(d,j){var h=this;var g={selectPackage:1,selectPaymentMethod:2,insertBillingInformation:3,confirmed:4};
if(j){g={selectPackage:1,selectPaymentMethod:2}}if(typeof g[d]==="undefined"){return false}if(j){var b=g[h.currentProgressStep];var f=g[d];if(b<f){return false}}h.progressSteps.removeClass("locked");h.progressSteps.removeClass("done");h.progressSteps.removeClass("active");var e=false;h.progressSteps.each(function(k,l){l=jQuery(l);if(!e){if(!l.hasClass(d)){l.addClass("done")}else{e=true;l.addClass("active")}}else{l.addClass("locked")}});switch(d){case"selectPackage":h.paymentWizard.removeClass("sms").removeClass("selectPaymentMethod").removeClass("insertBillingInformation").removeClass("confirmed").addClass("selectPackage");h.paymentShop.find("input[name=package]:checked").prop("checked",false);h.paymentShop.find("input[name=paymentMethod]:checked").prop("checked",false);h.paymentShop.find("input[name=paymentMethod]").attr("disabled","disabled");h.paymentWizard.removeClass("forwarded").removeClass("successful");h.paymentWizard.find(".silwia").addClass("normal").removeClass("success");h.continueButton.addClass("disabled");
break;case"selectPaymentMethod":h.paymentWizard.removeClass("selectPackage").removeClass("insertBillingInformation").removeClass("confirmed").addClass("selectPaymentMethod");h.paymentShop.find("input[name=paymentMethod]:checked").prop("checked",false);h.continueButton.addClass("disabled");break;case"insertBillingInformation":var c=h.paymentShop.find("input[name=paymentMethod]:checked").val();h.paymentWizard.removeClass("selectPackage").removeClass("selectPaymentMethod").removeClass("confirmed").addClass("insertBillingInformation");if(c==="SMART2PAY_VTC"){h.paymentShop.find(".vatInfo").html("*&nbsp;"+Travian.Translation.get("paymentWizard.pricesAreFinalExceptExtraTaxes"))}break;case"confirmed":h.paymentWizard.removeClass("selectPackage").removeClass("selectPaymentMethod").removeClass("insertBillingInformation").addClass("confirmed").addClass("forwarded");h.goldBookingListener();break}h.currentProgressStep=d};this.goldBookingListener=function(){var b=this;jQuery(window).on("travian.preferences.reloaded",function(){var c=Travian.Game.Preferences.get("goldBookingNotification");
if(c!==null&&parseInt(c)>0){b.paymentWizard.find(".confirmation .confirmationText .value").html(c);b.paymentWizard.removeClass("forwarded").addClass("successful");b.paymentWizard.find(".silwia").removeClass("normal").addClass("success");Travian.Game.Layout.updateGold();Travian.Game.Preferences.set("goldBookingNotification",null);clearInterval(b.goldBookingListenerInterval)}});b.goldBookingListenerInterval=setInterval(function(){if(b.paymentWizard.is(":visible")&&b.paymentWizard.hasClass("confirmed")&&b.paymentWizard.hasClass("forwarded")){Travian.Game.Preferences.reload()}else{clearInterval(b.goldBookingListenerInterval)}},3000)};this.displayPromotionIndicator=function(){jQuery(window).on("travian.preferences.reloaded",function(){var b=Travian.Game.Preferences.get("paymentShopPromotionEnd");var c=jQuery(".tabItem.buyGold").parent(".content");if(b!==null&&parseInt(b)>new Date().getTime()/1000){c.addClass("promotion")}else{c.removeClass("promotion")}});Travian.Game.Preferences.reload()};this.errorDialog=function(b){var c=new Travian.Dialog.Dialog({preventFormSubmit:true});
c.setContent('<div class="error centeredText errorMessage">'+b+"</div>").show()};this.initializeVouchers=function(){var f=this;f.paymentShop=jQuery(".dialog.paymentShopV4");f.paymentWizard=jQuery("#paymentWizard");var h=f.paymentShop.find("form");var e=f.paymentWizard.find(".voucherForm");if(e.length>0){var d=f.paymentWizard.find(".silwia");var c=e.find("input[name=voucher]");var g=e.find(".errorMessageContainer");var b=e.find("#redeemVoucher");c.on("keyup input",function(j){if(j.key==="Enter"){j.preventDefault();return false}c.removeClass("invalid");if(jQuery(this).val().trim()===""){b.addClass("disabled")}else{b.removeClass("disabled")}});h.off("submit");h.on("submit",function(j){j.preventDefault();if(b.hasClass("disabled")){return false}f.showLoader();Travian.api("paynet/redeem-voucher",{data:{code:c.val().trim()},success:function(k){f.paymentWizard.find(".packages label .amount .value").html(k.data.value);f.paymentWizard.find(".confirmation .confirmationText .value").html(k.data.value);
f.paymentShop.find("#backToGame").on("click.paymentShopV4",function(){Travian.WindowManager.closeByContext("paymentWizard")});f.hideLoader();f.paymentWizard.addClass("confirmed");d.removeClass("normal").addClass("success");jQuery(window).on("travian.preferences.reloaded",function(){var l=Travian.Game.Preferences.get("goldBookingNotification");if(l!==null&&parseInt(l)>0){Travian.Game.Layout.updateGold();Travian.Game.Preferences.set("goldBookingNotification",null);clearInterval(f.goldBookingListenerInterval)}});f.goldBookingListenerInterval=setInterval(function(){if(f.paymentWizard.hasClass("confirmed")){Travian.Game.Preferences.reload()}else{clearInterval(f.goldBookingListenerInterval)}},1000)},error:function(k){f.hideLoader();if(k.code&&k.code>=4001&&k.code<=4008){c.addClass("invalid");g.html(k.message);Travian.TimersAndCounters.initTimers()}else{f.errorDialog(k.message)}}},"post")})}};this.renderSmallestPackageDialog=function(c){var b=this;Travian.api("paynet/smallestPackageDialog/"+c,{success:function(e){if(typeof e.html!=="undefined"){var d=Travian.WindowManager.getWindowsByContext("smallestPackage")[0];
if(typeof d!=="undefined"){d.setContent(e.html)}}},error:function(d){b.errorDialog(d.message)}},"get")};this.renderTransactionHistoryDialog=function(){var b=this;b.showLoader();Travian.api("paynet/transactionHistoryDialog",{success:function(d){b.hideLoader();var c=new Travian.Dialog.Dialog({version:2,preventFormSubmit:true,buttonOk:false,cssClass:"plain scrollable transactionHistory"});c.setContent(d.html);c.show()},error:function(c){b.hideLoader();b.errorDialog(c.message)}},"get")};this.copyOrderCodeListener=function(){var b=jQuery(".copyOrderCode");b.off("click.paymentShopV4");b.on("click.paymentShopV4",function(g){g.preventDefault();var f=jQuery(g.target);jQuery(".copiedNotice").removeClass("success");var d=jQuery("<input/>");jQuery("body").append(d);d.val(f.data("order-id")).select();document.execCommand("copy");d.remove();var c=f.parent(".orderCode").find(".copiedNotice");c.removeClass("success").addClass("success")})};this.renderCountryDialog=function(){var d=this;var c=new Travian.Dialog.Dialog({version:2,preventFormSubmit:true,buttonOk:false,infoIcon:false,cssClass:"plain scrollable countrySelection",context:"paymentShopV4CountrySelection"});
c.setContent('<div id="countrySelection" class="'+d.countrySelectionTemplate.prop("class")+'">'+d.countrySelectionTemplate.html()+"</div>");c.show();var b=jQuery("#countrySelection");b.find("input[name=country][value="+d.country+"]").prop("checked","checked");b.find("input[name=country]").off("change.paymentShopV4").on("change.paymentShopV4",function(){Travian.WindowManager.closeByContext("paymentShopV4CountrySelection");d.changeCountry(jQuery(this).val())});b.find(".filterCountry input").off("keyup").on("keyup",function(){var e=jQuery(this).val().toUpperCase();b.find(".countryListItem").each(function(f,g){g=jQuery(g);if(g.data("country-native").toUpperCase().indexOf(e)!==-1||g.data("country-english").toUpperCase().indexOf(e)!==-1||g.find("input").val().toUpperCase().indexOf(e)!==-1){g.show()}else{g.hide()}});if(b.find(".countryListItem:visible").length===0){b.find(".noCountryFound").removeClass("hide")}else{b.find(".noCountryFound").addClass("hide")}})}}Travian.Game.VideoFeatureShowVideo=function(b){this.request=function(){var c=this;
Travian.api(this.options.call,{data:this.options.data,success:function(d){c.setContent(d.html);c.show();c.updateInfoButton({buttonTextInfo:Travian.Translation.get("videoFeature.infoButtonLabel"),infoIcon:function(){window.open(jQuery("#videoFeature").find(".videoFeatureAnswersLink").val())}})}});return this};this.close=function(c){if(typeof this.requestSend!=="undefined"&&this.requestSend===true){return window.location.reload()}if([Travian.Dialog.CLOSE_CONTEXT_OVERLAYBACKGROUND,Travian.Dialog.CLOSE_CONTEXT_CANCELBUTTON].indexOf(c)>-1){new Travian.Game.VideoFeatureAbort()}else{Travian.TimersAndCounters.enableReloadEvent();Travian.Dialog.Api.prototype.close.call(this)}};Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo",buttonOk:false,context:"videoFeatureShowVideo",version:2,darkOverlay:true,cssClass:"videoFeature",onClose:function(c){Travian.Game.VideoFeatureEventListener.VideoFeatureObject=null}},b))};Travian.Game.VideoFeatureShowVideo.prototype=Object.create(Travian.Dialog.Api.prototype);
Travian.Game.VideoFeatureShowVideo.constructor=Travian.Game.VideoFeatureShowVideo;Travian.Game.VideoFeatureInfo=function(b){this.request=function(){var c=this;Travian.api(this.options.call,{data:this.options.data,success:function(d){c.setContent(d.html);c.show();c.updateInfoButton({buttonTextInfo:Travian.Translation.get("videoFeature.infoButtonLabel"),infoIcon:function(){window.open(jQuery("#videoFeature").find(".videoFeatureAnswersLink").val())}})}});return this};Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo/info",buttonOk:false,context:"videoFeatureInfo",version:2,darkOverlay:true,cssClass:"videoFeature"},b))};Travian.Game.VideoFeatureInfo.prototype=Object.create(Travian.Dialog.Api.prototype);Travian.Game.VideoFeatureInfo.constructor=Travian.Game.VideoFeatureInfo;Travian.Game.VideoFeatureAbort=function(b){this.abortVideo=function(){window.location.href=window.location.href;Travian.WindowManager.closeByContext("videoFeatureAbort");Travian.WindowManager.closeByContext("videoFeatureShowVideo")
};Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo/abort",buttonOk:false,buttonCancel:false,context:"videoFeatureAbort",darkOverlay:true,overlayCancel:false},b));jQuery(window).one("videoFeatureAbortConfirm",this.abortVideo)};Travian.Game.VideoFeatureAbort.prototype=Object.create(Travian.Dialog.Api.prototype);Travian.Game.VideoFeatureAbort.constructor=Travian.Game.VideoFeatureAbort;Travian.Game.VideoFeatureSuccess=function(b){Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo/success",context:"videoFeatureSuccess",darkOverlay:true,overlayCancel:true,preventFormSubmit:true,onOkay:function(){Travian.Game.Preferences.set("adSalesVideoSuccessDialogDisabled",(jQuery("input#dontShowThisAgain").is(":checked")?1:0))}},b))};Travian.Game.VideoFeatureSuccess.prototype=Object.create(Travian.Dialog.Api.prototype);Travian.Game.VideoFeatureSuccess.constructor=Travian.Game.VideoFeatureSuccess;Travian.Game.MoreGames=function(b){this.activeCounterElement=null;this.activeCounter=0;
this.autoHoverDelay=3000;this.timeoutId=0;this.elements=null;this.options=Object.assign({countOfGamesToShow:0},b);this.initialize=function(){this.elements=jQuery("div.moreGames .game.game-image");if(this.options.countOfGamesToShow){this.events().toggleChildren(this.activeCounter).autoHover()}};this.autoHover=function(){var c=this;if(c.timeoutId){clearTimeout(c.timeoutId)}c.timeoutId=setTimeout(function(){c.toggleChildren(c.activeCounter);c.toggleChildren((c.activeCounter+1)%c.options.countOfGamesToShow);c.autoHover()}.bind(c),c.autoHoverDelay);return c};this.events=function(){var e=this;var d=function(f){e=this;clearTimeout(e.timeoutId);if(f===e.activeCounter){return}if(e.activeCounterElement.length>0){e.toggleChildren(e.activeCounter)}e.toggleChildren(f)};var c=function(){e=this;e.autoHover()};this.elements.each(function(f,g){jQuery(g).on({mouseenter:jQuery.proxy(d,e,f),mouseleave:jQuery.proxy(c,e)})});return this};this.toggleChildren=function(c){this.activeCounter=c;this.activeCounterElement=jQuery(this.elements[c]);
this.activeCounterElement.find("img").each(function(d,e){jQuery(e).toggleClass("hide")});return this};this.initialize()};Travian.Game.VideoFeatureEventListener=Object.create({VideoFeatureObject:null,options:null,infoScreenEnabled:true,videoOptions:{},initialize:function(b){this.DoubleClickPreventer=new Travian.DoubleClickPreventer();this.DoubleClickPreventer.timeout=1000;this.bindEvents();var c=Travian.Game.Preferences.get("adSalesVideoInfoScreen");this.infoScreenEnabled=c===null||c==="enabled";return this},bindEvents:function(){var b=this;jQuery(window).on("showVideoWindow",function(d,c){if(undefined===b.VideoFeatureObject||null===b.VideoFeatureObject){if(!b.DoubleClickPreventer.check()){return false}if(!b.infoScreenEnabled){b.VideoFeatureObject=b.startVideoDialog(c)}else{b.videoOptions=c;b.showVideoInfoDialog()}}else{b.VideoFeatureObject.options=Object.assign({},b.VideoFeatureObject.options,c||{});b.VideoFeatureObject.reload()}});jQuery(window).on("showVideoWindowAfterInfoScreen",function(){Travian.WindowManager.closeByContext("videoFeatureInfo");
if(undefined===b.VideoFeatureObject||null===b.VideoFeatureObject){b.VideoFeatureObject=b.startVideoDialog(b.videoOptions)}else{b.VideoFeatureObject.options=Object.assign({},b.VideoFeatureObject.options,options||{});b.VideoFeatureObject.reload()}});jQuery(window).on("toggleAdSalesVideoInfoScreen",function(c,d){Travian.Game.Preferences.set("adSalesVideoInfoScreen",d);b.infoScreenEnabled=d==="enabled"});jQuery(window).on("message",function(c){Travian.Game.VideoFeatureEventListener.onMessage(c)})},addEvent:function(d,b,c){if(d.addEventListener){d.addEventListener(b,c,false)}else{if(d.attachEvent){d.attachEvent("on"+b,c)}}},onMessage:function(g){if(g.originalEvent.origin==="http://media.oadts.com"||g.originalEvent.origin==="https://media.oadts.com"){var c=g.originalEvent.data;if(c==="videoStart"){var f=jQuery('input[name="vrid"]').val();if(f){Travian.api("adSalesVideo/start",{data:{vrid:f}})}}else{if(c==="noVideo"){}else{if(c==="videoEnds"){}else{if(c.indexOf("videoEnds:")===0){var b=c.replace("videoEnds:",""),d=b.indexOf(":");
Travian.api("adSalesVideo/build",{data:{vrid:b.substring(0,d),hash:b.substring(d+1)},success:function(e){window.location.href=e.redirectTo}})}else{}}}}}},startVideoDialog:function(b){Travian.TimersAndCounters.suppressReloadEvent();return new Travian.Game.VideoFeatureShowVideo(b)},showVideoInfoDialog:function(){new Travian.Game.VideoFeatureInfo()}});jQuery(function(){Travian.Game.VideoFeatureEventListener.initialize()});Travian.Game.PaymentWizardEventListener=Object.create({DoubleClickPreventer:null,PaymentWizardObject:null,defaultOptions:{},initialize:function(){this.DoubleClickPreventer=new Travian.DoubleClickPreventer();this.DoubleClickPreventer.timeout=2000;this.bindEvents()},bindEvents:function(){var b=this;jQuery(window).on("paymentWizardOnCloseEvent",function(c){b.PaymentWizardObject=null});jQuery(window).on("startPaymentWizard",function(d,c){c=Travian.Helpers.deepmergeObject({},b.defaultOptions,c||{});if(!b.DoubleClickPreventer.check()){return false}if(undefined===b.PaymentWizardObject||null===b.PaymentWizardObject){b.PaymentWizardObject=b.startPaymentWizard(c)
}else{b.PaymentWizardObject.options=Travian.Helpers.deepmergeObject({},b.PaymentWizardObject.options,c||{});b.PaymentWizardObject.reload()}})},startPaymentWizard:function(b){return new Travian.Game.PaymentWizard(b)}});jQuery(function(){Travian.Game.PaymentWizardEventListener.initialize()});Travian.Game.WayOfPaymentEventListener=Object.create({WayOfPaymentObject:null,initialize:function(){this.DoubleClickPreventer=new Travian.DoubleClickPreventer();this.DoubleClickPreventer.timeout=500;this.bindEvents()},bindEvents:function(){var b=this;jQuery(window).on("buttonClicked",function(e,d,c){if(typeof c.wayOfPayment==="object"&&b.DoubleClickPreventer.check()&&!jQuery(d).hasClass("disabled")){b.WayOfPaymentObject=b.startWayOfPayment(c.wayOfPayment.featureKey,c.wayOfPayment.context,c.wayOfPayment.dataCallback,c.wayOfPayment.confirmPopup,c.wayOfPayment.closeAllDialogs)}});jQuery(window).on("startWayOfPayment",function(g,h,e,f,c,d){if(!b.DoubleClickPreventer.check()){return false}b.WayOfPaymentObject=b.startWayOfPayment(h,e,f,c,d)
})},startWayOfPayment:function(f,d,e,b,c){return new Travian.Game.WayOfPayment(f,d,e,b,c)}});jQuery(function(){Travian.Game.WayOfPaymentEventListener.initialize()});Travian.Game.ButtonEventListener={bindEvents:function(){jQuery(window).on("buttonClicked",function(d,c,b){jQuery(c).blur();if(typeof b.dialog==="object"&&b.dialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Dialog.Ajax(b.dialog.cmd,b.dialog)}if(typeof b.plusDialog==="object"&&b.plusDialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Game.PlusDialog(b.plusDialog)}if(typeof b.productionBoostDialog==="object"&&b.productionBoostDialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Game.ProductionBoostDialog(b.productionBoostDialog)}if(typeof b.reportSpamMessagesDialog==="object"&&b.reportSpamMessagesDialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Game.ReportSpamMessagesDialog(b.reportSpamMessagesDialog)}if(typeof b.goldclubDialog==="object"&&b.goldclubDialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Game.GoldclubDialog(b.goldclubDialog)
}if(typeof b.questButtonGainReward!=="undefined"&&b.questButtonGainReward){return Travian.Game.Quest.rewardButtonClick(b.questId)}if(typeof b.questButtonOverview!=="undefined"&&b.questButtonOverview){return Travian.Game.Quest.openTodoListDialog()}if(typeof b.questButtonOverviewAchievements!=="undefined"&&b.questButtonOverviewAchievements){return Travian.Game.Quest.openTodoListDialog("",true)}if(typeof b.questButtonCloseOverlay!=="undefined"&&b.questButtonCloseOverlay){return Travian.Game.Quest.closeDialog()}if(typeof b.villageDialog!=="undefined"&&b.villageDialog&&Travian.DoubleClickPreventer.globalCheck()){return Travian.Game.showEditVillageDialog(b.villageDialog.title,b.villageDialog.description,b.villageDialog.saveText,b.villageDialog.villageId)}});jQuery(window).on("tabClicked",function(d,c,b){if(typeof b.dialog==="object"&&b.dialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Dialog.Ajax(b.dialog.cmd,b.dialog)}if(typeof b.plusDialog==="object"&&b.plusDialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Game.PlusDialog(b.plusDialog)
}if(typeof b.goldclubDialog==="object"&&b.goldclubDialog&&Travian.DoubleClickPreventer.globalCheck()){return new Travian.Game.GoldclubDialog(b.goldclubDialog)}})}};jQuery(function(){Travian.Game.ButtonEventListener.bindEvents()});Travian.Game.WayOfPayment=function(f,d,e,b,c){this.featureKey=null;this.context=null;this.confirmPopup=null;this.closeAllDialogs=null;this.initialize=function(m,k,l,g,h){if(typeof m==="undefined"){throw ("Feature Key must not be empty!")}var j={};if(typeof l==="string"&&typeof this[l]==="function"){j=this[l]()}if(typeof l==="string"&&typeof l.split(".").reduce(function(o,n){return o[n]},window)==="function"){j=l.split(".").reduce(function(o,n){return o[n]},window)()}if(typeof l==="function"){j=l()}this.featureKey=m;this.context=k;this.confirmPopup=g;this.closeAllDialogs=h;if(typeof g!=="undefined"&&typeof g==="object"){this.checkConfirmation(j)}else{this.bookPremiumFeature(j)}};this.checkConfirmation=function(g){var h=this;Travian.api("ajax/getGoldAmount",{data:{},success:function(k){var j=k.goldAmount;
var l=g.coins;if(j>0&&l<=j){h.showCustomConfirmationPopup(h.confirmPopup,g)}else{h.bookPremiumFeature(g)}}})};this.showCustomConfirmationPopup=function(g,h){new Travian.Dialog.Ajax("ajax/"+g.name,{buttonOk:false,data:{goldAmount:h.coins},context:this.context,elementFocus:g.options["elementFocus"]||".dialogButtonOk"})};this.bookPremiumFeature=function(g){var h={featureKey:this.featureKey,context:this.context,additionalData:g};var j=this;Travian.api("ajax/premiumFeature",{data:h,success:function(k){if(k.hasOwnProperty("functionToCall")){if(typeof j[k.functionToCall]==="function"){j[k.functionToCall](k.options,k.context)}else{if(typeof window[k.functionToCall]==="function"){window[k.functionToCall](k.options,k.context)}}}},error:function(k){new Travian.Dialog.Dialog({preventFormSubmit:true}).setContent(k.errorMsg).show()}})};this.renderDialog=function(g){var h=g.dialogOptions;var j=g.html;if(Travian.WindowManager.getWindowsByContext("convertGoldPopup")){Travian.WindowManager.closeByContext("convertGoldPopup")
}if(typeof this.closeAllDialogs!=="undefined"&&this.closeAllDialogs!==null&&this.closeAllDialogs){Travian.WindowManager.closeAllWindows()}g.context=this.featureKey;$dialog=new Travian.Dialog.Dialog(h);$dialog.setContent(j);$dialog.show();return $dialog};this.closeDialog=function(g,h){Travian.WindowManager.closeByContext(h)};this.hideDialog=function(g,h){Travian.WindowManager.hideByContext(h)};this.unhideDialog=function(g,h){Travian.WindowManager.showByContext(h)};this.reloadDialog=function(g,h){if(h===null&&undefined!==g.scope){h=g.scope.context}Travian.WindowManager.reloadWindowsByContext(h)};this.reloadUrl=function(){window.location.href=window.location.href.split("#")[0]};this.submitForm=function(g,j){var h=document.getElementById(g.buttonId);if(h&&h.tagName==="BUTTON"){h.type="submit";h.click()}};this.openPaymentWizard=function(j,g){var h;var k=Travian.emptyFunction;if(typeof j.goldProductId!=="undefined"){h=j.goldProductId}if(typeof j.callback!=="undefined"&&typeof j.callback==="function"){k=j.callback
}if(typeof j.callback==="string"&&typeof j.callback.split(".").reduce(function(m,l){return m[l]},window)==="function"){k=j.callback.split(".").reduce(function(m,l){return m[l]},window)}this.closeDialog(j,"smallestPackage");jQuery(window).trigger("startPaymentWizard",{data:{goldProductId:h,activeTab:"buyGold"},callback:k,callbackScope:this})};this.openPaymentWizardWithProsTab=function(){jQuery(window).trigger("startPaymentWizard",{data:{activeTab:"pros"}})};this.initialize(f,d,e,b,c)};Travian.Game.WayOfPayment.constructor=Travian.Game.WayOfPayment;Travian.Game.PlusDialog=function(b){this.requestSent=false;this.contentReloaded=false;this.request=function(){var d=this;this.options.data.context=this.context;var c=this.options.premiumFeatureDialogVersion;Travian.api(this.cmd,{data:this.options.data,success:function(e){switch(c){case 1:default:d.setContent(d.createContent(d,e));break;case 2:d.setContent(e.html);break}d.show()},error:function(e){d.dispose();new Travian.Dialog.Dialog({preventFormSubmit:true}).setContent(e.errorMsg).show()
}});return this};this.createContent=function(m,h){var n=this;var c=jQuery('<div class="paymentPopupDialogWrapper"></div>');var d=jQuery("<h1></h1>");var l=jQuery('<span class="headlineText">'+h.title+"</span>");d.append(l);var f=jQuery('<span class="goldWrapper">'+h.gold+"</span>");d.append(f);d.append(jQuery('<div class="clear"></div>'));var o=jQuery('<h2 class="subHeadline">'+h.subHeadLine+"</h2>");var q=jQuery('<div class="goldButtonWrapper"></div>');var r=jQuery("<div>"+h.goldButton+"</div>");var j=jQuery('<div class="buttonSubTitle">'+h.buttonSubtitle+"</div>");q.append(r);q.append(j);var p=jQuery('<h3 class="extraFeatures">'+h.plusPopupButtonExtraFeatures+"</h3>");var k=jQuery("<div></div>");var g=jQuery('<div class="furtherFeatures"></div>');jQuery.each(h.features,function(t,s){if(t===n.options.featureKey){k.append(jQuery('<div class="feature featureInfo">'+n.options.featureMarkup(s.title,s.text,t)+"</div>"))}else{g.append(jQuery('<div class="feature featureInfo">'+n.options.featureMarkup(s.title,s.text,t)+"</div>"))
}});var e=jQuery('<p class="furtherInfos">'+h.furtherInfos+"</p>");c.append(d);c.append(k);c.append(o);c.append(q);c.append(p);c.append(g);c.append(e);r.on("click",function(){n.goldButtonClicked()});return c};this.reload=function(){this.contentReloaded=true;Travian.Dialog.Ajax.prototype.reload.call(this)};this.goldButtonClicked=function(){this.requestSent=true;jQuery(window).trigger("startWayOfPayment",["plus","plus"]);return false};this.close=function(){if(this.requestSent&&this.contentReloaded){return window.location.reload()}Travian.Dialog.Ajax.prototype.close.call(this)};Travian.Dialog.Ajax.call(this,"ajax/plusPopup",Object.assign({data:{featureKey:b.featureKey},buttonOk:false,context:"plus",darkOverlay:true,overlayCancel:false,featureMarkup:function(d,c,e){return['<div class="featureImage '+e+'"></div>','<div class="featureContent">','<h3 class="featureTitle">'+d+"</h3>",'<div class="featureText">'+c+"</div>","</div>",'<div class="clear"></div>'].join("")}},b))};Travian.Game.PlusDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype);
Travian.Game.PlusDialog.constructor=Travian.Game.PlusDialog;Travian.Game.GoldclubDialog=function(b){this.options=Object.assign({data:{featureKey:b.featureKey},buttonOk:false,context:"goldclub",darkOverlay:true,overlayCancel:false,featureMarkup:function(d,c,e){return['<div class="featureImage '+e+'"></div>','<div class="featureContent">','<h3 class="featureTitle">'+d+"</h3>",'<div class="featureText">'+c+"</div>","</div>",'<div class="clear"></div>'].join("")}},b);this.request=function(){var d=this;this.options.data.context=this.context;var c=this.options.premiumFeatureDialogVersion;Travian.api(this.cmd,{data:this.options.data,success:function(e){switch(c){case 1:default:d.setContent(d.createContent(d,e));break;case 2:d.setContent(e.html);break}d.show()},error:function(e){d.dispose();new Travian.Dialog.Dialog({preventFormSubmit:true}).setContent(e.errorMsg).show()}});return this};this.initialize=function(){Travian.Dialog.Ajax.call(this,"ajax/goldclubPopup",this.options)};this.createContent=function(n,j){var o=this;
var c=jQuery('<div class="paymentPopupDialogWrapper"></div>');var d=jQuery("<h1></h1>");var m=jQuery('<span class="headlineText">'+j.title+"</span>");d.append(m);var f=jQuery('<span class="goldWrapper">'+j.gold+"</span>");d.append(f);d.append(jQuery('<div class="clear"></div>'));var p=jQuery('<h2 class="subHeadline">'+j.subHeadLine+"</h2>");var q=jQuery('<div class="goldButtonWrapper"></div>');var r=jQuery("<div>"+j.goldButton+"</div>");var k=jQuery('<div class="buttonSubTitle">'+j.buttonSubtitle+"</div>");q.append(r);q.append(k);var h=jQuery('<h3 class="extraFeatures">'+j.goldclubPopupButtonExtraFeatures+"</h3>");var l=jQuery("<div></div>");var g=jQuery('<div class="furtherFeatures"></div>');jQuery.each(j.features,function(t,s){if(t===o.options.featureKey){l.append(jQuery('<div class="feature featureInfo">'+o.options.featureMarkup(s.title,s.text,t)+"</div>"))}else{g.append(jQuery('<div class="feature featureInfo">'+o.options.featureMarkup(s.title,s.text,t)+"</div>"))}});var e=jQuery('<p class="furtherInfos">'+j.furtherInfos+"</p>");
c.append(d);c.append(l);c.append(p);c.append(q);c.append(h);c.append(g);c.append(e);r.on("click",function(){o.goldButtonClicked()});return c};this.goldButtonClicked=function(){this.requestSend=true;jQuery(window).trigger("startWayOfPayment",["goldclub","goldclub"]);return false};this.initialize()};Travian.Game.GoldclubDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype);Travian.Game.GoldclubDialog.constructor=Travian.Game.GoldclubDialog;Travian.Game.ProductionBoostDialog=function(b){this.options=Object.assign({data:{},buttonOk:false,context:"productionBoost",darkOverlay:true,overlayCancel:false,featureMarkup:function(f,h,d,c,e,g){return['<div class="featureImage '+f+'"></div>','<div class="featureContent">','<h3 class="featureTitle productionBoostTitle">'+h+"</h3>",'<div class="featureRemainingTime productionBoostSubtitle subtitle '+c+'">'+d+"</div>",'<div class="featureButton productionBoostButtonPos">'+e+"</div>",'<div class="featureDuration featureRenewal productionBoostButtonSubtitle subtitle">'+g+"</div>","</div>",'<div class="clear"></div>'].join("")
}},b);this.request=function(){var d=this;this.options.data.context=this.context;var c=this.options.premiumFeatureDialogVersion;Travian.api(this.cmd,{data:this.options.data,success:function(e){switch(c){case 1:default:d.setContent(d.createContent(d,e));d.bindElements();break;case 2:d.setContent(e.html);d.bindEvents();break}d.show()},error:function(e){d.dispose();new Travian.Dialog.Dialog({preventFormSubmit:true}).setContent(e.errorMsg).show()}});return this};this.toggleAutoprolong=function(f,c){var e=this;var d={featureKey:f,toggleAutoprolong:1};Travian.api("ajax/premiumFeature",{data:d,success:function(){Travian.WindowManager.reloadWindowsByContext(c)},error:function(){e.reload()}})};this.createContent=function(j,g){var c=jQuery('<div class="paymentPopupDialogWrapper"></div>');var k=jQuery('<h1 class="headline"></h1>').html(g.title);var f=jQuery('<span class="goldWrapper"></span>').html(g.gold);k.append(f);var d=jQuery('<h3 class="subHeadLine"></h3>').html(g.productionBoostChooseText);var l=jQuery('<div class="featureCollection" id="featureCollectionWrapper"></div>');
for(var m in g.features){var h=jQuery('<div class="feature featureBooking">').html(j.options.featureMarkup(m,g.features[m].title,g.features[m].subtitle,g.features[m].subtitleClassExtension,g.features[m].button,g.features[m].buttonSubtitle));l.append(h)}var e=jQuery('<p class="furtherInfos"></p>').html(g.furtherInfos);c.append(k);c.append(d);c.append(l);c.append(e);return c};this.bindElements=function(){var c=this;var d=jQuery("#featureCollectionWrapper");d.find("button.productionBoostButton").each(function(e,f){var g=jQuery(f);g.off("click");g.on("click",function(j){c.requestSend=true;var h=jQuery(window);var k=jQuery(this);if(k.hasClass("wood")){h.trigger("startWayOfPayment",["productionboostWood","productionBoost"])}else{if(k.hasClass("clay")){h.trigger("startWayOfPayment",["productionboostClay","productionBoost"])}else{if(k.hasClass("iron")){h.trigger("startWayOfPayment",["productionboostIron","productionBoost"])}else{if(k.hasClass("crop")){h.trigger("startWayOfPayment",["productionboostCrop","productionBoost"])
}}}}return false})});d.find(".checkbox").each(function(e,f){var g=jQuery(f);g.off("click");g.on("click",function(h){if(g.hasClass("prolongProductionboostWood")){return c.toggleAutoprolong("productionboostWood","productionBoost")}else{if(g.hasClass("prolongProductionboostClay")){return c.toggleAutoprolong("productionboostClay","productionBoost")}else{if(g.hasClass("prolongProductionboostIron")){return c.toggleAutoprolong("productionboostIron","productionBoost")}else{if(g.hasClass("prolongProductionboostCrop")){return c.toggleAutoprolong("productionboostCrop","productionBoost")}else{if(g.hasClass("prolongPlus")){return c.toggleAutoprolong("plus","plus")}}}}}return false})})};this.bindEvents=function(){var d=this;var e=jQuery("#featureCollectionWrapper");e.find(".featureButton button").each(function(){var f=jQuery(this);f.off("click.productionBoost");f.on("click.productionBoost",function(){d.requestSend=true})});var c=["Wood","Clay","Iron","Crop"];e.find("input[type=checkbox]").each(function(){var f=jQuery(this);
f.off("change.productionBoost");f.on("change.productionBoost",function(){var h=jQuery(this);for(var g=0;g<c.length;g++){if(h.hasClass("prolongProductionboost"+c[g])){d.toggleAutoprolong("productionboost"+c[g],"productionBoost");break}}})})};this.close=function(){if(typeof this.requestSend!=="undefined"&&this.requestSend===true){return window.location.reload()}Travian.Dialog.Ajax.prototype.close.call(this)};Travian.Dialog.Ajax.call(this,"ajax/productionBoostPopup",this.options)};Travian.Game.ProductionBoostDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype);Travian.Game.ProductionBoostDialog.constructor=Travian.Game.ProductionBoostDialog;Travian.Game.GoldTransferDialog=function(b,d,c){this.request=function(){var e=this;this.options.data.context=this.context;Travian.api(this.cmd,{data:this.options.data,success:function(f){if(f.showDialog===true){e.setContent(e.createContent(e,f));e.show();return true}else{window.location.href=window.location.href;window.location.reload()}}});return this
};this.createContent=function(f,e){return e.statusText};this.close=function(){window.location.href=window.location.href;window.location.reload()};Travian.Dialog.Ajax.call(this,"ajax/goldTransfer",{data:{code:d,messageId:b,accept:c?1:0,refuse:c?0:1}})};Travian.Game.GoldTransferDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype);Travian.Game.GoldTransferDialog.constructor=Travian.Game.GoldTransferDialog;Travian.Game.Quest=Object.create({options:{listData:{},dialogListData:{}},setOptions:function(b){this.options=Object.assign({},this.options,b)},dialog:{quest:null,achievement:null},mentorClick:function(b){if(Travian.WindowManager.getWindowsByContext("quest").length>0){Travian.WindowManager.closeByContext("quest")}else{this.openTodoListDialog(this.options.dialogListData.answersLink)}},rewardButtonClick:function(d){Travian.WindowManager.closeByContext("quest");var c="ajax/quest";var b={questTutorialId:d,action:"reward"};if(d.search(/DailyQuest/)!==-1){c="ajax/dailyquests";b={questId:d,action:"reward"}
}Travian.api(c,{data:b})},openInformationDialog:function(f,b,c){var e="quest";if(f.search(/Achievement/)!==-1||f.search(/DailyQuest/)!==-1){e="achievement"}var d=this;if(this.dialog[e]===null){Travian.WindowManager.closeByContext("quest");this.dialog[e]=new Travian.Dialog.Ajax("ajax/quest",{data:{questTutorialId:f,action:c},context:e,buttonOk:false,enableBackground:false,darkOverlay:false,draggable:true,savePositionForSession:{preferenceKey:"QuestDialogPosition"},overlayCancel:false,infoIcon:b,cssClass:"white questInformation "+f+" quest",preventFormSubmit:true,buttonTextInfo:Travian.Translation.get("answers."+f.toLowerCase()+"_title")||"Answers",fx:{duration:0},onClose:function(){d.dialog[e]=null}})}else{if(f.search(/DailyQuest/)!==-1){this.dialog[e].cmd="ajax/dailyquests";this.dialog[e].options.data.questId=f}else{this.dialog[e].cmd="ajax/quest";this.dialog[e].options.data.questTutorialId=f}this.dialog[e].displayButtonOk(false);this.dialog[e].options.data.action=c;this.dialog[e].options.infoIcon=b;
this.dialog[e].options.buttonTextInfo=Travian.Translation.get("answers."+f.toLowerCase()+"_title")||"Answers";this.dialog[e].request()}this.dialog[e].wrapper.find("form").off("submit");this.dialog[e].wrapper.find("form").on("submit",function(g){g.stopPropagation();return false})},openTodoListDialog:function(d,c){var g=this;var j="ajax/quest";var h="quest";var f=false;var e="";var b=false;if(typeof c!=="undefined"&&c!==null){j="ajax/dailyquests";h="achievement";f=true;e=Travian.Translation.get("allgemein.close_with_capital_c");b=true}if(this.dialog[h]===null){Travian.WindowManager.closeByContext(j);this.dialog[h]=new Travian.Dialog.Ajax(j,{data:{},context:h,buttonOk:f,buttonTextOk:e,buttonCloseOnClickOk:b,enableBackground:false,draggable:true,infoIcon:d,savePositionForSession:{preferenceKey:"QuestDialogAchievementPosition"},overlayCancel:false,cssClass:"white questTodoList",preventFormSubmit:true,fx:{duration:0},onClose:function(){g.dialog[h]=null}})}else{this.dialog[h].cmd=j;this.dialog[h].displayButtonOk(f);
this.dialog[h].options.infoIcon=null;this.dialog[h].options.data.questId=undefined;this.dialog[h].options.data.questTutorialId=undefined;this.dialog[h].options.data.action=undefined;this.dialog[h].request()}},bindListDelegation:function(b){var c=this;b.on("click",function(g){g.stopPropagation();var e=jQuery(g.delegateTarget);var d=e.attr("data-questId");var f=e.attr("data-category");if(f&&d){c.openInformationDialog(d,c.options.listData[f].quests[d].answersLink)}})},addListData:function(c){c=c||{};for(var b in c){if(c.hasOwnProperty(b)){this.options.listData[b]=c[b]}}},closeDialog:function(){if(this.dialog.quest!==null){this.dialog.quest.close()}}});Travian.Game.ReportSpamMessagesDialog={reportSpam:function(e,g,h,j,b){var f=[];var c='<select size="1" id="spamReason">';for(var k in b){if(b.hasOwnProperty(k)){c+='<option value="'+k+'">'+b[k]+"</option>"}}c+='</select><br/><br/><span class="notice">'+j+"</span>";var d=new Travian.Dialog.Dialog({title:g,keepOpen:true,buttonTextOk:h,preventFormSubmit:true,onOpen:function(){d.disableForm()
},onOkay:function(){if(f.length>0){Travian.api("ajax/reportSpamMessage",{data:{messageId:e,spamReason:f.val()},success:function(l){if(undefined!==l.reportingSuccessful&&l.reportingSuccessful){d.setContent(l.reportingSuccessful);jQuery(".dialog button").html(l.closeButtonText);jQuery("#reportSpam").addClass("disabled").off("click").attr("onclick",function(){return false});d.enableForm();jQuery(".dialog form").on("submit",function(m){m.stopPropagation();d.close()})}}})}}});d.setContent(c);d.show();f=jQuery("#spamReason");f.on("change",function(){var l=f.val()==="not_chosen";d.toggleFormState(l)})}};Travian.Game.Village={toggleBuildingLevels:function(){var g=jQuery("#levelSwitch"),d;var e=g.find("svg.plusMinusToggle path");var h="M5 0L5 5L0 5L0 10L5 10L5 15L10 15L10 10L15 10L15 5L10 5L10 0Z";var c="M0 5L0 10L15 10L15 5Z";g.toggleClass("minus").toggleClass("plus");d=g.hasClass("plus");if(d){Travian.Game.Preferences.set("t4level",1)}else{Travian.Game.Preferences.set("t4level",null)}var f=new TimelineLite();
var b=jQuery(".buildingSlot .level");if(d){TweenLite.to(e,0.3,{morphSVG:h});f.staggerTo(".buildingSlot .level",0.3,{opacity:0,marginTop:"20px",ease:Power4.easeOut},0.02,"+=0",function(){b.find("div.labelLayer").each(function(j,l){var n=jQuery(l);var m=n.html(),k=n.parent();n.remove();k.html(m).removeClass("colorLayer")});f.staggerTo(".buildingSlot .level",0.3,{opacity:1,marginTop:0,ease:Power4.easeOut},0.02)})}else{TweenLite.to(e,0.3,{morphSVG:c});f.staggerTo(".buildingSlot .level",0.3,{opacity:0,marginTop:"20px",ease:Power4.easeOut},0.02,"+=0",function(){b.each(function(j,k){var l=jQuery(k);var n=l.html(),m=jQuery("<div></div>").addClass("labelLayer").html(n);l.addClass("colorLayer").html("").append(m)});f.staggerTo(".buildingSlot .level",0.3,{opacity:1,marginTop:0,ease:Power4.easeOut},0.02)})}},initializeWallStates:function(){var c=jQuery(".a40 svg, .a40_city svg"),b=jQuery(c.find("path"));b.hover(function(){c.addClass("hover")},function(){c.removeClass("hover")});b.on("mousedown touchstart",function(){c.addClass("active")});b.on("mouseup mouseleave blur touchend",function(){c.removeClass("active")});},
toggleMobileUnitDisplay:function(){var b=Travian.Game.Preferences.get("mobileUnitDisplay");Travian.Game.Preferences.set("mobileUnitDisplay",(b==="expanded"?"collapsed":"expanded"))},enableVillageListShortcuts:function(){var c=jQuery("#sidebarBoxVillagelist .content ul");var b=c.find("li:not(.active) a .coordinatesGrid")[0];if(typeof b!=="undefined"&&b.hasAttribute("data-x")&&b.hasAttribute("data-y")&&b.hasAttribute("data-did")&&b.hasAttribute("data-villagename")){c.addClass("shortcutsEnabled");c.find("li:not(.active) a").on("click",function(j){var h=jQuery(j.target);if(h.is(".coordinatesGrid")||h.parents(".coordinatesGrid").length>0){j.preventDefault();var f=jQuery(this).find(".coordinatesGrid");if(f.length>0){var d=parseInt(f.data("x"));var l=parseInt(f.data("y"));var g=parseInt(f.data("did"));var k=f.data("villagename");jQuery(window).trigger("travian.villageList.coordinatesShortcut",[d,l,g,k])}}})}}};Travian.Game.Village.RearrangeBuildings={did:null,step:1,slotFrom:null,slotTo:null,hash:null,initialize:function(b){this.did=b;
Travian.Game.Layout.disable();jQuery("body").addClass("rearrangeBuildings");jQuery("#content .rearrangeBuildings").prependTo("#background");let container=jQuery("#background .rearrangeBuildings").removeClass("hide");setTimeout(function(){container.addClass("show")},1);this.hash=jQuery.md5(JSON.stringify(this.getBuildingPositions()));this.bindEvents()},bindEvents:function(){let $this=this;let map=jQuery("#village_map");map.find(".buildingSlot.movable[data-aid]").off("click").on("click",function(){let slot=jQuery(this);let aid=parseInt(slot.data("aid"));let gid=parseInt(slot.data("gid"));switch($this.step){case 1:if(gid!==0){$this.slotFrom=aid;$this.step=2}break;case 2:$this.slotTo=aid;$this.step=3;break;default:$this.slotFrom=null;$this.slotTo=null;$this.step=1;break}$this.executeStep()});let buildingSlotTriggers=map.find(".buildingSlot svg path, .buildingSlot .level");buildingSlotTriggers.off("hover").off("mousedown touchstart").off("mouseup mouseleave blur touchend");buildingSlotTriggers.hover(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").addClass("hover")
},function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").removeClass("hover")});buildingSlotTriggers.on("mousedown touchstart",function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").addClass("active")});buildingSlotTriggers.on("mouseup mouseleave blur touchend",function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").removeClass("active")})},executeStep:function(){let $this=this;let map=jQuery("#village_map");let container=jQuery("#background .rearrangeBuildings");let instructions=container.find(".instructions");let instructionsStep1=instructions.find(".step1");let instructionsStep2=instructions.find(".step2");switch($this.step){case 2:let slotFrom=map.find(".buildingSlot.aid"+$this.slotFrom).addClass("selected");let buildingName=slotFrom.data("name");let buildingLevel=slotFrom.find(".level").data("level");instructionsStep2.html(Travian.Translation.get("gid15.rearrangeBuildings_step2").replace("[NAME]",buildingName).replace("[LEVEL]",buildingLevel));
instructionsStep1.removeClass("active");instructionsStep2.addClass("active");map.addClass("selectTarget");break;case 3:$this.animateMovement();map.removeClass("selectTarget");instructionsStep2.removeClass("active");instructionsStep1.addClass("active");break}},animateMovement:function(){let $this=this;let map=jQuery("#village_map");let direction=jQuery("body").hasClass("rtl")?"right":"left";let slotFrom=map.find(".buildingSlot.aid"+$this.slotFrom);let slotTo=map.find(".buildingSlot.aid"+$this.slotTo);let buildingFrom=map.find(".animationContainer.buildingFrom");let buildingTo=map.find(".animationContainer.buildingTo");slotFrom.addClass("animating");slotTo.addClass("animating");buildingFrom.empty();slotFrom.find("img.building").clone().appendTo(buildingFrom);slotFrom.find(".level").clone().appendTo(buildingFrom);buildingTo.empty();slotTo.find("img.building").clone().appendTo(buildingTo);slotTo.find(".level").clone().appendTo(buildingTo);let cssOptions={};cssOptions[direction]=slotFrom.css(direction);
cssOptions.top=slotFrom.css("top");buildingFrom.css(cssOptions);cssOptions[direction]=slotTo.css(direction);cssOptions.top=slotTo.css("top");buildingTo.css(cssOptions);buildingFrom.animate(cssOptions,300);cssOptions[direction]=slotFrom.css(direction);cssOptions.top=slotFrom.css("top");buildingTo.animate(cssOptions,300);setTimeout(function(){$this.move();slotFrom.removeClass("animating");slotTo.removeClass("animating");setTimeout(function(){buildingFrom.empty();buildingTo.empty()},250)},300)},move:function(){let $this=this;let map=jQuery("#village_map");let slotFrom=map.find(".buildingSlot.aid"+$this.slotFrom);let slotTo=map.find(".buildingSlot.aid"+$this.slotTo);if(slotFrom.length>0&&slotTo.length>0){let contentFrom=slotFrom.html();let contentTo=slotTo.html();let buildingFrom=slotFrom.data("gid");let buildingTo=slotTo.data("gid");let nameFrom=slotFrom.data("name");let nameTo=slotTo.data("name");slotFrom.html(contentTo);slotTo.html(contentFrom);slotFrom.data("gid",buildingTo);slotFrom.removeClass("g"+buildingFrom).addClass("g"+buildingTo);
slotTo.data("gid",buildingFrom);slotTo.removeClass("g"+buildingTo).addClass("g"+buildingFrom);slotFrom.data("name",nameTo);slotTo.data("name",nameFrom);jQuery(".buildingSlot .hover").removeClass("hover");$this.bindEvents();slotFrom.removeClass("selected");$this.step=1;$this.slotFrom=null;$this.slotTo=null;$this.updateProceedButton()}},getBuildingPositions:function(){let map=jQuery("#village_map");let slots=map.find(".buildingSlot[data-aid]");let buildingPositions={};slots.each(function(b,c){let slot=jQuery(c);buildingPositions[slot.data("aid")]=slot.data("gid")||null});return buildingPositions},isAllowedToProceed:function(){return this.hash!==jQuery.md5(JSON.stringify(this.getBuildingPositions()))},updateProceedButton:function(){let container=jQuery("#background .rearrangeBuildings");let button=container.find("button.confirm");if(this.isAllowedToProceed()){button.removeClass("disabled");Travian.Tip.setContent(button,Travian.Translation.get("gid15.rearrangeBuildings"))}else{button.addClass("disabled");
Travian.Tip.setContent(button,Travian.Translation.get("gid15.rearrangeToContinue"))}},proceed:function(){if(this.isAllowedToProceed()){let dialog=new Travian.Dialog.Dialog({context:"rearrangeBuildingsConfirm",cssClass:"rearrangeBuildingsConfirmDialog",preventFormSubmit:true,buttonOk:false,relativeTo:jQuery("#background .rearrangeBuildings button.confirm")});dialog.setContent(jQuery("#background .rearrangeBuildings .proceedDialog").html());dialog.show()}},wayOfPaymentDataCallback:function(){return{did:Travian.Game.Village.RearrangeBuildings.did,buildingPositions:Travian.Game.Village.RearrangeBuildings.getBuildingPositions()}},abort:function(){if(!this.isAllowedToProceed()){window.location.href="/dorf2.php"}else{let dialog=new Travian.Dialog.Dialog({context:"rearrangeBuildingsAbort",cssClass:"rearrangeBuildingsAbortDialog",preventFormSubmit:true,buttonOk:false,buttonCancel:false,overlayCancel:false,relativeTo:jQuery("#background .rearrangeBuildings .container .close svg")});dialog.setContent(jQuery("#background .rearrangeBuildings .abortDialog").html());
dialog.show()}}};Travian.TabManager={initializeOnPageLoad:function(){var b=window.location.hash.trim();if(b!==""){Travian.TabManager.applyAnchor(b)}},initializeOnDialogLoad:function(){var b=jQuery(".dialog .contentNavi .tabItem:not([id])");b.off("click.tabManger").on("click.tabManger",function(d){d.preventDefault();var c=jQuery(this);var e=c.attr("href");if(e!=="#"){Travian.api(e,{success:function(g){var f=Travian.WindowManager.getWindowsByContext(c.parents(".dialogWrapper").data("context"))[0];f.updateInfoButton(g.options);f.setContent(g.content);if(typeof g.options.cssClass!=="undefined"){f.updateCssClass(g.options.cssClass)}Travian.TabManager.initializeOnDialogLoad()},error:function(f){var g=new Travian.Dialog.Dialog({preventFormSubmit:true});g.setContent('<div class="error">'+f.status+" "+f.statusText+"</div>").show()}},"GET")}})},handlers:{payment:function(b){jQuery(window).trigger("startPaymentWizard",{data:{activeTab:b}})}},applyAnchor:function(b){var c=b.split("-"),d=c[0].substring(1);
delete c[0];if(c.length&&Travian.TabManager.handlers[d]!==undefined){Travian.TabManager.handlers[d](c.join(""))}}};jQuery(function(){Travian.TabManager.initializeOnPageLoad()});Travian.Game.Vacation={dialog:null,updateVacationTime:function(e,c){var d=parseInt(Date.now())+parseInt(e)*86400000,b=function(h,l){var f=function(p){return(p<10)?"0"+p:p},g=new Date(h.getTime()+h.getTimezoneOffset()*60000+l*1000),n=f(g.getDate()),k=f(g.getMonth()+1),m=f(g.getFullYear()%100),j=f(g.getHours()),o=f(g.getMinutes());return n+"."+k+"."+m+", "+j+":"+o};jQuery("#vacationTime").html(b(new Date(d),c))},closeDialog:function(){if(this.dialog!==null){this.dialog.close()}},showDialog:function(b){this.dialog=new Travian.Dialog.Dialog({buttonOk:false,submitMethod:"post",submitUrl:"/options/vacation",keepOpen:true});this.dialog.setContent(b);this.dialog.show()},openConfirmation:function(){Travian.api("ajax/vacationModeConfirmation",{data:{params:jQuery("#dayInput").val()},success:function(b){if(b.html!==""){Travian.Game.Vacation.showDialog(b.html)
}else{Travian.Game.Vacation.closeDialog()}}})}};Travian.Game.Arifact={setAutoProlongue:function(c,b){Travian.api("ajax/artifact",{data:{id:c,action:"reactivate",state:b?1:0}})}};Travian.Game.ContextualHelp={groupName:[],helpData:[],stickyElements:[],documentDimensions:{width:0,height:0},currentStep:0,isRTL:false,isInitialized:false,isMousedown:false,isKeydown:false,keyDownInterval:null,overlay:false,initialize:function(){this.reset();var c=this;var b=jQuery(document);jQuery(function(){c.documentDimensions.width=b.width();c.documentDimensions.height=b.height();c.isRTL=jQuery("body").hasClass("rtl");var e=Travian.Game.contextHelpData;var d=e.steps||[];c.groupName=e.groupName;c.restartableGroup=e.restartableGroup;d.forEach(function(g){var f=g.stickToElement;c.addStep(g.content,f,g.boxPosition,g.arrowPosition,!!g.dismissButton,g.delay,g.teaser)})});jQuery(window).on("resize scroll click keyup travian.map.zoomed travian.map.imageLoaded travian.toggleMapDialog",function(){c.updateStickyElements();
c.updateElements()});b.on("mousedown touchstart",function(){c.isMousedown=true});b.on("mouseup touchend",function(){c.isMousedown=false});b.on("keydown",function(){c.isKeydown=true;if(c.keyDownInterval){clearInterval(c.keyDownInterval)}c.keyDownInterval=setInterval(function(){c.updateStickyElements();c.updateElements()},25)});b.on("keyup",function(){c.isKeydown=false;clearInterval(c.keyDownInterval)});b.on("mousemove",function(){if(c.isMousedown){c.updateStickyElements();c.updateElements()}});jQuery(window).on("travian.contextualHelp.add",function(l,k,f,j,g,h,d,e){c.addStep(k,f,j,g,h,d,e)})},addStep:function(g,k,b,c,f,e,d){var h=this;var j=h.helpData.length===0;e=typeof e!=="undefined"?e:0;d=typeof d!=="undefined"?d:null;if(h.registerStickyElement(k)!==false){h.helpData.push({content:g,stickToElement:k,boxPosition:b,arrowPosition:c,dismissButton:f,delay:e,teaser:d,active:j,dimensions:{width:0,height:0}});setTimeout(function(){if(j){h.initialRender();jQuery(".contextualHelp .helpBody nav svg").on("click",function(){if(jQuery(this).hasClass("chevronForward")){h.currentStep+=1
}else{h.currentStep-=1}h.updateElements()});jQuery(".contextualHelp .helpBody nav button").on("click",function(){h.close()});h.isInitialized=true}jQuery("<div></div>").appendTo(".contextualHelp .helpBody .steps").html(g);jQuery("<div></div>").appendTo(".contextualHelp .helpBody .progress");if(d!==null){if(h.registerStickyElement(d.stickToElement)!==false){jQuery("<div></div>").insertAfter(".contextualHelp .helpBody .steps").addClass("teaser hide").html(d.content)}}if(!j){jQuery(".contextualHelp .helpBody .steps div:last-of-type").addClass("hide")}h.updateElements()},e*1000)}},close:function(){var b=this;Travian.api("contextHelp/finish/"+this.groupName,{success:function(){b.reset()}},"GET")},restart:function(){var b=this;if(this.restartableGroup==this.groupName){return}Travian.api("contextHelp/restart/"+this.restartableGroup,{success:function(d){var c=d.helpData;if(c.groupName&&c.steps&&c.steps.length>0){b.reset();b.groupName=c.groupName;c.steps.forEach(function(f){var e=f.stickToElement;
b.addStep(f.content,e,f.boxPosition,f.arrowPosition,!!f.dismissButton,f.delay,f.teaser)})}}},"GET")},reset:function(){this.groupName="";this.helpData=[];this.stickyElements=[];this.currentStep=0;jQuery("#contextualHelp").remove()},updateElements:function(d){if(typeof d==="undefined"){d=false}var l=this;if(!l.isInitialized||l.helpData.length===0){return}var h=l.helpData[l.currentStep];var F=jQuery(window);var r=jQuery(".contextualHelp .helpBody");var B=r.find(".steps div");var b=r.find("nav");var n=b.find("svg");var J=b.find(".chevronForward");var z=b.find(".chevronBack");var c=b.find("button");var j=r.find(".progress div");var A=jQuery(".contextualHelp .pointingArrow");var v=r.find(".teaser:eq("+l.currentStep+")");b.removeClass("hide");if(l.helpData.length===1&&!l.helpData[0].dismissButton){b.addClass("hide")}var e=v.length>0&&!v.hasClass("hide");B.addClass("hide");j.removeClass("active");n.addClass("hide");c.addClass("hide");if(!e){r.find(".steps div:nth-of-type("+(l.currentStep+1)+")").removeClass("hide");
r.find(".progress div:nth-of-type("+(l.currentStep+1)+")").addClass("active");if(l.helpData.length>1){if(l.currentStep>0){z.removeClass("hide")}if(l.currentStep+1<l.helpData.length){J.removeClass("hide")}}if(h.dismissButton){c.removeClass("hide")}}var o=jQuery("#contextualHelp .contextualHelp");var k={width:o.outerWidth(),height:o.outerHeight(),offset:o.offset()};o.removeClass("hide");var t=l.stickyElements.filter(function(K){return K.selector===h.stickToElement})[0];if(h.teaser!==null&&!jQuery(t.selector).is(":visible")){var p=l.stickyElements.filter(function(K){return K.selector===h.teaser.stickToElement})[0];if(jQuery(p.selector).length>0){t=p;if(!e){v.removeClass("hide");l.updateElements();return}}}else{if(e){v.addClass("hide");l.updateElements();return}}var g=t.isMapElement?t.mapSelector:t.selector;if(jQuery(g).is(":visible")){var H,u;var G=5;var y=27;var s=e?h.teaser.boxPosition:h.boxPosition;var f=e?h.teaser.arrowPosition:h.arrowPosition;var I;if((t.y1-G)>(F.height()+F.scrollTop())){var E=s;
s="above";I="from";u=F.height()-k.height;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100);switch(E){case"before":f=100;H=t.x1-k.width+y;break;case"after":f=0;H=t.x2-y;break}o.addClass("teasing")}else{o.removeClass("teasing");switch(s){case"above":u=t.y1-k.height-G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100);I="from";if(u<0){s="below";u=t.y2+G}if(H<0){s="after";H=t.x2+G;u=t.y1-(k.height-t.height)/2+(k.height-y*2)*(0.5-f/100);I="top"}if(H+k.width>l.documentDimensions.width){s="before";H=t.x1-k.width-G;u=t.y1-(k.height-t.height)/2+(k.height-y*2)*(0.5-f/100);I="top"}break;case"below":u=t.y2+G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100);I="from";if(u+k.height>F.height()+F.scrollTop()){s="above";u=t.y1-k.height-G}if(H<0){s="after";H=t.x2+G;u=t.y1-(k.height-t.height)/2+(k.height-y*2)*(0.5-f/100);I="top"}if(H+k.width>l.documentDimensions.width){s="before";H=t.x1-k.width-G;u=t.y1-(k.height-t.height)/2+(k.height-y*2)*(0.5-f/100);I="top"}break;case"before":H=t.x1-k.width-G;u=t.y1-(k.height-t.height)/2+(k.height-y*2)*(0.5-f/100);
I="top";if(u<0){s="below";u=t.y2+G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100);I="from"}if(u+k.height>F.height()+F.scrollTop()){s="above";I="from";f=100;u=t.y1-k.height-G;H=t.x1-k.width+y}if(H<0){s="after";H=t.x2+G}if(H+k.width>l.documentDimensions.width||(d&&o.hasClass("above"))){s="above";I="from";f=50;u=t.y1-k.height-G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100)}break;case"after":H=t.x2+G;u=t.y1-(k.height-t.height)/2+(k.height-y*2)*(0.5-f/100);I="top";if(u<0){s="below";u=t.y2+G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100);I="from"}if(u+k.height>F.height()+F.scrollTop()){s="above";I="from";f=0;u=t.y1-k.height-G;H=t.x2-y}if(H+k.width>l.documentDimensions.width){s="before";H=t.x1-k.width-G}if(H<0||(d&&o.hasClass("above"))){s="above";I="from";f=50;u=t.y1-k.height-G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100)}break}}if(t.isMapElement){var q=jQuery("body.map.fullScreen");if(q.length<=0){q=jQuery("#content.map")}if(q.length>0){var D=q.outerWidth();var x=q.outerHeight();
var m=q.offset();if(t.x2<=m.left||t.x1>=m.left+D||t.y2<=m.top||t.y2>=m.top+x){o.addClass("hide")}else{if(!q.hasClass("fullScreen")){f=t.x2<=m.left+D/2?80:20;s=t.y2<=m.top+x/2?"above":"below";u=s==="below"?t.y2+G:t.y1-k.height-G;H=t.x1-(k.width-t.width)/2+(k.width-y*2)*(0.5-f/100)}}}}var C=!o.hasClass(s);o.removeClass("above").removeClass("below").removeClass("before").removeClass("after").addClass(s);if(l.isRTL){o.css({right:H+"px",top:u+"px"})}else{o.css({left:H+"px",top:u+"px"})}if(I==="from"){if(l.isRTL){A.css({top:0,right:f+"%"})}else{A.css({top:0,left:f+"%"})}}else{if(l.isRTL){A.css({right:0,top:f+"%"})}else{A.css({left:0,top:f+"%"})}}if(C){l.updateElements(true)}}else{o.addClass("hide")}},registerStickyElement:function(c){var f=this;var h=[];h.selector=c;h.isMapElement=/^MapID/.test(c);h.mapSelector="."+Travian.Game.Map.mapIds[c.replace("MapID.","")];jQuery("#contextualHelp").removeClass("overlay");if(/\.dialog/.test(c)){this.overlay=true}var e=jQuery((h.isMapElement?h.mapSelector:c));
if(e.length>0){var g=e.offset();h.width=e.outerWidth();h.height=e.outerHeight();var b=jQuery(window);var d=f.documentDimensions.width-b.width();if(f.isRTL){h.x1=f.documentDimensions.width-d-g.left-h.width;h.x2=f.documentDimensions.width-d-g.left}else{h.x1=g.left;h.x2=g.left+h.width}h.y1=g.top;h.y2=g.top+h.height;f.stickyElements.push(h)}else{return false}},updateStickyElements:function(){var e=this;var b=jQuery(window);var c=e.documentDimensions.width-b.width();e.stickyElements.map(function(g){var f=jQuery(g.isMapElement?g.mapSelector:g.selector);if(f.length>0){var h=f.offset();g.width=f.outerWidth();g.height=f.outerHeight();if(e.isRTL){g.x1=e.documentDimensions.width-c-h.left-g.width;g.x2=e.documentDimensions.width-c-h.left}else{g.x1=h.left;g.x2=h.left+g.width}g.y1=h.top;g.y2=h.top+g.height}else{if(g.isMapElement){g.mapSelector="."+Travian.Game.Map.mapIds[g.selector.replace("MapID.","")]}}});var d=jQuery(document);e.documentDimensions.width=d.width();e.documentDimensions.height=d.height()
},initialRender:function(){jQuery('<div id="contextualHelp"></div>').prependTo("body");if(this.overlay){jQuery("#contextualHelp").addClass("overlay")}var b='<div class="contextualHelp"><div class="arrowContainer"><svg class="pointingArrow" viewBox="0 0 20 20"><path d="M20 0L1 10L20 20"/></svg></div> <div class="helpBody"><div class="progress"></div><div class="steps"></div><nav>   <svg class="chevronBack" viewBox="0 0 20 20" preserveAspectRatio="none">      <path d="M19 1L1 10L19 19"/>   </svg>   <svg class="chevronForward" viewBox="0 0 20 20" preserveAspectRatio="none">      <path d="M1 1L19 10L1 19"/>   </svg>   <button type="button" class="textButtonV1">'+Travian.Translation.get("allgemein.ok")+"</button></nav></div></div>";jQuery(b).appendTo("#contextualHelp")}};Travian.Game.Profile={};Travian.Game.Profile.Languages={init:function(e,g,o,f){var n=4;var s=700;var h={};var k=false;var m=false;var d,c="";var b=jQuery(e);var q=jQuery(e+" #playerLanguages");var p=jQuery(e+" .addLanguageButton");
var l=function(){k=Object.keys(h).length>1;m=Object.keys(h).length<n;if(k){q.addClass("deletable")}else{q.removeClass("deletable")}if(m){b.addClass("addable")}else{b.removeClass("addable")}};var r=function(v){if(v!==undefined&&!h.hasOwnProperty(v)){var u=o[v];var t=u.langNative+" ("+u.countryNative+")";q.append(jQuery('<div class="flagContainer" title="'+t+'" data-flag="'+v+'" ><img class="languageFlag" alt="'+t+'" src="/img/svg/flags/'+u.flag+'.svg" title="'+t+'"><input value="'+v+'" type="hidden" name="languages[]"/></div>'));h[v]=v}};var j=function(t,u){if(Object.values(t).length>0){r(t.language);l()}u.close();Travian.Tip.updateAllInElement(e);Travian.Form.UnloadHelper.updateSubmitButtons(jQuery(f))};g.forEach(function(t,u){r(t)});l();Travian.Tip.updateAllInElement(e);q.on("click",".flagContainer",function(u){var t=jQuery(u.target);if(Object.keys(h).length===1){return true}var v=t.data("flag");delete h[v];t.remove();l();Travian.Form.UnloadHelper.updateSubmitButtons(jQuery(f))});p.on("click","",function(x){x.preventDefault();
var u={};var v=new Travian.Dialog.Dialog({version:2,preventFormSubmit:true,buttonOk:false,cssClass:"profileLanguages"});v.form.keydown(function(y){if(y.keyCode===13){j(u,v)}});var t=function(y,B){var C="profile-languages";var z=Object.values(h);var A=C+"?"+jQuery.param({query:B,languages:z});Travian.api(A,{success:function(D){y(D)}},"GET","html")};jQuery("body").off("keyup",'#dialogLanguagesList input[type="text"]').on("keyup",'#dialogLanguagesList input[type="text"]',function(y){clearTimeout(d);d=setTimeout(function(){c=jQuery(y.target).val();t(function(z){v.setContent(z);jQuery('#dialogLanguagesList input[type="text"]').val(c);jQuery('#dialogLanguagesList input[type="text"]').focus()},jQuery(y.target).val())},s)});jQuery("body").off("click","#dialogLanguagesList label").on("click","#dialogLanguagesList label",function(y){var z=jQuery(this).data("language");u={language:z}});jQuery("body").off("click","#dialogLanguagesList button").on("click","#dialogLanguagesList button",function(y){j(u,v)
});t(function(y){v.setContent(y).show();jQuery('#dialogLanguagesList input[type="text"]').focus()})})}};Travian.Game.ReferAFriend={navigate:function(c,b){Travian.api(c,{success:function(e){var d=Travian.WindowManager.getWindowsByContext(b)[0];d.updateInfoButton(e.options);d.setContent(e.content);if(typeof e.options.cssClass!=="undefined"){d.updateCssClass(e.options.cssClass)}Travian.TabManager.initializeOnDialogLoad()},error:function(d){var e=new Travian.Dialog.Dialog({preventFormSubmit:true});e.setContent('<div class="error">'+d.status+" "+d.statusText+"</div>").show()}},"GET")},initInviteForm:function(){var b=jQuery(".referAFriend .sendForm");var d=b.find(".receiverBlock");var f=d.find(".receiverLine");var c=b.find(".addReceiver");var e=b.parents(".dialogContents form");c.off("click").on("click",function(h){if(f.length<6){var g=Travian.Translation.translate("{earnGoldContentMailSendReceiverCount}").replace("[RECEIVER_COUNT]",f.length+1);var j=jQuery('<label class="receiverLine added"><span>'+g+'</span> <input type="text" class="text" name="receiver[]" /></label>');
d.append(j);f=d.find(".receiverLine");if(f.length===6){c.addClass("hide")}}});e.off("submit").on("submit",function(h){h.preventDefault();b.find("#inviteFormSubmit").prop("disabled","disabled");var g=[];b.find('input[name="receiver[]"]').each(function(j,k){g.push(jQuery(k).val())});Travian.api("referAFriendDialog/sendInvites",{data:{receiver:g,message:b.find("textarea.earnGoldSendMailMessage").val()},success:function(k){var j=Travian.WindowManager.getWindowsByContext("plusSupport")[0];j.updateInfoButton(k.options);j.setContent(k.content);if(typeof k.options.cssClass!=="undefined"){j.updateCssClass(k.options.cssClass)}Travian.TabManager.initializeOnDialogLoad()},error:function(j){var k=new Travian.Dialog.Dialog({preventFormSubmit:true});k.setContent('<div class="error">'+j.status+" "+j.statusText+"</div>").show()}},"POST")})}};Travian.Game.Manual={dialog:null,position:null,open:function(b,c){if(typeof b==="undefined"){b=0}if(typeof c==="undefined"){c=0}let $this=this;new Travian.api("manual/"+b+"/"+c,{success:function(d){let dialogWrapper=jQuery(".dialogWrapper[data-context=manual]");
if(dialogWrapper.length===0){$this.dialog=new Travian.Dialog.Dialog({context:"manual",title:Travian.Translation.translate("{allgemein.anleitung}"),buttonOk:false,enableBackground:false,draggable:true,cssClass:"manual"});$this.position=null}else{$this.position=dialogWrapper.position()}$this.dialog.setContent(d.html);$this.dialog.show();if($this.position!==null){$this.dialog.setPosition({x:$this.position.left,y:$this.position.top})}},error:function(d){let dialog=new Travian.Dialog.Dialog({buttonOk:true,buttonCloseOnClickOk:true,preventFormSubmit:true});dialog.setContent(d.error);dialog.show()}},"GET")}};Travian.Game.Map=(function(){var b=0;return{_map:null,Containers:null,version:1,getNewId:function(){b++;return"mapId"+b},mapIds:{},isPositionInRect:function(d,c){return(d.x0<=c.x&&d.y0<=c.y&&c.x<=d.x1&&c.y<=d.y1)},register:function(c){},wrapCoordinate:function(g,f){var e=Travian.Defaults.Map.Size;var d=((g-e.left)%e.width+e.width)%e.width+e.left;var c=((f-e.bottom)%e.height+e.height)%e.height+e.bottom;
return{$x:d,$y:c}},xy2id:function(e,d){var f=this.wrapCoordinate(e,d);var c=Travian.Defaults.Map.Size;return(c.top-f.$y)*c.width+(f.$x-c.left)+1}}})();Travian.Game.Map.Base=function(b,e){this.options=Object.assign({},b);var d;for(d in b){if(b.hasOwnProperty(d)){this[d]=b[d]}}if(this.id==null){this.id=Travian.Game.Map.getNewId()}if(e){this.parentContainer=e;for(var c=0;c<this.globalProperties.length;c++){d=this.globalProperties[c];if(this.parentContainer[d]){this[d]=this.parentContainer[d]}}if(e.classType==="Travian.Game.Map.Container"){this.mapContainer=e}else{if(e.mapContainer){this.mapContainer=this.parentContainer.mapContainer}}}};Travian.Game.Map.Base.prototype.classType="Travian.Game.Map.Base";Travian.Game.Map.Base.prototype.id=null;Travian.Game.Map.Base.prototype.element=null;Travian.Game.Map.Base.prototype.position=null;Travian.Game.Map.Base.prototype.mapCoordinates=null;Travian.Game.Map.Base.prototype.contextMenu=null;Travian.Game.Map.Base.prototype.transition=null;Travian.Game.Map.Base.prototype.updater=null;
Travian.Game.Map.Base.prototype.globalProperties=["cookie","dataStore","transition","updater","contextMenu"];Travian.Game.Map.Base.prototype.parentContainer=null;Travian.Game.Map.Base.prototype.render=function(b){b=b||{};if(!b.nodeType){b.nodeType="<div/>"}this.element=jQuery(b.nodeType).prop("unselectable","on");return this};Travian.Game.Map.Base.prototype.destroy=function(){if(this.element){this.element.remove()}};Travian.Game.Map.Base.prototype.isCoordinatesInRect=function(b){return(this.mapCoordinates.x<=b.x&&this.mapCoordinates.y<=b.y&&b.x<=this.mapCoordinates.right&&b.y<=this.mapCoordinates.top)};Travian.Game.Map.Base.prototype.isPositionInRect=function(b){return Travian.Game.Map.isPositionInRect({x0:this.position.x,y0:this.position.y,x1:this.position.x+this.position.width,y1:this.position.y+this.position.height},b)};Travian.Game.Map.Dialog=(function(){this.lowRes=false;this.open=function(c,e,b){var d=this;if(d.lowRes){b.disableEvents()}new Travian.Dialog.Ajax("ajax/viewTileDetails",Object.assign({},c,{context:"map",stickToUrlOnRestore:true,data:{x:e.x,y:e.y},onOpen:function(g,f){if(typeof b==="undefined"||b===null){return
}jQuery(f).find('a[href^="/karte.php"]').on("click",function(j){j.preventDefault();var h=Travian.parseURL(j.target.href);b.moveTo({x:parseInt(h.searchObject.x||"0"),y:parseInt(h.searchObject.y||"0")});g.close();return false});setTimeout(function(){jQuery(window).trigger("travian.toggleMapDialog")},500)},onClose:function(){if(d.lowRes){b.enableEvents()}setTimeout(function(){jQuery(window).trigger("travian.toggleMapDialog")},500)}}))}});Travian.Game.Map.Container=(function(){var c=function(f){var j=false;var e=false;var p=null;var k={count:0,shift:false,control:false,alt:false,keys:{},fn:null};for(var o in f.keyboard){if(f.keyboard.hasOwnProperty(o)){var l=f.keyboard[o];if(typeof f.keyboard[o]==="string"){f.keyboard[o]={fn:f.keyboard[o]}}f.keyboard[o]=Object.assign({periodical:1},f.keyboard[o]);if(typeof f.keyboard[o].fn==="string"){k.keys[o]=false}}}var q=f.containerRender.css("cursor");var d=function(r){return jQuery(r.target).closest("div.dialogContainer").length};var n=function(t,r,v,s){if(d(t)){return
}if(!f.isEventsEnabled()){return}var u=(t.which===3||t.button===2);if(f.containerViewSize.x<=r&&f.containerViewSize.y<=v&&r<=f.containerViewSize.right&&v<=f.containerViewSize.bottom&&s===f.containerMover.get(0)&&!u){j=true;e=false;p={x:r,y:v};t.stopPropagation()}};var h=function(s,r,u){if(f.containerViewSize.x<=r&&f.containerViewSize.y<=u&&r<=f.containerViewSize.right&&u<=f.containerViewSize.bottom){f.currentMousePosition.browserAbsolute.x=r;f.currentMousePosition.browserAbsolute.y=u;f.currentMousePosition.browser.x=r-f.containerSize.x-f.elementSize.x;f.currentMousePosition.browser.y=u-f.containerSize.y-f.elementSize.y;f.currentMousePosition.map=f.transition.translateToMap(f.currentMousePosition.browser,{})}else{f.currentMousePosition.browserAbsolute.x=null;f.currentMousePosition.browserAbsolute.y=null;f.currentMousePosition.browser.x=null;f.currentMousePosition.browser.y=null;f.currentMousePosition.map.x=null;f.currentMousePosition.map.y=null}if(!j){return}if(!f.isEventsEnabled()){return
}var t={x:r-p.x,y:-(u-p.y)};if((Math.abs(t.x)+Math.abs(t.y))>0){p={x:r,y:u};e=true;f.containerRender.css({cursor:"move"});f.move(t)}s.stopPropagation()};var m=function(s,r,v){if(d(s)){return}if(!f.isEventsEnabled()){return}var u=(s.which===3||s.button===2);if(r!==null&&v!==null&&f.containerViewSize.x<=r&&f.containerViewSize.y<=v&&r<=f.containerViewSize.right&&v<=f.containerViewSize.bottom&&!u&&!e&&j&&!Travian.WindowManager.checkOpenWindowByContext("map")){var t=f.transition.translateToMap({x:r-f.containerViewSize.x-f.elementSize.x,y:v-f.containerViewSize.y-f.elementSize.y},{});if(f.tileDisplayInformation.type==="dialog"){f.openDialog(f.tileDisplayInformation.optionsDialog,t,f)}else{Travian.popup(Travian.Helpers.substitute(f.tileDisplayInformation.optionsPopup.url,t),f.tileDisplayInformation.optionsPopup.windowOptions)}}f.containerRender.css({cursor:q});if(e){s.stopPropagation();f.updateBrowserURL(f.transition.getPointOfCenterInView())}j=false;e=false};var g=null;jQuery(window).on({selectstart:function(r){if(d(r)){return
}if(!f.isEventsEnabled()){return}if(!e){return}r.stopPropagation();return false},dragstart:function(r){if($(r.target).closest("div.dialogContainer").length){return}if(!f.isEventsEnabled()){return}if(!e){return}r.stopPropagation();return false},mousedown:function(r){n(r,r.pageX,r.pageY,r.target)},mousemove:function(r){if(d(r)){return}h(r,r.pageX,r.pageY);r.preventDefault()},mouseup:function(r){m(r,r.pageX,r.pageY)},wheel:function(r){if(!f.isEventsEnabled()){return}if(f.containerViewSize.x<=r.pageX&&f.containerViewSize.y<=r.pageY&&r.pageX<=f.containerViewSize.right&&r.pageY<=f.containerViewSize.bottom&&r.target===f.containerMover.get(0)){var s=f.transition.translateToMap({x:r.pageX-f.containerViewSize.x-f.elementSize.x,y:r.pageY-f.containerViewSize.y-f.elementSize.y},{});if(r.originalEvent.deltaY>0){f.zoomOut(s)}else{if(r.originalEvent.deltaY<0){f.zoomIn(s)}}r.preventDefault()}},touchstart:function(r){g=r;n(r,r.touches[0].pageX,r.touches[0].pageY,r.touches[0].target)},touchend:function(t){var s=g.touches[0].pageX,r=g.touches[0].pageY;
g=null;m(t,s,r);if(t.target===f.containerMover.get(0)){return false}},keydown:function(r){if(!f.isEventsEnabled()){return}if(r.shiftKey){k.shift=true}if(r.ctrlKey){k.control=true}if(r.altKey){k.alt=true}if(k.keys[r.keyCode]===false&&r.target.nodeName.toLowerCase()!=="input"){k.count++;k.keys[r.keyCode]=true;r.stopPropagation();if(!k.fnTimer){k.fn=function(){var x=0;for(var t in k.keys){if(k.keys.hasOwnProperty(t)&&k.keys[t]){var v=k.keys[t];if(v){if(!f.keyboard[t]){return}var z=f.keyboard[t].fn;if(z===false||!f[z]){return}var u="";if(z.substring(0,4)==="move"){u="normal";var s=f.keyboard.speed.slow;var y=f.keyboard.speed.fast;if(k[s]&&!k[y]){u="slow"}else{if(!k[s]&&k[y]){u="fast"}}}else{if(z.substring(0,4)==="zoom"){u=null}}f[z](u)}x+=f.keyboard[t].periodical}}if(x>0){k.fnTimer=requestAnimationFrame(k.fn)}};if(f.keyboard[r.keyCode].periodical===0){k.fn()}else{if(f.keyboard[r.keyCode].periodical>0){k.fnTimer=requestAnimationFrame(k.fn)}}}}},keyup:function(r){if(!f.isEventsEnabled()){return
}if(!r.shift){k.shift=false}if(!r.control){k.control=false}if(!r.alt){k.alt=false}if(k.keys[r.keyCode]){k.count--;k.keys[r.keyCode]=false;r.stopPropagation();if(k.count===0&&k.fnTimer){cancelAnimationFrame(k.fnTimer);k.fnTimer=null;f.updateBrowserURL(f.transition.getPointOfCenterInView())}}}});window.addEventListener("touchmove",function(r){if(r.target===f.containerMover.get(0)){r.preventDefault()}h(r,r.touches[0].pageX,r.touches[0].pageY);return false},{passive:false})};var b=function(d){this.blocks=null;this.classType="Travian.Game.Map.Container";this.containerRender=null;this.containerSize=null;this.containerViewSize=null;this.currentMousePosition={browserAbsolute:{x:null,y:null},browser:{x:null,y:null},map:{x:null,y:null}};this.element=null;this.elementSize=null;this.eventsEnabled=true;this.noGrid=false;this.loading=false;this.forcedUpdates=0;this.savedURL={};this.mapMarks={};this.addSymbol=function(j){var k=this.blocks.find(function(l){return l.isCoordinatesInRect(j.position)});if(k){k.addSymbol(j)
}return this};this.deleteSymbol=function(j){var k=this.blocks.find(function(l){return l.isCoordinatesInRect(j.position)});if(k){k.deleteSymbol(j)}return this};this.disableEvents=function(){this.eventsEnabled=false;return this};this.enableEvents=function(){this.eventsEnabled=true;return this};this.forceUpdateBlocksLayer=function(j){this.forcedUpdates=this.forcedUpdates+1;this.blocks.forEach(function(k){k.forceUpdateLayer(j)});return this};this.forceUpdateBlocksSymbols=function(k,j){this.blocks.forEach(function(l){l.forceUpdateSymbols(k,j)});return this};this.getContentForTooltip=function(j){var k=this.blocks.find(function(l){return l.isPositionInRect(j)});return k?k.getContentForTooltip(j):false};this.setContainerSizes=function(j){this.containerViewSize={x:j.x,y:j.y,width:j.width,height:j.height,right:j.x+j.width,bottom:j.y+j.height};this.containerSize={x:this.containerViewSize.x,y:this.containerViewSize.y,width:Math.ceil(this.containerViewSize.width/this.blockSize.width)*this.blockSize.width,height:Math.ceil(this.containerViewSize.height/this.blockSize.height)*this.blockSize.height,right:this.containerViewSize.x+Math.ceil(this.containerViewSize.width/this.blockSize.width)*this.blockSize.width,bottom:this.containerViewSize.y+Math.ceil(this.containerViewSize.height/this.blockSize.height)*this.blockSize.height}
};this.positionChange=function(){var k=Object.assign(this.containerRender.getDimensions({computeSize:true}),this.containerRender.getPosition());var j={x:this.containerViewSize.x-k.x,y:this.containerViewSize.y-k.y};this.setContainerSizes(k);this.miniMap.containerPosition=this.miniMap.container.getPosition();this.transition.containerPositionChange(j)};this.invalidateBlockVersionCache=function(){for(var j in this.blocks){if(this.blocks.hasOwnProperty(j)){this.blocks[j].invalidateVersionCache()}}return this};this.isEventsEnabled=function(){return this.eventsEnabled};this.updateBrowserURL=function(j){this.savedURL.searchObject=Object.assign(this.savedURL.searchObject,j);window.history.replaceState(this.savedURL,document.title,Travian.composeURI(this.savedURL));jQuery(document).trigger("toolbar.updateCoordinates",[j])};this.move=function(j){this.transition.move(j);if(this.blocks!==null){this.blocks.forEach(function(k){k.move(j)})}if(this.loading){if(!this.blockInitialDelta){this.blockInitialDelta={x:0,y:0}
}this.blockInitialDelta.x+=j.x;this.blockInitialDelta.y+=j.y}this.onMove(this,j);return this};this.moveDown=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:0,y:j})};this.moveLeft=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:j,y:0})};this.moveLeftDown=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:j,y:j})};this.moveLeftUp=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:j,y:-j})};this.moveRight=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:-j,y:0})};this.moveRightDown=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:-j,y:j})};this.moveRightUp=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return this}return this.move({x:-j,y:-j})};this.moveTo=function(k){var j=this.transition.translateToBrowser({x:Math.floor(k.x),y:Math.floor(k.y)});
j.x+=this.blockSize.width/this.transition.elementsPerBlock.x/2;j.y+=this.blockSize.height/this.transition.elementsPerBlock.y/2;j.x+=(this.containerSize.width-this.containerViewSize.width)/2;j.y+=(this.containerSize.height-this.containerViewSize.height)/2;this.updateBrowserURL(k);return this.move({x:this.elementSize.width/2-j.x,y:-(this.elementSize.height/2-j.y)})};this.moveUp=function(j){if(typeof j==="string"){j=this.speeds[j]}if(!j){return}return this.move({x:0,y:-j})};this.openDialog=function(k,m,j){var l=new Travian.Game.Map.Dialog();l.open(k,m,j)};this.render=function(){this.container=jQuery("<div></div>").css({overflow:"hidden",position:"relative",left:0,top:0,width:"100%",height:"100%",right:0,bottom:0}).prop("unselectable","on").attr("oncontextmenu","return false;").prependTo(this.containerRender);this.elementSize={x:-this.blockSize.width*this.blockOverflow,y:-this.blockSize.height*this.blockOverflow,width:this.containerSize.width+this.blockSize.width*this.blockOverflow*2,height:this.containerSize.height+this.blockSize.height*this.blockOverflow*2};
Travian.Game.Map.Base.prototype.render.call(this);this.element.css({position:"absolute",left:this.elementSize.x,top:this.elementSize.y,width:this.elementSize.width,height:this.elementSize.height}).prependTo(this.container);this.containerMover=jQuery("<div></div>").css({overflow:"hidden",position:"absolute",left:0,top:0,width:this.containerViewSize.width,height:this.containerViewSize.height,zIndex:100,backgroundColor:"transparent",opacity:1}).prop("unselectable","on").appendTo(this.container);this.onRender(this);this.moveTo(this.mapInitialPosition);this.renderBlocks();this.updateGrid();c(this);return this};this.renderBlocks=function(){if(this.blocks){return this}this.blocks=[];var k=Math.ceil(this.elementSize.width/this.blockSize.width);var j=Math.ceil(this.elementSize.height/this.blockSize.height);var m=Object.assign({x:0,y:0},this.blockInitialDelta);delete (this.blockInitialDelta);var o=null;var r=null;var l=null;for(var p=0,n=0;p<j;p++){for(var q=0;q<k;q++){o=Travian.Game.Map.Layer.Block.getCorrectPosition({x:q*this.blockSize.width+m.x,y:p*this.blockSize.height-m.y,width:this.blockSize.width,height:this.blockSize.height},this).position;
r=this.transition.translateToMap(o,{});l={id:n++,version:0};if(this.data.blocks[r.x]&&this.data.blocks[r.x][r.y]&&this.data.blocks[r.x][r.y][r.right]&&this.data.blocks[r.x][r.y][r.right][r.top]){l=Object.assign({},l,this.data.blocks[r.x][r.y][r.right][r.top])}this.blocks.push(new Travian.Game.Map.Layer.Block(Object.assign({},this.options.block,{id:l.id,symbolTypes:this.symbolTypes,position:o,mapCoordinates:r,version:l.version}),this))}}return this};this.toggleMiniMap=function(){return this.miniMap.animate()};this.toggleOutline=function(){return this.outline.animate()};this.toggleGrid=function(){var j=!this.noGrid;Travian.Game.Preferences.set("grid",j);this.noGrid=j;this.updateGrid()};this.updateGrid=function(){var j=this.noGrid?false:this.grid[this.transition.zoomLevel];this.element.find(".imageMark").each(function(k,l){jQuery(l).css({backgroundColor:"transparent",backgroundImage:j!==false?"url("+j+")":"none",backgroundPosition:"left top",backgroundRepeat:"repeat"})});return this};this.updateSymbolData=function(j){var k=this.blocks.find(function(l){return l.isCoordinatesInRect(j.position)
});if(k){k.updateSymbolData(j)}return this};this.zoom=function(l,k){var j=this.transition.zoomLevel;if(this.transition.zoom(l)){this.savedURL.searchObject.zoom=this.transition.zoomLevel;this.onZoom(this);if(T4_feature_flags.territory&&j===3||this.transition.zoomLevel===3){this.dataStore.removeAllOfType(Travian.Game.Map.DataStore.TYPE_TOOLTIP)}this.moveTo(k);this.updateGrid();jQuery(window).trigger("travian.map.zoomed")}return this};this.zoomIn=function(j){if(!j){j=this.transition.getPointOfCenterInView()}return this.zoom(-1,j)};this.zoomOut=function(j){if(!j){j=this.transition.getPointOfCenterInView()}return this.zoom(1,j)};this.loading=true;if(typeof d==="undefined"){d=Travian.Game.Map.Options.Default}Travian.Game.Map.Base.call(this,d);this.onMove=this.onMove||Travian.emptyFunction;this.onCreate=this.onCreate||Travian.emptyFunction;this.onRender=this.onRender||Travian.emptyFunction;this.onZoom=this.onZoom||Travian.emptyFunction;Travian.Game.Map.register(this);this.containerRender=this.container=jQuery(this.container);
Travian.Game.Map._map=this;var h={x:this.containerRender.offset().left,y:this.containerRender.offset().top,width:this.containerRender.width(),height:this.containerRender.height()};this.setContainerSizes(h);for(var e=0;e<this.globalProperties.length;e++){var g=this.globalProperties[e];var f=Travian.Helpers.capitalizeFirstLetter(g);if(Travian.Game.Map[f]){this[g]=new Travian.Game.Map[f](this[g]||{},this)}}if(this.data.elements){this.dataStore.setMultiple(Travian.Game.Map.DataStore.TYPE_TILE,this.data.elements)}this.noGrid=!!Travian.Game.Preferences.get("grid");this.onCreate(this);this.savedURL=Travian.parseURL(window.location.href);this.render();this.loading=false;jQuery("window").on({resize:this.positionChange.bind(this)})};b.prototype=Object.create(Travian.Game.Map.Base.prototype);b.constructor=b;return b})();Travian.Game.Map.Transition=(function(){var b=[];var f=function(j,h){var g=false;do{g=false;if(Math.round(j.x)>h.border.right){j.x=h.border.left+(j.x-h.border.right)-1;g=true}else{if(Math.round(j.x)<h.border.left){j.x=h.border.right-(h.border.left-j.x)+1;
g=true}}if(Math.round(j.right)>h.border.right){j.right=h.border.left+(j.right-h.border.right)-1;g=true}else{if(Math.round(j.right)<h.border.left){j.right=h.border.right-(h.border.left-j.right)+1;g=true}}if(Math.round(j.y)>h.border.top){j.y=h.border.bottom+(j.y-h.border.top)-1;g=true}else{if(Math.round(j.y)<h.border.bottom){j.y=h.border.top-(h.border.bottom-j.y)+1;g=true}}if(Math.round(j.top)>h.border.top){j.top=h.border.bottom+(j.top-h.border.top)-1;g=true}else{if(Math.round(j.top)<h.border.bottom){j.top=h.border.top-(h.border.bottom-j.top)+1;g=true}}}while(g);return j};var c=function(g){g.elementsPerBlock=g.zoomOptions.sizes[g.zoomLevel-1];g.pixelPerTile={x:g.mapContainer.blockSize.width/g.elementsPerBlock.x,y:g.mapContainer.blockSize.height/g.elementsPerBlock.y};g.elementsInView={x:g.elementsPerBlock.x*g.mapContainer.containerSize.width/g.mapContainer.blockSize.width,y:g.elementsPerBlock.y*g.mapContainer.containerSize.height/g.mapContainer.blockSize.height}};var e=function(k,h){var j={x:k.mapContainer.containerSize.x+k.mapContainer.elementSize.x,y:k.mapContainer.containerSize.y+k.mapContainer.elementSize.y};
var g=k.mapContainer.blockSize.height/k.elementsPerBlock.y;return{x:(h.x-k.positionOrigin.map.x)*k.pixelPerTile.x+k.positionOrigin.browser.x-j.x,y:(k.positionOrigin.map.y-h.y)*k.pixelPerTile.y-g-j.y+k.positionOrigin.browser.y}};var d=function(g,h){this.classType="Travian.Game.Map.Transition";this.elementsPerBlock=null;this.pixelPerTile=null;this.zoomLevel=null;this.zoomOptions=null;this.border=null;this.mapContainer=null;this.getPointOfCenterInView=function(){var j={x:this.mapContainer.containerViewSize.x+this.mapContainer.containerViewSize.width/2,y:this.mapContainer.containerViewSize.y+this.mapContainer.containerViewSize.height/2};j.x-=this.mapContainer.containerSize.x;j.y-=this.mapContainer.containerSize.y;j.x-=this.mapContainer.elementSize.x;j.y-=this.mapContainer.elementSize.y;return this.translateToMap(j,{})};this.containerPositionChange=function(j){this.positionOrigin.browser.x-=j.x;this.positionOrigin.browser.y+=j.y};this.move=function(j){this.positionOrigin.browser.x+=j.x;this.positionOrigin.browser.y-=j.y;
this.onMove(this,j);return this};this.registerCallbackOnZoom=function(j){b.push(j);return this};this.translateToBrowser=function(k){var l={x:this.mapContainer.containerSize.x+this.mapContainer.elementSize.x,y:this.mapContainer.containerSize.y+this.mapContainer.elementSize.y};var j=this.mapContainer.blockSize.height/this.elementsPerBlock.y;return{x:(k.x-this.positionOrigin.map.x)*this.pixelPerTile.x+this.positionOrigin.browser.x-l.x,y:(this.positionOrigin.map.y-k.y)*this.pixelPerTile.y-j-l.y+this.positionOrigin.browser.y}};this.translateToMap=function(l,m){m=Object.assign({round:true,correct:true},m||{});var n={x:this.mapContainer.containerSize.x+this.mapContainer.elementSize.x,y:this.mapContainer.containerSize.y+this.mapContainer.elementSize.y};var k=this.mapContainer.blockSize.height/this.elementsPerBlock.y;if(typeof l.height!=="undefined"){k=l.height}var j=null;if(m.round){j={x:Math.floor((l.x+n.x-this.positionOrigin.browser.x)/this.pixelPerTile.x)+this.positionOrigin.map.x,y:this.positionOrigin.map.y-Math.floor((l.y+k+(n.y-this.positionOrigin.browser.y))/this.pixelPerTile.y)}
}else{j={x:((l.x+n.x-this.positionOrigin.browser.x)/this.pixelPerTile.x)+this.positionOrigin.map.x-1,y:this.positionOrigin.map.y-((l.y+k+(n.y-this.positionOrigin.browser.y))/this.pixelPerTile.y)}}if(l.width){j.right=j.x+l.width/this.pixelPerTile.x-1}if(l.height){j.top=j.y+l.height/this.pixelPerTile.y-1}if(m.correct){j=f(j,this)}return j};this.zoom=function(k){if(k===0||(k<0&&this.zoomLevel+k<1)||(k>0&&this.zoomLevel+k>this.zoomOptions.sizes.length)){return false}this.zoomLevel+=k;c(this);this.onZoom(this);for(var j=0;j<b.length;j++){b[j](this)}return true};Travian.Game.Map.Base.call(this,g,h);this.onMove=this.onMove||Travian.emptyFunction;this.onCreate=this.onCreate||Travian.emptyFunction;this.onZoom=this.onZoom||Travian.emptyFunction;this.zoomLevel=this.zoomOptions.level;this.positionOrigin={browser:{x:this.mapContainer.containerSize.x,y:this.mapContainer.containerSize.y+this.mapContainer.containerSize.height},map:{x:0,y:0}};c(this);this.onCreate(this)};d.prototype=Object.create(Travian.Game.Map.Base.prototype);
d.constructor=d;return d})();Travian.Game.Map.Transition.Precision=2;Travian.Game.Map.Updater=(function(){var c=function(k){if(Object.keys(k.objects.ajax).length<=0){return false}k.updateWorking(1);var h=[];for(var j in k.objects.ajax){if(k.objects.ajax.hasOwnProperty(j)){var g=k.objects.ajax[j].getRequestData();if(g!==false){h.push(g)}}}k.requestObject.multiple=Travian.api("ajax/mapInfo",{data:Object.assign({},k.parameters.multiple,{data:h,zoomLevel:k.transition.zoomLevel}),success:function(l){k.updateWorking(-1);k.setContentDataAndRefresh(l);d(k)},error:function(l){k.updateWorking(-1);k.setContentDataAndRefresh(l);d(k)}});return true};var b=function(j,h){j.updateWorking(1);var g={x0:h.position.x+j.options.positionOptions.areaAroundPosition[j.transition.zoomLevel].left,y0:h.position.y+j.options.positionOptions.areaAroundPosition[j.transition.zoomLevel].bottom,x1:h.position.x+j.options.positionOptions.areaAroundPosition[j.transition.zoomLevel].right,y1:h.position.y+j.options.positionOptions.areaAroundPosition[j.transition.zoomLevel].top};
if(j.requestObject.position){j.requestObject.position.abort();j.requestObject.position=null;j.updateWorking(-1)}j.requestObject.position=Travian.api("ajax/mapPositionData",{data:Object.assign({},j.parameters.position,{data:Object.assign({},h.position,{zoomLevel:j.transition.zoomLevel,ignorePositions:j.dataStore.getPositionsOfData(h.dataStoreType).filter(function(k){return Travian.Game.Map.isPositionInRect(g,k)}).map(function(k){return Travian.Game.Map.xy2id(k.x,k.y)})})}),success:function(k){j.updateWorking(-1);(h.onSuccess||Travian.emptyFunction)(k)},error:function(k){j.updateWorking(-1);(h.onError||Travian.emptyFunction)(k)}})};var e=function(h,g){g.element.attr("src",g.srcUrl+"?t="+g.time);if(g.finishedLoading){g.finishedLoading()}delete (h.loadings[g.blockContainer.updaterId][g.updaterId]);if(Object.keys(h.loadings[g.blockContainer.updaterId]).length===0){g.blockContainer.layers.loading.hide()}h.requestCountImages--;h.updateWorking(-1);d(h);jQuery(window).trigger("travian.map.imageLoaded")
};var d=function(g){if(g.requestCountImages>=g.maxRequestCount){return}Object.keys(g.objects.images).map(function(j,h){return{imageId:j,priority:g.objects.images[j].getPriority()}}).sort(function(j,h){return j.priority-h.priority}).some(function(j,k){var l=g.objects.images[j.imageId];var h=function(){e(g,l)};delete (g.objects.images[l.updaterId]);g.requestCountImages++;g.updateWorking(1);if(!l.imageLoader){l.imageLoader=jQuery(new Image()).on("load",h)}l.refreshSrcUrl();l.imageLoader.attr("src",l.srcUrl);return g.requestCountImages>=g.maxRequestCount})};var f=function(g,h){this.lastRequestPosition={x:null,y:null};this.loadings={};this.requestCount=0;this.requestCountImages=0;this.maxRequestCount=5;this.requestDelayId={multiple:null,position:null};this.requestObject={multiple:null,position:null};this.classType="Travian.Game.Map.Updater";this.register=function(k,j){if(!this.objects[k]){return this}if(!j.updaterId){j.updaterId=Travian.Game.Map.getNewId()}if(!this.objects[k][j.updaterId]){this.objects[k][j.updaterId]=j
}if(k==="images"){if(!j.blockContainer.updaterId){j.blockContainer.updaterId=Travian.Game.Map.getNewId()}if(!this.loadings[j.blockContainer.updaterId]){this.loadings[j.blockContainer.updaterId]={}}this.loadings[j.blockContainer.updaterId][j.updaterId]=true;j.blockContainer.layers.loading.show()}this.request();return this};this.request=function(){var j=this;if(this.requestObject.multiple&&this.requestObject.multiple.cancel){this.requestObject.multiple.cancel();this.requestObject.multiple=null;this.updateWorking(-1)}if(this.requestDelayId.multiple){clearTimeout(this.requestDelayId.multiple);this.requestDelayId.multiple=null}this.requestDelayId.multiple=setTimeout(function(){if(c(j)===false){d(j)}},this.requestDelayTime.multiple);return this};this.requestPosition=function(j){var k=this;if(this.lastRequestPosition.x===j.position.x&&this.lastRequestPosition.y===j.position.y){return this}this.lastRequestPosition.x=j.position.x;this.lastRequestPosition.y=j.position.y;if(this.requestObject.position&&this.requestObject.position.cancel){this.requestObject.position.cancel();
this.requestObject.position=null;this.updateWorking(-1)}if(this.requestDelayId.position){clearTimeout(this.requestDelayId.position);this.requestDelayId.position=null}this.requestDelayId.position=setTimeout(function(){b(k,j)},this.requestDelayTime.position);return this};this.setContentDataAndRefresh=function(p){if(p.blocks){for(var l in p.blocks){if(p.blocks.hasOwnProperty(l)){for(var n in p.blocks[l]){if(p.blocks[l].hasOwnProperty(n)){for(var k in p.blocks[l][n]){if(p.blocks[l][n].hasOwnProperty(k)){for(var m in p.blocks[l][n][k]){if(p.blocks[l][n][k].hasOwnProperty(m)){var j={x:l,y:n,right:k,top:m};var q=Object.assign({},this.dataStore.get(Travian.Game.Map.DataStore.TYPE_BLOCKS,j,"block")||{},p.blocks[l][n][k][m]);this.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_BLOCKS,position:j,index:"block",data:q})}}}}}}}}this.mapContainer.invalidateBlockVersionCache()}if(p.elements){this.dataStore.setMultiple(Travian.Game.Map.DataStore.TYPE_TILE,p.elements)}for(var o in this.objects.ajax){if(this.objects.ajax.hasOwnProperty(o)){if(this.objects.ajax[o].refreshContent){this.objects.ajax[o].refreshContent()
}delete (this.objects.ajax[o])}}return this};this.updateWorking=function(j){this.requestCount+=j;if(this.elementWorking.length>0){if(this.requestCount>0){this.elementWorking.css({visibility:"visible"})}else{this.elementWorking.css({visibility:"hidden"})}this.elementWorking.html(this.requestCount)}return this};Travian.Game.Map.Base.call(this,g,h);this.objects={ajax:{},images:{}};this.elementWorking=jQuery(this.elementWorking)};f.prototype=Object.create(Travian.Game.Map.Base.prototype);f.constructor=f;return f})();Travian.Game.Map.ContextMenu=function(b,e){this.classType="Travian.Game.Map.ContextMenu";this.addAction=function(g){var j=this;var h=false;g.element=jQuery(g.element);if(g.element.length>0&&!h){var f=g.element.find("a");if(f.length>0){f.on("click",function(k){g.fn(j,j.mapPosition,j.contentData)});this.actions.push(g)}else{g.element.hide()}}return this};this.disable=function(){this.options.disabled=true;return this};this.enable=function(){this.options.disabled=false;return this};
this.hide=function(){if(this.shown){this.fx(this.menu,false);this.parentContainer.enableEvents();this.menu.hide();this.shown=false}return this};this.show=function(){this.fx(this.menu,true);this.parentContainer.disableEvents();this.menu.show();this.shown=true;return this};this.startListener=function(){var f=this;this.targets.each(function(g,h){jQuery(h).on(f.options.trigger,function(j){if(j.target===f.parentContainer.containerMover.get(0)&&!f.options.disabled){if(f.options.stopEvent){j.stopPropagation()}f.options.element=jQuery(h);f.menu.css({left:(j.pageX+f.options.offsets.x),top:(j.pageY+f.options.offsets.y),position:"absolute"});f.show()}})});jQuery("body").on("click",function(){f.hide()});return this};this.update=function(){var f=this;if(this.options.disabled||!this.shown){return this}this.menu.find("div.separator").each(function(h,j){var k=jQuery(j);var g=k.prev();g.show();k.show()});this.contentData=this.parentContainer.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,this.mapPosition);
this.actions.forEach(function(g){if(f.contentData!=null&&g.shouldDisplay(f.contentData)){g.element.show()}else{g.element.hide()}});this.menu.find("div.separator").each(function(h,j){var k=jQuery(j);var g=k.prev();if(g.find(".entry:visible").length===0){g.hide();k.hide()}});return this};this.options=Object.assign({actions:{},menu:"#contextmenu",stopEvent:true,targets:"#mapContainer",trigger:"contextmenu",offsets:{x:0,y:0},onShow:Travian.emptyFunction,onHide:Travian.emptyFunction,onClick:Travian.emptyFunction,fadeSpeed:200},b);this.parentContainer=e;this.mapPosition=null;this.menu=jQuery(this.options.menu);this.targets=jQuery(this.options.targets);this.fx=function(g,f){g.animate({opacity:f?1:0},this.options.fadeSpeed,function(){g.css({display:f?"block":"none"})})};this.hide().startListener();this.menu.css({position:"absolute",top:"-900000px",display:"block"});this.menu.detach().appendTo("body");this.actions=[];for(var c in this.options.actions){if(this.options.actions.hasOwnProperty(c)){this.addAction(this.options.actions[c])
}}var d=this;this.targets.each(function(f,g){jQuery(g).on(d.options.trigger,function(h){d.mapPosition=d.parentContainer.transition.translateToMap({x:h.pageX-d.parentContainer.containerSize.x-d.parentContainer.elementSize.x,y:h.pageY-d.parentContainer.containerSize.y-d.parentContainer.elementSize.y});d.update()})})};Travian.Game.Map.DataStore=(function(){var g=0;var f=function(h){for(var j in h.options.useStorageForType){if(h.options.useStorageForType.hasOwnProperty(j)&&h.options.useStorageForType[j]){Travian.Storage.set("mapDataContainer."+j,h.data[j],h.options.persistentStorage)}}};var d=function(k,n,h){var l=h.x;var o=h.y;var j=typeof h.right!=="undefined"?h.right:l;var m=typeof h.top!=="undefined"?h.top:o;if(!k.data[n]){k.data[n]={all:{}}}if(!k.data[n][l]){k.data[n][l]={}}if(!k.data[n][l][o]){k.data[n][l][o]={}}if(!k.data[n][l][o][j]){k.data[n][l][o][j]={}}if(!k.data[n][l][o][j][m]){k.data[n][l][o][j][m]={}}if(!k.data[n][l][o][j][m].id){g++;k.data[n][l][o][j][m].id=g}k.data[n][l][o][j][m].position=h;
return k.data[n][l][o][j][m]};var c=function(k,n,h){var l=h.x;var o=h.y;var j=typeof h.right!=="undefined"?h.right:l;var m=typeof h.top!=="undefined"?h.top:o;if(!k.data[n]){return null}if(!k.data[n][l]){return null}if(!k.data[n][l][o]){return null}if(!k.data[n][l][o][j]){return null}if(!k.data[n][l][o][j][m]){return null}if(e(k,k.data[n][l][o][j][m],n)){return null}return k.data[n][l][o][j][m]};var e=function(h,k,j){return k.time!==false&&(new Date()).getTime()-k.time>h.cachingTimeForType[j]};var b=function(h,l){this.classType="Travian.Game.Map.DataStore";this.data={};this.get=function(o,m,n){var p=c(this,o,m);if(p==null){return null}if(typeof n!=="undefined"){if(p.data[n]){return p.data[n]}return null}return p.data};this.getDataForArea=function(q,o,m){var u=[];var p=Object.assign({},o);if(!this.data[q]||!this.data[q].all){return u}if(p.x>p.right){p.right+=this.parentContainer.transition.border.width}if(p.y>p.top){p.top+=this.parentContainer.transition.border.height}for(var t in this.data[q].all){if(this.data[q].all.hasOwnProperty(t)){var s=this.data[q].all[t];
var r={x:s.position.x,y:s.position.y};if(p.x>r.x){r.x+=this.parentContainer.transition.border.width}if(p.y>r.y){r.y+=this.parentContainer.transition.border.height}if(e(this,s,q)===false&&p.x<=r.x&&r.x<=p.right&&p.y<=r.y&&r.y<=p.top){if(m){for(var n in s.data){if(s.data.hasOwnProperty(n)){u.push(s.data[n])}}}else{u.push(s.data)}}}}return u};this.getPositionsOfData=function(m){var n=this;if(!this.data[m]||!this.data[m].all){return[]}return Object.keys(this.data[m].all).filter(function(o){return e(n,n.data[m].all[o],m)===false}).map(function(o){return n.data[m].all[o].position})};this.push=function(m){if(typeof m.time==="undefined"){m.time=(new Date()).getTime()}if(m.time===-1){m.time=false}var n=d(this,m.type,m.position);if(!n.data){n.data={}}n.data[m.index]=m.data;n.time=m.time;this.data[m.type].all[n.id]=n;return this};this.refresh=function(m){var n=c(this,m.type,m.position);if(n!=null){if(typeof m.time==="undefined"){m.time=(new Date()).getTime()}if(m.time===-1){m.time=false}n.time=m.time
}return this};this.remove=function(o,m,n){var p=c(this,o,m);if(p==null){return this}if(typeof n!=="undefined"){if(p.data[n]){delete (p.data[n])}return this}p.time=0;return this};this.removeAllOfType=function(m){if(this.data[m]!==undefined){delete (this.data[m])}};this.saveDataToStorage=function(){f(this);return this};this.set=function(m){if(typeof m.time==="undefined"){m.time=(new Date()).getTime()}if(m.time===-1){m.time=false}var p=d(this,m.type,m.position);p.data=m.data;p.time=m.time;this.data[m.type].all[p.id]=p;if(m.data.symbols){for(var n in m.data.symbols){if(m.data.symbols.hasOwnProperty(n)){var o=m.data.symbols[n];if(!o.dataId){o.dataId=o.type+"-"+index}this.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,position:m.position,data:o,index:o.dataId,time:false})}}}return this};this.setMultiple=function(p,m,q){for(var o=0;o<m.length;o++){var n=m[o];this.set({type:p,position:n.position,data:n,time:q})}f(this);return this};Travian.Game.Map.Base.call(this,h,l);var k;for(k in this.options.clearStorageForType){if(this.options.clearStorageForType.hasOwnProperty(k)&&this.options.clearStorageForType[k]){Travian.Storage.clear("mapDataContainer."+k,this.options.persistentStorage)
}}for(k in this.options.useStorageForType){if(this.options.useStorageForType.hasOwnProperty(k)&&this.options.useStorageForType[k]){this.data[k]=Travian.Storage.get("mapDataContainer."+k,this.options.persistentStorage)||{};if(!this.data[k].all){this.data[k].all={}}else{var j=Math.max(Object.keys(this.data[k].all).map(function(m){return parseInt(m)}));if(j>g){g=j}}}}};b.TYPE_BLOCKS="blocks";b.TYPE_SYMBOL="symbol";b.TYPE_TILE="tile";b.TYPE_TOOLTIP="tooltip";b.prototype=Object.create(Travian.Game.Map.Base.prototype);b.constructor=b;return b})();Travian.Game.Map.Tips={lastText:"",lastTitle:"",tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>',render:function(d,b){var c=this;Travian.Tip.set(b,{title:"",text:""});jQuery(b).on("mousemove",function(h){var g={x:h.pageX-d.containerSize.x-d.elementSize.x,y:h.pageY-d.containerSize.y-d.elementSize.y};var f=d.getContentForTooltip(g);if(f===false){f={title:"",text:Travian.Helpers.substitute(c.tooltipHtml,d.transition.translateToMap(g))}
}if(c.lastText!==f.text||c.lastTitle!==f.title){f.unescaped=true;Travian.Tip.show(f);c.lastText=f.text;c.lastTitle=f.title}});return this}};Travian.Game.Map.Rulers=(function(){var c=function(j,h){h+=j.delta.x[j.transition.zoomLevel];if(h<j.transition.border.left){h=j.transition.border.right-(j.transition.border.left-h)+1}else{if(h>j.transition.border.right){h=j.transition.border.left+(h-j.transition.border.right)-1}}return h};var b=function(j,h){h+=j.delta.y[j.transition.zoomLevel];if(h<j.transition.border.bottom){h=j.transition.border.top-(j.transition.border.bottom-h)+1}else{if(h>j.transition.border.top){h=j.transition.border.bottom+(h-j.transition.border.top)-1}}return h};var g=function(h){h.elements.moverX.css({backgroundImage:"url("+Travian.Helpers.substitute(h.imgSource.x,{zoomLevel:h.transition.zoomLevel})+")"});h.elements.moverY.css({backgroundImage:"url("+Travian.Helpers.substitute(h.imgSource.y,{zoomLevel:h.transition.zoomLevel})+")"})};var f=function(o){if(o.elements.coordinates){o.elements.coordinates.x.forEach(function(q){q.remove()
});o.elements.coordinates.y.forEach(function(q){q.remove()})}o.elements.coordinates={x:[],y:[]};var p=o.transition.elementsInView.x+o.transition.elementsPerBlock.x*2;var n=o.steps.x[o.transition.zoomLevel];for(var h=0,j=null,l=null;h<p;h+=n){j=jQuery("<div></div>").addClass("coordinate zoom"+o.transition.zoomLevel).css({position:"absolute",left:h*o.mapContainer.blockSize.width/o.transition.elementsPerBlock.x,top:0,width:n*o.mapContainer.blockSize.width/o.transition.elementsPerBlock.x,height:o.containerSize.height}).appendTo(o.elements.moverX);j.rulerLeft=h*o.mapContainer.blockSize.width/o.transition.elementsPerBlock.x;o.elements.coordinates.x[h]=j}var m=o.transition.elementsInView.y+o.transition.elementsPerBlock.y*2;var k=o.steps.y[o.transition.zoomLevel];for(h=0,j=null,l=null;h<m;h+=k){j=jQuery("<div></div>").addClass("coordinate zoom"+o.transition.zoomLevel).css({position:"absolute",left:0,top:h*o.mapContainer.blockSize.height/o.transition.elementsPerBlock.y,width:o.containerSize.width,height:k*o.mapContainer.blockSize.height/o.transition.elementsPerBlock.y}).appendTo(o.elements.moverY);
j.rulerTop=h*o.mapContainer.blockSize.height/o.transition.elementsPerBlock.y;o.elements.coordinates.y[h]=j}d(o,true,true)};var d=function(l,j,h){var k=false;do{k=false;if(l.position.x<-2*l.mapContainer.blockSize.width){l.position.x+=l.mapContainer.blockSize.width*1;j=true;k=true}if(l.position.x>0){l.position.x+=l.mapContainer.blockSize.width*-1;j=true;k=true}if(l.position.y<-2*l.mapContainer.blockSize.height){l.position.y+=l.mapContainer.blockSize.height*1;h=true;k=true}if(l.position.y>0){l.position.y+=l.mapContainer.blockSize.height*-1;h=true;k=true}}while(k);l.elements.moverX.css({left:l.position.x});l.elements.moverY.css({top:l.position.y});if(j&&l.elements.coordinates){jQuery(l.elements.coordinates.x).each(function(m,o){if(o&&o.length>0){var n=l.transition.translateToMap({x:l.position.x+o.rulerLeft-l.mapContainer.elementSize.x,y:0});o.html(c(l,n.x))}})}if(h&&l.elements.coordinates){jQuery(l.elements.coordinates.y).each(function(m,o){if(o&&o.length>0){var n=l.transition.translateToMap({x:0,y:l.position.y+o.rulerTop-l.mapContainer.elementSize.y});
o.html(b(l,n.y))}})}};var e=function(h,j){this.classType="Travian.Game.Map.Rulers";this.destroy=function(){this.elements.containerX.remove();this.elements.containerY.remove();return this};this.render=function(k){var l=this;this.position={x:this.mapContainer.blockSize.width,y:this.mapContainer.blockSize.height};this.elements={containerX:jQuery("<div></div>").addClass(this.cls.x).css({position:"absolute",left:0,right:0,width:this.mapContainer.containerViewSize.width,overflow:"hidden"}).appendTo(this.mapContainer.containerRender),containerY:jQuery("<div></div>").addClass(this.cls.y).css({position:"absolute",top:0,bottom:0,height:this.mapContainer.containerViewSize.height,overflow:"hidden"}).appendTo(this.mapContainer.containerRender)};this.containerSize={width:this.elements.containerY.width(),height:this.elements.containerX.height()};this.elements.containerX.css({height:this.containerSize.height});if(this.direction.toLowerCase()==="ltr"){this.elements.containerY.css({left:-this.containerSize.width})
}else{if(this.direction.toLowerCase()==="rtl"){this.elements.containerY.css({right:-this.containerSize.width})}}this.elements.moverX=jQuery("<div></div>").css({position:"absolute",left:0,top:0,width:this.mapContainer.containerSize.width+2*this.mapContainer.blockSize.width,height:"100%",backgroundPosition:"left top",backgroundColor:"transparent",backgroundRepeat:"repeat-x"}).appendTo(this.elements.containerX);this.elements.moverY=jQuery("<div></div>").css({position:"absolute",left:0,top:0,width:"100%",height:this.mapContainer.containerSize.height+2*this.mapContainer.blockSize.height,backgroundPosition:"left top",backgroundColor:"transparent",backgroundRepeat:"repeat-y"}).appendTo(this.elements.containerY);g(this);f(this);d(this);return this};this.move=function(k){this.position.x+=k.x;this.position.y-=k.y;d(this);return this};this.zoom=function(){g(this);f(this);d(this);return this};if(!h.direction){h.direction=jQuery("body").css("direction")}Travian.Game.Map.Base.call(this,h,j);this.position={x:0,y:0}
};e.prototype=Object.create(Travian.Game.Map.Base.prototype);e.constructor=e;return e})();Travian.Game.Map.MiniMap=(function(){var d=function(k){var f=k.transition.translateToMap({x:-k.mapContainer.elementSize.x,y:-k.mapContainer.elementSize.y},{});var j=k.transition.translateToMap({x:0,y:0,width:k.mapContainer.containerViewSize.width,height:k.mapContainer.containerViewSize.height},{round:false,correct:false});j.width=j.right-j.x;j.height=j.top-j.y;var h={x:k.containerSize.width/k.transition.border.width,y:k.containerSize.height/k.transition.border.height};k.position={x:f.x*h.x+k.containerSize.width/2-1,y:f.y*h.y+k.containerSize.height/2-j.height*h.y-1,width:j.width*h.x,height:j.height*h.y};var g=k.position;if(g.width>=k.containerSize.width){g.x=-1}if(g.height>=k.containerSize.height){g.y=-1}k.element.css({left:g.x,bottom:g.y,width:g.width,height:g.height});var e=Object.assign({},g);if(g.x<0){g.x+=k.containerSize.width}else{if(g.x+g.width>k.containerSize.width){g.x-=k.containerSize.width
}}if(g.y<0){g.y+=k.containerSize.height}else{if(g.y+g.height>k.containerSize.height){g.y-=k.containerSize.height}}k.elementHelpers[0].css({left:g.x,bottom:g.y,width:g.width,height:g.height});k.elementHelpers[1].css({left:e.x,bottom:g.y,width:g.width,height:g.height});k.elementHelpers[2].css({left:g.x,bottom:e.y,width:g.width,height:g.height})};var c=function(h,g){var f={x:g.containerSize.width/g.transition.border.width,y:g.containerSize.height/g.transition.border.height};return{x:Math.floor((h.pageX-g.containerPosition.x)/f.x-Math.abs(g.transition.border.left)),y:-Math.floor((h.pageY-g.containerPosition.y)/f.y-Math.abs(g.transition.border.bottom))}};var b=function(e,f){this.classType="Travian.Game.Map.MiniMap";this.expanded=true;this.animate=function(){var h=this;this.elements.container.stop(true);this.expanded=!!Travian.Game.Preferences.get("minimap-expanded");var g=function(){return !h.expanded?h.elements.container._height.min:h.elements.container._height.max};this.expanded=!this.expanded;
Travian.Game.Preferences.set("minimap-expanded",this.expanded);this.elements.headlineExpander.toggleClass("expand collapse");this.elements.container.animate({height:g()},200);this.parentContainer.outline.update(this.elements.container.height()-g());return this};this.getContentForTooltip=function(g,j){var h=c(j,this);return{text:Travian.Helpers.substitute(this.tooltipHtml,h)}};this.render=function(j){var l=this;this.container=jQuery(this.container).css({overflow:"hidden"}).prop("unselectable","on").on("click",function(n){l.mapContainer.moveTo(c(n,l))});Travian.Game.Map.Base.prototype.render.call(this,j);this.element.addClass("view").css({position:"absolute",zIndex:3}).appendTo(this.container);jQuery("<div></div>").addClass("inner").css({height:"100%",opacity:0.25,width:"100%"}).appendTo(this.element);this.elementHelpers=[];for(var k=0;k<3;k++){var g=jQuery("<div></div>").addClass("view").css({position:"absolute",zIndex:3}).appendTo(this.container);jQuery("<div></div>").addClass("inner").css({height:"100%",opacity:0.25,width:"100%"}).appendTo(g);
this.elementHelpers.push(g)}this.containerSize={width:this.container.width(),height:this.container.height()};this.containerPosition={x:this.container.offset().left,y:this.container.offset().top};this.elementSize={width:this.element.width(),height:this.element.height()};if(this.showToolTip){Travian.Game.Map.MiniMap.Tips.render(this,this.container.find("img"))}d(this);var h=jQuery(this.containerContent);this.elements={container:h,headline:h.find(".headline"),headlineExpander:h.find(".iconButton"),background:h.find(".background")};this.expanded=!!Travian.Game.Preferences.get("minimap-expanded");this.elements.headlineExpander.addClass(this.expanded?"expand":"collapse");var m=function(){l.elements.container._height={max:l.elements.container.height(),min:l.elements.headline.height()+parseInt(l.elements.headline.css("margin-top"))+parseInt(l.elements.headline.css("margin-bottom"))};if(l.expanded!==true){l.elements.container.css({height:l.elements.container._height.min})}l.elements.headline.on("click",function(n){l.animate()
})};m()};this.move=function(){d(this);return this};this.zoom=function(){d(this);return this};Travian.Game.Map.Base.call(this,e,f);this.position={x:0,y:0,width:0,height:0}};b.prototype=Object.create(Travian.Game.Map.Base.prototype);b.constructor=b;return b})();Travian.Game.Map.MiniMap.Tips={lastText:"",lastTitle:"",tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>',render:function(d,b){var c=this;Travian.Tip.set(b,{title:"",text:""});jQuery(b).on("mousemove",function(h){var g={x:h.pageX-d.containerSize.width-d.elementSize.width,y:h.pageY-d.containerSize.height-d.elementSize.height};var f=d.getContentForTooltip(g,h);if(f===false){f={title:"",text:Travian.Helpers.substitute(c.tooltipHtml,d.transition.translateToMap(g))}}if(c.lastText!==f.text||c.lastTitle!==f.title){f.unescaped=true;Travian.Tip.show(f);c.lastText=f.text;c.lastTitle=f.title}});return this}};Travian.Game.Map.Toolbar=function(b,c){this.classType="Travian.Game.Map.Toolbar";
this.render=function(d){var g=this;this.element=jQuery(this.element);this.zoomIn=this.element.find(".iconButton.zoomIn").on("click",function(h){g.mapContainer.zoomIn()});this.zoomOut=this.element.find(".iconButton.zoomOut").on("click",function(h){g.mapContainer.zoomOut()});var f=function(){g.zoomDropDownDataContainer._dropped=false;g.zoomDropDownDataContainer.css({height:g.zoomDropDownDataContainer._styleBackup.height});g.zoomDropDownEntries.each(function(h,k){var j=jQuery(k);if(j.hasClass("selected")){j.addClass("display")}j.addClass("hide").removeClass("selected")});jQuery(g.zoomDropDownEntries[g.transition.zoomLevel-1]).removeClass("hide").addClass("display")};this.zoomDropDownDataContainer=this.element.find(".dropdown .dataContainer");this.zoomDropDownEntries=this.zoomDropDownDataContainer.find(".entry");this.zoomDropDownDataContainer._styleBackup={height:this.zoomDropDownDataContainer.height(),maxHeight:this.zoomDropDownEntries.toArray().reduce(function(j,h){return j+jQuery(h).height()
},0)};this.zoomDropDownClick=this.element.find(".dropdown .iconButton.dropDownImage").on("click",function(h){if(!g.mapContainer.isEventsEnabled()){return}h.stopPropagation();if(g.zoomDropDownDataContainer._dropped){f();return}g.zoomDropDownDataContainer._dropped=true;g.zoomDropDownEntries.each(function(j,l){var k=jQuery(l);if(k.hasClass("display")){k.addClass("selected")}k.removeClass("display").removeClass("hide")});g.zoomDropDownDataContainer.css({height:g.zoomDropDownDataContainer._styleBackup.maxHeight})});this.zoomDropDownEntries.each(function(h,k){var j=jQuery(k);j.on("click",function(l){l.stopPropagation();if(!g.zoomDropDownDataContainer._dropped){return}g.zoomDropDownDataContainer._dropped=false;g.zoomDropDownDataContainer.css({height:g.zoomDropDownDataContainer._styleBackup.height});g.zoomDropDownEntries.each(function(m,n){jQuery(n).addClass("hide").removeClass("selected")});j.removeClass("hide").addClass("display");g.mapContainer.zoom(h+1-g.mapContainer.transition.zoomLevel,g.mapContainer.transition.getPointOfCenterInView())
})});jQuery("body").on("click",function(){if(g.zoomDropDownDataContainer._dropped){f()}});var e=this.element.find(".viewFull");if(e.length>0){this.viewFull=e.on("click",function(h){window.location.href=Travian.Helpers.substitute(g.viewFullScreenUrl,Object.assign({},g.mapContainer.transition.getPointOfCenterInView(),{zoom:g.mapContainer.transition.zoomLevel}))})}e=this.element.find(".iconButton.viewNormal");if(e.length>0){this.viewNormal=this.element.find(".iconButton.viewNormal").on("click",function(h){window.location.href=Travian.Helpers.substitute(g.viewNormalUrl,Object.assign({},g.mapContainer.transition.getPointOfCenterInView(),{zoom:g.mapContainer.transition.zoomLevel}))})}this.filterPlayer=this.element.find(".iconButton.filterMy").on("click",function(h){Travian.api("ajax/mapSetting",{data:{data:{type:"outline",outline:"user"}},success:function(j){g.filterPlayer[j.result?"addClass":"removeClass"]("checked");g.filterPlayer.checked=j.result;g.mapContainer.forceUpdateBlocksLayer("imageMark");
g.mapContainer.forceUpdateBlocksSymbols("player",j.result)}})});this.filterPlayer.checked=this.filterPlayer.hasClass("checked");this.filterAlliance=this.element.find(".iconButton.filterAlliance");if(!this.filterAlliance.hasClass("disabled")){this.filterAlliance.on("click",function(h){Travian.api("ajax/mapSetting",{data:{data:{type:"outline",outline:"alliance"}},success:function(j){g.filterAlliance[j.result?"addClass":"removeClass"]("checked");g.filterAlliance.checked=j.result;g.mapContainer.forceUpdateBlocksLayer("imageMark");g.mapContainer.forceUpdateBlocksSymbols("alliance",j.result)}})});this.filterAlliance.checked=this.filterAlliance.hasClass("checked")}e=this.element.find(".iconButton.linkCropfinder");if(e.length>0&&!(e.parent().hasClass("iconRequireGold"))){e.on("click",function(h){window.location.href="/cropfinder.php"})}this.coordinateEnter=jQuery("#mapCoordEnter").on("submit",function(h){var j={x:parseInt(g.coordinateEnter.find("input.coordinates.x").val()),y:parseInt(g.coordinateEnter.find("input.coordinates.y").val())};
if(!isNaN(j.x)&&!isNaN(j.y)){g.mapContainer.moveTo(j)}h.stopPropagation();return false});jQuery(document).on("toolbar.updateCoordinates",function(j,h){var k=jQuery("#mapCoordEnter");k.find("input.coordinates.x").val(h.x);k.find("input.coordinates.y").val(h.y)});this.update()};this.update=function(){var d=this;if(this.transition.zoomLevel===1){this.zoomIn.addClass("disabled");this.zoomOut.removeClass("disabled")}else{if(this.transition.zoomLevel===this.transition.zoomOptions.sizes.length){this.zoomIn.removeClass("disabled");this.zoomOut.addClass("disabled")}else{this.zoomIn.removeClass("disabled");this.zoomOut.removeClass("disabled")}}this.zoomDropDownEntries.each(function(e,g){var f=jQuery(g);if(d.zoomDropDownDataContainer._dropped){f.removeClass("selected")}else{f.addClass("hide").removeClass("display")}});jQuery(this.zoomDropDownEntries[this.transition.zoomLevel-1]).removeClass("hide").addClass(this.zoomDropDownDataContainer._dropped?"selected":"display")};this.zoom=function(){this.update()
};Travian.Game.Map.Base.call(this,b,c)};Travian.Game.Map.Toolbar.prototype=Object.create(Travian.Game.Map.Base.prototype);Travian.Game.Map.Toolbar.constructor=Travian.Game.Map.Toolbar;Travian.Game.Map.Outline=(function(){var b=function(c,d){this.classType="Travian.Game.Map.Outline";this.expanded=false;this.animate=function(){var e=this;this.element.stop(true);if(this.expanded===false){this.expanded=true;this.elements.tabContainer.show();Travian.Game.Preferences.set("outline-expanded",true);this.elements.headlineExpander.removeClass("expand").addClass("collapse");this.element.animate({height:this.element._height.max},200,function(){for(var f in e.parentContainer.mapMarks){if(e.parentContainer.mapMarks.hasOwnProperty(f)){e.parentContainer.mapMarks[f].update(false)}}})}else{this.expanded=false;Travian.Game.Preferences.set("outline-expanded",false);this.elements.headlineExpander.removeClass("collapse").addClass("expand");this.element.animate({height:this.element._height.min},200,function(){e.elements.tabContainer.hide()
})}return this};this.render=function(e){var f=this;this.element=jQuery(this.element);this.elements={headline:this.element.find(".headline"),headlineExpander:this.element.find(".headline").find(".iconButton"),tabContainer:this.element.find(".tabContainer"),mapMarks:this.element.find("#mapMarks"),background:this.element.find(".background")};this.expanded=!!Travian.Game.Preferences.get("outline-expanded");this.elements.headlineExpander.addClass(this.expanded?"expand":"collapse");var g=function(){f.element._height={max:f.parentContainer.containerViewSize.height-parseInt(f.element.css("bottom"))-f.parentContainer.miniMap.elements.container.height()-2,min:f.element.height()};f.elements.tabContainer.hide();if(f.expanded===true){f.elements.tabContainer.show();f.element.css({height:f.element._height.max});for(var h in f.parentContainer.mapMarks){if(f.parentContainer.mapMarks.hasOwnProperty(h)){f.parentContainer.mapMarks[h].update(false)}}}f.elements.headlineExpander.on("click",function(j){f.animate()
})};g();return this};this.update=function(e){var f=this;this.element._height.max+=e;if(this.expanded){this.element.stop(true);this.element.animate({height:this.element._height.max},200,function(){for(var g in f.parentContainer.mapMarks){if(f.parentContainer.mapMarks.hasOwnProperty(g)){f.parentContainer.mapMarks[g].update(false)}}})}return this};Travian.Game.Map.Base.call(this,c,d);this.render(c)};b.prototype=Object.create(Travian.Game.Map.Base.prototype);b.constructor=b;return b})();Travian.Game.Map.Layer=function(b,c){Travian.Game.Map.Base.call(this,b,c);if(this.position===null&&this.parentContainer!==null){this.position={x:0,y:0,width:Math.ceil(this.parentContainer.element.width()),height:Math.ceil(this.parentContainer.element.height())}}if(this.parentContainer.classType==="Travian.Game.Map.Layer.Block"){this.blockContainer=this.parentContainer}else{if(this.parentContainer.blockContainer){this.blockContainer=this.parentContainer.blockContainer}}if(typeof b.version!=="undefined"){this.setVersion(b.version)
}this.render()};Travian.Game.Map.Layer.prototype=Object.create(Travian.Game.Map.Base.prototype);Travian.Game.Map.Layer.constructor=Travian.Game.Map.Layer;Travian.Game.Map.Layer.prototype.classType="Travian.Game.Map.Layer";Travian.Game.Map.Layer.prototype.parentContainer=null;Travian.Game.Map.Layer.prototype.position=null;Travian.Game.Map.Layer.prototype.render=function(b){Travian.Game.Map.Base.prototype.render.call(this,b);if(this.id!==null){this.element.addClass(this.id)}if(this.position){this.element.css({position:"absolute",left:this.position.x,top:this.position.y,width:this.position.width,height:this.position.height})}if(this.zIndex){this.element.css({zIndex:this.zIndex+1})}if(this.parentContainer&&this.parentContainer.element){this.element.appendTo(this.parentContainer.element)}return this};Travian.Game.Map.Layer.prototype.finishedLoading=function(){return this};Travian.Game.Map.Layer.prototype.forceUpdateContent=function(){return this};Travian.Game.Map.Layer.prototype.getContentForTooltip=function(b){return false
};Travian.Game.Map.Layer.prototype.getRequestData=function(){return false};Travian.Game.Map.Layer.prototype.hide=function(){this.element.hide();return this};Travian.Game.Map.Layer.prototype.refreshContent=function(){return this};Travian.Game.Map.Layer.prototype.setVersion=function(b){return this};Travian.Game.Map.Layer.prototype.show=function(){this.element.show();return this};Travian.Game.Map.Layer.prototype.update=function(){this.element.css({left:this.position.x+"px",top:this.position.y+"px"});return this};Travian.Game.Map.Layer.prototype.updateContent=function(){return this};Travian.Game.Map.Layer.Block=(function(){var h=function(n,m,l){m.position=m.position||l;if(typeof m.text==="undefined"&&typeof m.title==="undefined"){m.text=Travian.Helpers.substitute(n.tooltipHtml,{x:m.position.x,y:m.position.y})}return m};var k=function(p,s){var r=Object.assign({},s);var u=p.transition.getPointOfCenterInView();var o=Object.assign({},p.mapCoordinates);r.x=parseFloat(r.x);r.y=parseFloat(r.y);u.x=parseFloat(u.x);
u.y=parseFloat(u.y);o.x=parseFloat(o.x);o.y=parseFloat(o.y);var n=function(B){return B>0?1:B<0?-1:0};var z={x:(p.transition.border.right-Math.abs(r.x)<p.transition.border.right/2),y:(p.transition.border.top-Math.abs(r.y)<p.transition.border.top/2)};var q={x:(p.transition.border.right-Math.abs(u.x)<p.transition.border.right/2),y:(p.transition.border.top-Math.abs(u.y)<p.transition.border.top/2)};var y={x:(p.transition.border.right-Math.abs(o.x)<p.transition.border.right/2),y:(p.transition.border.top-Math.abs(o.y)<p.transition.border.top/2)};var l=n(r.x);var x=n(u.x);if((z.x||q.x)&&(l+x===0&&l!==x)){r.x+=x*p.transition.border.width}var A=n(r.y);var t=n(u.y);if((z.y||q.y)&&(A+t===0&&A!==t)){r.y+=t*p.transition.border.height}var v=n(o.x);if((y.x||q.x)&&(v+x===0&&v!==x)){o.x+=x*p.transition.border.width}var m=n(o.y);if((y.y||q.y)&&(m+t===0&&m!==t)){o.y+=t*p.transition.border.height}return{x:(r.x-o.x)*p.transition.pixelPerTile.x,y:(p.transition.elementsPerBlock.y-(r.y-o.y)-1)*p.transition.pixelPerTile.y}
};var e=function(q,o){if(!o.type){throw"Missing symbol type for symbol: "+o.dataId}if(o.position){o.x=o.position.x;o.y=o.position.y}var n=q.symbolTypes[o.type];if(!n||!n["class"]||!n.visibleInZoom[q.transition.zoomLevel]){return}if(!q.symbols[o.x]){q.symbols[o.x]={}}if(!q.symbols[o.x][o.y]){q.symbols[o.x][o.y]={}}var p=k(q,{x:o.x,y:o.y});var m=q.symbols[o.x][o.y];var l=g(q,n,m);m[o.dataId]=new n["class"](Object.assign({},n,o,{positionOfTile:{x:p.x,y:p.y},positionInTile:l,position:{x:p.x+l.x,y:p.y+l.y,width:n.sizes[q.transition.zoomLevel].width,height:n.sizes[q.transition.zoomLevel].height},positionDefault:{x:p.x+l.x,y:p.y+l.y,width:n.sizes[q.transition.zoomLevel].width,height:n.sizes[q.transition.zoomLevel].height},symbolSize:{width:n.sizes[q.transition.zoomLevel].width,height:n.sizes[q.transition.zoomLevel].height}}),q)};var f=function(m){d(m);var l=m.dataStore.getDataForArea(Travian.Game.Map.DataStore.TYPE_SYMBOL,m.mapCoordinates,true);l.forEach(function(n){e(m,n)})};var d=function(n){for(var l in n.symbols){if(n.symbols.hasOwnProperty(l)){for(var o in n.symbols[l]){if(n.symbols[l].hasOwnProperty(o)){for(var m in n.symbols[l][o]){if(n.symbols[l][o].hasOwnProperty(m)){n.symbols[l][o][m].destroy()
}}}}}}n.symbols={}};var g=function(q,p,m){var l={x:false,y:false};var n=p.sizes[q.transition.zoomLevel].width;var o=Object.keys(m).reverse().find(function(s){var r=m[s].position.x===m[s].positionDefault.x;r=r&&m[s].position.y===m[s].positionDefault.y;r=r&&m[s].position.width===m[s].positionDefault.width;r=r&&m[s].position.height===m[s].positionDefault.height;return r});if(o){l.x=m[o].positionInTile.x;l.x+=n}if(l.x===false){l.x=0}if(l.x+n>(q.position.width/q.transition.elementsPerBlock.x)){l.x=0;l.y+=p.sizes[q.transition.zoomLevel].height}return l};var j=function(q,l,p){if(typeof p==="undefined"){p={}}if(typeof p.tiles!=="undefined"&&p.tiles.length!==0){for(var m in p.tiles){if(p.tiles.hasOwnProperty(m)){var n=p.tiles[m];n=h(q,n,l);if(n.position.x===l.x&&n.position.y===l.y){p.tile=n}q.dataStore.set({position:n.position,type:Travian.Game.Map.DataStore.TYPE_TOOLTIP,data:n})}}q.dataStore.saveDataToStorage()}if(l.x===q.mapContainer.currentMousePosition.map.x&&l.y===q.mapContainer.currentMousePosition.map.y){q.mapContainer.contextMenu.update();
var o=Object.assign({unescaped:true},q.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,l));Travian.Tip.set(q.mapContainer.containerMover,o);Travian.Tip.show(o)}};var b=function(n,l,m){if(n.mapContainer.currentMousePosition.map.x==null||n.mapContainer.currentMousePosition.map.y==null){return}if(l.x!==n.mapContainer.currentMousePosition.map.x||l.y!==n.mapContainer.currentMousePosition.map.y){return}n.mapContainer.containerMover.setTitle({title:"",text:Travian.Helpers.substitute("{x}|{y}",l)})};var c=function(l,m){this.mapCoordinates=null;this.layers=null;this.symbols={};this.dataStore=null;this.versionCache=null;this.classType="Travian.Game.Map.Layer.Block";this.addSymbol=function(n){e(this,n);return this};this.deleteSymbol=function(n){if(!this.symbols||!this.symbols[n.position.x]||!this.symbols[n.position.x][n.position.y]){return this}if(this.symbols[n.position.x][n.position.y][n.dataId]){this.symbols[n.position.x][n.position.y][n.dataId].destroy();delete (this.symbols[n.position.x][n.position.y][n.dataId])
}return this};this.forceUpdateLayer=function(n){if(this.layers[n]){this.layers[n].forceUpdateContent()}return this};this.forceUpdateSymbols=function(p,o){if(this.symbols){for(var n in this.symbols){if(this.symbols.hasOwnProperty(n)){for(var s in this.symbols[n]){if(this.symbols[n].hasOwnProperty(s)){for(var r in this.symbols[n][s]){if(this.symbols[n][s].hasOwnProperty(r)){var q=this.symbols[n][s][r];if(q.layer===p){q.forceUpdate(o)}}}}}}}}return this};this.getContentForTooltip=function(n){var r=this;var o=this.transition.translateToMap(n);if(this.symbols&&this.symbols[o.x]&&this.symbols[o.x][o.y]&&this.symbols[o.x][o.y]!==0){var s=false;var q=(function(t){for(var u in t){if(t.hasOwnProperty(u)){var v=t[u];s=v.getContentForTooltip();if(s!==false&&v.isPositionInRect({x:n.x-r.position.x,y:n.y-r.position.y})){return v}}}})(this.symbols[o.x][o.y]);if(q&&s!==false){return s}}var p=this.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,o);if(p!=null&&(p.text!==undefined||p.title!==undefined)){p={text:p.text,title:p.title}
}else{p={title:"",text:Travian.Translation.translate(this.tooltipHtml,o)};this.requestDataForPosition(o)}return p};this.getData=function(){return Object.assign({loaded:false,version:0},this.dataStore.get(Travian.Game.Map.DataStore.TYPE_BLOCKS,this.mapCoordinates,"block")||{})};this.getRequestData=function(){return{position:{x0:this.mapCoordinates.x,y0:this.mapCoordinates.y,x1:this.mapCoordinates.right,y1:this.mapCoordinates.top}}};this.getVersion=function(){if(this.versionCache==null){this.versionCache=this.getData().version}return this.versionCache};this.invalidateVersionCache=function(){this.versionCache=null;return this};this.move=function(o){if(o.x===0&&o.y===0){return this}this.position.x+=o.x;this.position.y-=o.y;var n=Travian.Game.Map.Layer.Block.getCorrectPosition(this.position,this.mapContainer);this.position=n.position;this.mapCoordinates=this.transition.translateToMap(this.position);this.update(n.updateInnerContent);return this};this.refreshContent=function(n){if(n){var p=this.getData();
p.loaded=true;this.setData(p)}Travian.Game.Map.Layer.prototype.refreshContent.call(this);for(var o in this.layers){if(this.layers.hasOwnProperty(o)){this.layers[o].refreshContent()}}f(this);return this};this.render=function(n){var s=this;this.layers={};Travian.Game.Map.Layer.prototype.render.call(this,n);this.mapCoordinates=this.transition.registerCallbackOnZoom(function(){s.mapCoordinates=s.transition.translateToMap(s.position);s.update(true)}).translateToMap(this.position);for(var p in this.mapContainer.layers){if(this.mapContainer.layers.hasOwnProperty(p)){var o=this.mapContainer.layers[p];if(!o["class"]){continue}var q=Object.assign({},o,{index:p});this.layers[q.id]=new o["class"](q,this)}}var r=this.getData();r.loaded=true;this.setData(r);f(this);return this};this.requestDataForPosition=function(n){var o=this;this.updater.requestPosition({dataStoreType:Travian.Game.Map.DataStore.TYPE_TOOLTIP,position:n,onSuccess:function(q,p){j(o,n,q)},onError:function(q,p){b(o,n,q)}});return this};
this.setData=function(n){this.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_BLOCKS,position:this.mapCoordinates,index:"block",data:Object.assign({loaded:false,version:0},n)});return this};this.setVersion=function(n){var o=this.getData();o.version=n;return this.setData(o)};this.update=function(n){Travian.Game.Map.Layer.prototype.update.call(this);this.updateContent(n);return this};this.updateContent=function(n){Travian.Game.Map.Layer.prototype.updateContent.call(this);for(var o in this.layers){if(this.layers.hasOwnProperty(o)){this.layers[o].updateContent(n)}}if(n){d(this);if(this.getData.loaded){this.refreshContent(false)}else{this.updater.register("ajax",this)}}return this};this.updateSymbolData=function(n){if(!this.symbols||!this.symbols[n.position.x]||!this.symbols[n.position.x][n.position.y]){return this}if(this.symbols[n.position.x][n.position.y][n.dataId]){this.symbols[n.position.x][n.position.y][n.dataId].updateData(n)}return this};Travian.Game.Map.Layer.call(this,l,m)};c.prototype=Object.create(Travian.Game.Map.Layer.prototype);
c.constructor=c;return c})();Travian.Game.Map.Layer.Block.getCorrectPosition=function(c,d){var b={position:c,updateInnerContent:false,updateBlockPosition:false};do{b.updateBlockPosition=false;if(b.position.x<0&&Math.abs(b.position.x)>=d.blockSize.width){b.position.x=d.elementSize.width+b.position.x;b.updateInnerContent=true;b.updateBlockPosition=true}else{if(b.position.x+b.position.width>d.elementSize.width){b.position.x=b.position.x-d.elementSize.width;b.updateInnerContent=true;b.updateBlockPosition=true}}if(b.position.y<0&&Math.abs(b.position.y)>=d.blockSize.height){b.position.y=d.elementSize.height+b.position.y;b.updateInnerContent=true;b.updateBlockPosition=true}else{if(b.position.y+b.position.height>d.elementSize.height){b.position.y=b.position.y-d.elementSize.height;b.updateInnerContent=true;b.updateBlockPosition=true}}}while(b.updateBlockPosition);return b};Travian.Game.Map.Layer.Image=function(b,c){this.image=null;this.srcUrl=null;this.getPriority=function(){var f={x:this.blockContainer.mapCoordinates.x+(this.blockContainer.mapCoordinates.right-this.blockContainer.mapCoordinates.x)/2,y:this.blockContainer.mapCoordinates.y+(this.blockContainer.mapCoordinates.top-this.blockContainer.mapCoordinates.y)/2};
var d=this.transition.getPointOfCenterInView();var e={x:d.x-f.x,y:d.y-f.y};return Math.pow(e.x,2)+Math.pow(e.y,2)};this.getSrcUrl=function(){return Travian.Helpers.substitute(this.src,{x:this.parentContainer.mapCoordinates.x,y:this.parentContainer.mapCoordinates.y,right:this.parentContainer.mapCoordinates.right,top:this.parentContainer.mapCoordinates.top})};this.refreshSrcUrl=function(){this.srcUrl=this.getSrcUrl();return this};this.render=function(d){Travian.Game.Map.Layer.prototype.render.call(this,{nodeType:'<img src="'+this.srcInit+'">'});this.time=(new Date()).getTime();this.updateContent();return this};Travian.Game.Map.Layer.call(this,b,c)};Travian.Game.Map.Layer.Image.prototype=Object.create(Travian.Game.Map.Layer.prototype);Travian.Game.Map.Layer.Image.constructor=Travian.Game.Map.Layer.Image;Travian.Game.Map.Layer.Image.prototype.classType="Travian.Game.Map.Layer.Image";Travian.Game.Map.Layer.Image.prototype.updateContent=function(b){var c=this.getSrcUrl();if(this.srcUrl!==c||b){this.refreshSrcUrl();
this.updater.register("images",this)}return this};Travian.Game.Map.Layer.ImageMark=function(b,c){this.classType="Travian.Game.Map.Layer.ImageMark";this.finishedLoading=function(){Travian.Game.Map.Layer.Image.prototype.finishedLoading.call(this);this.show();return this};this.forceUpdateContent=function(){this.time=(new Date()).getTime();this.updateContent(true);return this};this.updateContent=function(d){Travian.Game.Map.Layer.Image.prototype.updateContent.call(this,d);if(d){this.hide()}return this};Travian.Game.Map.Layer.Image.call(this,b,c)};Travian.Game.Map.Layer.ImageMark.prototype=Object.create(Travian.Game.Map.Layer.Image.prototype);Travian.Game.Map.Layer.ImageMark.constructor=Travian.Game.Map.Layer.Image;Travian.Game.Map.Layer.Loading=function(b,c){this.classType="Travian.Game.Map.Layer.Loading";this.render=function(d){Travian.Game.Map.Layer.prototype.render.call(this,d);this.element.css(this.styles).hide();return this};this.updateContent=function(d){return this};Travian.Game.Map.Layer.call(this,b,c)
};Travian.Game.Map.Layer.Loading.prototype=Object.create(Travian.Game.Map.Layer.prototype);Travian.Game.Map.Layer.Loading.constructor=Travian.Game.Map.Layer;Travian.Game.Map.Layer.Symbol=function(b,c){this.byUser=false;this.visible=true;this.destroy=function(){if(this.element){this.element.remove()}return this};this.forceUpdate=function(d){if(this.byUser){this.visible=d;this.element[d?"show":"hide"]()}return this};b.mapCoordinates=b.mapCoordinates||c.transition.translateToMap({x:b.position.x+c.position.x,y:b.position.y+c.position.y});b.id=b.id||Travian.Game.Map.getNewId();b.parameters=b.parameters||{};Travian.Game.Map.mapIds[b.dataId]=b.id;Travian.Game.Map.Layer.call(this,b,c)};Travian.Game.Map.Layer.Symbol.prototype=Object.create(Travian.Game.Map.Layer.prototype);Travian.Game.Map.Layer.constructor=Travian.Game.Map.Layer;Travian.Game.Map.Layer.Symbol.prototype.classType="Travian.Game.Map.Layer.Symbol";Travian.Game.Map.Layer.Symbol.prototype.updateData=function(b){this.title=b.title;this.text=b.text
};Travian.Game.Map.Layer.Symbol.prototype.getContentForTooltip=function(){if(this.visible&&(this.title||this.text)){return{title:this.title,text:this.text}}return false};Travian.Game.Map.Layer.Symbol.prototype.render=function(b){Travian.Game.Map.Layer.prototype.render.call(this,{nodeType:"<img/>"},b);this.element.attr("src",Travian.Helpers.substitute(this.imgSource,Object.assign({},this.parameters,{width:this.symbolSize.width,height:this.symbolSize.height,zoomLevel:this.transition.zoomLevel}))).css({position:"absolute",left:this.position.x,top:this.position.y,width:this.position.width,height:this.position.height});return this};Travian.Game.Map.Layer.Symbol.Flag=function(b,c){this.classType="Travian.Game.Map.Layer.Symbol.Flag";this.index=null;this.render=function(e){this.parameters.index=this.index||1;Travian.Game.Map.Layer.Symbol.prototype.render.call(this,e);var d=Travian.Game.Map.Options.Toolbar;var f=this.layer==="alliance"?"filterAlliance":"filterPlayer";if(this.mapContainer.toolbar){d=this.mapContainer.toolbar
}this.forceUpdate(d[f].checked);return this};this.updateData=function(d){Travian.Game.Map.Layer.Symbol.prototype.updateData.call(this,d);this.parameters.index=this.index=d.index;this.element.attr("src",Travian.Helpers.substitute(this.imgSource,Object.assign({},this.parameters,{zoomLevel:this.transition.zoomLevel,width:this.symbolSize.width,height:this.symbolSize.height})))};Travian.Game.Map.Layer.Symbol.call(this,b,c)};Travian.Game.Map.Layer.Symbol.Flag.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype);Travian.Game.Map.Layer.Symbol.constructor=Travian.Game.Map.Layer.Symbol;Travian.Game.Map.Layer.Symbol.Attack=function(b,c){this.classType="Travian.Game.Map.Layer.Symbol.Attack";Travian.Game.Map.Layer.Symbol.call(this,b,c)};Travian.Game.Map.Layer.Symbol.Attack.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype);Travian.Game.Map.Layer.Symbol.Attack.constructor=Travian.Game.Map.Layer.Symbol;Travian.Game.Map.Layer.Symbol.BattleGround=function(b,c){this.classType="Travian.Game.Map.Layer.Symbol.BattleGround";
this.getContentForTooltip=function(){return false};this.render=function(d){this.position={x:this.positionOfTile.x,y:this.positionOfTile.y,width:this.transition.pixelPerTile.x,height:this.transition.pixelPerTile.y};Travian.Game.Map.Layer.Symbol.prototype.render.call(this,d);return this};Travian.Game.Map.Layer.Symbol.call(this,b,c)};Travian.Game.Map.Layer.Symbol.BattleGround.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype);Travian.Game.Map.Layer.Symbol.BattleGround.constructor=Travian.Game.Map.Layer.Symbol.BattleGround;Travian.Game.Map.Layer.Symbol.Adventure=function(b,c){this.classType="Travian.Game.Map.Layer.Symbol.Adventure";this.render=function(d){this.position={x:this.positionOfTile.x+this.transition.pixelPerTile.x-this.position.width,y:this.positionOfTile.y+this.transition.pixelPerTile.y-this.position.height,width:this.position.width,height:this.position.height};Travian.Game.Map.Layer.Symbol.prototype.render.call(this,d);return this};Travian.Game.Map.Layer.Symbol.call(this,b,c)
};Travian.Game.Map.Layer.Symbol.Adventure.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype);Travian.Game.Map.Layer.Symbol.Adventure.constructor=Travian.Game.Map.Layer.Symbol.Adventure;Travian.Game.Map.Layer.Symbol.Reinforcement=function(b,c){this.classType="Travian.Game.Map.Layer.Symbol.Reinforcement";this.render=function(d){this.position={x:this.positionOfTile.x,y:this.positionOfTile.y+this.transition.pixelPerTile.y-this.position.height,width:this.position.width,height:this.position.height};Travian.Game.Map.Layer.Symbol.prototype.render.call(this,d);return this};Travian.Game.Map.Layer.Symbol.call(this,b,c)};Travian.Game.Map.Layer.Symbol.Reinforcement.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype);Travian.Game.Map.Layer.Symbol.Reinforcement.constructor=Travian.Game.Map.Layer.Symbol.Reinforcement;Travian.Game.Map.MapMark=function(b,c){this.classType="Travian.Game.Map.MapMark";this.render=function(){this.element=jQuery(this.element);for(var f in this.layers){if(this.layers.hasOwnProperty(f)){var e=this.layers[f];
this.layers[f]=new e["class"](e,this)}}this.update();for(var d=0;d<this.data.length;d++){var g=this.data[d];if(!g.layer||!this.layers[g.layer]){continue}this.layers[g.layer].addData(g)}return this};this.update=function(){var h=[];var g=this.element.height();for(var f in this.layers){if(this.layers.hasOwnProperty(f)){var e=this.layers[f];h.push({data:e.elements.data,expandContainer:e.elements.expandContainer,expanded:e.expanded});g-=e.element.outerHeight()-e.elements.expandContainer.outerHeight()}}for(var d=0;d<h.length;d++){var j=h[d];j.data.parent().css({height:g});j.expandContainer.css({height:j.expanded?g:0})}};Travian.Game.Map.Base.call(this,b,c);this.render()};Travian.Game.Map.MapMark.prototype=Object.create(Travian.Game.Map.Base.prototype);Travian.Game.Map.MapMark.constructor=Travian.Game.Map.MapMark;Travian.Game.Map.MapMark.Layer=function(c,d){Travian.Game.Map.Base.call(this,c,d);var b=Travian.Game.Preferences.get("markLayer-"+this.parentContainer.typeId+"-"+this.typeId+"-expanded");
if(b!=null){this.expanded=b}this.datas={};this.render()};Travian.Game.Map.MapMark.Layer.prototype=Object.create(Travian.Game.Map.Base.prototype);Travian.Game.Map.MapMark.Layer.constructor=Travian.Game.Map.MapMark.Layer;Travian.Game.Map.MapMark.Layer.prototype.classType="Travian.Game.Map.MapMark.Layer";Travian.Game.Map.MapMark.Layer.prototype.addData=function(b){return this};Travian.Game.Map.MapMark.Layer.prototype.deleteData=function(b){if(this.datas[b.id]){delete (this.datas[b.id])}return this};Travian.Game.Map.MapMark.Layer.prototype.render=function(b){var c=this;this.element=jQuery("<div></div>").addClass("collapseContainer").html(Travian.Helpers.substitute(this.html,Object.assign({},b||{},{data:"scroll-dataContainer",add:"addButton",expandButton:"expandButton",expandContainer:"expandContainer",title:this.title}))).appendTo(this.parentContainer.element);this.elements={data:this.element.find(".scroll-dataContainer"),title:this.element.find(".title"),add:this.element.find(".addButton"),expandButton:this.element.find(".expandButton"),expandContainer:this.element.find(".expandContainer")};
if(!this.editable&&this.elements.add){this.elements.add.hide()}if(this.elements.expandButton){this.elements.expandButton.addClass(this.expanded?"collapse":"expand");this.elements.expandButton.on("click",function(g){if(!c.expanded){for(var f in c.parentContainer.layers){if(c.parentContainer.layers.hasOwnProperty(f)){var d=c.parentContainer.layers[f];d.expanded=false;d.elements.expandButton.removeClass("collapse").addClass("expand");Travian.Game.Preferences.set("markLayer-"+d.parentContainer.typeId+"-"+d.typeId+"-expanded",d.expanded)}}c.expanded=true;c.elements.expandButton.removeClass("expand").addClass("collapse");Travian.Game.Preferences.set("markLayer-"+c.parentContainer.typeId+"-"+c.typeId+"-expanded",true)}c.parentContainer.update()})}return this};Travian.Game.Map.MapMark.Layer.Mark=function(b,d){this.classType="Travian.Game.Map.MapMark.Layer.Mark";this.dialogInstance=null;this.addData=function(e){var f=new Travian.Game.Map.MapMark.Layer.Data.Mark(Object.assign({},e,this.optionsData,{editable:this.editable}),this);
this.datas[f.id]=f;return this};this.add=function(e){var f=this;if(!this.editable){return this}Travian.api("ajax/mapMultiMarkAdd",{data:{data:{x:e.position.x,y:e.position.y,type:this.typeId,color:e.color||0,owner:this.parentContainer.typeId,text:e.text||undefined,title:e.title||undefined}},success:function(g){f.addData(g);f.mapContainer.forceUpdateBlocksLayer("imageMark");f.dialogInstance.close();f.dialogInstance=null},error:function(g){f.dialogInstance.enableForm().toElement().find(".errorMessage").html(g.errorMsg);return false}});return this};this.render=function(e){var f=this;Travian.Game.Map.MapMark.Layer.prototype.render.call(this,e);this.elements.add.on("click",function(g){f.showDialog()});return this};this.showDialog=function(e){var g=this;e=Object.assign({color:this.color,onOkay:this.add.bind(this),onOpen:Travian.emptyFunction,position:{x:"",y:""}},e||{});this.color=e.color;var f=Travian.Helpers.substitute(this.dialog.html,{select:"select",textX:this.dialog.textX,textY:this.dialog.textY,textDisplay:"textDisplay",coord:"coord",inputX:"inputX",inputY:"inputY"});
this.dialogInstance=new Travian.Dialog.Dialog({keepOpen:true,relativeTo:this.mapContainer.container,elementFocus:e.position.x===""?this.dialog.elementFocusNew:this.dialog.elementFocusEdit,buttonTextOk:this.dialog.textOkay,title:this.dialog.title,preventFormSubmit:true,onOpen:function(j,k){k.find("input.inputX").val(e.position.x);k.find("input.inputY").val(e.position.y);var h=new Travian.Game.ColorPicker(k.find(".select"),{colors:g.colorsArray,defaultColor:g.color,onChange:function(l,m){g.colorsArray.map(function(n,o){if(n===l){g.color=o}})}});e.onOpen(j,k,h)},onOkay:function(h,j){e.onOkay({color:g.color,position:{x:j.find("input.inputX").val(),y:j.find("input.inputY").val()}},h,j)}});this.dialogInstance.setContent(f);this.dialogInstance.show();return this};Travian.Game.Map.MapMark.Layer.call(this,b,d);this.colorsArray=[];for(var c in this.colors){if(this.colors.hasOwnProperty(c)&&typeof this.colors[c]==="string"){this.colorsArray.push(this.colors[c])}}};Travian.Game.Map.MapMark.Layer.Mark.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype);
Travian.Game.Map.MapMark.Layer.Mark.constructor=Travian.Game.Map.MapMark.Layer;Travian.Game.Map.MapMark.Layer.Flag=function(b,d){this.classType="Travian.Game.Map.MapMark.Layer.Flag";this.dialogInstance=null;this.add=function(e){var f=this;if(!this.editable){return this}if(e.index<this.indexes.min){e.index=this.indexes.max}if(e.index>this.indexes.max){e.index=this.indexes.min}Travian.api("ajax/mapFlagAdd",{data:{data:{x:e.position.x,y:e.position.y,color:e.index||this.indexes.min,owner:this.parentContainer.typeId,text:e.text||undefined,title:e.title||undefined}},success:function(g){g.type="flag";f.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,index:g.dataId,position:g.position,data:g,time:false});f.addData(g);g.position=e.position;g.layer=f.parentContainer.typeId;f.mapContainer.addSymbol(g);f.dialogInstance.close();f.dialogInstance=null},error:function(g){f.dialogInstance.enableForm().toElement().find(".errorMessage").html(g.errorMsg);return false}});return this};this.addData=function(f){var e=new Travian.Game.Map.MapMark.Layer.Data.Flag(Object.assign({},f,this.optionsData,{editable:this.editable}),this);
this.datas[e.id]=e;return this};this.render=function(e){Travian.Game.Map.MapMark.Layer.prototype.render.call(this,e);var f=this;this.elements.add.on("click",function(g){f.showDialog(e)});return this};this.showDialog=function(e){var g=this;e=Object.assign({index:this.index,onOkay:this.add.bind(this),onOpen:Travian.emptyFunction,text:"",position:{x:"",y:""}},e||{});this.index=e.index;var f=Travian.Helpers.substitute(this.dialog.html,{select:"select",textX:this.dialog.textX,textY:this.dialog.textY,textDisplay:"textDisplay",coord:"coord",inputX:"inputX",inputY:"inputY",inputText:"inputText"});this.dialogInstance=new Travian.Dialog.Dialog({keepOpen:true,relativeTo:this.mapContainer.container,elementFocus:e.position.x===""?this.dialog.elementFocusNew:this.dialog.elementFocusEdit,buttonTextOk:this.dialog.textOkay,title:this.dialog.title,preventFormSubmit:true,onOpen:function(j,k){k.find("input.inputX").val(e.position.x);k.find("input.inputY").val(e.position.y);k.find("input.inputText").val(e.text);
var h=new Travian.Game.ImagePicker(k.find(".select"),{images:g.imagesArray,defaultImage:g.index-g.indexes.min,onChange:function(l){g.imagesArray.map(function(n,m){if(n===l){g.index=m+1}})}});e.onOpen(j,k,h)},onOkay:function(h,j){if(g.index<g.indexes.min){g.index+=g.indexes.min-1}e.onOkay({index:g.index,text:j.find("input.inputText").val(),position:{x:j.find("input.inputX").val(),y:j.find("input.inputY").val()}},h,j)}});this.dialogInstance.setContent(f);this.dialogInstance.show();return this};Travian.Game.Map.MapMark.Layer.call(this,b,d);this.imagesArray=[];for(var c=this.indexes.min;c<=this.indexes.max;c++){this.imagesArray.push(Travian.Helpers.substitute(this.imgSource,{index:c}))}};Travian.Game.Map.MapMark.Layer.Flag.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype);Travian.Game.Map.MapMark.Layer.Flag.constructor=Travian.Game.Map.MapMark.Layer;Travian.Game.Map.MapMark.Layer.Data=function(b,c){Travian.Game.Map.MapMark.Layer.call(this,b,c)};Travian.Game.Map.MapMark.Layer.Data.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype);
Travian.Game.Map.MapMark.Layer.Data.constructor=Travian.Game.Map.MapMark.Layer;Travian.Game.Map.MapMark.Layer.Data.prototype.classType="Travian.Game.Map.MapMark.Layer.Data";Travian.Game.Map.MapMark.Layer.Data.prototype.del=function(){this.destroy();this.parentContainer.deleteData(this);return this};Travian.Game.Map.MapMark.Layer.Data.prototype.render=function(b){var c=this;this.element=jQuery("<div></div>").html(Travian.Helpers.substitute(this.html,Object.assign({},b||{},{entry:this.id,text:"textContainer","delete":"deleteButton",select:"selectLink",editDelete:"editDeleteContainer"}))).appendTo(this.parentContainer.elements.data);this.elements={text:this.element.find(".textContainer"),"delete":this.element.find(".deleteButton"),select:this.element.find(".selectLink"),editDelete:this.element.find(".editDeleteContainer")};this.elements["delete"].on("click",function(d){c.del()});this.elements.text.html(this.text);if(!this.editable&&this.elements.editDelete){this.elements.editDelete.hide()}return this
};Travian.Game.Map.MapMark.Layer.Data.Mark=(function(){var b=function(d){d.elements.color.css({backgroundColor:d.parentContainer.colors[d.color]})};var c=function(d,e){this.classType="Travian.Game.Map.MapMark.Layer.Data.Mark";this.del=function(){var f=this;if(!this.editable){return this}Travian.api("ajax/mapFlagOrMultiMarkDelete",{data:{data:{dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId,type:"mark"}},success:function(g){if(g.result){f.destroy();f.mapContainer.forceUpdateBlocksLayer("imageMark")}}});return this};this.render=function(f){var g=this;Travian.Game.Map.MapMark.Layer.Data.prototype.render.call(this,{color:"colorContainer",urlLink:"urlLink"});this.elements.color=this.element.find(".colorContainer");this.elements.urlLink=this.element.find(".urlLink");if(this.elements.urlLink){this.elements.urlLink.href=Travian.Helpers.substitute(this.urlLink,{markId:this.markId})}if(this.editable){this.elements.select.on("click",function(h){g.parentContainer.showDialog({color:g.color,onOpen:function(k,l,j){l.find(".coord").each(function(m,n){jQuery(n).hide()
});l.find(".textDisplay").show().html(g.text)},onOkay:function(j,k,l){g.setColor(j.color)}})})}this.elements.urlLink.on("click",function(h){if(g.elements.urlLink){window.location.href=g.elements.urlLink.href}});b(this);return this};this.setColor=function(f){var g=this;if(!this.editable){return this}if(typeof f!=="number"){return this}if(f<this.parentContainer.colors.min){f=this.parentContainer.colors.max}if(f>this.parentContainer.colors.max){f=this.parentContainer.colors.min}Travian.api("ajax/mapMultiMarkUpdate",{data:{data:{color:f,dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId}},success:function(h){if(h){g.color=f;b(g);g.mapContainer.forceUpdateBlocksLayer("imageMark")}g.parentContainer.dialogInstance.close();g.parentContainer.dialogInstance=null},error:function(h){g.parentContainer.dialogInstance.enableForm().toElement().find(".errorMessage").html(h.errorMsg);return false}});return this};d.color=Number(d.color);Travian.Game.Map.MapMark.Layer.Data.call(this,d,e)};
c.prototype=Object.create(Travian.Game.Map.MapMark.Layer.Data.prototype);c.constructor=c;return c})();Travian.Game.Map.MapMark.Layer.Data.Flag=(function(){var b=function(d){d.elements.text.html(d.text);d.elements.index.html('<img src="'+Travian.Helpers.substitute(d.parentContainer.imgSource,{index:d.index})+'" alt="" />')};var c=function(d,e){this.classType="Travian.Game.Map.MapMark.Layer.Data.Flag";this.del=function(){var f=this;if(!this.editable){return this}Travian.api("ajax/mapFlagOrMultiMarkDelete",{data:{data:{dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId,type:"flag"}},success:function(g){if(g.result){f.destroy();f.dataStore.remove(Travian.Game.Map.DataStore.TYPE_SYMBOL,{x:f.x,y:f.y},f.dataId);f.mapContainer.deleteSymbol({position:{x:f.x,y:f.y},dataId:f.dataId})}}});return this};this.render=function(f){var g=this;Travian.Game.Map.MapMark.Layer.Data.prototype.render.call(this,{index:"indexContainer",urlLink:"urlLink"});this.elements.index=this.element.find(".indexContainer");
this.elements.urlLink=this.element.find(".urlLink");if(this.editable){this.elements.select.on("click",function(h){g.parentContainer.showDialog({index:g.index,text:g.text,position:{x:g.x,y:g.y},onOpen:function(k,l,j){g.dialogInstance=k;l.find("input.inputX").prop("disabled",true);l.find("input.inputY").prop("disabled",true)},onOkay:function(j,k,l){g.setIndex(j.index,j.text)}})})}this.elements.urlLink.on("click",function(h){if(g.mapContainer.isEventsEnabled()){g.mapContainer.moveTo({x:g.x,y:g.y})}});b(this);return this};this.setIndex=function(f,h){var g=this;if(!this.editable){return this}if(typeof f!=="number"){return this}if(f<this.parentContainer.indexes.min){f=this.parentContainer.indexes.max}if(f>this.parentContainer.indexes.max){f=this.parentContainer.indexes.min}Travian.api("ajax/mapFlagUpdate",{data:{data:{index:f,text:h,dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId}},success:function(j){if(j){g.index=f;g.text=h;b(g);var k=g.dataStore.get(Travian.Game.Map.DataStore.TYPE_SYMBOL,{x:g.x,y:g.y},g.dataId);
k.index=g.index;k.text=g.text;g.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,position:{x:g.x,y:g.y},index:g.dataId,data:k,time:false});g.mapContainer.updateSymbolData({position:{x:g.x,y:g.y},dataId:g.dataId,index:g.index,text:g.text})}g.dialogInstance.close();g.dialogInstance=null},error:function(j){g.parentContainer.dialogInstance.enableForm().toElement().down(".errorMessage").html(j.errorMsg);return false}});return this};d.index=Number(d.index);Travian.Game.Map.MapMark.Layer.Data.call(this,d,e)};c.prototype=Object.create(Travian.Game.Map.MapMark.Layer.Data.prototype);c.constructor=c;return c})();Travian.Game.Map.Options={};Travian.Game.Map.Options.Symbols={flag:{"class":Travian.Game.Map.Layer.Symbol.Flag,imgSource:"img/terrain/map/flag/flag-{index}/{width}x{height}.png",byUser:true,zIndex:10,visibleInZoom:{1:true,2:true,3:false,4:false},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}},attack:{"class":Travian.Game.Map.Layer.Symbol.Attack,imgSource:"img/terrain/map/attack/attack-{attackType}/{width}x{height}.gif",zIndex:10,visibleInZoom:{1:true,2:true,3:false,4:false},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}},battleGround:{"class":Travian.Game.Map.Layer.Symbol.BattleGround,imgSource:"img/terrain/map/battleground/battleground-{center}-{north}-{east}-{south}-{west}-{width}x{height}.png",zIndex:9,visibleInZoom:{1:true,2:true,3:false,4:false},sizes:{1:{width:16,height:16},2:{width:8,height:8},3:{width:4,height:4},4:{width:4,height:4}}},adventure:{"class":Travian.Game.Map.Layer.Symbol.Adventure,imgSource:"img/terrain/map/adventure/difficulty-{difficulty}/{width}x{height}.png",zIndex:10,visibleInZoom:{1:true,2:true,3:false,4:false},sizes:{1:{width:16,height:16},2:{width:8,height:8},3:{width:6,height:6},4:{width:4,height:4}}},reinforcement:{"class":Travian.Game.Map.Layer.Symbol.Reinforcement,imgSource:"img/terrain/map/reinforcement/{width}x{height}.gif",zIndex:10,visibleInZoom:{1:true,2:true,3:false,4:false},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}}};
Travian.Game.Map.Options.Rulers={direction:null,imgSource:{x:"img/terrain/map/rulers/x-{zoomLevel}.gif",y:"img/terrain/map/rulers/y-{zoomLevel}.gif"},cls:{x:"ruler x",y:"ruler y"},steps:{x:{1:1,2:1,3:10,4:20},y:{1:1,2:1,3:10,4:20}},delta:{x:{1:0,2:0,3:0,4:0},y:{1:0,2:0,3:-9,4:-19}}};Travian.Game.Map.Options.MiniMap={container:"#miniMap",containerContent:"#minimapContainer",showToolTip:true,classLines:{x:"lines",y:"lines"},tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>'};Travian.Game.Map.Options.Toolbar={element:"#toolbar",viewFullScreenUrl:"/karte.php?fullscreen=1&x={x}&y={y}&zoom={zoom}",viewNormalUrl:"/karte.php?x={x}&y={y}&zoom={zoom}",filterPlayer:{checked:true},filterAlliance:{checked:true}};Travian.Game.Map.Options.Outline={element:"#outline"};Travian.Game.Map.Options.MapMark=Travian.Game.Map.Options.MapMark||{};Travian.Game.Map.Options.MapMark.Mark={"class":Travian.Game.Map.MapMark.Layer.Mark,title:"",typeId:"player",editable:true,expanded:false,color:0,colors:{0:"#C0C0C0",1:"#FF7722",2:"#B15BDB",3:"#DF4E78",4:"#34822F",5:"#3F90C5",6:"#C2AF09",7:"#8B1C1C",8:"#575BD2",9:"#4FE600",min:0,max:9},html:'<div class="title">{title} <a href="#" class="add {add}">+</a></div><div class="iconButton {expandButton} small"></div><div class="clear"></div><div class="{expandContainer}"><div class="{data}"></div></div>',dialog:{title:"",textOkay:"okay",textCancel:"cancel",textX:"X:",textY:"Y:",elementFocusNew:"#coordinateDialogX",elementFocusEdit:"#coordinateDialogX",html:'<div class="mapMarkMark"><div class="color {select}"></div><div class="{coord}"><span>{textX}</span><input id="coordinateDialogX" class="text coordinates x {inputX}" type="text" /><span>{textY}</span><input class="text coordinates y {inputY}" type="text" /></div><div class="{textDisplay}"></div></div>'},optionsData:{urlLink:"/profile/{markId}",html:'<div class="entry flag {entry}"><div class="marker color"><a href="#" class="{select} {color}"></a></div><div class="text"><a href="#" class="{urlLink} {text}"></a></div><div class="iconButton delete small {editDelete} {delete}"></div><div class="clear"></div></div>'}};
Travian.Game.Map.Options.MapMark=Travian.Game.Map.Options.MapMark||{};Travian.Game.Map.Options.MapMark.Flag={"class":Travian.Game.Map.MapMark.Layer.Flag,title:"",editable:true,expanded:true,typeId:"flag",index:1,indexes:{min:1,max:20},imgSource:Travian.Helpers.substitute(Travian.Game.Map.Options.Symbols.flag.imgSource,{index:"{index}",zoomLevel:1,width:16,height:16}),html:'<div class="title">{title} <a href="#" class="add {add}">+</a></div><div class="iconButton {expandButton} small"></div><div class="clear"></div><div class="{expandContainer}"><div class="{data}"></div></div>',dialog:{title:"",textOkay:"okay",textCancel:"cancel",textX:"X:",textY:"Y:",elementFocusNew:"#coordinateDialogX",elementFocusEdit:"#coordinateDialogText",html:'<div class="mapMarkField"><div class="flag {select}"></div><div class="{coord}"><span>{textX}</span><input id="coordinateDialogX" class="text coordinates x {inputX}" type="text" /><span>{textY}</span><input class="text coordinates y {inputY}" type="text" /></div><div class="{textDisplay}"><input id="coordinateDialogText" class="text {inputText}" type="text" /></div><p class="error errorMessage"></p></div>'},optionsData:{html:'<div class="entry flag {entry}"><div class="marker index"><a href="#" class="{select} {index}"></a></div><div class="text"><a href="#" class="{urlLink} {text}"></a></div><div class="iconButton delete small {editDelete} {delete}"></div><div class="clear"></div></div>'}};
Travian.Game.Map.Options.Default={container:"#mapContainer",containerViewSize:null,tileDisplayInformation:{type:"dialog",optionsPopup:{url:"/position_details.php?x={x}&y={y}",windowOptions:{}},optionsDialog:{buttonOk:false,data:{x:null,y:null}}},blockOverflow:1,blockSize:{width:170,height:150},mapInitialPosition:{x:0,y:0},grid:{1:"/img/terrain/map/grid/grid-1.gif",2:"/img/terrain/map/grid/grid-2.gif",3:"/img/terrain/map/grid/grid-3.gif",4:false},speeds:{slow:5,normal:20,fast:40},symbolTypes:Travian.Game.Map.Options.Symbols,onCreate:function(b){},onRender:function(d){Travian.Game.Map.Tips.render(d,d.containerMover);d.rulers=new Travian.Game.Map.Rulers(Travian.Game.Map.Options.Rulers,d);d.rulers.render();d.miniMap=new Travian.Game.Map.MiniMap(Travian.Game.Map.Options.MiniMap,d);d.miniMap.render();if(d.mapMarks){for(var c in d.mapMarks){if(d.mapMarks.hasOwnProperty(c)){var b=d.mapMarks[c];if(b.enabled===true){d.mapMarks[c]=new Travian.Game.Map.MapMark(b,d)}else{delete (d.mapMarks[c])}}}}d.outline=new Travian.Game.Map.Outline(Travian.Game.Map.Options.Outline,d);
d.toolbar=new Travian.Game.Map.Toolbar(Travian.Game.Map.Options.Toolbar,d);d.toolbar.render()},onMove:function(b,c){if(b.rulers){b.rulers.move(c)}if(b.miniMap){b.miniMap.move()}},onZoom:function(b){if(b.rulers){b.rulers.zoom()}if(b.miniMap){b.miniMap.zoom()}if(b.toolbar){b.toolbar.zoom()}}};Travian.Game.Map.Options.Default.contextMenu={targets:"#mapContainer",zIndex:2000,menu:"#contextmenu",actions:[{element:"#contextMenuSendTroops",displayOn:"did",shouldDisplay:function(b){return(typeof b[this.displayOn]!=="undefined")},fn:function(d,c,b){window.location.href="/build.php?gid=16&tt=2&x="+b.position.x+"&y="+b.position.y}},{element:"#contextMenuSendTraders",displayOn:"uid",shouldDisplay:function(b){var d=(typeof b[this.displayOn]!=="undefined");var c=(b.title!=="{k.bt}");return(d&&c)},fn:function(d,c,b){window.location.href="/build.php?gid=17&t=5&x="+b.position.x+"&y="+b.position.y}},{element:"#contextMenuMarkPlayerAlliance",displayOn:"aid",shouldDisplay:function(b){return(typeof b[this.displayOn]!=="undefined")
},fn:function(d,c,b){d.parentContainer.mapMarks.player.layers.alliance.showDialog({position:c})}},{element:"#contextMenuMarkPlayerPlayer",displayOn:"uid",shouldDisplay:function(b){return(typeof b[this.displayOn]!=="undefined")},fn:function(d,c,b){d.parentContainer.mapMarks.player.layers.player.showDialog({position:c})}},{element:"#contextMenuFlagPlayer",displayOn:true,shouldDisplay:function(b){return true},fn:function(d,c,b){d.parentContainer.mapMarks.player.layers.flag.showDialog({position:c})}},{element:"#contextMenuMarkAllianceAlliance",displayOn:"aid",shouldDisplay:function(b){return(typeof b[this.displayOn]!=="undefined")},fn:function(d,c,b){d.parentContainer.mapMarks.alliance.layers.alliance.showDialog({position:c})}},{element:"#contextMenuMarkAlliancePlayer",displayOn:"uid",shouldDisplay:function(b){return(typeof b[this.displayOn]!=="undefined")},fn:function(d,c,b){d.parentContainer.mapMarks.alliance.layers.player.showDialog({position:c})}},{element:"#contextMenuFlagAlliance",displayOn:true,shouldDisplay:function(b){return true
},fn:function(d,c,b){d.parentContainer.mapMarks.alliance.layers.flag.showDialog({position:c})}}]};Travian.Game.Map.Options.Default.transition={onCreate:function(b){},onMove:function(b,c){},onZoom:function(b){},zoomOptions:{level:1,sizes:[{x:10,y:10},{x:20,y:20},{x:100,y:100}]},border:Travian.Defaults.Map.Size};Travian.Game.Map.Options.Default.layers=[{id:"loading",styles:{background:"#000000 url(img/loading.gif) center center no-repeat",opacity:0.5},"class":Travian.Game.Map.Layer.Loading,zIndex:20},{id:"image",src:"/map/block/{x}.{y}.{right}.{top}.png",srcInit:"/img/x.gif","class":Travian.Game.Map.Layer.Image,zIndex:1},{id:"imageMark",src:"/map/mark/{x}.{y}.{right}.{top}.png",srcInit:"/img/x.gif","class":Travian.Game.Map.Layer.ImageMark,zIndex:2}];Travian.Game.Map.Options.Default.block={tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span><br />{k.loadingData}'};Travian.Game.Map.Options.Default.updater={maxRequestCount:5,parameters:{multiple:{},position:{}},requestDelayTime:{multiple:100,position:300},elementWorking:"#working",positionOptions:{areaAroundPosition:{1:{left:-5,bottom:-4,right:5,top:4},2:{left:-10,bottom:-8,right:10,top:8},3:{left:-25,bottom:-25,right:25,top:25},4:{left:-25,bottom:-25,right:25,top:25}}}};
Travian.Game.Map.Options.Default.keyboard={37:"moveLeft",65:"moveLeft",100:"moveLeft",39:"moveRight",68:"moveRight",102:"moveRight",38:"moveUp",87:"moveUp",104:"moveUp",40:"moveDown",83:"moveDown",98:"moveDown",103:"moveLeftUp",97:"moveLeftDown",105:"moveRightUp",99:"moveRightDown",speed:{slow:"control",fast:"shift"},61:{fn:"zoomIn",periodical:0},107:{fn:"zoomIn",periodical:0},109:{fn:"zoomOut",periodical:0},71:{fn:"toggleGrid",periodical:0},77:{fn:"toggleMiniMap",periodical:0},79:{fn:"toggleOutline",periodical:0}};Travian.Game.Map.Options.Default.dataStore={cachingTimeForType:{blocks:30*60*1000,symbol:10*60*1000,tile:10*60*1000,tooltip:2*60*1000},persistentStorage:false,useStorageForType:{blocks:false,symbol:false,tile:false,tooltip:true},clearStorageForType:{blocks:false,symbol:false,tile:false,tooltip:false}};Travian.Game.Map.Options.Default.data={elements:[]};Travian.Game.Map.Options.Default.mapMarks={player:{enabled:true,data:[],element:"#tabPlayer",typeId:"player",layers:{alliance:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"alliance",optionsData:Object.assign({},Travian.Game.Map.Options.MapMark.Mark.optionsData,{urlLink:"/alliance/{markId}"})}),player:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"player"}),flag:Object.assign({},Travian.Game.Map.Options.MapMark.Flag,{indexes:{min:1,max:10}})}},alliance:{enabled:true,data:[],element:"#tabAlliance",typeId:"alliance",layers:{alliance:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"alliance",optionsData:Object.assign({},Travian.Game.Map.Options.MapMark.Mark.optionsData,{urlLink:"/alliance/{markId}"})}),player:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"player"}),flag:Object.assign({},Travian.Game.Map.Options.MapMark.Flag,{indexes:{min:11,max:20}})}}};